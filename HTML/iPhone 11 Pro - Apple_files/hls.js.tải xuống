/**
 * @license
 * Copyright (c) 2017 Dailymotion (http://www.dailymotion.com)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * src/remux/mp4-generator.js and src/demux/exp-golomb.js implementation in this project
 * are derived from the HLS library for video.js (https://github.com/videojs/videojs-contrib-hls)
 *
 * That work is also covered by the Apache 2 License, following copyright:
 * Copyright (c) 2013-2015 Brightcove
 *
 * src/utils/url-toolkit.js implementation in this project
 * is derived from the url-toolkit library (https://github.com/tjenkinson/url-toolkit)
 *
 * That work is also covered by the Apache 2 License, following copyright:
 * Copyright (c) 2016 Tom Jenkinson
 */
/*! Modules included in this bundle:
* name: timers-browserify
*  license: MIT
*  version: 2.0.11
* 
* name: typescript
*  license: Apache-2.0
*  version: 3.7.2
* 
* name: events
*  license: MIT
*  version: 3.0.0
*  text:
*  MIT
*  
*  Copyright Joyent, Inc. and other Node contributors.
*  
*  Permission is hereby granted, free of charge, to any person obtaining a
*  copy of this software and associated documentation files (the
*  "Software"), to deal in the Software without restriction, including
*  without limitation the rights to use, copy, modify, merge, publish,
*  distribute, sublicense, and/or sell copies of the Software, and to permit
*  persons to whom the Software is furnished to do so, subject to the
*  following conditions:
*  
*  The above copyright notice and this permission notice shall be included
*  in all copies or substantial portions of the Software.
*  
*  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
*  OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
*  NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
*  DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
*  OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
*  USE OR OTHER DEALINGS IN THE SOFTWARE.
*  
* name: setimmediate
*  license: MIT
*  version: 1.0.5
* 
* name: webworkify-webpack
*  license: MIT
*  version: 2.1.3
* 
*/
!(function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Hls",[],t):"object"==typeof exports?exports.Hls=t():e.Hls=t()})(window,(function(){return (function(e){function t(t){for(var i,a,r=t[0],n=t[1],o=0,d=[];o<r.length;o++)a=r[o],Object.prototype.hasOwnProperty.call(s,a)&&s[a]&&d.push(s[a][0]),s[a]=0;for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);for(l&&l(t);d.length;)d.shift()()}var i={},s={0:0};function a(t){if(i[t])return i[t].exports;var s=i[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=e,a.c=i,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)a.d(i,s,function(t){return e[t]}.bind(null,s));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a.oe=function(e){throw console.error(e),e};var r=window.webpackJsonpHls=window.webpackJsonpHls||[],n=r.push.bind(r);r.push=t,r=r.slice();for(var o=0;o<r.length;o++)t(r[o]);var l=n;return a(a.s=23)})([(function(e,t,i){"use strict";t.a={MEDIA_ATTACHING:"hlsMediaAttaching",MEDIA_ATTACHED:"hlsMediaAttached",MEDIA_DETACHING:"hlsMediaDetaching",MEDIA_DETACHED:"hlsMediaDetached",BUFFER_CREATED:"hlsBufferCreated",BUFFER_APPENDING:"hlsBufferAppending",BUFFER_APPENDED:"hlsBufferAppended",BUFFER_FLUSHED:"hlsBufferFlushed",BUFFER_CODEC_UPDATED:"hlsBufferCodecUpdated",BUFFER_SOURCE_RESETTING:"hlsBufferSourceResetting",BUFFER_SOURCE_RESET:"hlsBufferSourceReset",MANIFEST_LOADING:"hlsManifestLoading",MANIFEST_LOADED:"hlsManifestLoaded",MANIFEST_PARSED:"hlsManifestParsed",LEVEL_SWITCH:"hlsLevelSwitch",LEVEL_SWITCHING:"hlsLevelSwitching",LEVEL_SWITCHED:"hlsLevelSwitched",LEVEL_LOADING:"hlsLevelLoading",LEVEL_LOADED:"hlsLevelLoaded",LEVEL_UPDATED:"hlsLevelUpdated",LEVEL_PTS_UPDATED:"hlsLevelPtsUpdated",LEVELS_CHANGED:"hlsLevelsChanged",AUDIO_TRACKS_UPDATED:"hlsAudioTracksUpdated",AUDIO_TRACK_SWITCH:"hlsAudioTrackSwitch",AUDIO_TRACK_SWITCHING:"hlsAudioTrackSwitching",AUDIO_TRACK_SWITCHED:"hlsAudioTrackSwitched",AUDIO_TRACK_LOADING:"hlsAudioTrackLoading",AUDIO_TRACK_LOADED:"hlsAudioTrackLoaded",SUBTITLE_TRACKS_CREATED:"hlsSubtitleTracksCreated",SUBTITLE_TRACKS_UPDATED:"hlsSubtitleTracksUpdated",SUBTITLE_TRACK_SWITCH:"hlsSubtitleTrackSwitch",SUBTITLE_TRACK_LOADING:"hlsSubtitleTrackLoading",SUBTITLE_TRACK_LOADED:"hlsSubtitleTrackLoaded",SUBTITLE_FRAG_PROCESSED:"hlsSubtitleFragProcessed",INLINE_STYLES_PARSED:"hlsInlineStylesParsed",SESSION_DATA_PARSED:"hlsSessionDataParsed",SESSION_DATA_LOADING:"hlsSessionDataLoading",SESSION_DATA_LOADED:"hlsSessionDataLoaded",SESSION_DATA_COMPLETE:"hlsSessionDataComplete",INIT_PTS_FOUND:"hlsInitPtsFound",FRAG_LOADING:"hlsFragLoading",FRAG_LOAD_PROGRESS:"hlsFragLoadProgress",FRAG_LOAD_EMERGENCY_ABORTED:"hlsFragLoadEmergencyAborted",FRAG_LOADED:"hlsFragLoaded",FRAG_DECRYPTED:"hlsFragDecrypted",FRAG_PARSING_INIT_SEGMENT:"hlsFragParsingInitSegment",FRAG_PARSING_USERDATA:"hlsFragParsingUserdata",FRAG_PARSING_CAPTIONDATA:"hlsFragParsingCaptiondata",FRAG_PARSING_METADATA:"hlsFragParsingMetadata",FRAG_PARSING_DATA:"hlsFragParsingData",FRAG_PARSED:"hlsFragParsed",FRAG_BUFFERED:"hlsFragBuffered",FRAG_CHANGED:"hlsFragChanged",FPS_DROP:"hlsFpsDrop",FPS_DROP_LEVEL_CAPPING:"hlsFpsDropLevelCapping",ERROR:"hlsError",DESTROYING:"hlsDestroying",KEY_REQUEST_STARTED:"hlsKeyRequestStarted",LICENSE_CHALLENGE_CREATED:"hlsLicenseChallengeCreated",KEY_LOADED:"hlsKeyLoaded",STREAM_STATE_TRANSITION:"hlsStreamStateTransition",LICENSE_RELEASED:"hlsLicenseReleased",UNRESOLVED_URI_LOADING:"hlsUnresolvedUriLoading",UNRESOLVED_URI_LOADED:"hlsUnresolvedUriLoaded",DESIRED_RATE_CHANGED:"hlsDesiredRateChanged",PLAYER_STATE_CHANGE:"hlsPlayerStateChange",SEEKING:"hlsSeeking",SEEKED:"hlsSeeked",BANDWIDTH_CHANGED:"hlsBandwidthChanged",BUFFER_CHANGED:"hlsBufferChanged",STALLED:"hlsStalled",PREFERRED_HOST_CHANGED:"hlsPreferredHostChanged"}}),(function(e,t,i){"use strict";i.d(t,"c",(function(){return s})),i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return r})),i.d(t,"d",(function(){return n}));const s={NETWORK_ERROR:"networkError",MEDIA_ERROR:"mediaError",MUX_ERROR:"muxError",KEY_SYSTEM_ERROR:"keySystemError",OTHER_ERROR:"otherError"},a={MANIFEST_LOAD_ERROR:"manifestLoadError",MANIFEST_LOAD_TIMEOUT:"manifestLoadTimeOut",MANIFEST_PARSING_ERROR:"manifestParsingError",MANIFEST_INCOMPATIBLE_CODECS_ERROR:"manifestIncompatibleCodecsError",MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR:"manifestIncompatibleVideoRangeError",LEVEL_LOAD_ERROR:"levelLoadError",LEVEL_LOAD_TIMEOUT:"levelLoadTimeOut",LEVEL_SWITCH_ERROR:"levelSwitchError",AUDIO_TRACK_LOAD_ERROR:"audioTrackLoadError",AUDIO_TRACK_LOAD_TIMEOUT:"audioTrackLoadTimeOut",SUBTITLE_TRACK_LOAD_ERROR:"subtitleTrackLoadError",SUBTITLE_TRACK_LOAD_TIMEOUT:"subtitleTrackLoadTimeout",FRAG_LOAD_ERROR:"fragLoadError",FRAG_LOOP_LOADING_ERROR:"fragLoopLoadingError",FRAG_LOAD_TIMEOUT:"fragLoadTimeOut",FRAG_DECRYPT_ERROR:"fragDecryptError",FRAG_PARSING_ERROR:"fragParsingError",REMUX_ALLOC_ERROR:"remuxAllocError",BUFFER_ADD_CODEC_ERROR:"bufferAddCodecError",BUFFER_APPEND_ERROR:"bufferAppendError",BUFFER_APPENDING_ERROR:"bufferAppendingError",BUFFER_STALLED_ERROR:"bufferStalledError",BUFFER_FULL_ERROR:"bufferFullError",BUFFER_SEEK_OVER_HOLE:"bufferSeekOverHole",BUFFER_NUDGE_ON_STALL:"bufferNudgeOnStall",INTERNAL_EXCEPTION:"internalException",WEBVTT_EXCEPTION:"webVTTException",KEY_LOAD_ERROR:"keyLoadError",KEY_LOAD_TIMEOUT:"keyLoadTimeOut",KEY_SYSTEM_GENERIC_ERROR:"keySystemGenericError",CERT_LOAD_ERROR:"certificateLoadError",CERT_LOAD_TIMEOUT:"certificateLoadTimeOut",SESSION_DATA_LOAD_ERROR:"sessionDataLoadError",SESSION_DATA_LOAD_TIMEOUT:"sessionDataLoadTimeOut"},r={PlaylistNotReceived:{code:-12884,text:"Playlist not received"},CryptResponseReceivedSlowly:{code:-16833,text:"Crypt key received slowly"},LivePlaylistUpdateError:{code:-12888,text:"Live playlist not updated"},NoResponseFromMediaRequest:{code:-12889,text:"No response for fragment"},IncompatibleAsset:{code:-12927,text:"IncompatibleAsset"},CorruptStream:{code:-16041,text:"Corrupt fragment"},InternalError:{code:-12645,text:"InternalException"},CantSwitchInTime:{code:-12644,text:"CantSwitchInTime"},VideoDecoderBadDataErr:{code:-12909,text:"Buffer error"},InsufficientDataAvailable:{code:-12928,text:"Incomplete data"},AllocationFailed:{code:-12862,text:"AllocationFailed"},PlaylistErrorMissingEXTM3U:{code:-12269,text:"Response doesnt have #EXTM3U tag"},PlaylistErrorInvalidEntry:{code:-12264,text:"Invalid entry"},PlaylistErrorBadTargetDuration:{code:-12271,text:"Invalid targetduration"},NoValidAlternates:{code:-12925,text:"No valid alternates"},FormatError:{code:-12642,text:"Incorrect playlist format"}};class n extends Error{constructor(e,t){super(e),this.name="HlsError",this.payload=t}}}),(function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));const s=()=>s;function a(e){return e<10?"0"+e:e.toString()}const r=["debug","log","info","warn","error"];class n{constructor(){this._enabled={},this.streamAndSessionIDStr=this.getStreamAndSessionIDString()}_fn(e,...t){return"function"!=typeof this._enabled[e]?s:(t=[`${(function(){const e=new Date,t=e.getTimezoneOffset(),i=a(Math.floor(Math.abs(t)/60)),s=a(Math.abs(t)%60);let r=t<=0?"UTC+"+i:"UTC-"+i;return r=s?r+":"+s:r,e.getFullYear()+"-"+a(e.getMonth()+1)+"-"+a(e.getDate())+" "+a(e.getHours())+":"+a(e.getMinutes())+":"+a(e.getSeconds())+"."+(e.getMilliseconds()/1e3).toFixed(3).slice(2,5)+" "+r})()}${this.streamAndSessionIDStr} | [${e}] >`,...t],this._enabled[e].bind(this,t.map(e=>"string"==typeof e?e:"function"==typeof e.toString?e.toString():Object.prototype.toString.call(e)).join(" ")))}trace(...e){return this._fn("trace",...e)}debug(...e){return this._fn("debug",...e)}log(...e){return this._fn("log",...e)}info(...e){return this._fn("info",...e)}warn(...e){return this._fn("warn",...e)}error(...e){return this._fn("error",...e)}_set(e,t){this._enabled[e]=t||console[e]}enable(e,t){e&&(this._enabled={},(null!=t&&r.indexOf(t)>=0?r.slice(r.indexOf(t)):r).forEach(t=>this._set(t,"boolean"!=typeof e&&e[t]||console[t])))}setStreamAndSessionIDs(e,t){this.sessionID=e,this.streamID=t,this.streamAndSessionIDStr=this.getStreamAndSessionIDString()}getStreamAndSessionIDString(){return(this.sessionID?"| [SessionID: "+this.sessionID.slice(0,8):"")+(this.streamID?", StreamID: "+this.streamID+"]":"]")}}const o=new n;o.enable(!0),t.b=o}),(function(e,t,i){"use strict";const s=Math.pow(2,32)-1;class a{static init(){var e;for(e in a.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],free:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],dec3:[],"ec-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],uuid:[],encv:[],enca:[],frma:[],schm:[],schi:[],senc:[],saio:[],saiz:[],sinf:[],tenc:[],sbgp:[],seig:[],sgpd:[],pssh:[]},a.types)a.types.hasOwnProperty(e)&&(a.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);var t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);a.HDLR_TYPES={video:t,audio:i};var s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);a.STTS=a.STSC=a.STCO=r,a.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),a.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),a.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),a.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var n=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);a.FTYP=a.box(a.types.ftyp,n,l,n,o),a.DINF=a.box(a.types.dinf,a.box(a.types.dref,s))}static set16(e,t,i){return t[i]=e>>8&255,t[i+1]=255&e,i+2}static set32(e,t,i){return t[i]=e>>24&255,t[i+1]=e>>16&255,t[i+2]=e>>8&255,t[i+3]=255&e,i+4}static box(e,...t){for(var i,s=Array.prototype.slice.call(arguments,1),a=8,r=s.length,n=r;r--;)a+=s[r].byteLength;for((i=new Uint8Array(a))[0]=a>>24&255,i[1]=a>>16&255,i[2]=a>>8&255,i[3]=255&a,i.set(e,4),r=0,a=8;r<n;r++)i.set(s[r],a),a+=s[r].byteLength;return i}static hdlr(e){return a.box(a.types.hdlr,a.HDLR_TYPES[e])}static mdat(e){return a.box(a.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(s+1)),r=Math.floor(t%(s+1));return a.box(a.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(e){let t=a.mdhd(e.info.timescale,e.info.duration),i=a.hdlr(e.type),s=a.minf(e);return a.box(a.types.mdia,t,i,s)}static mfhd(e){return a.box(a.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?a.box(a.types.minf,a.box(a.types.smhd,a.SMHD),a.DINF,a.stbl(e)):a.box(a.types.minf,a.box(a.types.vmhd,a.VMHD),a.DINF,a.stbl(e))}static moof(e,t){a.types||a.init();let i=a.traf(t,e);return a.box(a.types.moof,a.mfhd(t.sequenceNumber),i)}static moov(e){for(var t=e.length,i=[];t--;)i[t]=a.trak(e[t]);return a.box.apply(null,[a.types.moov,a.mvhd(e[0].info.timescale,e[0].info.duration)].concat(i).concat(a.mvex(e)))}static mvex(e){for(var t=e.length,i=[];t--;)i[t]=a.trex(e[t]);return a.box(a.types.mvex,...i)}static mvhd(e,t){t*=e;const i=Math.floor(t/(s+1)),r=Math.floor(t%(s+1));var n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return a.box(a.types.mvhd,n)}static sdtp(e){var t,i,s=e.samples||[],r=new Uint8Array(4+s.length);for(i=0;i<s.length;i++)t=s[i].flags,r[i+4]=t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;return a.box(a.types.sdtp,r)}static stbl(e){let t=a.stsd(e),i=a.box(a.types.stts,a.STTS),s=a.box(a.types.stsc,a.STSC),r=a.box(a.types.stsz,a.STSZ),n=a.box(a.types.stco,a.STCO);return a.box(a.types.stbl,t,i,s,r,n)}static avc1(e){var t,i,s,r=[],n=[];let o=e.info.encrypted?a.types.encv:a.types.avc1;for(t=0;t<e.config.sps.length;t++)s=(i=e.config.sps[t]).byteLength,r.push(s>>>8&255),r.push(255&s),r=r.concat(Array.prototype.slice.call(i));for(t=0;t<e.config.pps.length;t++)s=(i=e.config.pps[t]).byteLength,n.push(s>>>8&255),n.push(255&s),n=n.concat(Array.prototype.slice.call(i));var l=a.box(a.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|e.config.sps.length].concat(r).concat([e.config.pps.length]).concat(n))),d=e.config.width,h=e.config.height,c=e.config.pixelRatio[0],u=e.config.pixelRatio[1],f=e.info.encrypted&&e.info.decryptdata?a.sinf(e.info.decryptdata,e.type,a.types.avc1):new Uint8Array;return a.box(o,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,d>>8&255,255&d,h>>8&255,255&h,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,f,a.box(a.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),a.box(a.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,u>>24,u>>16&255,u>>8&255,255&u])))}static esds(e){var t=e.esdsConfig.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.esdsConfig).concat([6,1,2]))}static audioStsd(e){var t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static dac3(e){let t=e.extraData;return new Uint8Array([t>>16&255,t>>8&255,255&t])}static dec3(e){return e.extraDataBytes}static mp4a(e,t){let i=a.types.mp4a,s=null;e.encrypted&&e.decryptdata?(i=a.types.enca,s=a.sinf(e.decryptdata,"audio",a.types.mp4a)):s=new Uint8Array;let r=a.audioStsd(t),n=a.box(a.types.esds,a.esds(t));return a.box(i,r,n,s)}static mp3(e){return a.box(a.types[".mp3"],a.audioStsd(e))}static ac3(e,t){let i=a.types["ac-3"],s=null;return e.encrypted&&e.decryptdata?(i=a.types.enca,s=a.sinf(e.decryptdata,"audio",a.types["ac-3"])):s=new Uint8Array,a.box(i,a.audioStsd(t),a.box(a.types.dac3,a.dac3(t)),s)}static ec3(e,t){let i=a.types["ec-3"],s=null;return e.encrypted&&e.decryptdata?(i=a.types.enca,s=a.sinf(e.decryptdata,"audio",a.types["ec-3"])):s=new Uint8Array,a.box(i,a.audioStsd(t),a.box(a.types.dec3,a.dec3(t)),s)}static stsd(e){if("audio"===e.type){if("mp3"===e.config.segmentCodec&&"mp3"===e.config.codec)return a.box(a.types.stsd,a.STSD,a.mp3(e.config));if("ac3"===e.config.segmentCodec)return a.box(a.types.stsd,a.STSD,a.ac3(e.info,e.config));if("ec3"===e.config.segmentCodec)return a.box(a.types.stsd,a.STSD,a.ec3(e.info,e.config));if("aac"===e.config.segmentCodec)return a.box(a.types.stsd,a.STSD,a.mp4a(e.info,e.config));throw`unknown segmentCodec ${e.config.segmentCodec}`}return a.box(a.types.stsd,a.STSD,a.avc1(e))}static tkhd(e){let t=e.info.id,i=e.info.duration*e.info.timescale,r=Math.floor(i/(s+1)),n=Math.floor(i%(s+1)),o=0,l=0;return"video"===e.type&&(o=e.config.width,l=e.config.height),a.box(a.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,o>>8&255,255&o,0,0,l>>8&255,255&l,0,0]))}static traf(e,t){const i=a.senc(e);var r=a.sdtp(e),n=i.boxData,o=n.length?a.saio(76):new Uint8Array,l=n.length?a.saiz(i.defaultSampleInfoSize,i.sampleInfoSizes):new Uint8Array,d=a.sbgp(e),h=a.sgpd(e),c=e.id,u=Math.floor(t/(s+1)),f=Math.floor(t%(s+1));return a.box(a.types.traf,a.box(a.types.tfhd,new Uint8Array([0,2,0,0,c>>24,c>>16&255,c>>8&255,255&c])),a.box(a.types.tfdt,new Uint8Array([1,0,0,0,u>>24,u>>16&255,u>>8&255,255&u,f>>24,f>>16&255,f>>8&255,255&f])),n,o,l,d,h,a.trun(e,r.length+n.length+d.length+h.length+o.length+l.length+16+20+8+16+8+8),r)}static trak(e){if("trakData"in e)return e.trakData;e.info.duration=e.info.duration||4294967295;let t=a.types.trak,i=a.tkhd(e),s=a.mdia(e);return a.box(t,i,s)}static trex(e){var t=e.info.id;return a.box(a.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){var i,s,r,n,o,l,d=e.samples||[],h=d.length,c=12+16*h,u=new Uint8Array(c);for(t+=8+c,u.set([0,0,15,1,h>>>24&255,h>>>16&255,h>>>8&255,255&h,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),i=0;i<h;i++)r=(s=d[i]).duration,n=s.size,o=s.flags,l=s.cts,u.set([r>>>24&255,r>>>16&255,r>>>8&255,255&r,n>>>24&255,n>>>16&255,n>>>8&255,255&n,o.isLeading<<2|o.dependsOn,o.isDependedOn<<6|o.hasRedundancy<<4|o.paddingValue<<1|o.isNonSync,61440&o.degradPrio,15&o.degradPrio,l>>>24&255,l>>>16&255,l>>>8&255,255&l],12+16*i);return a.box(a.types.trun,u)}static initSegment(e){a.types||a.init();var t,i=a.moov(e);return(t=new Uint8Array(a.FTYP.byteLength+i.byteLength)).set(a.FTYP),t.set(i,a.FTYP.byteLength),t}static saio(e){const t=e+4+4;return a.box(a.types.saio,new Uint8Array([0,0,0,0,0,0,0,1,t>>24&255,t>>16&255,t>>8&255,255&t]))}static saiz(e,t){isNaN(e)&&(e=0);const i=t.length;let s=0===e?new Uint8Array(t):new Uint8Array;return a.box(a.types.saiz,new Uint8Array([0,0,0,0,e,i>>24&255,i>>16&255,i>>8&255,255&i]),s)}static senc(e){const t=e.samples||[],i=t.length;let s=0,r=NaN,n=!0,o=[];if(!e.encrypted||i<=0)return{boxData:new Uint8Array,sampleInfoSizes:o,defaultSampleInfoSize:0};const l=e.defaultPerSampleIVSize?e.defaultPerSampleIVSize:0;for(const e of t)e.subsamples&&(s+=e.subsamples.length);if(s<=0)return{boxData:new Uint8Array,sampleInfoSizes:o,defaultSampleInfoSize:0};let d=new Uint8Array(2*i+i*l+6*s+4),h=this.set32(i,d,0);for(const e of t){let t=e.subsamples?e.subsamples:[],i=2;e.iv&&(d.set(e.iv,h),h+=e.iv.byteLength,i+=e.iv.byteLength),h=this.set16(t.length,d,h);for(const e of t)h=this.set16(e[0],d,h),h=this.set32(e[1],d,h),i+=6;o.push(i),isNaN(r)&&(r=i),n=n&&r==i,r=i}return{boxData:a.box(a.types.senc,new Uint8Array([0,0,0,2]),d),defaultSampleInfoSize:n?r:0,sampleInfoSizes:o}}static sinf(e,t,i){return a.box(a.types.sinf,a.frma(i),a.schm(),a.schi(e,t))}static frma(e){return a.box(a.types.frma,new Uint8Array(e))}static schm(){return a.box(a.types.schm,new Uint8Array([0,0,0,0,99,98,99,115,0,1,0,0]))}static schi(e,t){return a.box(a.types.schi,a.tenc(e,t))}static tenc(e,t){let i=0;"video"===t&&(i=25);let s=new Uint8Array(17);if(s[0]=16,e.iv&&16===e.iv.byteLength&&s.set(e.iv,1),!e.keyId)throw"tenc: no key id found in decryptdata";return a.box(a.types.tenc,new Uint8Array([1,0,0,0,0,i,1,0]),e.keyId,s)}static sbgp(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].decryptdata)return new Uint8Array;let t=e.samples.length;return a.box(a.types.sbgp,new Uint8Array([0,0,0,0]),new Uint8Array(a.types.seig),new Uint8Array([0,0,0,1,t>>24&255,t>>16&255,t>>8&255,255&t,0,1,0,1]))}static sgpd(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].decryptdata)return new Uint8Array;let t=e.samples[0].decryptdata,i=0;"video"===e.type&&(i=25);let s=new Uint8Array(17);if(s[0]=16,t.iv&&s.set(t.iv,1),!t.keyId)throw"sgpd: no keyid in decryptdata";return a.box(a.types.sgpd,new Uint8Array([1,0,0,0]),new Uint8Array(a.types.seig),new Uint8Array([0,0,0,37,0,0,0,1]),new Uint8Array([0,i,1,0]),t.keyId,s)}static pssh(e,t,i){if(a.types||a.init(),!e)throw new TypeError("Bad system id");if(16!==e.byteLength)throw new RangeError("Invalid system id");let s,r,n;if(t){s=1,r=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){let i=t[e];if(16!==i.byteLength)throw new RangeError("Invalid key");r.set(i,16*e)}}else s=0,r=new Uint8Array;s>0?(n=new Uint8Array(4),t.length>0&&new DataView(n.buffer).setUint32(0,t.length,!1)):n=new Uint8Array;let o=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(o.buffer).setUint32(0,i.byteLength,!1),a.box(a.types.pssh,new Uint8Array([s,0,0,0]),e,n,r,o,i||new Uint8Array)}}t.a=a}),(function(e,t,i){"use strict";var s=i(8);let a,r;const n="undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder?{strToUtf8array:function(e){return a||(a=new TextEncoder),a.encode(e)},utf8arrayToStr:function(e){return r||(r=new TextDecoder("utf-8")),r.decode(e)}}:{strToUtf8array:function(e){const t=s.a.Buffer.from(e,"utf-8");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)},utf8arrayToStr:function(e){return s.a.Buffer.from(e).toString("utf-8")}};t.a=n}),(function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));const s=new Set(["ac-3","mp4a.a5","mp4a.A5"]),a=new Set(["ec-3","mp4a.a6","mp4a.A6"]),r={aac:1024,mp3:1024,ac3:1536,ec3:1536},n={isAC3:function(e){return Boolean(e&&s.has(e))},isEC3:function(e){return Boolean(e&&a.has(e))},isDolbyAtmos:function(e,t){let i=t.split("/");return Boolean(n.isEC3(e)&&i.length>1&&"JOC"===i[1])},isAAC:function(e){let t;return Boolean(e&&("aac"===e||null!==(t=e.match(/^mp4a\.40\.(.*)/))&&"34"!==t[1]))},isAVC:function(e){return Boolean(e&&e.match(/^avc[13]\.(.*)/))},isHEVC:function(e){return Boolean(e&&e.match(/^(hev|hvc)1\..*/))},isDolby:function(e){return Boolean(e&&e.match(/^dv(h1|he|a1|av)\..*/))},isCompatibleCodecString:function(e,t){let i=e.split(","),s=t.split(","),a=i.filter(e=>n.isVideoCodec(e)),r=s.filter(e=>n.isVideoCodec(e)),o=i.filter(e=>n.isAudioCodec(e)),l=s.filter(e=>n.isAudioCodec(e)),d=0===a.length&&0===r.length||a.length===r.length&&n.isCompatibleVideoCodec(a[0],r[0]),h=0===o.length&&0===l.length||o.length===l.length&&n.isCompatibleAudioCodec(o[0],l[0]);return d&&h},isVideoCodec:function(e){return n.isAVC(e)||n.isDolby(e)||n.isHEVC(e)},isAudioCodec:function(e){return n.isAC3(e)||n.isEC3(e)||n.isAAC(e)},isCompatibleVideoCodec:function(e,t){return Boolean(e&&t&&(e===t||n.isDolby(e)&&n.isDolby(t)||n.isHEVC(e)&&n.isHEVC(t)||n.isAVC(e)&&n.isAVC(t)))},isCompatibleAudioCodec:function(e,t){return Boolean(e&&t&&(e===t||n.isAAC(e)&&n.isAAC(t)||n.isAC3(e)&&n.isAC3(t)||n.isEC3(e)&&n.isEC3(t)))},getSegmentCodec:function(e){let t;if(n.isAAC(e))t="aac";else if(n.isAC3(e))t="ac3";else if(n.isEC3(e))t="ec3";else{if("mp3"!==e)throw`invalid audio config, codec ${e}`;t="mp3"}return t},getChannelCount:function(e){if(!e)return 0;let t=e.split("/"),i=parseInt(t[0]);return isNaN(i)?0:i}};t.b=n}),(function(e,t,i){"use strict";var s=i(8);class a{static strToBase64Encode(e){return btoa(e)}static base64DecodeToStr(e){return atob(e)}static base64Encode(e){return btoa(String.fromCharCode(...e))}static base64UrlEncode(e){return this.base64Encode(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,"")}static base64Decode(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}}const r=void 0!==s.a.Buffer?class extends a{static strToBase64Encode(e){return s.a.Buffer.from(e).toString("base64")}static base64DecodeToStr(e){return s.a.Buffer.from(e,"base64").toString()}static base64Encode(e){return s.a.Buffer.from(e).toString("base64")}static base64Decode(e){const t=s.a.Buffer.from(e,"base64");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}}:a;t.a=r}),(function(e,t,i){"use strict";var s="undefined"!=typeof global&&global||"undefined"!=typeof self&&self||window,a=Function.prototype.apply;function r(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new r(a.call(setTimeout,s,arguments),clearTimeout)},t.setInterval=function(){return new r(a.call(setInterval,s,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},r.prototype.unref=r.prototype.ref=function(){},r.prototype.close=function(){this._clearFn.call(s,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},i(16),t.setImmediate="undefined"!=typeof self&&self.setImmediate||"undefined"!=typeof global&&global.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||"undefined"!=typeof global&&global.clearImmediate||this&&this.clearImmediate}),(function(e,t,i){"use strict";const s=e=>e&&e.Math==Math&&e;t.a=s("object"==typeof globalThis&&globalThis)||s("object"==typeof window&&window)||s("object"==typeof self&&self)||s("object"==typeof global&&global)||Function("return this")()}),(function(e,t,i){"use strict";var s,a="object"==typeof Reflect?Reflect:null,r=a&&"function"==typeof a.apply?a.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};s=a&&"function"==typeof a.ownKeys?a.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var l=10;function d(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function h(e,t,i,s){var a,r,n,o;if("function"!=typeof i)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i);if(void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),r=e._events),n=r[t]),void 0===n)n=r[t]=i,++e._eventsCount;else if("function"==typeof n?n=r[t]=s?[i,n]:[n,i]:s?n.unshift(i):n.push(i),(a=d(e))>0&&n.length>a&&!n.warned){n.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+n.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=n.length,o=l,console&&console.warn&&console.warn(o)}return e}function c(e,t,i){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},a=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,r(this.listener,this.target,e))}.bind(s);return a.listener=i,s.wrapFn=a,a}function u(e,t,i){var s=e._events;if(void 0===s)return[];var a=s[t];return void 0===a?[]:"function"==typeof a?i?[a.listener||a]:[a]:i?(function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t})(a):g(a,a.length)}function f(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(e,t){for(var i=new Array(t),s=0;s<t;++s)i[s]=e[s];return i}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return d(this)},o.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var s="error"===e,a=this._events;if(void 0!==a)s=s&&void 0===a.error;else if(!s)return!1;if(s){var n;if(t.length>0&&(n=t[0]),n instanceof Error)throw n;var o=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw o.context=n,o}var l=a[e];if(void 0===l)return!1;if("function"==typeof l)r(l,this,t);else{var d=l.length,h=g(l,d);for(i=0;i<d;++i)r(h[i],this,t)}return!0},o.prototype.addListener=function(e,t){return h(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return h(this,e,t,!0)},o.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,c(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,c(this,e,t)),this},o.prototype.removeListener=function(e,t){var i,s,a,r,n;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(s=this._events))return this;if(void 0===(i=s[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(a=-1,r=i.length-1;r>=0;r--)if(i[r]===t||i[r].listener===t){n=i[r].listener,a=r;break}if(a<0)return this;0===a?i.shift():(function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()})(i,a),1===i.length&&(s[e]=i[0]),void 0!==s.removeListener&&this.emit("removeListener",e,n||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,i,s;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var a,r=Object.keys(i);for(s=0;s<r.length;++s)"removeListener"!==(a=r[s])&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},o.prototype.listeners=function(e){return u(this,e,!0)},o.prototype.rawListeners=function(e){return u(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},o.prototype.listenerCount=f,o.prototype.eventNames=function(){return this._eventsCount>0?s(this._events):[]}}),(function(e,t,i){"use strict";function s(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),s(i(17)),s(i(19))}),(function(e,t,i){"use strict";var s=i(0),a=i(1),r=i(2),n=i(4);class o{constructor(e){this._hasTimeStamp=!1,this._audioType=null,this._length=0,this._frames=[];for(var t,i,s,a,n=0;;)if(s=o.readUTF(e,n,3),n+=3,"ID3"===s){this._minor=e[n++],this._revision=e[n++];let s=e[n++];if(128&s&&(this._unsynchronized=!0,r.b.error("id3 tag is unsynchronized")()),64&s&&(this._hasExtendedHeader=!0,r.b.warn("id3 tag has extended header")()),t=o.calcTagSize(e.subarray(n,n+4)),i=(n+=4)+t,this._hasExtendedHeader){let t=o.calcTagSize(e.subarray(n,n+4));r.b.warn(`id3 tag has ${t}-byte extended header. usually 6 or 10 bytes`)(),n+=t}this.minor>2?this._parseID3Frames(e,n,i):r.b.error("[id3] doesn't support older than v2.3 tags")(),n=i}else{if("3DI"!==s)return void((a=n-=3)&&(this.hasTimeStamp||r.b.warn("ID3 tag found, but no timestamp")(),this._length=a,this._payload=e.subarray(0,a)));n+=7}}static calcTagSize(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}static readUTF(e,t,i){var s="",a=t,r=t+i;do{s+=String.fromCharCode(e[a++])}while(a<r);return s}isID3Frame(e,t){return e[t+4]<128&&e[t+5]<128&&e[t+6]<128&&e[t+7]<128}decodeID3Frame(e){return"TXXX"===e.type?this.decodeTxxxFrame(e):"WXXX"===e.type?this.decodeWxxxFrame(e):"PRIV"===e.type?this.decodePrivFrame(e):"T"===e.type[0]?this.decodeTextFrame(e):{key:e.type,data:e.data}}decodeTxxxFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=1,i=this.utf8ArrayToStr(e.data.subarray(t));return t+=i.length+1,{key:"TXXX",description:i,data:this.utf8ArrayToStr(e.data.subarray(t))}}decodeWxxxFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=1,i=this.utf8ArrayToStr(e.data.subarray(t));return t+=i.length+1,{key:"WXXX",description:i,data:n.a.utf8arrayToStr(e.data.subarray(t))}}decodeTextFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=e.data.subarray(1);return{key:e.type,data:this.utf8ArrayToStr(t)}}decodePrivFrame(e){if(e.size<2)return;let t=this.utf8ArrayToStr(e.data);return{key:"PRIV",info:t,data:e.data.subarray(t.length+1)}}_extractID3Frame(e,t,i,s,a){let n,o=s+i;return o<=a?(r.b.info(`[id3] parsed frame id ${t} size ${i}`)(),n={type:t,data:e.subarray(s,o)}):r.b.error(`id3 frame ${t} size ${i} exceeded ${a}`)(),n}_parseID3Frames(e,t,i){for(var s,a,n,l;t+8<=i;){if(!this.isID3Frame(e,t))return void r.b.error(`[id3] illegal id3 frame @ offset ${t}. skip this id3 tag`)();if(s=o.readUTF(e,t,4),t+=4,""===s)return void r.b.info("[id3] empty tagId. padding.")();if(0===(a=o.calcTagSize(e.subarray(t,t+4))))return void r.b.info("[id3] zero tag length. padding.")();t+=4,e[t++],e[t++],n=t;let h=this._extractID3Frame(e,s,a,n,i);if(h){let e=this.decodeID3Frame(h);this._frames.push(e)}switch(s){case"PRIV":if(53===a&&"com.apple.streaming.transportStreamTimestamp"===o.readUTF(e,t,44)){t+=44,t+=4;var d=1&e[t++];this._hasTimeStamp=!0,l=((e[t++]<<23)+(e[t++]<<15)+(e[t++]<<7)+e[t++])/45,d&&(l+=47721858.84),l=Math.round(l),this._timeStamp=l}else a>=45&&"com.apple.streaming.audioDescription"===o.readUTF(e,t,36)?(t+=37,this._audioType=o.readUTF(e,t,4),t+=4,t+=a-41):t+=a;break;default:t+=a}}}utf8ArrayToStr(e){let t,i,s="",a=0,r=e.length;for(;a<r;){let r=e[a++];switch(r>>4){case 0:return s;case 1:case 2:case 3:case 4:case 5:case 6:case 7:s+=String.fromCharCode(r);break;case 12:case 13:t=e[a++],s+=String.fromCharCode((31&r)<<6|63&t);break;case 14:t=e[a++],i=e[a++],s+=String.fromCharCode((15&r)<<12|(63&t)<<6|(63&i)<<0)}}}get hasTimeStamp(){return this._hasTimeStamp}get timeStamp(){return this._timeStamp}get audioType(){return this._audioType}get length(){return this._length}get payload(){return this._payload}get frames(){return this._frames}get minor(){return this._minor}get revision(){return this._revision}}var l=o;class d{bsReadAndUpdate(e,t,i){let s=this.readBits(e,t,i);return this.updateOffset(t,i),s}bsWriteAndUpdate(e,t,i,s){let a=this.writeBits(e,t,i,s);return this.updateOffset(t,i),a}bsSkip(e,t){this.updateOffset(e,t)}readBits(e,t,i){if(!e||!t)return;let s,a=t.byteOffset,r=t.usedBits;if(r>=8||r+i>32)return;let n=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);if(!(r>=8||i>32)){if(r){let t=8-r,n=i<t?t-i:0;o[0]=4278190080>>>32-t,s=(e[a]&o[0])>>>n,a+=1,i-=t}for(;i>0;){l[0]=e[a];let t=Math.min(i,8),r=8-t;o[0]=4278190080>>>24+r<<r,n[0]=(l[0]&o[0])>>r,s=s?s<<t|n[0]:n[0],a+=1,i-=t}return s}}writeBits(e,t,i,s){if(!e||!t)return;let a=t.byteOffset,r=t.usedBits;if(r>=8||r+i>32)return;let n=new Uint32Array(1),o=new Uint32Array(1),l=new Uint32Array(1),d=new Uint8Array(1);for(n[0]=s,r&&(o[0]=n[0]<<32-i,l[0]=4278190080,d[0]=(o[0]&l[0])>>>24+r,e[a]&=~(l[0]>>>24+r),e[a]|=d[0],a+=1,i-=8-r);i>0;){o[0]=n[0]<<32-i,l[0]=4278190080,d[0]=(o[0]&l[0])>>>24;let t=i<0?8-i:0;e[a]&=~(l[0]>>>24>>>t<<t),e[a]|=d[0],i-=8,a+=1}return 0}updateOffset(e,t){if(!e||!t||e.usedBits+t>32)return;let i=e.usedBits%8,s=Math.floor((i+t)/8),a=(i+t)%8;e.byteOffset+=s,e.usedBits=a}}var h=function(e,t,i){let r=new d,n=!1,o=0;for(;i<t.length;){if(i+8>t.length)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ec-3, not enough data"});if(11!==t[i]||119!==t[i+1])return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ec-3 magic"});let l={byteOffset:i+2,usedBits:0},d=r.bsReadAndUpdate(t,l,2),h=r.bsReadAndUpdate(t,l,3);if(0===d||2===d)if(!0===n){if(0===h)break}else n=!0;else if(1!==d)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"reserved stream type"});let c=2*(r.bsReadAndUpdate(t,l,11)+1);i+=c,o+=c}return o},c=function(e,t,i){let r={frmsiz:0,fscod:0,numblkscod:0,acmod:0,lfeon:0,bsid:0,strmtyp:0,substreamid:0,chanmape:0,chanmap:0,mixdef:0,mixdeflen:0,bsmod:0},n={fscod:0,acmod:0,lfeon:0,bsid:0,bsmod:0,chan_loc:0,data_rate:0,num_ind_sub:0,num_dep_sub:[],complexity_index_type_a:0},o=new d,l=!1,h=0;for(;i<t.length;){if(i+8>t.length)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ec-3, not enough data"});if(11!==t[i]||119!==t[i+1])return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ec-3 magic"});let d={byteOffset:i+2,usedBits:0};if(r.strmtyp=o.bsReadAndUpdate(t,d,2),r.substreamid=o.bsReadAndUpdate(t,d,3),0===r.strmtyp||2===r.strmtyp){if(!0===l){if(0===r.substreamid)break}else l=!0;n.num_ind_sub++,n.num_dep_sub.push(0)}else{if(1!==r.strmtyp)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"reserved stream type"});n.num_dep_sub[n.num_ind_sub-1]++}if(r.frmsiz=o.bsReadAndUpdate(t,d,11),r.fscod=o.bsReadAndUpdate(t,d,2),3===r.fscod?(o.bsSkip(d,2),r.numblkscod=3):r.numblkscod=o.bsReadAndUpdate(t,d,2),r.acmod=o.bsReadAndUpdate(t,d,3),r.lfeon=o.bsReadAndUpdate(t,d,1),r.bsid=o.bsReadAndUpdate(t,d,5),o.bsSkip(d,5),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,8),0===r.acmod&&(o.bsSkip(d,5),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,8)),1===r.strmtyp&&(r.chanmape=o.bsReadAndUpdate(t,d,1),r.chanmape&&(r.chanmap=o.bsReadAndUpdate(t,d,16))),o.bsReadAndUpdate(t,d,1)&&(r.acmod>2&&o.bsSkip(d,2),1&r.acmod&&r.acmod>2&&o.bsSkip(d,6),4&r.acmod&&o.bsSkip(d,6),r.lfeon&&o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,5),0===r.strmtyp)){if(o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,6),0===r.acmod&&o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,6),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,6),r.mixdef=o.bsReadAndUpdate(t,d,2),1===r.mixdef)o.bsSkip(d,5);else if(2===r.mixdef)o.bsSkip(d,12);else if(3===r.mixdef){r.mixdeflen=o.bsReadAndUpdate(t,d,5),o.bsReadAndUpdate(t,d,1)&&(o.bsSkip(d,5),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4),o.bsReadAndUpdate(t,d,1)&&(o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,4))),o.bsReadAndUpdate(t,d,1)&&(o.bsSkip(d,5),o.bsReadAndUpdate(t,d,1)&&(o.bsSkip(d,7),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,8)));let e=r.mixdeflen+2+(d.usedBits?1:0);d.byteOffset+=e}if(r.acmod<2&&(o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,14),0===r.acmod&&o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,14)),o.bsReadAndUpdate(t,d,1))if(0===r.numblkscod)o.bsSkip(d,5);else for(let e=0;e<r.numblkscod;e++)o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,5)}if(r.bsmod=0,o.bsReadAndUpdate(t,d,1)&&(r.bsmod=o.bsReadAndUpdate(t,d,3),o.bsSkip(d,2),2===r.acmod&&o.bsSkip(d,4),r.acmod>=6&&o.bsSkip(d,2),o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,8),0===r.acmod&&o.bsReadAndUpdate(t,d,1)&&o.bsSkip(d,8),r.fscod<3&&o.bsSkip(d,1)),0===r.strmtyp&&3!=r.numblkscod&&o.bsSkip(d,1),2===r.strmtyp){let e;(e=3===r.numblkscod?1:o.bsReadAndUpdate(t,d,1))&&o.bsReadAndUpdate(t,d,6)}if(o.bsReadAndUpdate(t,d,1)){let e=o.bsReadAndUpdate(t,d,6);if(0===r.strmtyp&&0===r.substreamid&&1===e){let e=o.bsReadAndUpdate(t,d,7),i=o.bsReadAndUpdate(t,d,1),s=o.bsReadAndUpdate(t,d,8);0===e&&1===i&&s>=1&&s<=16&&(n.complexity_index_type_a=s)}}if(r.chanmape)n.chan_loc|=r.chanmap;else{let e=[40960,16384,40960,57344,41472,57856,47104,63488];n.chan_loc|=e[r.acmod]}0===r.strmtyp&&(n.fscod=r.fscod,n.bsid=r.bsid,n.bsmod=r.bsmod,n.acmod=r.acmod,n.lfeon=r.lfeon),n.chan_loc|=r.lfeon?1:0;let c=2*(r.frmsiz+1);i+=c,h+=c}let c=0;for(let e=0;e<16;e++)n.chan_loc&1<<e&&c++;n.lfeon&&c++;let u=10+3*n.num_ind_sub,f=[48e3,44100,32e3][n.fscod];n.data_rate=f/1536*h*8,u=10+3*n.num_ind_sub;for(let e=0;e<n.num_ind_sub;e++)n.num_dep_sub[e]>0&&u++;n.complexity_index_type_a>0&&(u+=2);let g=new Uint8Array(u),m={byteOffset:0,usedBits:0};o.bsWriteAndUpdate(g,m,32,u),o.bsWriteAndUpdate(g,m,32,1684366131),o.bsWriteAndUpdate(g,m,13,n.data_rate),o.bsWriteAndUpdate(g,m,3,n.num_ind_sub);for(let e=0;e<n.num_ind_sub;e++)o.bsWriteAndUpdate(g,m,2,n.fscod),o.bsWriteAndUpdate(g,m,5,n.bsid),o.bsWriteAndUpdate(g,m,1,0),o.bsWriteAndUpdate(g,m,1,0===e?0:1),o.bsWriteAndUpdate(g,m,3,n.bsmod),o.bsWriteAndUpdate(g,m,3,n.acmod),o.bsWriteAndUpdate(g,m,1,n.lfeon),o.bsWriteAndUpdate(g,m,3,0),o.bsWriteAndUpdate(g,m,4,n.num_dep_sub[e]),n.num_dep_sub[e]>0?o.bsWriteAndUpdate(g,m,9,n.chan_loc):o.bsWriteAndUpdate(g,m,1,0);return n.complexity_index_type_a>0&&(o.bsWriteAndUpdate(g,m,7,0),o.bsWriteAndUpdate(g,m,1,1),o.bsWriteAndUpdate(g,m,8,n.complexity_index_type_a)),{samplerate:f,channelCount:c,segmentCodec:"ec3",codec:"ec-3",extraDataBytes:g}};class u{constructor(e,t,i,s){this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=s}static probe(e){throw new Error("Method not implemented.")}resetTimeStamp(e){}resetInitSegment(e,t,i,s,a,r){}destroy(){}}class f extends u{constructor(e,t,i,s){super(e,t,i,s),this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=s,this.esRemuxer=t}}class g{constructor(e,t){this.observer=e,this.config=t}resetInitSegment(){}resetTimeStamp(e){}destroy(){}}let m=[48e3,44100,32e3],p=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920];var y={getFrameDuration:function(e,t){return 1536/e.samplerate*t},getAudioConfig:function(e,t,i){if(i+8>t.length)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ac-3, not enough data"});if(11!==t[i]||119!==t[i+1])return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"});let r=t[i+4]>>6;if(r>=3)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ac-3 samplingRateCode:${r}`});let n=63&t[i+4],o=t[i+6]>>5,l=0;2===o?l+=2:(1&o&&1!==o&&(l+=2),4&o&&(l+=2));let d=(t[i+6]<<8|t[i+7])>>12-l&1,h=[2,1,2,3,3,4,4,5][o]+d,c=t[i+5]>>3,u=7&t[i+5];return{samplerate:m[r],channelCount:h,segmentCodec:"ac3",codec:"ac-3",extraData:r<<22|c<<17|u<<14|o<<11|d<<10|n>>1<<5}},getFrameLength:function(e,t,i){if(i+8>t.length)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ac-3, not enough data"});if(11!==t[i]||119!==t[i+1])return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"});let r=t[i+4]>>6;if(r>=3)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ac-3 samplingRateCode:${r}`});let n=63&t[i+4];return 2*p[3*n+r]}},v={getAudioConfig:function(e,t,i,r){let n,o,l,d,h,c=navigator.userAgent.toLowerCase(),u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];if(n=1+((192&t[i+2])>>>6),!((o=(60&t[i+2])>>>2)>u.length-1))return d=(1&t[i+2])<<2,d|=(192&t[i+3])>>>6,/firefox/i.test(c)?o>=6?(n=5,h=new Array(4),l=o-3):(n=2,h=new Array(2),l=o):-1!==c.indexOf("android")?(n=2,h=new Array(2),l=o):(n=5,h=new Array(4),r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&o>=6?l=o-3:((r&&-1!==r.indexOf("mp4a.40.2")&&o>=6&&1===d||!r&&1===d)&&(n=2,h=new Array(2)),l=o)),h[0]=n<<3,h[0]|=(14&o)>>1,h[1]|=(1&o)<<7,h[1]|=d<<3,5===n&&(h[1]|=(14&l)>>1,h[2]=(1&l)<<7,h[2]|=8,h[3]=0),{esdsConfig:h,samplerate:u[o],channelCount:d,segmentCodec:"aac",codec:"mp4a.40."+n};e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${o}`})}};const T={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],onFrame:function(e,t,i,s,a,r,n){var o=n+r*(10368e4/s);e.esSamples.push({unit:t,pts:o,dts:o}),e.len+=t.length},onNoise:function(e){r.b.warn("mpeg audio has noise: "+e.length+" bytes")()},parseFrames:function(e,t,i,s,a,r){if(i+2>s)return-1;if(255===t[i]||224==(224&t[i+1])){if(i+24>s)return-1;var n=t[i+1]>>3&3,o=t[i+1]>>1&3,l=t[i+2]>>4&15,d=t[i+2]>>2&3,h=!!(2&t[i+2]);if(1!==n&&0!==l&&15!==l&&3!==d){var c=1e3*[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160][14*(3===n?3-o:3===o?3:4)+l-1],u=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3][3*(3===n?0:2===n?1:2)+d],f=h?1:0,g=t[i+3]>>6==3?1:2,m=3===o?(3===n?12:6)*c/u+f<<2:(3===n?144:72)*c/u+f|0;return i+m>s?-1:(T.onFrame(e,t.subarray(i,i+m),c,u,g,a,r),m)}}for(var p=i+2;p<s;){if(255===t[p-1]&&224==(224&t[p]))return T.onNoise(t.subarray(i,p-1)),p-i-1;p++}return-1},parse:function(e,t,i,s){for(var a,r=t.length,n=0;i<r&&(a=T.parseFrames(e,t,i,r,n++,s))>0;)i+=a},getAudioConfig:function(e,t){let i=e[t+1]>>3&3,s=e[t+1]>>1&3,a=e[t+2]>>4&15,r=e[t+2]>>2&3,n=e[t+2]>>1&1;if(1!==i&&0!==a&&15!==a&&3!==r){let o=3===i?3-s:3===s?3:4,l=1e3*T.BitratesMap[14*o+a-1],d=3===i?0:2===i?1:2,h=T.SamplingRateMap[3*d+r],c=e[t+3]>>6==3?1:2,u=T.SamplesCoefficients[i][s],f=T.BytesInSlot[s];return{segmentCodec:"mp3",codec:"mp3",samplerate:h,channelCount:c,frameLength:parseInt(u*l/h+n,10)*f}}},isHeaderPattern:function(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])},probe:function(e,t){if(t+1<e.length&&T.isHeaderPattern(e,t)){let i=4,s=T.getAudioConfig(e,t),a=i;s&&s.frameLength&&(a=s.frameLength);let r=t+a;if(r===e.length||r+1<e.length&&T.isHeaderPattern(e,r))return!0}return!1}};var S=T,b=i(3),_=i(5);class E{static getTrack(e,t,i,s){let a;switch(_.b.getSegmentCodec(i)){case"aac":{let r;(r=1===s?v.getAudioConfig(e,new Uint8Array([255,241,92,64,1,127,252]),0,i):v.getAudioConfig(e,new Uint8Array([255,241,92,128,1,191,252]),0,i))&&(a={type:"audio",info:{id:t,timescale:r.samplerate,duration:0,encrypted:!1,decryptdata:void 0},config:r})}break;case"ac3":case"ec3":{let i;(i=y.getAudioConfig(e,new Uint8Array([11,119,69,17,128,64,47,132]),0))&&(a={type:"audio",info:{id:t,timescale:i.samplerate,duration:0,encrypted:!1,decryptdata:void 0},config:i})}}return a}static getSample(e,t){let i;switch(e){case"mp4a.40.2":case"mp4a.40.5":i=1===t?new Uint8Array([0,208,0,7]):new Uint8Array([33,0,3,64,104,28]);break;case"ac-3":case"ec-3":i=new Uint8Array([11,119,69,17,128,64,47,132,41,3,253,214,124,253,243,215,233,95,185,123,78,20,40,106,97,190,74,253,43,218,208,140,191,176,144,120,214,181,44,124,129,251,91,109,187,109,198,225,43,172,116,140,176,123,38,144,211,247,225,64,29,53,175,96,16,57,121,87,78,203,81,37,7,72,228,132,37,169,38,231,97,229,247,194,208,8,12,83,74,139,137,17,22,26,221,203,107,113,94,93,75,33,208,247,146,105,39,143,6,36,1,227,108,70,11,180,152,218,182,218,209,59,85,104,201,70,37,82,219,68,55,225,144,99,149,0,119,26,14,69,164,241,204,222,81,177,142,80,20,100,97,143,101,221,140,113,31,208,124,25,64,29,49,77,140,30,155,74,214,204,138,229,109,172,95,130,70,230,134,88,59,179,212,155,232,0,0,0,0,0,173,234])}return i}static getSegment(e,t,i,s){let a=E.getSample(e.config.codec,e.config.channelCount);if(!a)return;let r=[],n={id:e.info.id,sequenceNumber:t,type:"audio",encrypted:!1,samples:r,defaultPerSampleIVSize:0},o=_.a[e.config.segmentCodec],l=Math.ceil(s*e.info.timescale/o),d=0,h=l*a.byteLength+8,c=new Uint8Array(h);c[0]=h>>24&255,c[1]=h>>16&255,c[2]=h>>8&255,c[3]=255&h,b.a.types||b.a.init(),c.set(b.a.types.mdat,4),d+=8;for(var u=0;u<l;u++)r.push({duration:o,size:a.byteLength,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0,paddingValue:0}}),c.set(a,d),d+=a.byteLength;let f=b.a.moof(i,n),g=new Uint8Array(f.byteLength+c.byteLength);return g.set(f),g.set(c,f.byteLength),g}}var R=E;i(6);const D={bin2str:e=>String.fromCharCode.apply(null,e),readUint16(e,t){const i=e[t]<<8|e[t+1];return i<0?65536+i:i},readSint32:(e,t)=>e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],readUint32(e,t){const i=D.readSint32(e,t);return i<0?4294967296+i:i},writeUint32(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i},findBox(e,t){let i,s,a,r,n,o=[];if(!t.length)return[];for(i=0;i<e.byteLength;)s=D.readUint32(e,i),a=D.bin2str(e.subarray(i+4,i+8)),r=s>1?i+s:e.byteLength,a===t[0]&&(1===t.length?o.push(e.subarray(i+8,r)):(n=D.findBox(e.subarray(i+8,r),t.slice(1))).length&&(o=o.concat(n))),i=r;return o},findBoxWithOffset(e,t,i,s){let a,r,n,o,l,d=[];if(!i.length)return[];for(a=0;a<e.byteLength;)r=D.readUint32(e,a),n=D.bin2str(e.subarray(a+4,a+8)),o=r>1?a+r:e.byteLength,n===i[0]&&(s&&s.push({offset:a+t,type:n,size:r}),1===i.length?d.push({offset:a+t,type:n,data:e.subarray(a+8,o),boxSize:r,walkedPath:s?s.slice(0):void 0}):(l=D.findBoxWithOffset(e.subarray(a+8,o),a+t+8,i.slice(1),s?s.slice(0):void 0)).length&&(d=d.concat(l),s=s?s.slice(0,-1):void 0)),a=o;return d}};class L extends g{constructor(e,t){super(e,t)}static _isCommonEncryptionInternal(e){return Boolean(e&&!("NONE"===e||"AES-128"===e))}static remuxInitSegment(e,t,i){if(!t)return e;let s=e;if(L._isCommonEncryptionInternal(t.method)){let a=t.keyId,n=!1,o=[];D.findBoxWithOffset(e,0,["moov","trak"]).forEach(s=>{let l,d,h=s.data,c=0,u=D.findBoxWithOffset(h,0,["mdia","minf","stbl","stsd"],[])[0],f=u.data.subarray(8),g=null,m=D.findBoxWithOffset(f,u.offset+16,["enca"])[0];m?(g=m.data.subarray(28),d="audio",c=u.offset+16+8+28):(m=D.findBoxWithOffset(f,u.offset+16,["encv"])[0])&&(g=m.data.subarray(78),d="video",c=u.offset+16+8+78),g&&D.findBoxWithOffset(g,c,["sinf"]).forEach(e=>{let s=e.data,o=D.findBox(s,["frma"])[0],c=D.findBox(s,["schm"])[0];if(!o)return void r.b.error("missing frma box")();if(!c)return void r.b.error("missing schm box")();let f=D.bin2str(c.subarray(4,8));if("aac "===D.bin2str(o.subarray(0,4))&&(b.a.types||b.a.init(),r.b.info("found frma with type 'aac ', patching to 'mp4a'")(),o.set(b.a.types.mp4a,0)),"cbcs"===f||"cenc"===f){i&&i.push(s);let e=D.findBox(s,["schi","tenc"])[0];if(e){const i=8;e.subarray(i,i+16).find((function(e){return 0!==e})),e.set(a,i);let s=e[6],r=e[7];if(1===s&&0===r){let i=e[24];i>0&&t.iv&&i===t.iv.length&&e.set(t.iv,25)}}}else if("cbc2"===f){n=!0,b.a.types||b.a.init();let i=D.findBoxWithOffset(s,0,["frma"])[0],a=b.a.box(b.a.types.schi,b.a.tenc(t,d)),r=b.a.box(b.a.types.sinf,s.subarray(i.offset,i.boxSize),b.a.schm(),a),o=(l=b.a.box(b.a.types.trak,h.subarray(0,e.offset),r,h.subarray(e.offset+e.boxSize))).subarray(8),c=r.byteLength-e.boxSize;u.walkedPath&&(u.walkedPath.push({type:"stsd",offset:m.offset,size:m.boxSize}),u.walkedPath.forEach(e=>{D.writeUint32(o,e.offset,e.size+c)}))}});let p=D.findBoxWithOffset(h,0,["edts"])[0];p&&(b.a.types||b.a.init(),h.set(b.a.types.free,p.offset+4)),l||(l=e.subarray(s.offset,s.offset+s.boxSize)),o.push(l)}),n&&(s=L.remuxCbc2InitSegment(e,o)||e)}return s}static remuxCbc2InitSegment(e,t){let i=D.findBoxWithOffset(e,0,["ftyp"])[0];if(!i)return void r.b.error("no ftyp found")();let s=D.findBoxWithOffset(e,i.boxSize,["moov"])[0],a=[],n=0;for(;n<s.data.byteLength;){let e=D.readUint32(s.data,n),i=D.bin2str(s.data.subarray(n+4,n+8)),r=e>1?n+e:s.data.byteLength;switch(i){case"trak":t&&(a=a.concat(t),t=void 0);break;default:a.push(s.data.subarray(n,r))}n=r}let o=b.a.box(b.a.types.moov,...a),l=new Uint8Array(i.boxSize+o.byteLength);return l.set(e.subarray(0,i.boxSize)),l.set(o,i.boxSize),l}static remuxOverflowSegment(e){b.a.types||b.a.init();let t,i=D.findBoxWithOffset(e,0,["moof","traf","tfdt"],[]),s=e.byteLength;if(i.forEach(e=>{0===e.data[0]&&(s+=4)}),s>e.byteLength){t=new Uint8Array(s);let i=0,a=0;for(;a<e.byteLength;){let s=D.readUint32(e,a),r=D.bin2str(e.subarray(a+4,a+8)),n=s>1?a+s:e.byteLength;if("moof"===r){let s=L.remuxOverflowMoof(e.subarray(a+8,n));t.set(s,i),i+=s.byteLength}else t.set(e.subarray(a,n),i),i+=s;a=n}}else r.b.warn("no increase in size")();return t||e}static remuxOverflowMoof(e){let t=0,i=[];for(;t<e.byteLength;){let s=D.readUint32(e,t);if("traf"===D.bin2str(e.subarray(t+4,t+8))){let a=L.remuxOverflowTraf(e.subarray(t+8,t+s));i.push(a)}else i.push(e.subarray(t,t+s));t=s>1?t+s:e.byteLength}let s=b.a.box(b.a.types.moof,...i),a=s.byteLength-e.byteLength-8;return D.findBoxWithOffset(s,0,["moof","traf","trun"],[]).forEach(e=>{if(0!=(1&e.data[3])){let t=D.readUint32(e.data,8);D.writeUint32(e.data,8,t+a)}}),s}static remuxOverflowTraf(e){let t=0,i=[];for(;t<e.byteLength;){let s=D.readUint32(e,t);if("tfdt"===D.bin2str(e.subarray(t+4,t+8))&&0===e[t+8]){let s=D.readUint32(e,t+12),a=b.a.box(b.a.types.tfdt,new Uint8Array([1,0,0,0,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s]));i.push(a)}else i.push(e.subarray(t,t+s));t=s>1?t+s:e.byteLength}return b.a.box(b.a.types.traf,...i)}remuxText(e){e.captionSamples.sort((function(e,t){return e.pts-t.pts})),e.captionSamples.length&&this.observer.trigger(s.a.FRAG_PARSING_CAPTIONDATA,{samples:e.captionSamples}),e.captionSamples=[]}remuxIFrame(e,t,i,a,r){if(!i.samples||!i.samples.length||!i.samples[0].data)return;var n=this.observer;let o,l="",d=b.a.moof(e*i.timescale,i),h=new Uint8Array(d.byteLength+i.samples[0].data.byteLength+8);h.set(d),D.writeUint32(h,d.byteLength,i.samples[0].data.byteLength+8),h.set(b.a.types.mdat,d.byteLength+4),h.set(i.samples[0].data,d.byteLength+8),i.sequenceNumber++,a&&(l+="audio",a.sequenceNumber=i.sequenceNumber,i.sequenceNumber++,o=R.getSegment(a,a.sequenceNumber,e*a.info.timescale,r)),l+="video",n.trigger(s.a.FRAG_PARSING_DATA,{data1:h,data2:o,startPTS:e,startDTS:e,type:l,nb:1,dropped:0,decryptdata:i.encrypted?t:void 0}),n.trigger(s.a.FRAG_PARSED)}remuxRawData(e,t,i,a,r){var n=this.observer,o="";e&&(o+="audio"),t&&(o+="video"),n.trigger(s.a.FRAG_PARSING_DATA,{data1:r,startPTS:a,startDTS:a,type:o,nb:1,dropped:0}),i&&i.captionSamples.length&&this.remuxText(i),n.trigger(s.a.FRAG_PARSED)}}var I=L;const A=Math.pow(2,32)-1,k=Math.pow(2,20)-1,C=1e6;class w extends u{constructor(e,t,i,s){super(e,t,i,{}),this.mp4Remuxer=t,this.audioPrimingDelay=i.audioPrimingDelay,this.audioPrimingDelay}resetTimeStamp(e){isNaN(e)?this.initPtsTs=void 0:this.initData.audio&&!this.initData.video?(this.initPtsTs={baseTime:Math.round(e*this.initData.audio.timescale/9e4),timescale:this.initData.audio.timescale},r.b.info(`resetting audio track initPTS: ${this.initPtsTs.baseTime}/${this.initPtsTs.timescale}, seconds: ${this.initPtsTs.baseTime/this.initPtsTs.timescale}`)()):this.initPtsTs={baseTime:e,timescale:9e4}}static isHEVCFlavor(e){if(!e)return!1;let t=e.indexOf("."),i=t<0?e:e.substring(0,t);return"hvc1"===i||"hev1"===i||"chvc"===i||"qhvc"===i||"qhev"===i||"muxa"===i||"dvh1"===i||"dvhe"===i||"cdh1"===i||"qdh1"===i||"qdhe"===i}resetInitSegment(e,t,i,a,n,o){if(this._silentAudioTrack=void 0,e&&e.byteLength){let t=I.remuxInitSegment(e,n);const i=this.initData=w.parseInitSegment(t);let l={tracks:{},discontinuity:!!o},d=l.tracks;i.foundLargeTimescale&&r.b.warn("large timescale found, will check for 32 bit tfdts")();const h=i.audioCodec,c=i.videoCodec;if(i.audio&&i.video?d.audiovideo={container:"video/mp4",codec:h+","+c,initSegment:t}:(i.audio&&h&&(d.audio={container:"audio/mp4",codec:h,initSegment:t}),i.video&&c&&(d.video={container:"video/mp4",codec:c,initSegment:t})),i.video){const t=i.video,s=e.subarray(t.trakOffset,t.trakOffset+t.trakSize);this._videoTrack=Object.assign(Object.assign({},t),{info:{id:t.id,timescale:t.timescale,duration:a},trakData:s,sequenceNumber:0,len:0,samples:[]}),i.audio&&h&&(this._audioTrack={id:i.audio.id,codec:h})}i.caption&&(this._captionTrack=Object.assign(Object.assign({},i.caption),{sequenceNumber:0,len:0,captionSamples:[]})),this.observer.trigger(s.a.FRAG_PARSING_INIT_SEGMENT,l)}else t&&(this.audioCodec=t),i&&(this.videoCodec=i)}static probe(e){return D.findBox(e.subarray(0,Math.min(e.length,16384)),["moof"]).length>0}static parseHvcC(e){let t;if(e){let i=e[0];if(1===i){let i=e[1];t={profileSpace:i>>6,tierFlag:(32&i)>>5?"H":"L",profileIDC:31&i,profileCompat:D.readUint32(e,2),constraintIndicator:e.subarray(6,12),levelIDC:e[12]}}else r.b.warn(`Unhandled version ${i} in hvcC box`)()}else r.b.warn("No hvcC box")();return t}static hvcCToCodecString(e,t){let i=e+"."+(t.profileSpace?String.fromCharCode(t.profileSpace+"A"-1):"")+t.profileIDC+"."+t.profileCompat.toString(16).toUpperCase()+"."+t.tierFlag.toString()+t.levelIDC,s="";for(let e=t.constraintIndicator.length-1;e>=0;--e){let i=t.constraintIndicator[e];if(0!==i||""!==s){let e=i.toString(16).toUpperCase();s="."+(""===s?e:e+s)}}return i+s}static parseDvcC(e){let t;return e?t={versionMajor:e[0],versionMinor:e[1],profile:e[2]>>1&127,level:e[2]<<5&32|e[3]>>3&31}:r.b.warn("No dvcC box")(),t}static dvcCToCodecString(e,t){return e+"."+(t.profile<10?"0"+t.profile.toString():t.profile.toString())+"."+(t.level<10?"0"+t.level.toString():t.level.toString())}static parseInitSegment(e){let t={foundLargeTimescale:!1,tracksById:{}};return D.findBoxWithOffset(e,0,["moov","trak"]).forEach(e=>{let i=e.data;const s=D.findBox(i,["tkhd"])[0];if(s){let a=s[0],r=0===a?12:20,n=D.readUint32(s,r);const o=D.findBox(i,["mdia","mdhd"])[0];if(o){let s=0===(a=o[0])?12:20;const r=D.readUint32(o,s);s+=4,r>=C&&(t.foundLargeTimescale=!0);let l=0===a?D.readUint32(o,s):0;const d=D.findBox(i,["mdia","hdlr"])[0];if(d){const s=D.bin2str(d.subarray(8,12));let a={soun:"audio",vide:"video",clcp:"caption"}[s]||s;if(a){let s,o=D.findBox(i,["mdia","minf","stbl","stsd"]);if(o.length){let i=o[0];s=D.bin2str(i.subarray(12,16));const d=w.parseStsd(i);let h;if("caption"===a){let e=Object.assign({id:n,type:a,timescale:r,duration:l,isTimingTrack:!1,sequenceNumber:0,len:0,captionSamples:[]},d);t.caption=e,h=e}else{let i=Object.assign({id:n,type:a,timescale:r,duration:l,isTimingTrack:!0,trakOffset:e.offset,trakSize:e.boxSize,sequenceNumber:0,len:0,samples:[]},d);"video"===a?(t.video=i,t.videoCodec=i.codec):(t.audio=i,t.audioCodec=i.codec),h=i}t.tracksById[n]=h}}}}}}),t}static parseStsd(e){let t,i,s;const a=e.subarray(8);let r,n=D.bin2str(a.subarray(4,8)),o=null,l=null;"enca"===n?l=(o=D.findBox(a,["enca"])[0]).subarray(28):"encv"===n&&(l=(o=D.findBox(a,["encv"])[0]).subarray(78)),t=!!l,i=0,l&&D.findBox(l,["sinf"]).forEach(e=>{let t=D.findBox(e,["schm"])[0];if(t){let s=D.bin2str(t.subarray(4,8));if("cbcs"===s||"cenc"===s){let t=D.findBox(e,["frma"])[0];t&&(n=D.bin2str(t));let s=D.findBox(e,["schi","tenc"])[0];s&&(i=s[7])}}});let d=a.subarray(86);switch(n){case"mp4a":s="mp4a.40.5";break;case"ac-3":case"ec-3":s=n;break;case"avc1":case"avc3":s=n+".640028";break;case"hvc1":case"hev1":let e=D.findBox(d,["hvcC"])[0];s=(r=w.parseHvcC(e))?w.hvcCToCodecString(n,r):n+".2.4.H150.B0";break;case"dvh1":case"dvhe":let t=D.findBox(d,["dvcC"])[0];s=(r=w.parseDvcC(t))?w.dvcCToCodecString(n,r):n+".05.01";break;case"c608":default:s=n}return{codec:s,encrypted:t,defaultPerSampleIVSize:i}}static has32BitTfdts(e){let t=!1;return D.findBox(e,["moof","traf","tfdt"]).forEach(e=>{0===e[0]&&(t=!0)}),t}static getStartDtsTs(e,t){let i,s=D.findBox(t,["moof","traf"]),a=Number.MAX_SAFE_INTEGER;return s.map((function(t){return D.findBox(t,["tfhd"]).forEach(s=>{const n=D.readUint32(s,4),o=e.tracksById[n];let l,d;if(!o)return;if(!o.isTimingTrack)return 1/0;l=o.timescale||9e4;let h=D.findBox(t,["tfdt"]).map((function(e){var t,i;return t=e[0],i=D.readUint32(e,4),1===t&&(i>k&&r.b.warn(`Value larger than can be represented by float for upper 32 bits ${i}`)(),i*=Math.pow(2,32),i+=D.readUint32(e,8)),i}));d=h.length>0?h[0]:1/0,isFinite(d)&&d/l<a&&(a=d/l,i={baseTime:d,timescale:l})})})),i}static offsetStartDTS(e,t,i,s){D.findBox(t,["moof","traf"]).map((function(t){return D.findBox(t,["tfhd"]).map((function(a){const n=D.readUint32(a,4),o=e.tracksById[n];if(o){var l=o.timescale||9e4;D.findBox(t,["tfdt"]).map((function(e){var t=e[0];const a=o.type;if(0===t){let t=D.readUint32(e,4)-Math.round(i.baseTime*l/i.timescale);"video"===a&&t<0&&(r.b.warn(`video tdft would have gone negative by ${t/l} seconds`)(),t=0),t+=Math.round(s*l),t=Math.max(t,0),D.writeUint32(e,4,t)}else{let t=D.readUint32(e,4);t>k&&r.b.error(`baseMediaDecodeTime larger than can be represented by float for upper 32 bits ${t}`)();let n=t;n*=Math.pow(2,32),n+=D.readUint32(e,8),n-=Math.round(i.baseTime*l/i.timescale),"video"===a&&n<0&&(r.b.warn(`video tdft would have gone negative by ${n/l} seconds`)(),n=0),n+=Math.round(s*l),n=Math.max(n,0);const o=Math.floor(n/(A+1)),d=Math.floor(n%(A+1));D.writeUint32(e,4,o),D.writeUint32(e,8,d)}}))}}))}))}static writeStartDTS(e,t,i){D.findBox(t,["moof","traf"]).map((function(t){return D.findBox(t,["tfhd"]).map((function(s){let a=D.readUint32(s,4),n=e.tracksById[a];if(!n)return;let o=n.timescale||9e4,l=Math.round(i*o)/o;Math.abs(l-i)>.01&&r.b.warn(`[iframes] large rounding error when adjusting timestamps, startDTS: ${i}, roundedStartDTS: ${l}`)(),D.findBox(t,["tfdt"]).map((function(e){if(0===e[0])D.writeUint32(e,4,l*o);else{let t=l*o;t=Math.max(t,0);const i=Math.floor(t/(A+1)),s=Math.floor(t%(A+1));D.writeUint32(e,4,i),D.writeUint32(e,8,s)}}))}))}))}static parseSAIO(e){let t=0,i=0,s=e[0];i+=4,0!=(1&D.readUint32(e,0))&&(i+=8);let a=16777215&D.readUint32(e,i);return 1===a?(i+=4,t=D.readUint32(e,i),1===s&&(i+=4,t*=Math.pow(2,32),t+=D.readUint32(e,i))):r.b.error(`saio entry count error, count is: ${a}`)(),t}static parseSAIZ(e){let t=0,i=0;return i+=4,0!=(1&D.readUint32(e,0))&&(i+=8),t=e[i],i++,i+=4,0===t&&(t=e[i]),t}static parseSubsample(e,t){let i={subsamples:[]},s=0;for(e&&(i.iv=t.subarray(0,e),s+=e),s+=2;s+6<=t.byteLength;){let e=D.readUint16(t,s);s+=2;let a=D.readUint32(t,s);s+=4,i.subsamples.push([e,a])}return i}static isSEIMessage(e,t){return e?39===t||40===t:6===t}static parseSamples(e,t,i,s,a,n){let o,l=i.timescale,d=i.id,h=0,c=e,u=0,f=!1;D.findBoxWithOffset(t,0,["moof"]).map((function(e){var g=e.data,m=e.offset;D.findBox(g,["traf"]).map((function(e){let g=D.findBox(e,["tfdt"]).map((function(e){var t,i;return t=e[0],i=D.readUint32(e,4),1===t&&(i*=Math.pow(2,32),i+=D.readUint32(e,8)),i/l}))[0];return void 0!==g&&(c=g),D.findBox(e,["tfhd"]).map((function(g){let p=D.readUint32(g,4),y=16777215&D.readUint32(g,0),v=0,T=0!=(2&y),S=0,b=0!=(8&y),_=0,E=0!=(16&y),R=0,L=0!=(32&y),I=0,A=8;if(p===d){if(0!=(1&y)){v=D.readUint32(g,A),A+=4;let e=D.readUint32(g,A);A+=4,0!==e&&r.b.info("tfhd baseDataOffset has 64-bit value. Caption should be turned off")()}if(T&&(S=D.readUint32(g,A),A+=4),b&&(_=D.readUint32(g,A),A+=4),E&&(R=D.readUint32(g,A),A+=4),L&&(I=D.readUint32(g,A),A+=4),"video"===i.type){let s=0,a=0;D.findBox(e,["saio"]).map((function(e){s=w.parseSAIO(e)})),D.findBox(e,["saiz"]).map((function(e){a=w.parseSAIZ(e)})),s&&a&&(o=w.parseSubsample(i.defaultPerSampleIVSize,t.subarray(s,s+a))),f=w.isHEVCFlavor(i.codec)}D.findBox(e,["trun"]).map((function(e){let d=e[0],g=16777215&D.readUint32(e,0),p=0!=(1&g),y=0,v=0!=(4&g),T=0!=(256&g),S=0,b=0!=(512&g),E=0,L=0!=(1024&g),I=0!=(2048&g),A=0,k=D.readUint32(e,4),C=8;p&&(y=D.readUint32(e,C),C+=4),v&&(C+=4);let P=y+m;for(let g=0;g<k&&(u<n||a);g++){if(T?(S=D.readUint32(e,C),h+=S,C+=4):S=_,b?(E=D.readUint32(e,C),C+=4):E=R,L&&(C+=4),I&&(A=0===d?D.readUint32(e,C):D.readSint32(e,C),C+=4),"video"===i.type)if(a){let e=0,s=0;for(;e<E;){let a=D.readUint32(t,P),r=31&t[P+=4];if(i.seiSamples||(i.seiSamples=[]),w.isSEIMessage(f,r)){var M=t.subarray(P,P+a);i.seiSamples.push({pts:c+A/l,type:r,data:M,sampleOffset:P,naluSize:a})}P+=a,e+=a+4,s++}}else s&&i.samples.push({data:t.subarray(P,P+E),size:E,duration:s*l,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:2,isNonSync:0,paddingValue:0},subsamples:o?o.subsamples:[],iv:o?o.iv:void 0});else if("caption"===i.type){D.readUint32(t,P),P+=4;const e=D.bin2str(t.subarray(P,P+4));if(P+=4,"cdat"===e){let e=E-8;var O=t.subarray(P,P+e);let s=new Uint8Array(O);P+=e,i.captionSamples.push({type:3,pts:c,bytes:s})}else r.b.warn(`clcp track: unknown atom type ${e}`)()}u++,i.len++,c+=S/l}}))}}))}))}))}append(e,t,i,n,o,l,d){let h=this.initData;void 0===h&&(this.resetInitSegment(e,this.audioCodec,this.videoCodec,0),h=this.initData);let c,u=this.initPtsTs;if(u||(c=w.getStartDtsTs(h,e),this.initPtsTs=u={baseTime:c.baseTime-Math.round(t*c.timescale),timescale:c.timescale},r.b.info(`initPtsTs: ${u.baseTime}/${u.timescale}, sec: ${u.baseTime/u.timescale}, startDtsTs: ${c.baseTime}/${c.timescale} timeOffset: ${t}`)(),this.observer.trigger(s.a.INIT_PTS_FOUND,{initPTS90k:9e4*u.baseTime/u.timescale})),h.foundLargeTimescale&&w.has32BitTfdts(e)&&!d&&(e=I.remuxOverflowSegment(e)),d){let t=this._videoTrack.timescale;d=Math.ceil(d*t)/t,w.writeStartDTS(h,e,l)}else w.offsetStartDTS(h,e,u,this.audioPrimingDelay);if(c=w.getStartDtsTs(h,e),h.video&&h.video.encrypted&&!D.findBox(e,["moof","traf"]).find((function(e){return Boolean(D.findBox(e,["senc"])[0]||D.findBox(e,["saiz"])[0]&&D.findBox(e,["saio"])[0])}))&&(r.b.warn(`Missing subsample information for encrypted content codec=${h.videoCodec}`)(),h.videoCodec&&!_.b.isAVC(h.videoCodec)))this.observer.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"Missing subsample information for encrypted content"});else if(d){let t=(c.baseTime+this.audioPrimingDelay*c.timescale)/c.timescale;if(this._audioTrack&&!this._silentAudioTrack){let e=R.getTrack(this.observer,this._audioTrack.id,this._audioTrack.codec,2);if(!e)throw`unable to create silent audio track for codec ${this._audioTrack.codec}`;this._silentAudioTrack=Object.assign(Object.assign({},e),{sequenceNumber:0});let t=b.a.initSegment([this._videoTrack,this._silentAudioTrack]),i={audiovideo:{container:"video/mp4",codec:this._silentAudioTrack.config.codec+","+this._videoTrack.codec,initSegment:t}};this.observer.trigger(s.a.FRAG_PARSING_INIT_SEGMENT,{tracks:i})}w.parseSamples(t,e,this._videoTrack,d,!1,1),this.mp4Remuxer.remuxIFrame(t,o,this._videoTrack,this._silentAudioTrack,d),this._videoTrack.samples=[]}else{let t=(c.baseTime-this.audioPrimingDelay*c.timescale)/c.timescale;t=Math.max(0,t),this.trySEICaptions?(w.parseSamples(t,e,this._videoTrack,void 0,!0,Number.MAX_SAFE_INTEGER),w.extractSEICaptionsFromNALu(this._videoTrack.seiSamples,this._captionTrack),this._videoTrack.seiSamples=[]):this._captionTrack&&w.parseSamples(t,e,this._captionTrack,void 0,!1,Number.MAX_SAFE_INTEGER),this.mp4Remuxer.remuxRawData(!!h.audio,!!h.video,this._captionTrack,t,e)}}static extractSEICaptionsFromNALu(e,t){if(e){for(let c=0;c<e.length;++c){let u=e[c],f=u.pts,g=0;g++;for(var i=0,s=0,a=!1,r=0;!a&&g<u.data.length;){i=0;do{if(g>=u.data.length)break;i+=r=u.data[g++]}while(255===r);s=0;do{if(g>=u.data.length)break;s+=r=u.data[g++]}while(255===r);let e=u.data.length-g;if(4===i&&g<u.data.length){if(a=!0,181===u.data[g++]){var n=D.readUint16(u.data,g);if(g+=2,49===n){var o=D.readUint32(u.data,g);if(g+=4,1195456820===o&&3===u.data[g++]){var l=u.data[g++];g++;var d=31&l,h=[];if(64&l)for(let e=0;e<d;e++){let e=u.data[g++];if(e===(252&e)){let t=3&e;if(0===t||1===t){let e=u.data[g++],t=u.data[g++];h.push(e),h.push(t)}}else g+=2}h.length>0&&t.captionSamples.push({type:3,pts:f,bytes:h})}}}}else if(s<e)g+=s;else if(s>e)break}}return t}}}var P=w,M=class{constructor(e){this.data=e,this._bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}get bytesAvailable(){return this._bytesAvailable}loadWord(){var e=this.data,t=this._bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),a=Math.min(4,t);if(0===a)throw new Error("no bytes available");s.set(e.subarray(i,i+a)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=8*a,this._bytesAvailable-=a}skipBits(e){var t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,e-=(t=e>>3)>>3,this._bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){var t=Math.min(this.bitsAvailable,e),i=this.word>>>32-t;return e>32&&r.b.error("Cannot read more than 32 bits at a time")(),this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this._bytesAvailable>0&&this.loadWord(),(t=e-t)>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var e=this.skipLZ();return this.readBits(e+1)-1}readEG(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){var t,i=8,s=8;for(t=0;t<e;t++)0!==s&&(s=(i+this.readEG()+256)%256),i=0===s?i:s}readSPS(){var e,t,i,s,a,r,n,o=0,l=0,d=0,h=0,c=this.readUByte.bind(this),u=this.readBits.bind(this),f=this.readUEG.bind(this),g=this.readBoolean.bind(this),m=this.skipBits.bind(this),p=this.skipEG.bind(this),y=this.skipUEG.bind(this),v=this.skipScalingList.bind(this);if(c(),e=c(),u(5),m(3),c(),y(),100===e||110===e||122===e||244===e||44===e||83===e||86===e||118===e||128===e){var T=f();if(3===T&&m(1),y(),y(),m(1),g())for(r=3!==T?8:12,n=0;n<r;n++)g()&&v(n<6?16:64)}y();var S=f();if(0===S)f();else if(1===S)for(m(1),p(),p(),t=f(),n=0;n<t;n++)p();y(),m(1),i=f(),s=f(),0===(a=u(1))&&m(1),m(1),g()&&(o=f(),l=f(),d=f(),h=f());let b=[1,1];if(g()&&g())switch(c()){case 1:b=[1,1];break;case 2:b=[12,11];break;case 3:b=[10,11];break;case 4:b=[16,11];break;case 5:b=[40,33];break;case 6:b=[24,11];break;case 7:b=[20,11];break;case 8:b=[32,11];break;case 9:b=[80,33];break;case 10:b=[18,11];break;case 11:b=[15,11];break;case 12:b=[64,33];break;case 13:b=[160,99];break;case 14:b=[4,3];break;case 15:b=[3,2];break;case 16:b=[2,1];break;case 255:b=[c()<<8|c(),c()<<8|c()]}return{width:Math.ceil(16*(i+1)-2*o-2*l),height:(2-a)*(s+1)*16-(a?2:4)*(d+h),pixelRatio:b}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}},O=class{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}},N=class extends g{constructor(e,t,i,s){super(e,t),this.typeSupported=i;const a=navigator.userAgent;this.isSafari=s&&s.indexOf("Apple")>-1&&a&&!a.match("CriOS"),this.ISGenerated=!1}resetTimeStamp(e){this._initPTS=this._initDTS=e}resetInitSegment(){this.ISGenerated=!1,this._silentAudioTrack=void 0}remuxEsTracks(e,t,i,a,n,o,l,d,h,c){let u,f=void 0===h?n:h;if(!this.ISGenerated){if(e&&e.config.codec&&(this._audioTrackInfo={id:e.info.id,codec:e.config.codec,channelCount:e.config.channelCount}),t&&c&&this._audioTrackInfo){let e=R.getTrack(this.observer,this._audioTrackInfo.id,this._audioTrackInfo.codec,this._audioTrackInfo.channelCount);e&&(this._silentAudioTrack=Object.assign(Object.assign({},e),{info:Object.assign(Object.assign({},e.info),{inputTimescale:9e4}),parsingData:{len:0,sequenceNumber:0,esSamples:[]}}),u=R.getSegment(this._silentAudioTrack,t.parsingData.sequenceNumber,f*this._silentAudioTrack.info.timescale,c))}else this._silentAudioTrack=void 0;this.updateInitPTSDTS(t,e,n),this.generateIS(this._silentAudioTrack?this._silentAudioTrack:e,t)}if(this.ISGenerated)if(t&&c&&this._silentAudioTrack&&!u&&(u=R.getSegment(this._silentAudioTrack,t.parsingData.sequenceNumber,Math.round((f+this.config.audioPrimingDelay)*this._silentAudioTrack.info.timescale),c)),e&&e.parsingData.esSamples.length){isNaN(e.info.timescale)&&(r.b.warn("regenerate InitSegment as audio detected")(),this.updateInitPTSDTS(t,e,n),this.generateIS(e,t));let i=this.remuxAudio(e,f,o,l,d);if(t&&t.parsingData.esSamples.length){let s;i&&(s=i.endPTS-i.startPTS),isNaN(t.info.timescale)&&(r.b.warn("regenerate InitSegment as video detected")(),this.updateInitPTSDTS(t,e,n),this.generateIS(e,t)),this.remuxVideo(t,f,o,s,c)}}else{let i;t&&t.parsingData.esSamples.length&&(i=this.remuxVideo(t,f,o,void 0,c)),i&&e&&e.config.codec&&this.remuxEmptyAudio(e,f,o,l,i,d)}else r.b.error("failed to generate IS")();u&&this.observer.trigger(s.a.FRAG_PARSING_DATA,{data1:u,startPTS:f,startDTS:f,type:"audio",nb:1,dropped:0,decryptdata:void 0}),i&&i.id3Samples.length&&this.remuxID3(i,f),a&&a.captionSamples.length&&this.remuxText(a,f),this.observer.trigger(s.a.FRAG_PARSED)}updateInitPTSDTS(e,t,i){let r=1/0,n=1/0,o=e?e.parsingData.esSamples:[],l=t?t.parsingData.esSamples:[];if(isNaN(this._initPTS)){if(t&&l.length&&(r=n=l[0].pts-t.info.inputTimescale*i),e&&o.length){const t=e.info.inputTimescale;e.info.timescale=t,r=Math.min(r,o[0].pts-t*i),n=Math.min(n,o[0].dts-t*i),this.observer.trigger(s.a.INIT_PTS_FOUND,{initPTS90k:r})}isNaN(r)||isNaN(n)?this.observer.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!1,reason:"invalid initPTS or initDTS"}):(this._initPTS=r,this._initDTS=n)}}generateIS(e,t){var i=this.observer,r=(e&&e.parsingData.esSamples,t?t.parsingData.esSamples:[]),n=this.typeSupported,o="audio/mp4",l={tracks:{},discontinuity:!1},d=l.tracks;if(e){switch(e.info.timescale=e.config.samplerate,e.config.segmentCodec){case"mp3":n.mpeg?(o="audio/mpeg",e.config.codec=""):n.mp3&&(e.config.codec="mp3")}const t="mp3"===e.config.segmentCodec&&n.mpeg?new Uint8Array:b.a.initSegment([e]);d.audio={container:o,codec:e.config.codec,initSegment:t,metadata:{channelCount:e.config.channelCount}}}if(t&&r.length){const e=t.info.inputTimescale;t.info.timescale=e;const i=b.a.initSegment([t]);d.video={container:"video/mp4",codec:t.config.codec,initSegment:i,metadata:{width:t.config.width,height:t.config.height}}}Object.keys(d).length?(i.trigger(s.a.FRAG_PARSING_INIT_SEGMENT,l),this.ISGenerated=!0):i.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!1,reason:"no audio/video samples found"})}remuxVideo(e,t,i,n,o){var l,d,h,c,u,f,g,m=8,p=e.info.inputTimescale,y=e.parsingData.esSamples,v=[],T=y.length,S=this._PTSNormalize,_=this._initDTS,E=e.info.encrypted;let R;R=i?this.nextAvcDts:t*p,y.forEach((function(e){e.pts=S(e.pts-_,R),e.dts=S(e.dts-_,R)})),y.sort((function(e,t){const i=e.dts-t.dts,s=e.pts-t.pts;return i||s||e.id-t.id}));let D=y.reduce((e,t)=>Math.max(Math.min(e,t.pts-t.dts),-18e3),0);if(D<0){r.b.warn(`PTS < DTS detected in video samples, shifting DTS by ${Math.round(D/90)} ms to overcome this issue`)();for(let e=0;e<y.length;e++)y[e].dts+=D}let L=y[0];u=Math.max(L.dts,0),c=Math.max(L.pts,0),isNaN(o)||(u=t*p,c=t*p);let I=Math.round((u-R)/90);i&&I&&(u=R,y[0].dts=u,c=Math.max(c-I,R),y[0].pts=c,r.b.info(`Video/PTS/DTS adjusted: ${Math.round(c/90)}/${Math.round(u/90)},delta:${I} ms`)()),L=y[y.length-1],g=Math.max(L.dts,0),f=Math.max(L.pts,0,g),isNaN(o)||(g=t*p,f=t*p);const A=this.isSafari;A&&(l=Math.round((g-u)/(y.length-1)));let k=0,C=0;for(let e=0;e<T;e++){let t=y[e],i=t.units,s=i.length,a=0;for(let e=0;e<s;e++)a+=i[e].data.length;C+=a,k+=s,t.length=a,t.dts=A?u+e*l:Math.max(t.dts,u),t.pts=Math.max(t.pts,t.dts)}let w=C+4*k+8;try{d=new Uint8Array(w)}catch(e){return void this.observer.trigger(s.a.ERROR,{type:a.c.MUX_ERROR,details:a.a.REMUX_ALLOC_ERROR,fatal:!1,bytes:w,reason:`fail allocating video mdat ${w}`,response:a.b.InternalError})}let P=new DataView(d.buffer);P.setUint32(0,w),d.set(b.a.types.mdat,4);for(let e=0;e<T;e++){let t,i=y[e],s=i.units,a=0,r=[],h=0;for(let e=0,t=s.length;e<t;e++){let t=s[e],i=t.data,n=t.data.byteLength;if(P.setUint32(m,n),m+=4,d.set(i,m),m+=n,a+=4+n,E)if(n<=48||1!==t.type&&5!==t.type)h+=4+n;else{let e=n-32;e%16==0&&(e-=16),r.push([h+36,e]),h=n-32-e}}if(h>0&&r.push([h,0]),A)t=Math.max(0,l*Math.round((i.pts-i.dts)/l));else{if(e<T-1)l=y[e+1].dts-i.dts;else{let t=this.config,s=i.dts-y[e>0?e-1:e].dts;if(t.stretchShortVideoTrack){let e=t.maxBufferHole,a=t.maxSeekHole,r=Math.floor(Math.min(e,a)*p),o=(n?c+n*p:this.nextAudioPts)-i.pts;o>r?(l=o-s)<0&&(l=s):l=s}else l=s}t=Math.round(i.pts-i.dts)}isNaN(o)||(t=0,l=o*p),v.push({size:a,duration:l,cts:t,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:i.key?2:1,isNonSync:i.key?0:1,paddingValue:0},decryptdata:i.decryptdata,subsamples:r})}this.nextAvcDts=g+l;let M=e.parsingData.dropped;if(e.parsingData.dropped=0,v.length&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){let e=v[0].flags;e.dependsOn=2,e.isNonSync=0}let O={sequenceNumber:e.parsingData.sequenceNumber++,id:e.info.id,type:e.type,encrypted:e.info.encrypted,samples:v,defaultPerSampleIVSize:0};h=b.a.moof(u+this.config.audioPrimingDelay*p,O),e.parsingData.esSamples=[];let N=new Uint8Array(h.byteLength+d.byteLength);N.set(h),N.set(d,h.byteLength);let x={data1:N,startPTS:c/p,endPTS:(f+l)/p,startDTS:u/p,endDTS:this.nextAvcDts/p,type:"video",nb:v.length,dropped:M};return this.observer.trigger(s.a.FRAG_PARSING_DATA,x),x}remuxAudio(e,t,i,n,o){const l=e.info.inputTimescale,h=l/e.info.timescale,c=("aac"===e.config.segmentCodec?1024:"mp3"===e.config.segmentCodec?1152:1536)*h,u=this._PTSNormalize,f=this._initDTS,g="mp3"===e.config.segmentCodec&&this.typeSupported.mpeg,m=e.info.encrypted;var p,y,v,T,S,_,E,R,D,L,I,A,k,C=g?0:8,w=[],P=[];let M=new d;if(P=e.parsingData.esSamples,k=this.nextAudioPts,(i=i||P.length&&k&&(n&&Math.abs(t-k/l)<.1||Math.abs(P[0].pts-k-f)<20*c))||(k=t*l),P.forEach((function(e){e.pts=e.dts=u(e.pts-f,k)})),P.sort((function(e,t){return e.pts-t.pts})),n&&"aac"===e.config.segmentCodec)for(let t=0,i=k;t<P.length;){var N,x=P[t];N=(D=x.pts)-i;const s=Math.abs(1e3*N/l);if(N<=-c)r.b.warn(`Dropping 1 audio frame @ ${(i/l).toFixed(3)}s due to ${s} ms overlap.`)(),P.splice(t,1),e.parsingData.len-=x.unit.length;else if(N>=c&&s<1e4&&i){var F=Math.round(N/c);r.b.warn(`Injecting ${F} audio frame @ ${(i/l).toFixed(3)}s due to ${Math.round(1e3*N/l)} ms gap.`)();for(var B=0;B<F;B++)A=Math.max(i,0),(I=O.getSilentFrame(e.config.codec,e.config.channelCount))||(r.b.warn("Unable to get silent frame for given audio codec; duplicating last frame instead.")(),I=x.unit.subarray(0)),P.splice(t,0,{unit:I,pts:A,dts:A,decryptdata:o}),e.parsingData.len+=I.length,i+=c,t+=1;x.pts=x.dts=i,i+=c,t+=1}else Math.abs(N),i+=c,x.pts=x.dts=0===t?k:P[t-1].pts+c,t+=1}for(let t=0,n=P.length;t<n;t++){if(v=(p=P[t]).unit,D=p.pts,L=p.dts,void 0!==R)y.duration=Math.round((L-R)/h);else{let t=Math.round(1e3*(D-k)/l),n=0;if(i&&"aac"===e.config.segmentCodec&&t){if(t>0&&t<1e4)(n=Math.round((D-k)/c))>0&&((I=O.getSilentFrame(e.config.codec,e.config.channelCount))||(I=v.subarray(0)),e.parsingData.len+=n*I.length);else if(t<-12){e.parsingData.len-=v.byteLength;continue}D=L=k}if(_=Math.max(0,D),E=Math.max(0,L),!(e.parsingData.len>0))return;{let t=g?e.parsingData.len:e.parsingData.len+8;try{T=new Uint8Array(t)}catch(e){return void this.observer.trigger(s.a.ERROR,{type:a.c.MUX_ERROR,details:a.a.REMUX_ALLOC_ERROR,fatal:!1,bytes:t,reason:`fail allocating audio mdat ${t}`,response:a.b.InternalError})}g||(new DataView(T.buffer).setUint32(0,t),T.set(b.a.types.mdat,4))}for(let t=0;t<n;t++)A=D-(n-t)*c,(I=O.getSilentFrame(e.config.codec,e.config.channelCount))||(r.b.warn("Unable to get silent frame for given audio codec; duplicating this frame instead.")(),I=v.subarray(0)),T.set(I,C),C+=I.byteLength,y={size:I.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},decryptdata:p.decryptdata,subsamples:m?[[I.byteLength,0]]:[]},w.push(y)}T.set(v,C);let n=v.byteLength;C+=n;let o=[];if(m)if("ec3"===e.config.segmentCodec){let e=0;for(;e<v.byteLength;){let t=2*(M.bsReadAndUpdate(v,{byteOffset:e+2,usedBits:5},11)+1);e+=t;let i=Math.min(t,16);o.push([i,t-i])}}else{let e=Math.min(n,16);o.push([e,n-e])}y={size:n,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},decryptdata:p.decryptdata,subsamples:o},w.push(y),R=L}var U=0,V=w.length;if(V>=2&&(U=w[V-2].duration,y.duration=U),V){if(this.nextAudioPts=D+h*U,e.parsingData.len=0,g)S=new Uint8Array;else{let t={sequenceNumber:e.parsingData.sequenceNumber++,id:e.info.id,type:e.type,encrypted:e.info.encrypted,samples:w,defaultPerSampleIVSize:0};S=b.a.moof((E+this.config.audioPrimingDelay*l)/h,t)}let t=new Uint8Array(S.byteLength+T.byteLength);t.set(S),t.set(T,S.byteLength),e.parsingData.esSamples=[];let i={data1:t,startPTS:_/l,endPTS:this.nextAudioPts/l,startDTS:E/l,endDTS:(L+h*U)/l,type:"audio",nb:V};return this.observer.trigger(s.a.FRAG_PARSING_DATA,i),i}return null}remuxEmptyAudio(e,t,i,s,a,n){let o=e.info.inputTimescale,l=o/(e.config.samplerate?e.config.samplerate:o),d=this.nextAudioPts,h=(void 0!==d?d:a.startDTS*o)+this._initDTS,c=a.endDTS*o+this._initDTS,u=1024*l,f=Math.ceil((c-h)/u),g=O.getSilentFrame(e.config.codec,e.config.channelCount);if(r.b.warn("remux empty Audio")(),!g)return void r.b.error("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!")();let m=[];for(var p=0;p<f;p++){var y=h+p*u;m.push({unit:g,pts:y,dts:y,decryptdata:n}),e.parsingData.len+=g.length}e.parsingData.esSamples=m,this.remuxAudio(e,t,i,s,n)}remuxID3(e,t){var i,a=e.id3Samples.length;const r=e.inputTimescale,n=this._initPTS,o=this._initDTS;if(a){for(var l=0;l<a;l++)(i=e.id3Samples[l]).pts=(i.pts-n)/r,i.dts=(i.dts-o)/r;this.observer.trigger(s.a.FRAG_PARSING_METADATA,{samples:e.id3Samples})}e.id3Samples=[]}remuxText(e,t){e.captionSamples.sort((function(e,t){return e.pts-t.pts}));var i,a=e.captionSamples.length;const r=e.inputTimescale,n=this._initPTS;if(a){for(var o=0;o<a;o++)(i=e.captionSamples[o]).pts=(i.pts-n)/r;this.observer.trigger(s.a.FRAG_PARSING_USERDATA,{samples:e.captionSamples})}e.captionSamples=[]}_PTSNormalize(e,t){var i;if(void 0===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}};t.a=class{constructor(e,t,i,s){this.observer=e,this.typeSupported=t,this.config=i,this.vendor=s}destroy(){var e=this.demuxer;e&&e.destroy()}push(e,t,i,n,o,u,g,m,p,T,b,_,E,R){var D=this.demuxer;i=new Uint8Array(i);const L=new Uint8Array(e);if(!D||(g||m)&&!this.probeFn(L)){const{observer:e,typeSupported:t,config:i}=this,n=[{demux:class extends f{constructor(e,t,i,s){super(e,t,i,s)}static probe(e){return e.length>=564&&71===e[0]&&71===e[188]&&71===e[376]}resetInitSegment(e,t,i,s,a){this.pmtParsed=!1,this._pmtId=-1;const r={id:-1,inputTimescale:9e4,timescale:NaN,duration:0,encrypted:a&&a.isEncrypted,decryptdata:a},n={len:0,sequenceNumber:0};this._avcContext={info:Object.assign({},r),parsingData:Object.assign(Object.assign({},n),{esSamples:new Array,dropped:0}),config:{},container:"video/mp2t",type:"video"},this._audioContext={info:Object.assign({},r),parsingData:Object.assign(Object.assign({},n),{esSamples:new Array}),container:"video/mp2t",type:"audio"},this._id3Track={id:-1,inputTimescale:9e4,id3Samples:[]},this._txtTrack={inputTimescale:9e4,captionSamples:[]},this._duration=s,this._initSegment=e}append(e,t,i,n,o,l,d){var h,c,u,f,g,m=!1;this.contiguous=i;var p=this.pmtParsed,y=this._avcContext,v=this._audioContext,T=this._id3Track,S=y.info.id,b=v.info.id,_=T.id,E=this._pmtId,R=y.pesData,D=v.pesData,L=T.pesData;if(this.iframeMode=void 0!==d,this._initSegment&&this._initSegment.byteLength>0){let t=new Uint8Array(this._initSegment.byteLength+e.byteLength);t.set(this._initSegment),t.set(e,this._initSegment.byteLength),this._initSegment=void 0,e=t}let I,A,k=e.length;for(k-=k%188,h=0;h<k;h+=188){if(71!==e[h])return void this.observer.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});if(c=!!(64&e[h+1]),u=((31&e[h+1])<<8)+e[h+2],(48&e[h+3])>>4>1){if((f=h+5+e[h+4])===h+188)continue}else f=h+4;switch(u){case S:c&&(R&&(g=this._parsePES(R))&&this._parseAVCPES(g,!1),R={data:[],size:0,decryptdata:o}),R&&(R.data.push(e.subarray(f,h+188)),R.size+=h+188-f);break;case b:if(c&&!this.iframeMode){if(D&&(g=this._parsePES(D)))switch(v.segmentCodec){case"aac":this._parseAACPES(g);break;case"mp3":this._parseMPEGPES(g);break;case"ac3":case"ec3":this._parseDolbyPES(g)}D={data:[],size:0,decryptdata:o}}D&&(D.data.push(e.subarray(f,h+188)),D.size+=h+188-f);break;case _:c&&(L&&(g=this._parsePES(L))&&T.id3Samples.push(g),L={data:[],size:0}),L&&(L.data.push(e.subarray(f,h+188)),L.size+=h+188-f);break;case 0:c&&(f+=e[f]+1),E=this._pmtId=this._parsePAT(e,f);break;case E:c&&(f+=e[f]+1);let t=this._parsePMT(e,f,this.typeSupported);(S=t.avcId)>0&&(y.info.id=S,y.info.encrypted=t.videoEncrypted),(b=t.audioId)>0&&(v.info.id=b,v.segmentCodec=t.audioSegmentCodec,v.info.encrypted=t.audioEncrypted),(_=t.id3Id)>0&&(T.id=_),m&&!p&&(m=!1,h=-188),p=this.pmtParsed=!0;break;case 17:case 8191:break;default:m=!0}}if(R&&(g=this._parsePES(R))?(this._parseAVCPES(g,!0),y.pesData=void 0):y.pesData=R,D&&(g=this._parsePES(D))){switch(v.segmentCodec){case"aac":this._parseAACPES(g);break;case"mp3":this._parseMPEGPES(g);break;case"ac3":case"ec3":this._parseDolbyPES(g)}v.pesData=void 0}else D&&D.size&&r.b.warn("last AAC PES packet truncated,might overlap between fragments")(),v.pesData=D;L&&(g=this._parsePES(L))?(T.id3Samples.push(g),T.pesData=void 0):T.pesData=L,v.config&&v.segmentCodec&&(I={type:"audio",info:v.info,config:v.config,parsingData:v.parsingData});let C=y.config;var w;"string"==typeof(w=C).codec&&Array.isArray(w.sps)&&Array.isArray(w.pps)&&"number"==typeof w.width&&"number"==typeof w.height&&Array.isArray(w.pixelRatio)&&(A={type:"video",info:y.info,config:C,parsingData:y.parsingData}),this.esRemuxer.remuxEsTracks(I,A,T,this._txtTrack,t,i,n,o,l,d)}destroy(){this._duration=0}_parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}_parsePMT(e,t,i){var s,a;let n={audioId:-1,avcId:-1,id3Id:-1,audioEncrypted:!1,videoEncrypted:!1};for(s=t+3+((15&e[t+1])<<8|e[t+2])-4,t+=12+((15&e[t+10])<<8|e[t+11]);t<s;){switch(a=(31&e[t+1])<<8|e[t+2],e[t]){case 207:n.audioEncrypted=!0;case 15:-1===n.audioId&&(n.audioId=a,n.audioSegmentCodec="aac");break;case 21:-1===n.id3Id&&(n.id3Id=a);break;case 219:n.videoEncrypted=!0;case 27:-1===n.avcId&&(n.avcId=a);break;case 3:case 4:!0!==i.mpeg&&!0!==i.mp3?r.b.warn("MPEG audio found, not supported in this browser for now")():-1===n.audioId&&(n.audioId=a,n.audioSegmentCodec="mp3");break;case 193:n.audioEncrypted=!0;case 129:!0!==i.ac3?r.b.warn("AC-3 audio found, not supported in this browser for now")():-1===n.audioId&&(n.audioId=a,n.audioSegmentCodec="ac3");break;case 194:n.audioEncrypted=!0;case 135:!0!==i.ec3?r.b.warn("EC-3 audio found, not supported in this browser for now")():-1===n.audioId&&(n.audioId=a,n.audioSegmentCodec="ec3");break;case 36:r.b.warn("HEVC stream type found, not supported for now")();break;default:r.b.warn("unkown stream type:"+e[t])()}t+=5+((15&e[t+3])<<8|e[t+4])}return n}_parsePES(e){var t,i,s,a,n,o,l=0,d=e.data,h=e.decryptdata;let c=NaN,u=NaN;if(e&&0!==e.size){for(;d[0].length<19&&d.length>1;){let e=new Uint8Array(d[0].length+d[1].length);e.set(d[0]),e.set(d[1],d[0].length),d[0]=e,d.splice(1,1)}if(1===((t=d[0])[0]<<16)+(t[1]<<8)+t[2]){if((s=(t[4]<<8)+t[5])&&s>e.size-6)return;192&(i=t[7])&&((c=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2)>4294967295&&(c-=8589934592),64&i?((u=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2)>4294967295&&(u-=8589934592),c-u>54e5&&(r.b.warn(`${Math.round((c-u)/9e4)}s delta between PTS and DTS, align them`)(),c=u)):u=c),o=(a=t[8])+9,e.size-=o,n=new Uint8Array(e.size);for(let e=0,i=d.length;e<i;e++){let i=(t=d[e]).byteLength;if(o){if(o>i){o-=i;continue}t=t.subarray(o),i-=o,o=0}n.set(t,l),l+=i}return s&&(s-=a+3),{data:n,pts:c,dts:u,len:s,decryptdata:h}}}}pushAccesUnit(e,t){let i=e.avcSample;if(i&&i.units.length&&i.frame){const s=e.parsingData.esSamples,a=s.length;!this.config.forceKeyFrameOnDiscontinuity||!0===i.key||e.config.sps&&(a||this.contiguous)?(i.id=a,i.decryptdata=t,e.info.encrypted&&i.units.forEach(e=>{if(e.data.byteLength>48)switch(e.type){case 1:case 5:e.data=this.discardEPB(e.data)}}),s.push(i)):e.parsingData.dropped++}i&&i.debug.length}_parseAVCPES(e,t){if(!e.data)throw"invalid pes data";var i,s,a,r=this._avcContext,n=this._parseAVCNALu(e.data),o=r.avcSample,l=e.decryptdata;e.data=void 0,n.forEach(t=>{switch(t.type){case 1:if(o&&!this.iframeMode){s=!0,o.frame=!0;let e=t.data;if(e.length>4){let t=new M(e).readSliceType();2!==t&&4!==t&&7!==t&&9!==t||(o.key=!0)}}break;case 5:s=!0,o&&(o||(o=r.avcSample=this._createAVCSample(!0,e.pts,e.dts,"")),o.key=!0,o.frame=!0);break;case 6:s=!0,(i=new M(this.discardEPB(t.data))).readUByte();for(var n=0,d=0,h=!1,c=0;!h&&i.bytesAvailable>1;){n=0;do{n+=c=i.readUByte()}while(255===c);d=0;do{d+=c=i.readUByte()}while(255===c);if(4===n&&0!==i.bytesAvailable){if(h=!0,181===i.readUByte()&&49===i.readUShort()&&1195456820===i.readUInt()&&3===i.readUByte()){var u=i.readUByte(),f=31&u,g=[u,i.readUByte()];for(a=0;a<f;a++)g.push(i.readUByte()),g.push(i.readUByte()),g.push(i.readUByte());this._insertSampleInOrder(this._txtTrack.captionSamples,{type:3,pts:e.pts,bytes:g})}}else if(d<i.bytesAvailable)for(a=0;a<d;a++)i.readUByte()}break;case 7:if(s=!0,!r.config.sps){var m=(i=new M(t.data)).readSPS();r.config.width=m.width,r.config.height=m.height,r.config.pixelRatio=m.pixelRatio,r.config.sps=[t.data],r.info.duration=this._duration;var p=t.data.subarray(1,4),y="avc1.";for(a=0;a<3;a++){var v=p[a].toString(16);v.length<2&&(v="0"+v),y+=v}r.config.codec=y}break;case 8:s=!0,r.config.pps||(r.config.pps=[t.data]);break;case 9:s=!1,o&&this.pushAccesUnit(r,l),o=r.avcSample=this._createAVCSample(!1,e.pts,e.dts,"");break;case 12:s=!1;break;default:s=!1,o&&(o.debug+="unknown NAL "+t.type+" ")}o&&s&&o.units.push(t)}),t&&o&&(this.pushAccesUnit(r,l),r.avcSample=void 0)}_createAVCSample(e,t,i,s){return{id:NaN,key:e,pts:t,dts:i,units:new Array,debug:s}}_insertSampleInOrder(e,t){var i=e.length;if(i>0){if(t.pts>=e[i-1].pts)e.push(t);else for(var s=i-1;s>=0;s--)if(t.pts<e[s].pts){e.splice(s,0,t);break}}else e.push(t)}_getLastNalUnit(){let e,t=this._avcContext,i=t.avcSample;if(!i||0===i.units.length){let e=t.parsingData.esSamples;i=e[e.length-1]}if(i){let t=i.units;e=t[t.length-1]}return e}_parseAVCNALu(e){var t,i,s,a,r=0,n=e.byteLength,o=this._avcContext,l=o.naluState||0,d=l,h=[],c=-1;for(-1===l&&(c=0,a=31&e[0],l=0,r=1);r<n;)if(t=e[r++],l)if(1!==l)if(t)if(1===t){if(c>=0)s={data:e.subarray(c,r-l-1),type:a},h.push(s);else{let t=this._getLastNalUnit();if(t&&(d&&r<=4-d&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-d)),(i=r-l-1)>0)){let s=new Uint8Array(t.data.byteLength+i);s.set(t.data,0),s.set(e.subarray(0,i),t.data.byteLength),t.data=s}}r<n?(c=r,a=31&e[r],l=0):l=-1}else l=0;else l=3;else l=t?0:2;else l=t?0:1;if(c>=0&&l>=0&&(s={data:e.subarray(c,n),type:a,state:l},h.push(s)),0===h.length){let t=this._getLastNalUnit();if(t){let i=new Uint8Array(t.data.byteLength+e.byteLength);i.set(t.data,0),i.set(e,t.data.byteLength),t.data=i}}return o.naluState=l,h}discardEPB(e){for(var t,i,s=e.byteLength,a=[],r=1;r<s-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(a.push(r+2),r+=2):r++;if(0===a.length)return e;t=s-a.length,i=new Uint8Array(t);var n=0;for(r=0;r<t;n++,r++)n===a[0]&&(n++,a.shift()),i[r]=e[n];return i}_parseAACPES(e){var t,i,n,o,l,d,h,c,u,f,g=this._audioContext,m=e.data,p=e.pts,y=g.audioOverFlow,T=g.audioLastPTS,S=e.decryptdata;if(y){var b=new Uint8Array(y.byteLength+m.byteLength);b.set(y,0),b.set(m,y.byteLength),m=b}for(o=0,h=m.length;o<h-1&&(255!==m[o]||240!=(240&m[o+1]));o++);if(!o||(o<h-1?(u=`AAC PES did not start with ADTS header,offset:${o}`,f=!1):(u="no ADTS header found in AAC PES",f=!0),r.b.warn(`parsing error:${u}`)(),this.observer.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:f,reason:u}),!f)){if(!g.config){let e=v.getAudioConfig(this.observer,m,o);if(!e)throw"unable to parse adts header";g.config=e}if(n=0,i=9216e4/g.config.samplerate,y&&T){var _=T+i;Math.abs(_-p)>1&&(p=_)}for(;o+5<h&&(l=1&m[o+1]?7:9,t=(3&m[o+3])<<11|m[o+4]<<3|(224&m[o+5])>>>5,(t-=l)>0&&o+l+t<=h);)for(d=p+n*i,c={unit:m.subarray(o+l,o+l+t),pts:d,dts:d,decryptdata:S},g.parsingData.esSamples.push(c),g.parsingData.len+=t,o+=t+l,n++;o<h-1&&(255!==m[o]||240!=(240&m[o+1]));o++);y=o<h?m.subarray(o,h):void 0,g.audioOverFlow=y,g.audioLastPTS=d}}_parseMPEGPES(e){"mp3"===this._audioContext.segmentCodec&&S.parse(this._audioContext.parsingData,e.data,0,e.pts)}_parseDolbyPES(e){let t=this._audioContext,i=e.data,r=e.pts,n=e.decryptdata,o=0,l=0,d=t.audioOverFlow,u=t.audioLastPTS;if(!t.config){let e;if("ac3"===t.segmentCodec?e=y.getAudioConfig(this.observer,i,l):"ec3"===t.segmentCodec&&(e=c(this.observer,i,l)),!e)throw"unable to parse dolby header";t.config=e}if("ac3"!==t.config.segmentCodec&&"ec3"!==t.config.segmentCodec)throw"unexpected config type";const f=1536/t.config.samplerate*t.info.inputTimescale;if(d){var g=new Uint8Array(d.byteLength+i.byteLength);g.set(d,0),g.set(i,d.byteLength),i=g}let m=i.length;if(d&&u){var p=u+f;Math.abs(p-r)>1&&(r=p)}let v=0;for(;l+v<=m;){if(11!==i[l]||119!==i[l+1])return void this.observer.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid dolby audio magic"});"ac3"===t.segmentCodec?v=y.getFrameLength(this.observer,i,l):"ec3"===t.segmentCodec&&(v=h(this.observer,i,l));let e=r+o*f;t.audioLastPTS=e;let d={unit:i.subarray(l,l+v),pts:e,dts:e,decryptdata:n};t.parsingData.esSamples.push(d),t.info.duration=this._duration,t.parsingData.len+=v,l+=v,o++}d=l<m?i.subarray(l,m):void 0,t.audioOverFlow=d}},remux:N},{demux:class extends f{resetInitSegment(e,t,i,s){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=s}static probe(e){let t=new l(e),i=t.length;return!(!t.hasTimeStamp||11!==e[i]||119!==e[i+1]||16!==(new d).bsReadAndUpdate(e,{byteOffset:i+5,usedBits:0},5))}append(e,t,i,r,n){const o=new l(e),d=90*o.timeStamp,u=e.length;let f=0,g=o.length;if(this.audioConfig||(this.audioConfig=c(this.observer,e,g)),!this.audioConfig)throw"failed to parse ec-3 config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}const m=y.getFrameDuration(this.audioConfig,this.audioTrack.info.inputTimescale);for("zec3"===o.audioType&&(this.audioTrack.info.encrypted=!0);g<u;){if(11!==e[g]||119!==e[g+1])return void this.observer.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ec-3 magic"});let t=h(this.observer,e,g),i=d+f*m,r={unit:e.subarray(g,g+t),pts:i,dts:i,decryptdata:n};this.audioTrack.parsingData.esSamples.push(r),this.audioTrack.parsingData.len+=t,g+=t,f++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:d,dts:d,data:o.payload,frames:o.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,r,n)}},remux:N},{demux:class extends f{resetInitSegment(e,t,i,s){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=s}static probe(e){const t=new l(e),i=t.length;return!!(t.hasTimeStamp&&11===e[i]&&119===e[i+1]&&(new d).bsReadAndUpdate(e,{byteOffset:i+5,usedBits:0},5)<16)}append(e,t,i,r,n){let o=new l(e),d=90*o.timeStamp,h=e.byteLength,c=0,u=o.length;if(this.audioConfig||(this.audioConfig=y.getAudioConfig(this.observer,e,u)),!this.audioConfig)throw"failed to parse ac3 config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}const f=y.getFrameDuration(this.audioConfig,this.audioTrack.info.inputTimescale);for("zac3"===o.audioType&&(this.audioTrack.info.encrypted=!0);u<h;){if(11!==e[u]||119!==e[u+1])return void this.observer.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"});let t=y.getFrameLength(this.observer,e,u),i=d+c*f,r={unit:e.subarray(u,u+t),pts:i,dts:i,decryptdata:n};this.audioTrack.parsingData.esSamples.push(r),this.audioTrack.parsingData.len+=t,u+=t,c++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:d,dts:d,data:o.payload,frames:o.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,r,n)}},remux:N},{demux:class extends f{resetInitSegment(e,t,i,s){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=s}static probe(e){let t,i,s=new l(e);if(s.hasTimeStamp)for(t=s.length,i=Math.min(e.length-1,t+100);t<i;t++)if(255===e[t]&&240==(246&e[t+1]))return!0;return!1}append(e,t,i,s,a){const r=new l(e),n=90*r.timeStamp;let o,d,h,c,u,f,g,m;for(c=r.length,g=e.length;c<g-1&&(255!==e[c]||240!=(246&e[c+1]));c++);if(!this.audioConfig&&(this.audioConfig=v.getAudioConfig(this.observer,e,c),!this.audioConfig))throw"failed to parse adts config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:a},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}for("zaac"!==r.audioType&&"zach"!==r.audioType&&"zacp"!==r.audioType||(this.audioTrack.info.encrypted=!0),h=0,d=9216e4/this.audioConfig.samplerate;c+5<g&&(u=1&e[c+1]?7:9,o=(3&e[c+3])<<11|e[c+4]<<3|(224&e[c+5])>>>5,(o-=u)>0&&c+u+o<=g);)for(f=n+h*d,m={unit:e.subarray(c+u,c+u+o),pts:f,dts:f,decryptdata:a},this.audioTrack.parsingData.esSamples.push(m),this.audioTrack.parsingData.len+=o,c+=o+u,h++;c<g-1&&(255!==e[c]||240!=(246&e[c+1]));c++);this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:n,dts:n,data:r.payload,frames:r.frames}],inputTimescale:9e4},void 0,t,i,s,a)}},remux:N},{demux:P,remux:I},{demux:class extends f{resetInitSegment(e,t,i,s){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=s}static probe(e){let t,i,s=new l(e);if(s.hasTimeStamp)for(t=s.length,i=Math.min(e.length-1,t+100);t<i;t++)if(S.probe(e,t))return r.b.warn("MPEG Audio sync word found !")(),!0;return!1}append(e,t,i,s,a){const r=new l(e),n=90*r.timeStamp;let o,d;for(o=r.length,d=e.length;o<d-1&&(255!==e[o]||224!=(224&e[o+1])||0==(6&e[o+1]));o++);if(this.audioConfig||(this.audioConfig=S.getAudioConfig(e,r.length)),!this.audioConfig)throw"unable to parse mp3 header";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:a},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}S.parse(this.audioTrack.parsingData,e,r.length,n),this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:n,dts:n,data:r.payload,frames:r.frames}],inputTimescale:9e4},void 0,t,i,s)}},remux:N}];for(let s of n){const{probe:a}=s.demux;if(a(L)){this.remuxer=new s.remux(e,i,t,this.vendor),D=new s.demux(e,this.remuxer,i,t),this.probeFn=a;break}}if(!D)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"});this.demuxer=D}const A=this.remuxer;let k=!this.lastDecryptData||t&&"NONE"!==t.method&&this.lastDecryptData.uri!==t.uri;this.lastDecryptData=t,(g||m||k)&&(D.resetInitSegment(i,n,o,T,t,g),A.resetInitSegment()),g&&(D.resetTimeStamp(_),A.resetTimeStamp(_)),D.append(L,u,p,b,t,E,R)}}}),(function(e,t,i){"use strict";class s{constructor(e,t){this.subtle=e,this.iv=t}decrypt(e,t){const{iv:i,subtle:s}=this;return s.decrypt({name:"AES-CBC",iv:i},t,e)}}class a{constructor(e,t){this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC",length:null},!1,["encrypt","decrypt"])}}class r{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=Math.floor(t.byteLength/4),s=new Uint32Array(i);for(let e=0;e<i;e++)s[e]=t.getUint32(4*e);return s}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],a=i[1],r=i[2],n=i[3],o=this.invSubMix,l=o[0],d=o[1],h=o[2],c=o[3],u=new Uint32Array(256);let f=0,g=0,m=0;for(m=0;m<256;m++)u[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){let i=g^g<<1^g<<2^g<<3^g<<4;i=i>>>8^255&i^99,e[f]=i,t[i]=f;const o=u[f],m=u[o],p=u[m];let y=257*u[i]^16843008*i;s[f]=y<<24|y>>>8,a[f]=y<<16|y>>>16,r[f]=y<<8|y>>>24,n[f]=y,y=16843009*p^65537*m^257*o^16843008*f,l[i]=y<<24|y>>>8,d[i]=y<<16|y>>>16,h[i]=y<<8|y>>>24,c[i]=y,f?(f=o^u[u[u[p^o]]],g^=u[u[g]]):f=g=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;let a=this.keySize=t.length;if(4!==a&&6!==a&&8!==a)throw new Error("Invalid aes key size="+a);const r=this.ksRows=4*(a+6+1);let n,o;const l=this.keySchedule=new Uint32Array(r),d=this.invKeySchedule=new Uint32Array(r),h=this.sBox,c=this.rcon,u=this.invSubMix,f=u[0],g=u[1],m=u[2],p=u[3];let y,v;for(n=0;n<r;n++)n<a?y=l[n]=t[n]:(v=y,n%a==0?(v=h[(v=v<<8|v>>>24)>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[255&v],v^=c[n/a|0]<<24):a>6&&n%a==4&&(v=h[v>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[255&v]),l[n]=y=(l[n-a]^v)>>>0);for(o=0;o<r;o++)n=r-o,v=3&o?l[n]:l[n-4],d[o]=o<4||n<=4?v:f[h[v>>>24]]^g[h[v>>>16&255]]^m[h[v>>>8&255]]^p[h[255&v]],d[o]=d[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,a=this.invKeySchedule,r=this.invSBox,n=this.invSubMix,o=n[0],l=n[1],d=n[2],h=n[3],c=this.uint8ArrayToUint32Array_(i);let u=c[0],f=c[1],g=c[2],m=c[3];const p=new Int32Array(e),y=new Int32Array(p.length);let v,T,S,b,_,E,R,D,L,I,A,k;var C,w;const P=this.networkToHostOrderSwap;for(;t<p.length;){for(L=P(p[t]),I=P(p[t+1]),A=P(p[t+2]),k=P(p[t+3]),_=L^a[0],E=k^a[1],R=A^a[2],D=I^a[3],C=4,w=1;w<s;w++)v=o[_>>>24]^l[E>>16&255]^d[R>>8&255]^h[255&D]^a[C],T=o[E>>>24]^l[R>>16&255]^d[D>>8&255]^h[255&_]^a[C+1],S=o[R>>>24]^l[D>>16&255]^d[_>>8&255]^h[255&E]^a[C+2],b=o[D>>>24]^l[_>>16&255]^d[E>>8&255]^h[255&R]^a[C+3],_=v,E=T,R=S,D=b,C+=4;v=r[_>>>24]<<24^r[E>>16&255]<<16^r[R>>8&255]<<8^r[255&D]^a[C],T=r[E>>>24]<<24^r[R>>16&255]<<16^r[D>>8&255]<<8^r[255&_]^a[C+1],S=r[R>>>24]<<24^r[D>>16&255]<<16^r[_>>8&255]<<8^r[255&E]^a[C+2],b=r[D>>>24]<<24^r[_>>16&255]<<16^r[E>>8&255]<<8^r[255&R]^a[C+3],C+=3,y[t]=P(v^u),y[t+1]=P(b^f),y[t+2]=P(S^g),y[t+3]=P(T^m),u=L,f=I,g=A,m=k,t+=4}return y.buffer}destroy(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}var n=i(1),o=i(0),l=i(2);class d{constructor(e,t){this.observer=e,this.config=t,this.logEnabled=!0;try{const t=crypto||self.crypto;this.subtle=t.subtle||t.webkitSubtle}catch(e){l.b.error(e)()}this.disableWebCrypto=!this.subtle}isSync(){return this.disableWebCrypto&&this.config.enableSoftwareAES}decrypt(e,t,i,n){if(!this.disableWebCrypto||!this.config.enableSoftwareAES){this.logEnabled&&(this.logEnabled=!1);const r=this.subtle;return this.key!==t&&(this.key=t,this.fastAesKey=new a(r,t)),this.fastAesKey.expandKey().then(a=>{new s(r,i).decrypt(e,a).then(e=>{try{n(e)}catch(e){l.b.error(e)()}}).catch(s=>{this.onWebCryptoError(s,e,t,i,n)})}).catch(s=>{this.onWebCryptoError(s,e,t,i,n)})}{this.logEnabled&&(this.logEnabled=!1),this.decryptor||(this.decryptor=new r);const{decryptor:s}=this;s.expandKey(t),n(s.decrypt(e,0,i))}}onWebCryptoError(e,t,i,s,a){this.config.enableSoftwareAES?(this.disableWebCrypto=!0,this.logEnabled=!0,this.decrypt(t,i,s,a)):(l.b.error(`decrypting error : ${e.message}`)(),this.observer.trigger(o.a.ERROR,{type:n.c.MEDIA_ERROR,details:n.a.FRAG_DECRYPT_ERROR,fatal:!0,reason:e.message}))}destroy(){this.decryptor&&(this.decryptor.destroy(),this.decryptor=void 0)}}i.d(t,"a",(function(){return h}));class h{constructor(e,t){this.observer=e,this.config=t}destroy(){this.decryptor&&this.decryptor.destroy()}decrypt(e,t,i){if(e.byteLength>0&&t&&t.key&&t.iv&&"AES-128"===t.method){null==this.decryptor&&(this.decryptor=new d(this.observer,this.config));try{performance.now()}catch(e){Date.now()}return this.decryptor.decrypt(e,t.key.buffer,t.iv.buffer,e=>{try{performance.now()}catch(e){Date.now()}i&&i(e)})}}}}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"","&rlm;":"","&nbsp;":""},a={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},r={v:"title",lang:"lang"},n={rt:"ruby"},o={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class l{static parseTimeStamp(e){function t(e){const[t,i,s,a]=e.map(e=>e?parseInt(""+e):0);return 3600*t+60*i+s+a/1e3}const i=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return i?i[3]?t([i[1],i[2],i[3].substring(1),i[4]]):parseInt(i[1])>59?t([i[1],i[2],null,i[4]]):t([null,i[1],i[2],i[4]]):null}static parseContent(e,t,i){let d=t.text;function h(){if(!d)return null;const e=/^([^<]*)(<[^>]+>?)?/.exec(d);return t=e[1]?e[1]:e[2],d=d.substr(t.length),t;var t}function c(e){return s[e]}function u(e,t){return!n[t.dataset.localName]||n[t.dataset.localName]===e.dataset.localName}function f(t,s,n){const l=a[t];if(!l)return null;const d=e.document.createElement(l);d.dataset.localName=l;const h=r[t];if(h&&n&&(d[h]=n.trim()),s)if(i[s]){const e=(function(e){let t="";for(const i in e)o[i]?t+=o[i]:t+=i+":"+e[i]+";";return t})(i[s]);d.setAttribute("style",e)}else console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${s}'!`);return d}const g=e.document.createElement("div"),m=[];let p,y,v=g;for(;null!==(p=h());)if("<"!==p[0])v.appendChild(e.document.createTextNode(p.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,c)));else{if("/"===p[1]){m.length&&m[m.length-1]===p.substr(2).replace(">","")&&(m.pop(),v=v.parentNode);continue}const t=l.parseTimeStamp(p.substr(1,p.length-2));let i;if(t){i=e.document.createProcessingInstruction("timestamp",t.toString()),v.appendChild(i);continue}if(!(y=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(p)))continue;if(!(i=f(y[1],y[2],y[3])))continue;if(!u(v,i))continue;y[2],m.push(y[1]),v.appendChild(i),v=i}return g}}t.default=l}),(function(e,t,i){"use strict";var s=this&&this.__decorate||function(e,t,i,s){var a,r=arguments.length,n=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(r<3?a(n):r>3?a(t,i,n):a(t,i))||n);return r>3&&n&&Object.defineProperty(t,i,n),n};Object.defineProperty(t,"__esModule",{value:!0});const a=i(15),r=i(13);let n=class{constructor(e,t,i){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position=50,this._positionAlign="center",this._size=50,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=i}get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError(`Start time must be set to a number: ${e}`);this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError(`End time must be set to a number: ${e}`);this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!a.isValidDirectionSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for vertical: ${e}`);this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!a.isValidLineAndPositionSetting(e))throw new SyntaxError(`An invalid number or illegal string was specified for line: ${e}`);this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!a.isValidLineAlignSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for lineAlign: ${e}`);this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!a.isValidLineAndPositionSetting(e))throw new Error(`Position must be between 0 and 100 or auto: ${e}`);this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||e>100)throw new Error(`Size must be between 0 and 100: ${e}`);this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!a.isValidAlignSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for align: ${e}`);this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return r.default.parseContent(window,this,{})}static create(e){if(!e.hasOwnProperty("startTime")||!e.hasOwnProperty("endTime")||!e.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const t=new this(e.startTime,e.endTime,e.text);return Object.keys(e).forEach(i=>{t.hasOwnProperty(i)&&(t[i]=e[i])}),t}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&"getCueAsHTML"!==t&&"hasBeenReset"!==t&&"displayState"!==t&&(e[t]=this[t])}),e}};n=s([function(e){let t=e;return"undefined"!=typeof window&&null!=window.VTTCue&&((t=window.VTTCue).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],n),t.VTTCue=n}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isValidPercentValue=function(e){return"number"==typeof e&&e>=0&&e<=100},t.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right"].includes(e)},t.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},t.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},t.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},t.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto"].includes(e)},t.isValidScrollSetting=function(e){return["","up"].includes(e)}}),(function(e,t,i){"use strict";!(function(e,t){if(!e.setImmediate){var i,s,a,r,n,o=1,l={},d=!1,h=e.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(e);c=c&&c.setTimeout?c:e,"[object process]"==={}.toString.call(e.process)?i=function(e){process.nextTick((function(){f(e)}))}:(function(){if(e.postMessage&&!e.importScripts){var t=!0,i=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=i,t}})()?(r="setImmediate$"+Math.random()+"$",n=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(r)&&f(+t.data.slice(r.length))},e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),i=function(t){e.postMessage(r+t,"*")}):e.MessageChannel?((a=new MessageChannel).port1.onmessage=function(e){f(e.data)},i=function(e){a.port2.postMessage(e)}):h&&"onreadystatechange"in h.createElement("script")?(s=h.documentElement,i=function(e){var t=h.createElement("script");t.onreadystatechange=function(){f(e),t.onreadystatechange=null,s.removeChild(t),t=null},s.appendChild(t)}):i=function(e){setTimeout(f,0,e)},c.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),s=0;s<t.length;s++)t[s]=arguments[s+1];var a={callback:e,args:t};return l[o]=a,i(o),o++},c.clearImmediate=u}function u(e){delete l[e]}function f(e){if(d)setTimeout(f,0,e);else{var i=l[e];if(i){d=!0;try{!(function(e){var i=e.callback,s=e.args;switch(s.length){case 0:i();break;case 1:i(s[0]);break;case 2:i(s[0],s[1]);break;case 3:i(s[0],s[1],s[2]);break;default:i.apply(t,s)}})(i)}finally{u(e),d=!1}}}}})("undefined"==typeof self?"undefined"==typeof global?this:global:self)}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(14);t.VTTCue=s.VTTCue;const a=i(18);t.VTTRegion=a.VTTRegion;const r=i(13);class n extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof n&&(this.message=e.message)}}t.ParsingError=n,n.Errors={BadSignature:new n(0,"Malformed WebVTT signature."),BadTimeStamp:new n(1,"Malformed time stamp.")};class o{constructor(){this.values={}}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return"object"==typeof t&&"string"==typeof i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}catch(e){return!1}return!1}}class l{constructor(e,t,i){this.window=e,this.state="INITIAL",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.onStylesParsedCallback=i,this._styles={}}static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof n&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,i,s){const a=s?e.split(s):[e];for(const e of a){if("string"!=typeof e)continue;const s=e.split(i);2===s.length&&t(s[0],s[1])}}parseCue(e,t,i){const s=e,a=()=>{const t=r.default.parseTimeStamp(e);if(null===t)throw new n(n.Errors.BadTimeStamp,"Malformed timestamp: "+s);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t},l=()=>{e=e.replace(/^\s+/,"")};if(l(),t.startTime=a(),l(),"--\x3e"!==e.substr(0,3))throw new n(n.Errors.BadTimeStamp,`Malformed time stamp (time stamps must be separated by '--\x3e'): ${s}`);e=e.substr(3),l(),t.endTime=a(),l(),((e,t)=>{const s=new o;this.parseOptions(e,(e,t)=>{let a,r;switch(e){case"region":for(let a=i.length-1;a>=0;a--)if(i[a].id===t){s.set(e,i[a].region);break}break;case"vertical":s.alt(e,t,["rl","lr"]);break;case"line":r=(a=t.split(","))[0],s.integer(e,r),s.percent(e,r)&&s.set("snapToLines",!1),s.alt(e,r,["auto"]),2===a.length&&s.alt("lineAlign",a[1],["start","center","end"]);break;case"position":a=t.split(","),s.percent(e,a[0]),2===a.length&&s.alt("positionAlign",a[1],["start","center","end"]);break;case"size":s.percent(e,t);break;case"align":s.alt(e,t,["start","center","end","left","right"])}},/:/,/\s/),t.region=s.get("region",null),t.vertical=s.get("vertical",""),t.line=s.get("line",void 0===t.line?"auto":t.line),t.lineAlign=s.get("lineAlign","start"),t.snapToLines=s.get("snapToLines",!0),t.size=s.get("size",100),t.align=s.get("align","center"),t.position=s.get("position","auto"),t.positionAlign=s.get("positionAlign",{start:"start",left:"start",center:"center",end:"end",right:"end"},t.align)})(e,t)}parseRegion(e){const t=new o;if(this.parseOptions(e,(e,i)=>{switch(e){case"id":t.set(e,i);break;case"width":t.percent(e,i);break;case"lines":t.integer(e,i);break;case"regionanchor":case"viewportanchor":{const s=i.split(",");if(2!==s.length)break;const a=new o;if(a.percent("x",s[0]),a.percent("y",s[1]),!a.has("x")||!a.has("y"))break;t.set(e+"X",a.get("x")),t.set(e+"Y",a.get("y"));break}case"scroll":t.alt(e,i,["up"])}},/=/,/\s/),t.has("id")){const e=new a.VTTRegion;e.width=t.get("width",100),e.lines=t.get("lines",3),e.regionAnchorX=t.get("regionanchorX",0),e.regionAnchorY=t.get("regionanchorY",100),e.viewportAnchorX=t.get("viewportanchorX",0),e.viewportAnchorY=t.get("viewportanchorY",100),e.scroll=t.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:t.get("id"),region:e})}}parseStyle(e){const t=e=>{const t={},i=e.split(";");for(let e=0;e<i.length;e++){const s=i[e].split(":",2),a=s[0].trim(),r=s[1].trim();""!==a&&""!==r&&(t[a]=r)}return t},i=e.replace(" ","").split("}");i.pop();for(const e of i){let i=null,s=null;const a=e.split("{");a[0]&&(i=a[0].trim()),a[1]&&(s=t(a[1])),i&&s&&(this._styles[i]=s)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,(function(e,t){switch(e){case"Region":this.parseRegion(t)}}),/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));const t=()=>{const e=this.buffer;let t=0;const i=(e,t)=>{const i={start:-1,length:-1};if("\r"===e[t])i.start=t,i.length=1;else if("\n"===e[t])i.start=t,i.length=1;else if("<"===e[t]&&t+1<e.length&&"b"===e[t+1]&&t+2<e.length&&"r"===e[t+2]){let s=t+2;for(;s<e.length&&">"!==e[s++];);i.start=t,i.length=s-t}return i};let s={start:e.length,length:0};for(;t<e.length;){const a=i(e,t);if(a.length>0){s=a;break}++t}const a=e.substr(0,s.start);return this.buffer=e.substr(s.start+s.length),a};try{let i;if(this.styleCollector="","INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;i=t();const e=/^()?WEBVTT([ \t].*)?$/.exec(i);if(!e||!e[0])throw new n(n.Errors.BadSignature);this.state="HEADER"}let a=!1;for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(a?a=!1:i=t(),this.state){case"HEADER":i.includes(":")?this.parseHeader(i):i||(this.state="ID");continue;case"NOTE":i||(this.state="ID");continue;case"STYLE":i?this.styleCollector+=i:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(i)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(i)){this.state="STYLE";break}if(!i)continue;if(this.cue=new s.VTTCue(0,0,""),this.state="CUE",!i.includes("--\x3e")){this.cue.id=i;continue}case"CUE":try{this.parseCue(i,this.cue,this.regionList)}catch(e){this.reportOrThrowError(e),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const e=i.includes("--\x3e");if(!i||e){a=!0,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=i;continue}case"BADCUE":i||(this.state="ID");continue}}}catch(e){this.reportOrThrowError(e),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new n(n.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}}t.default=l,t.WebVTTParser=l}),(function(e,t,i){"use strict";var s=this&&this.__decorate||function(e,t,i,s){var a,r=arguments.length,n=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(r<3?a(n):r>3?a(t,i,n):a(t,i))||n);return r>3&&n&&Object.defineProperty(t,i,n),n};Object.defineProperty(t,"__esModule",{value:!0});const a=i(15);let r=class{constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!a.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!a.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){const t=e.toLowerCase();if(a.isValidScrollSetting(t))return void(this._scroll=t)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!a.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!a.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!a.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&(e[t]=this[t])}),e}static create(e){const t=new this;return Object.keys(e).forEach(i=>{t.hasOwnProperty(i)&&(t[i]=e[i])}),t}static fromJSON(e){return this.create(JSON.parse(e))}};r=s([function(e){let t=e;return"undefined"!=typeof window&&null!=window.VTTRegion&&((t=window.VTTRegion).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],r),t.VTTRegion=r}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(14);t.VTTCue=s.VTTCue;const a=i(13),r="1.5%",n=0,o=.05,l=10,d=41,h="::cue",c="::-webkit-media-text-track-display",u=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],f=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class g{applyStyles(e,t){t=t||this.div;for(const i in e)e.hasOwnProperty(i)&&(t.style[i]=e[i])}formatStyle(e,t){return 0===e?"0":e+t}}t.StyleBox=g;class m extends g{constructor(e,t,i,s,r){super(),this.cue=t;let n={textAlign:t.align,whiteSpace:"pre-line",position:"absolute"};n.direction=this.determineBidi(this.cueDiv),n.writingMode=this.directionSettingToWritingMode(t.vertical),n.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(n),n={backgroundColor:s.backgroundColor,display:"inline-block"},this.parseOpacity(n.backgroundColor)&&(n.padding="5px",n.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(n,this.backgroundDiv),(n={color:i.color,backgroundColor:i.backgroundColor,textShadow:i.textShadow,fontSize:i.fontSize,fontFamily:i.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"}).writingMode=this.directionSettingToWritingMode(t.vertical),n.unicodeBidi="plaintext",this.cueDiv=a.default.parseContent(e,t,r),this.applyStyles(n,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let o=null;t.align&&(o={start:"start",left:"start",middle:"center",center:"center",end:"end",right:"end"}[t.align]);let l=0;if("number"==typeof t.position)switch(o){case"start":l=t.position;break;case"center":l=t.position-t.size/2;break;case"end":l=t.position-t.size}""===t.vertical?this.applyStyles({left:this.formatStyle(l,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(l,"%"),height:this.formatStyle(t.size,"%")})}determineBidi(e){let t,i=[],s="";if(!e||!e.childNodes)return"ltr";function a(e,t){for(let i=t.childNodes.length-1;i>=0;i--)e.push(t.childNodes[i])}function r(e){if(!e||!e.length)return null;let t=e.pop(),i=t.textContent||t.innerText;if(i){const t=/^.*(\n|\r)/.exec(i);return t?(e.length=0,t[0]):i}return"ruby"===t.tagName?r(e):t.childNodes?(a(e,t),r(e)):void 0}function n(e,t){for(const i of t)if(e>=i[0]&&e<=i[1])return!0;return!1}for(a(i,e);s=r(i);)for(let e=0;e<s.length;e++)if(n(t=s.charCodeAt(e),f))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;const t=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return t&&t.length>=4?t[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}}t.CueStyleBox=m;class p{constructor(e){var t;let i,s,a,r,n,o;if(e instanceof m&&e.cue?(t=e.cue)&&""!==t.vertical?this.property="width":this.property="height":e instanceof p&&(this.property=e.property||"height"),e instanceof m&&e.div){a=e.div.offsetHeight,r=e.div.offsetWidth,n=e.div.offsetTop;const t=e.div.firstChild;if(i=(o=t?t.getBoundingClientRect():e.div.getBoundingClientRect())&&o[this.property]||null,t&&t.firstChild){const e=t.firstChild;e&&"string"==typeof e.textContent&&(s=i/this.calculateNewLines(e.textContent))}}else e instanceof p&&(o=e);this.left=o.left,this.right=o.right,this.top=o.top||n,this.height=o.height||a,this.bottom=o.bottom||n+(o.height||a),this.width=o.width||r,this.lineHeight=null!==i?i:o.lineHeight,this.singleLineHeight=null!==s?s:o.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=d)}calculateNewLines(e){let t=1;for(let i=0;i<e.length;i++)"\n"===e[i]&&t++;return t}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(const t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){let t=null;e instanceof g&&e.div?t=e.div:e instanceof HTMLElement&&(t=e);let i=t.offsetHeight||0,s=t.offsetWidth||0,a=t.offsetTop||0,r=a+i,n=t.getBoundingClientRect();const{left:o,right:l}=n;return n.top&&(a=n.top),n.height&&(i=n.height),n.width&&(s=n.width),n.bottom&&(r=n.bottom),{left:o,right:l,top:a,height:i,bottom:r,width:s}}static getBoxPosition(e,t){if(e&&e.length>0){let i=0,s=e[0][t];for(let a=0;a<e.length;a++)t in["top","right"]?e[a][t]>s&&(i=a,s=e[a][t]):t in["bottom","left"]&&e[a][t]<s&&(i=a,s=e[a][t]);return e[i]}return null}static moveToMinimumDistancePlacement(e,t,i){"height"===e.property?"+y"===t?(e.top=i.topMostBoxPosition.bottom+n,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=i.bottomMostBoxPosition.top-n,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=i.rightMostBoxPosition.right+n,e.right=e.left+e.width):"-x"===t&&(e.right=i.leftMostBoxPosition.left-n,e.left=e.right-e.width))}static moveBoxToLinePosition(e,t,i){const s=e.cue;let a,r=new p(e),n=(function(e){if("number"==typeof e.line&&(e.snapToLines||e.line>=0&&e.line<=100))return e.line;if(!e.track||!e.track.textTrackList||!e.track.textTrackList.mediaElement)return-1;let t=0;const i=e.track,s=i.textTrackList;for(let e=0;e<s.length&&s[e]!==i;e++)"showing"===s[e].mode&&t++;return-1*++t})(s),d=[];if(s.snapToLines){let e=0;switch(s.vertical){case"":d=["+y","-y"],a="height";break;case"rl":d=["+x","-x"],a="width";break;case"lr":d=["-x","+x"],a="width"}const i=r.lineHeight,l=t[a]+i,h=d[0];if(n<0){let a=0;switch(s.vertical){case"":a=t.height-i-t.height*o;break;case"rl":case"lr":a=-t.width+i+t.width*o}e=a,d=d.reverse()}else{switch(s.vertical){case"":e=i*Math.round(n);break;case"rl":e=t.width-i*Math.round(n);break;case"lr":e=i*Math.round(n)}Math.abs(e)>l&&(e=e<0?-1:1,e*=Math.ceil(l/i)*i)}r.move(h,e)}else{const i=""===s.vertical?t.height:t.width,a=r.lineHeight/i*100;switch(s.lineAlign){case"center":n-=a/2;break;case"end":n-=a}switch(s.vertical){case"":e.applyStyles({top:e.formatStyle(n,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(n,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(n,"%")})}d=["+y","-y","+x","-x"],"+y"===s.axis?d=["+y","-y","+x","-x"]:"-y"===s.axis&&(d=["-y","+y","+x","-x"]),r=new p(e)}const h=(function(e,s){let a;for(let r=0;r<s.length;r++){e.moveIfOutOfBounds(t,s[r]);let n=0,o=!1;for(;e.overlapsAny(i)&&!(n>l-1);)o?e.move(s[r]):(i&&i.length>0&&(a||(a={topMostBoxPosition:p.getBoxPosition(i,"top"),bottomMostBoxPosition:p.getBoxPosition(i,"bottom"),leftMostBoxPosition:p.getBoxPosition(i,"left"),rightMostBoxPosition:p.getBoxPosition(i,"right")}),p.moveToMinimumDistancePlacement(e,s[r],a)),o=!0),n++}return e})(r,d);e.move(h.toCSSCompatValues(t))}}t.BoxPosition=p;class y{constructor(e,t){if(!e)return null;this.window=e,this.overlay=t,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const i=e.document.createElement("div");i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0",i.style.margin=r,this.paddedOverlay=i,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}initSubtitleCSS(){const e=[new s.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?a.default.parseContent(this.window,e,this.globalStyleCollection):null}setStyles(e){function t(e,t,i){for(const s in t)t.hasOwnProperty(s)&&(!0===i&&void 0!==e[s]?e[s]=t[s]:!1===i&&(e[s]=t[s]))}for(const i in e){let s=!1,a=null;i===h?(a=this.foregroundStyleOptions,s=!0):i===c&&(a=this.backgroundStyleOptions,s=!0);const r=e[i];if(!0===s)t(a,r,s);else for(let e=0;e<u.length;e++){const a=u[e].exec(i);if(a&&4===a.length){const e=a[2],i={};t(i,r,s),this.globalStyleCollection[e]=i}}}this.initSubtitleCSS(),console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection))}processCues(e){if(!e)return;for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(!(function(e){for(let t=0;t<e.length;t++)if(e[t].hasBeenReset||!e[t].displayState)return!0;return!1})(e)){for(let t=0;t<e.length;t++)this.paddedOverlay.appendChild(e[t].displayState);return}const t=[],i=p.getSimpleBoxPosition(this.paddedOverlay);e.length>1&&(e=(function(e){const t=[];let i=0;for(let s=0;s<e.length;s++){let a=e[s];if("number"!=typeof a.line)return e;i+=a.line,t.push(a)}return(i/=e.length)>50?(t.forEach((function(e){e.axis="-y"})),t.sort((e,t)=>t.line-e.line)):(t.forEach((function(e){e.axis="+y"})),t.sort((e,t)=>e.line-t.line)),t})(e));for(let s=0;s<e.length;s++){let a=e[s],r=new m(this.window,a,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(r.div),p.moveBoxToLinePosition(r,i,t),a.displayState=r.div,t.push(p.getSimpleBoxPosition(r))}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}}t.default=y,t.WebVTTRenderer=y}),(function(e,t,i){"use strict";function s(e){var t={};function i(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw console.error(e),e};var s=i(i.s=ENTRY_MODULE);return s.default||s}var a="[\\.|\\-|\\+|\\w|/|@]+",r="\\((/\\*.*?\\*/)?s?.*?("+a+").*?\\)";function n(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function o(e,t,s){var o={};o[s]=[];var l=t.toString(),d=l.match(/^function\s?\(\w+,\s*\w+,\s*(\w+)\)/);if(!d)return o;for(var h,c=d[1],u=new RegExp("(\\\\n|\\W)"+n(c)+r,"g");h=u.exec(l);)"dll-reference"!==h[3]&&o[s].push(h[3]);for(u=new RegExp("\\("+n(c)+'\\("(dll-reference\\s('+a+'))"\\)\\)'+r,"g");h=u.exec(l);)e[h[2]]||(o[s].push(h[1]),e[h[2]]=i(h[1]).m),o[h[2]]=o[h[2]]||[],o[h[2]].push(h[4]);for(var f,g=Object.keys(o),m=0;m<g.length;m++)for(var p=0;p<o[g[m]].length;p++)f=o[g[m]][p],isNaN(1*f)||(o[g[m]][p]=1*o[g[m]][p]);return o}function l(e){return Object.keys(e).reduce((function(t,i){return t||e[i].length>0}),!1)}e.exports=function(e,t){t=t||{};var a={main:i.m},r=t.all?{main:Object.keys(a.main)}:(function(e,t){for(var i={main:[t]},s={main:[]},a={main:{}};l(i);)for(var r=Object.keys(i),n=0;n<r.length;n++){var d=r[n],h=i[d].pop();if(a[d]=a[d]||{},!a[d][h]&&e[d][h]){a[d][h]=!0,s[d]=s[d]||[],s[d].push(h);for(var c=o(e,e[d][h],d),u=Object.keys(c),f=0;f<u.length;f++)i[u[f]]=i[u[f]]||[],i[u[f]]=i[u[f]].concat(c[u[f]])}}return s})(a,e),n="";Object.keys(r).filter((function(e){return"main"!==e})).forEach((function(e){for(var t=0;r[e][t];)t++;r[e].push(t),a[e][t]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",n=n+"var "+e+" = ("+s.toString().replace("ENTRY_MODULE",JSON.stringify(t))+")({"+r[e].map((function(t){return JSON.stringify(t)+": "+a[e][t].toString()})).join(",")+"});\n"})),n=n+"new (("+s.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+r.main.map((function(e){return JSON.stringify(e)+": "+a.main[e].toString()})).join(",")+"}))(self);";var d=new window.Blob([n],{type:"text/javascript"});if(t.bare)return d;var h=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(d),c=new window.Worker(h);return c.objectURL=h,c}}),(function(e,t,i){"use strict";i.r(t);var s=i(11),a=i(0),r=i(9),n=i(2);t.default=function(e){var t=new r.EventEmitter;t.trigger=function(e,...i){t.emit(e,e,...i)},t.off=(e,...i)=>t.removeListener(e,...i);const i=(t,i)=>e.postMessage({event:t,data:i});e.addEventListener("message",(function({data:a}){switch(a.cmd){case"init":let r=JSON.parse(a.config);e.demuxer=new s.a(t,a.typeSupported,r,a.vendor);try{n.b.enable(!0===r.debug,r.debugLevel),n.b.setStreamAndSessionIDs(a.options.sessionID,a.options.streamID)}catch(e){console.warn("demuxerWorker: unable to enable logs")}i("init",null);break;case"demux":e.demuxer.push(a.data,a.decryptdata,a.initSegment,a.audioCodec,a.videoCodec,a.timeOffset,a.discontinuity,a.trackSwitch,a.contiguous,a.duration,a.accurateTimeOffset,a.defaultInitPTS,a.iframeMediaStart,a.iframeDuration)}})),t.on(a.a.FRAG_DECRYPTED,i),t.on(a.a.FRAG_PARSING_INIT_SEGMENT,i),t.on(a.a.FRAG_PARSED,i),t.on(a.a.ERROR,i),t.on(a.a.FRAG_PARSING_METADATA,i),t.on(a.a.FRAG_PARSING_USERDATA,i),t.on(a.a.FRAG_PARSING_CAPTIONDATA,i),t.on(a.a.INIT_PTS_FOUND,i),t.on(a.a.FRAG_PARSING_DATA,(t,i)=>{let s=[],a={event:t,data:i};i.data1&&(a.data1=i.data1.buffer,s.push(i.data1.buffer),delete i.data1),i.data2&&(a.data2=i.data2.buffer,s.push(i.data2.buffer),delete i.data2),e.postMessage(a,s)})}}),(function(e,t,i){"use strict";i.r(t);var s=i(12),a=i(9),r=i(2);t.default=function(e){const t=new a.EventEmitter;t.trigger=(e,...i)=>{t.emit(e,e,...i)},t.off=(e,...i)=>t.removeListener(e,...i);const i=(t,i,s)=>{s?e.postMessage({event:t,fragObjId:i,data:s},[s]):e.postMessage({event:t,data:s})};e.addEventListener("message",({data:a})=>{switch(a.cmd){case"init":const n=JSON.parse(a.config);e.decryptor=new s.a(t,n);try{r.b.enable(!0===n.debug,n.debugLevel)}catch(e){console.warn("SegmentDecryptorWorker: unable to enable logs")}i("init",null);break;case"segment-decrypt":a=a,e.decryptor.decrypt(a.fragPayload,a.decryptdata,e=>{i("segment-decrypted",a.fragObjId,e)})}})}}),(function(e,t,i){"use strict";i.r(t);var s=i(0),a=i(1),r=/^((?:[^\/;?#]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,n=/^([^\/;?#]*)(.*)$/,o=/(?:\/|^)\.(?=\/)/g,l=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g;const d={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),!(t=t.trim())){if(!i.alwaysNormalize)return e;var s=d.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");return s.path=d.normalizePath(s.path),d.buildURLFromParts(s)}var a=d.parseURL(t);if(!a)throw new Error("Error trying to parse relative URL.");if(a.scheme)return i.alwaysNormalize?(a.path=d.normalizePath(a.path),d.buildURLFromParts(a)):t;var r=d.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");if(!r.netLoc&&r.path&&"/"!==r.path[0]){var o=n.exec(r.path);r.netLoc=o[1],r.path=o[2]}r.netLoc&&!r.path&&(r.path="/");var l={scheme:r.scheme,netLoc:a.netLoc,path:null,params:a.params,query:a.query,fragment:a.fragment};if(!a.netLoc&&(l.netLoc=r.netLoc,"/"!==a.path[0]))if(a.path){i.inheritQuery&&(a.query||(l.query=r.query));var h=r.path,c=h.substring(0,h.lastIndexOf("/")+1)+a.path;l.path=d.normalizePath(c)}else l.path=r.path,a.params||(l.params=r.params,a.query||(l.query=r.query));return null===l.path&&(l.path=i.alwaysNormalize?d.normalizePath(a.path):a.path),d.buildURLFromParts(l)},parseURL:function(e){var t=r.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(o,"");e.length!==(e=e.replace(l,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment},getHostName:function(e){return(e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split(":")[0].split("?")[0]}};var h=d,c=i(2);class u{constructor(e){this.logger=e,null!=e||(this.logger=c.b)}destroy(){this.abort()}abort(){clearTimeout(this.firstByteLoadTimeout),this.firstByteLoadTimeout=null,clearTimeout(this.fullLoadTimeout),this.fullLoadTimeout=null,clearTimeout(this.retryTimeout),this.retryTimeout=null}load(e,t,i){this.context=e,this.config=t,this.callbacks=i,this.stats={aborted:!1,trequest:performance.now(),tfirst:0,loaded:0,retry:0},this.loadInternal()}loadsuccess(e,t){let i,s,a=this.context,r=this.stats;r.tload=Math.max(r.tfirst,performance.now()),s="arraybuffer"===a.responseType?(i=e.response).byteLength:(i=e.responseText).length,r.tdataack=performance.now(),r.loaded=r.total=s,r.contentType=e.getResponseHeader("Content-Type");let n={url:e.responseURL,data:i,len:s,contentLen:t};this.callbacks.onSuccess(n,r,a),r.retry=0}loaderror(e,t){if(this.abort(),this.retryConfig=this.config.errorRetry,!this.config.autoRetry||e>=400&&e<499||!this.scheduleRetry()){this.logger.error(`[QE Critical] ${e} while loading url type: ${this.type}`)();let i={code:e,text:t};this.callbacks.onError(i,this.context)}}scheduleRetry(){let e=this.stats,t=!1,i=this.retryConfig;if(clearTimeout(this.retryTimeout),e.retry<i.maxNumRetry){let s=Math.min(Math.pow(2,e.retry)*i.retryDelayMs,i.maxRetryDelayMs);e.retry++,e.aborted=!1,this.logger.warn(`[QE Critical] current retryCount ${e.retry} schedule retry in ${s} ms`)(),this.retryTimeout=setTimeout(this.loadInternal.bind(this),s),t=!0}return t}resetStats(){let e=this.stats;e.aborted=!1,e.tfirst=0,e.loaded=0,e.trequest=performance.now()}setupTimeouts(){isFinite(this.config.maxLoadTimeMs)&&this.config.maxLoadTimeMs>0&&(this.fullLoadTimeout=setTimeout(this.loadtimeout.bind(this,!1),this.config.maxLoadTimeMs)),isFinite(this.config.maxTimeToFirstByteMs)&&this.config.maxTimeToFirstByteMs>0&&(this.firstByteLoadTimeout=setTimeout(this.loadtimeout.bind(this,!0),this.config.maxTimeToFirstByteMs))}loadtimeout(e){this.abort();let t=e?"maxTimeToFirstByteMs":"maxLoadTimeMs";this.logger.warn(`[QE Critical] timeout while loading url type: ${this.type}, this.config.${t}: ${this.config[t]}`)(),this.retryConfig=this.config.timeoutRetry,this.callbacks.onTimeout(this.stats,this.context)}}var f=class extends u{constructor(e,t){super(t),e&&e.xhrSetup&&(this.xhrSetup=e.xhrSetup)}abort(){var e=this.request;e&&4!==e.readyState&&(this.stats.aborted=!0,e.abort()),this.request=null,super.abort()}get loader(){return this.request}overrideMimeType(e){this.request&&typeof this.request.overrideMimeType==typeof Function?this.request.overrideMimeType(e):this.mimeType=e}responseXML(){let e=null;return this.request&&this.request.responseXML&&(e=this.request.responseXML),e}loadInternal(){var e,t=this.context;"undefined"!=typeof XDomainRequest?e=this.request=new XDomainRequest:(e=this.request=new XMLHttpRequest,this.mimeType&&typeof this.request.overrideMimeType==typeof Function&&this.request.overrideMimeType(this.mimeType)),this.resetStats();const i=this.xhrSetup;let s=t.method?t.method:"GET";try{if(i)try{i(e,t.url)}catch(a){e.open(s,t.url,!0),i(e,t.url)}e.readyState||e.open(s,t.url,!0)}catch(i){return void this.callbacks.onError({code:e.status,text:i.message},t)}t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,this.setupTimeouts(),"POST"===s&&t.payload?e.send(t.payload):e.send()}getByteRangeLength(e){let t=/([0-9]+)\-([0-9]+)\/([0-9]+)/.exec(e);return t?parseInt(t[2])-parseInt(t[1])+1:void 0}getContentLength(e){let t,i=e.getResponseHeader("Content-Encoding"),s=e.getResponseHeader("Transfer-Encoding"),a=!i||i&&"identity"===i.toLowerCase(),r=!s||s&&"identity"===s.toLowerCase();return a&&r&&(t=this.getByteRangeLength(e.getResponseHeader("Content-Range")),isNaN(t)&&(t=parseInt(e.getResponseHeader("Content-Length")))),t}readystatechange(e){var t=e.currentTarget,i=t.readyState,s=this.stats;if(this.context,this.config,!s.aborted&&i>=2&&(0===s.tfirst&&(s.tfirst=Math.max(performance.now(),s.trequest)),this.firstByteLoadTimeout&&(clearTimeout(this.firstByteLoadTimeout),this.firstByteLoadTimeout=null),s.cdnServer=t.getResponseHeader("CDN-Server"),4===i)){this.fullLoadTimeout&&(clearTimeout(this.fullLoadTimeout),this.fullLoadTimeout=null);let e=t.status;e>=200&&e<300?this.loadsuccess(t,this.config.forceContentLenCheckIfNoHeader?this.getContentLength(t):void 0):this.loaderror(e,t.statusText)}}loadprogress(e){var t=e.currentTarget,i=this.stats;let s=this.callbacks.onProgress;s&&3===t.readyState&&(i.loaded=e.loaded,e.lengthComputable&&(i.total=e.total),s(i,this.context,this.request.response))}get type(){let e=this.context;return e&&(e.frag&&e.frag.type||e.type)||""}},g=i(4),m=class extends u{constructor(e){super(e.logger),this.hls=e,this._loader=void 0}abort(){this.onuriloaded&&(this.hls.off(s.a.UNRESOLVED_URI_LOADED,this.onuriloaded),this.onuriloaded=void 0);var e=this._loader;e&&(e.abort(),this.stats.aborted=e.stats.aborted),this._loader=void 0,super.abort()}loadInternal(){var e=this.context;this.resetStats(),this.setupTimeouts(),this.onuriloaded=this.onUnresolvedUriLoaded.bind(this),this.hls.on(s.a.UNRESOLVED_URI_LOADED,this.onuriloaded);let t={uri:e.url,userAgent:navigator.userAgent};this.hls.trigger(s.a.UNRESOLVED_URI_LOADING,t)}onUnresolvedUriLoaded(e,t){let i=t.uri,s=t.response;this.context.url===i&&this.handleExternalResponse(s)}handleExternalResponse(e){if(this.hls.off(s.a.UNRESOLVED_URI_LOADED,this.onuriloaded),this.stats.aborted)return;let t=this.stats,i=this.context;0===t.tfirst&&(t.tfirst=Math.max(performance.now(),t.trequest)),this.fullLoadTimeout&&(clearTimeout(this.fullLoadTimeout),this.fullLoadTimeout=null),this.firstByteLoadTimeout&&(clearTimeout(this.firstByteLoadTimeout),this.firstByteLoadTimeout=null);let a=e.status||200;if(a>=200&&a<300)this.loadsuccess({responseURL:i.url,response:e.data,get responseText(){return g.a.utf8arrayToStr(new Uint8Array(this.response))},getResponseHeader:()=>{}});else{let t;switch(a){case 300:case 302:case 303:case 305:t=e.uri}t?this.redirectRequest(t):this.loaderror(a,"Unable to load custom url")}}redirectRequest(e){let t=this.stats,i=this.config;this._loader=new f(this.hls.config);let s=function(e){let t=this.stats.trequest;this.stats=Object.assign({},e),this.stats.trequest=t}.bind(this),a=Object.assign({},this.context),r=Object.assign({},this.config),n={onSuccess:function(e,t){s(t),this.callbacks.onSuccess(e,this.stats,this.context)}.bind(this),onError:function(e){this.callbacks.onError(e,this.context)}.bind(this),onTimeout:function(e){s(e),this.loadtimeout(!1)}.bind(this),onProgress:function(e,t,i){this.stats.loaded=e.loaded,e.total&&(this.stats.total=e.total),this.callbacks.onProgress&&this.callbacks.onProgress(this.stats,this.context,i)}.bind(this)};a.url=e,r.maxLoadTimeMs=i.maxLoadTimeMs-(performance.now()-t.trequest),r.maxTimeToFirstByteMs=i.maxTimeToFirstByteMs-(performance.now()-t.trequest),!isFinite(i.maxLoadTimeMs)||i.maxLoadTimeMs<=0||r.maxLoadTimeMs>0&&r.maxTimeToFirstByteMs>0?this._loader.load(a,r,n):r.maxTimeToFirstByteMs<=0?this.loadtimeout(!0):r.maxLoadTimeMs<=0&&this.loadtimeout(!1)}get loader(){return this._loader?this._loader.loader:void 0}static isCustomUrl(e){let t=d.parseURL(e);return"http:"!==t.scheme&&"https:"!==t.scheme}overrideMimeType(e){}responseXML(){}get type(){return this.context?this.context.type:""}},p=i(6);const y={avc1:"video/mp4",avc3:"video/mp4",dvav:"video/mp4",dva1:"video/mp4",hev1:"video/mp4",hvc1:"video/mp4",dvh1:"video/mp4",dvhe:"video/mp4"};var v={mp4a:"audio/mp4","ac-3":"audio/mp4","ec-3":"audio/mp4"};function T(e){let t=g.a.strToUtf8array(e).subarray(0,16),i=new Uint8Array(16);return i.set(t,16-t.length),i}var S={getCapabilities:function(e,t){let i={videoCapabilities:new Array,audioCapabilities:new Array};return e&&e.forEach((function(e){let t=e.split(".")[0].trim();t in y&&i.videoCapabilities.push({contentType:y[t]+";codecs="+e,robustness:""})})),t&&t.forEach((function(e){let t=e.split(".")[0].trim();t in v&&i.audioCapabilities.push({contentType:v[t]+";codecs="+e,robustness:""})})),i},getKeyIdBytes:T,convertDataUriToArrayBytes:function(e){let t=e.split(":"),i=null;if("data"===t[0]&&2===t.length){let e=t[1].split(";"),s=e[e.length-1].split(",");if(2===s.length){let t="base64"===s[0],a=s[1];t?(e.splice(-1,1),i=p.a.base64Decode(a)):i=T(a)}}return i},makeKeyIdsInitData:function(e){let t={kids:e.map(p.a.base64UrlEncode)};return g.a.strToUtf8array(JSON.stringify(t))},parsePSSHList:function(e){let t=new DataView(e),i=0,s={};for(;i<t.buffer.byteLength;){let e,a=i,r=t.getUint32(i);if(i+=4,e=a+r,1886614376!==t.getUint32(i)){i=e;continue}switch(i+=4,t.getUint8(i)){case 0:case 1:i+=1;break;default:i=e}i+=3;let n="";for(let e=0;e<16;++e,++i)switch(n+=t.getUint8(i).toString(16),e){case 4:case 6:case 8:case 10:n+="-"}i+=4,s[n]=t.buffer.slice(a,e)}return s}},b={id:"playready",systemStringPrefix:"com.microsoft.playready",keyFormatString:"com.microsoft.playready"},_={id:"widevine",systemStringPrefix:"com.widevine.alpha",keyFormatString:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};const E={NONE:"","AES-128":"","ISO-23001-7":"","SAMPLE-AES":"","SAMPLE-AES-CTR":""};let R={};class D{constructor(e,t,i,s,a){if(this.method=e,this.uri=t,this.iv=i,this.format=s,this.formatversions=a,this.isEncrypted=this.method&&"NONE"!==this.method,this.formatversions&&0!==this.formatversions.length||(this.formatversions=[1]),this.key=null,this.keyId=null,!this.isEncrypted)return;let r=S.convertDataUriToArrayBytes(this.uri);if(r)switch(s){case b.keyFormatString:{this.pssh=r;let e=new Uint16Array(r.buffer);var n,o=String.fromCharCode.apply(null,e),l=o.substring(o.indexOf("<"),o.length),d=(new DOMParser).parseFromString(l,"text/xml").getElementsByTagName("KID")[0];if(d)(n=d.childNodes[0]?d.childNodes[0].nodeValue:d.getAttribute("VALUE"))&&(this.keyId=p.a.base64Decode(n).subarray(0,16));break}case _.keyFormatString:this.pssh=r,r.length>=22&&(this.keyId=r.subarray(r.length-22,r.length-6));break;default:{let e=r.subarray(0,16);if(16!==e.length){let t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=R[this.uri];if(!e){let t=Object.keys(R).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16),new DataView(e.buffer,12,4).setUint32(0,t),R[this.uri]=e}this.keyId=e}}static clearKeyUriToKeyIdMap(){R={}}}var L=D;const I={afr:"af",aka:"ak",amh:"am",ara:"ar",arg:"an",asm:"as",ava:"av",ave:"ae",aym:"ay",aze:"az",bam:"bm",bel:"be",ben:"bn",bih:"bh",bod:"bo",bos:"bs",bre:"br",bul:"bg",cat:"ca",ces:"cs",cha:"ch",che:"ce",chu:"cu",chv:"cv",cor:"kw",cos:"co",cre:"cr",cym:"cy",dan:"da",deu:"de",div:"dv",dzo:"dz",ell:"el",eng:"en",epo:"eo",est:"et",eus:"eu",ewe:"ee",fao:"fo",fas:"fa",fin:"fi",fra:"fr",fry:"fy",ful:"ff",gla:"gd",gle:"ga",glg:"gl",glv:"gv",grn:"gn",guj:"gu",hat:"ht",heb:"he",her:"hz",hin:"hi",hmo:"ho",hrv:"hr",hun:"hu",hye:"hy",ibo:"ig",ido:"io",iii:"ii",iku:"iu",ile:"ie",ina:"ia",ind:"id",isl:"is",ita:"it",jav:"jv",jpn:"ja",kal:"kl",kan:"kn",kas:"ks",kat:"ka",kau:"kr",kaz:"kk",khm:"km",kik:"ki",kin:"rw",kir:"ky",kom:"kv",kon:"kg",kor:"ko",kua:"kj",kur:"ku",lao:"lo",lat:"la",lav:"lv",lim:"li",lit:"lt",ltz:"lb",lub:"lu",lug:"lg",mah:"mh",mal:"ml",mar:"mr",mkd:"mk",mlg:"mg",mlt:"mt",mol:"mo",mon:"mn",mri:"mi",msa:"ms",mya:"my",nav:"nv",nbl:"nr",nde:"nd",ndo:"ng",nep:"ne",nld:"nl",nno:"nn",nob:"nb",nya:"ny",oci:"oc",oji:"oj",ori:"or",orm:"om",oss:"os",pan:"pa",pli:"pi",pol:"pl",por:"pt",pus:"ps",que:"qu",roh:"rm",ron:"ro",run:"rn",rus:"ru",san:"sa",sin:"si",slk:"sk",slv:"sl",sme:"se",snd:"sd",som:"so",spa:"es",sqi:"sq",srd:"sc",srp:"sr",sun:"su",swa:"sw",swe:"sv",tah:"ty",tam:"ta",tat:"tt",tel:"te",tgk:"tg",tgl:"tl",tha:"th",tir:"ti",ton:"to",tuk:"tk",tur:"tr",uig:"ug",ukr:"uk",urd:"ur",uzb:"uz",ven:"ve",vie:"vi",wln:"wa",yid:"yi",zha:"za",zho:"zh"},A={isLanguageCode:function(e){return e in I},shortenLanguageCode:function(e){let t;if(e){let i=e.indexOf("-"),s=i>=0?e.slice(0,i):e;A.isLanguageCode(s)&&(t=I[s]),t||(t=s),i>0&&(t+="-"+e.slice(i+1))}return t}};var k=A;class C{constructor(e){this._url=null,this._byteRange=null,this.inheritQuery=e,this.tagList=new Array,this.loadCounter=0}equals(e){return e.sn===this.sn&&e.level===this.level}get url(){return!this._url&&this.relurl&&(this._url=d.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0,inheritQuery:this.inheritQuery})),this._url}set url(e){this._url=e}get programDateTime(){return!this._programDateTime&&this.rawProgramDateTime&&(this._programDateTime=new Date(Date.parse(this.rawProgramDateTime))),this._programDateTime}get byteRange(){if(!this._byteRange){let e=new Array(2);if(this.rawByteRange){const t=this.rawByteRange.split("@",2);if(1===t.length){const t=this.lastByteRangeEndOffset;e[0]=t||0}else e[0]=parseInt(t[1]);e[1]=parseInt(t[0])+e[0]}this._byteRange=e}return this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get decryptdata(){return this._decryptdata||(this._decryptdata=this.fragmentDecryptdataFromLevelkey(this.levelkey,this.sn)),this._decryptdata}set decryptdata(e){this._decryptdata=e}static createInitializationVector(e){for(var t=new Uint8Array(16),i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}fragmentDecryptdataFromLevelkey(e,t){var i=e;if(e&&e.method&&e.uri&&!e.iv&&(!e.format||"identity"===e.format)){let s=C.createInitializationVector(t);i=new L(e.method,e.uri,s,e.format,e.formatversions)}return i}get rangeString(){return this.start>=0&&this.duration>=0?`${this.start.toFixed(2)}-${(this.start+this.duration).toFixed(2)}`:"N/A"}}var w=C,P=class{constructor(e,...t){this.hls=e,this.destroyed=!1,this.hls=e,this.logger=e.logger,this.onEvent=this.onEvent.bind(this),this.handledEvents=t,this.registerListeners()}destroy(){this.destroyed=!0,this.unregisterListeners()}registerListeners(){for(const e of this.handledEvents)this.hls.on(e,this.onEvent)}unregisterListeners(){for(const e of this.handledEvents)this.hls.off(e,this.onEvent)}onEvent(e,t){if(this.destroyed)this.logger.warn(`Event fired after event handler is destroyed! Event name: ${e}`)();else try{const i="on"+e.replace("hls",""),r=this[i];if("function"!=typeof r)throw new Error(`Event ${e} has no generic handler in this ${this.constructor.name} class (tried ${i})`);r.call(this,t)}catch(t){this.logger.error(`internal error happened while processing ${e}:${t.message} ${t.stack}`)(),this.hls.trigger(s.a.ERROR,{type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!1,event:e,err:t,response:a.b.InternalError})}}};const M={"com.apple.hls.chapters":!0},O={JSON_PARSE_ERROR:-1};var N=function(e){if(!e.complete&&e.itemList){e.complete=!0;for(let t=0;t<e.itemList.length;++t){let i=e.itemList[t];if(M[i["DATA-ID"]]&&!i.VALUE&&!i._STATUS){e.complete=!1;break}}e.complete}return e.complete};class x extends P{constructor(e){super(e,s.a.SESSION_DATA_LOADING),this.loader=null,this.nextSessionDataItemId=0}destroy(){this.loader&&this.loader.destroy(),P.prototype.destroy.call(this)}onSessionDataLoading(e){this.loadSessionData(e.sessionData)}loadSessionData(e){let t,i,a,r=!1;for(;!1===r&&e.itemList&&this.nextSessionDataItemId<e.itemList.length;){let s=e.itemList[this.nextSessionDataItemId];i=s["DATA-ID"],s.URI&&M[i]&&(t=h.buildAbsoluteURL(this.hls.baseurl,s.URI,{alwaysNormalize:!0}),a="",s.VALUE=null,r=!0,this.loadSessionDataItemWithURL(t,i,"")),this.nextSessionDataItemId=this.nextSessionDataItemId+1}!1===r&&N(e)&&this.hls.trigger(s.a.SESSION_DATA_COMPLETE,{})}loadSessionDataItemWithURL(e,t,i){let s,a,r,n=this.loader,o=this.hls.config;n&&n.abort(),n=this.loader=m.isCustomUrl(e)?new m(this.hls):new o.loader(o),this.loader.overrideMimeType("application/xml"),s={type:"session",url:e,id:t,responseType:i},a=m.isCustomUrl(e)?o.fragLoadPolicy.customURL:o.fragLoadPolicy.default,r={onSuccess:this.onLoadSuccess.bind(this),onError:this.onLoadError.bind(this),onTimeout:this.onLoadTimeout.bind(this)},n.load(s,a,r)}stringIsXMLPlist(e){const t=/[\s]*<\?xml/i;let i,s;return t.lastIndex=0,(i=t.exec(e))||(s=/[\s]*<plist/i.exec(e)),i||s}stringIsJSONPlist(e){const t=/[\s]*[\{\[]/;return t.lastIndex=0,null!=t.exec(e)}onLoadSuccess(e,t,i){let s,a=this.hls,r=e.data,n=i.id,o=null;if(this.stringIsXMLPlist(r)&&(o=this.loader.responseXML()))s=this.convertPlisttoJSON(o),this.setSessionData(a.sessionData,n,"VALUE",s);else if(this.stringIsJSONPlist(r))try{s=JSON.parse(r),this.setSessionData(a.sessionData,n,"VALUE",s)}catch(e){this.setSessionData(a.sessionData,n,"VALUE",r),this.setSessionData(a.sessionData,n,"_STATUS",O.JSON_PARSE_ERROR)}else this.setSessionData(a.sessionData,n,"VALUE",r);this.loadSessionData(this.hls.sessionData),this.loader=void 0}onLoadError(e,t){let i=t.url,r=t.id;this.loader=void 0,this.setSessionData(this.hls.sessionData,r,"_STATUS",e.code),this.hls.trigger(s.a.ERROR,{type:a.c.NETWORK_ERROR,details:a.a.SESSION_DATA_LOAD_ERROR,fatal:!1,id:r,url:i,response:e})}onLoadTimeout(e,t){let i=t.url,r=t.id;this.loader=void 0,this.hls.trigger(s.a.ERROR,{type:a.c.NETWORK_ERROR,details:a.a.SESSION_DATA_LOAD_TIMEOUT,fatal:!1,id:r,url:i})}setSessionData(e,t,i,s){if(e.itemList){let a;for(a=0;a<e.itemList.length;++a){let r=e.itemList[a];if(r["DATA-ID"]===t){r[i]=s;break}}e.itemList.length}}convertPlisttoJSON(e){var t=null,i=e.childNodes;if(i)if(e.tagName){if("plist"===e.tagName.toLowerCase()){t=[];for(let e=0;e<i.length;++e){let s=i[e];s.tagName&&t.push(this.convertPlisttoJSON(s))}1===t.length&&(t=t[0])}if("array"===e.tagName.toLowerCase()){t=[];for(let e=0;e<i.length;++e){let s=i[e];s.tagName&&t.push(this.convertPlisttoJSON(s))}}if("dict"===e.tagName.toLowerCase()){var s,a,r=0;t={};for(let e=0;e<i.length;e++)i[e].tagName&&(r%2==0?"key"===i[e].tagName.toLowerCase()&&(s=this.convertPlisttoJSON(i[e]),r++):(a=this.convertPlisttoJSON(i[e]),t[s]=a,s=null,a=null,r++));s&&(t[s]=a,s=null,a=null)}else"key"===e.tagName.toLowerCase()?t=i[0]?i[0].nodeValue:null:"string"===e.tagName.toLowerCase()?t=i[0]?i[0].nodeValue:null:"integer"===e.tagName.toLowerCase()?t=i[0]?parseInt(i[0].nodeValue):0:"float"===e.tagName.toLowerCase()?t=i[0]?parseFloat(i[0].nodeValue):0:"date"===e.tagName.toLowerCase()?t=i[0]?new Date(i[0].nodeValue):null:"data"===e.tagName.toLowerCase()?t=i[0]?atob(i[0].nodeValue):null:"true"===e.tagName.toLowerCase()?t=!0:"false"===e.tagName.toLowerCase()&&(t=!1)}else if(0===i.length);else{t=[];for(let e=0;e<i.length;++e){let s=i[e];s.tagName&&t.push(this.convertPlisttoJSON(s))}1===t.length&&(t=t[0])}return t}}const F={canplay:"canplay",desiredratechange:"desiredratechange",pause:"pause",playing:"playing",ended:"ended",mediaerror:"mediaerror",playbackinfo:"playbackinfo",manifestparsed:"manifestparsed",manifestloaded:"manifestloaded",fragloading:"fragloading",fragloaded:"fragloaded",fragbuffered:"fragbuffered",variantend:"variantend",segmentkeyloaded:"segmentkeyloaded",levelloaded:"levelloaded",levelloaderror:"levelloaderror",levelswitched:"levelswitched",bufferstalled:"bufferstalled",mediaenginestalled:"mediaenginestalled",nwerror:"nwerror",spcrequested:"spcrequested",spcreceived:"spcreceived",spcsubmitted:"spcsubmitted",spccreated:"spccreated",ckcrequested:"ckcrequested",ckcreceived:"ckcreceived",ckcsubmitted:"ckcsubmitted",ckcprocessed:"ckcprocessed",keyaborted:"keyaborted",spcerror:"spcerror",ckcerror:"ckcerror"},B=6101,U=6103,V=6106,G=6107,$=6108,K=6202,W=["PlayTimeWC","PlayTime","PlayType","StallCount","MediaEngineStallCount","InitTime","PauseTime","StallTime","LastPause","LastStall","LastMediaEngineStall","MediaEngineStallTime","ADT","SegmentProcessTime","SegmentParseTime","PlaylistADT","MaxPlaylistDT","MasterPlaylistADT","NwErrCount","PlayerErrCount","FatalNwErrCount","FatalPlayerErrCount","GroupViFrDr","GroupViFrDrEvtCount","SparseViFrDr","SparseViFrDrEvtCount","AvgVideoBitrate","AvgAudioBitrate","TWOBR","PerceivedTWOBR","NetTWOBR","PlayerTWIBR","PlayerTWIABR","TWBitRk","SwCnt","NetBytes","TargetDur","VariantList","PlaylistMimeType","SegmentMimeType","MediaRequestsSent","Rate","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],H=["EventCounter","PInterval","PlayTimeWC","PlayTime","PlayType","StallCount","MediaEngineStallCount","InitTime","PauseTime","StallTime","MediaEngineStallTime","ADT","SegmentProcessTime","SegmentParseTime","PlaylistADT","MaxPlaylistDT","MasterPlaylistADT","NwErrCount","PlayerErrCount","FatalNwErrCount","FatalPlayerErrCount","GroupViFrDr","GroupViFrDrEvtCount","SparseViFrDr","SparseViFrDrEvtCount","AvgVideoBitrate","AvgAudioBitrate","TWOBR","PerceivedTWOBR","NetTWOBR","PlayerTWIBR","PlayerTWIABR","TWBitRk","SwCnt","NetBytes","TargetDur","VariantList","MediaRequestsSent","Rate","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],q=["MediaDur","BitRnk","Codecs","PlayTime","PlayType","LastLikelyToKeepUp","LastSwitch","LastResume","NwErrTime","NwErrCode","LaSwDir","TargetDur","PlayerIABR","PlayerIBR","Rate","OBRLast","OBRMean","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],j=["KeyFormat","CDMVersion","SPCRequestTime","SPCCreationTime","CKCResponseTime","CKCProcessTime","KeyDeliveryTime","CurrentMediaTime","KeyInitTime","KeyErrorType","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],Y=["EventCounter","PlayType","PlayerIABR","PlayerIBR","MediaDur","BitRnk","Codecs","StartupTime","PlaylistADT","TargetDur","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],z=["Rate","PlayType","StNPT","StartupTime","PlayerIABR","PlayerIBR","BitRnk","MediaDur","Codecs","LastPause","LastStall","LastMediaEngineStall","RateChangePlayTime","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],Q=["ErrCode","ErrIsFatal","PlayerErrCount","ErrDomain","PlayType","BitRnk","MediaDur","PlayTime","PlayTimeWC","PlayerIABR","PlayerIBR","LastStall","LastMediaEngineStall","LastLikelyToKeepUp","LastSwitch","LastResume","VideoQltyIndex","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],X=["MediaDur","BitRnk","Codecs","PlayTime","PlayType","LastLikelyToKeepUp","LastSwitch","LastResume","LaSwDir","TargetDur","PlayerIABR","PlayerIBR","Rate","OBRLast","OBRMean","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],J=["FrBitRnk","ToBitRnk","TimeToBitrate","MediaDur","Rate","PlayType","SwFail","PlayerIBR","PlayerIABR","LastPlayerIBR","LastPlayerIABR","PlayTime","PlayTimeLastSW","BadSw","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],Z=["Rate","PlayType","VarAvgBitrate","VarPeakBitrate","VarBitRk","VarSTTime","VarEndTime","VarPlayTime","VarPlayTimeWC","IFR","ODR","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],ee=["ErrCode","ErrReason","ErrIsFatal","NwErrCount","ErrDomain","PlayTime","PlayTimeWC","LastResume","BitRnk","PlayType","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt"],te="rtcStateInit",ie="rtcStatePause",se="rtcStatePlay",ae="rtcStateStall",re="rtcStateMediaEngineStall",ne="rtcStateStop",oe=[V,U,$,K,G,B],le=["aapl","akam","llnw"],de={avc1:1,avc3:1,hvc1:{SDR:2,HLG:10,PQ:11},hev1:{SDR:2,HLG:10,PQ:11},dvh1:{PQ:12}};var he={id:"fairplaystreaming",systemStringPrefix:"com.apple.fps",keyFormatString:"com.apple.streamingkeydelivery"};const ce={video:["avc1.42E01E"],audio:["mp4a.40.2"]};class ue extends P{constructor(e,t){super(e,s.a.MANIFEST_LOADING,s.a.MEDIA_ATTACHING,s.a.MEDIA_DETACHING),this.keyLoader=t,this.protectionData={},this.keySystem=void 0,this.keySystemId=void 0,this.createMediaKeysPromise=void 0,this.setMediaKeysPromise=void 0,!0===e.config.warmupCdms&&ue.warmupCDM()}static warmupCDM(){return ze.createMediaKeys(he.id,ce.video,ce.audio,[])}destroy(){this.reset()}reset(){this.keySystem&&(this.keySystem.shouldDestroyMediaKeys&&ze.destroyMediaKeys(),this.keySystem.destroy(),this.keySystem=void 0),this.keySystemId=void 0,this.createMediaKeysPromise=void 0,this.setMediaKeysPromise=void 0}cleanMediaKeys(e){e.setMediaKeys(null).catch(this.onMediaKeysError.bind(this))}onManifestLoading(){this.reset()}onMediaAttaching(e){if(this.media=e.media,this.keySystem)this.setMediaKeys(this.keySystem.mediaKeys);else if(this.hls.platformInfo&&this.hls.platformInfo.requiresCDMAttachOnStart&&!0===this.hls.platformInfo.requiresCDMAttachOnStart){let e=this.hls.config.keySystemPreference?ze.getKeySystemFormat(this.hls.config.keySystemPreference):he.keyFormatString;this.createAndSetMediaKeys(new L("NONE",null,null,e,[1]))}}onMediaDetaching(){let e=this.media;this.hls.config.clearMediaKeysOnPromise&&this.setMediaKeysPromise?this.setMediaKeysPromise.then(this.cleanMediaKeys.bind(this,e)):this.cleanMediaKeys(e),this.setMediaKeysPromise=void 0,this.reset()}ensureKeySystem(e){if(!this.keySystem&&this.keySystemId){this.keySystem=ze.make(this.keySystemId,this.hls,e,this.keyLoader);let t=this.protectionData&&this.protectionData[this.keySystemId];t&&(this.keySystem.setLicenseServer(t.licenseServerUrl),this.keySystem.setServerCertificate(t.certificate))}return this.keySystem}createAndSetMediaKeys(e){return this.ensureMediaKeys(e).then(function(e){return this.ensureKeySystem(e),this.setMediaKeys(e).catch(this.onMediaKeysError.bind(this))}.bind(this))}requestKey(e){return this.createAndSetMediaKeys(e).then(function(){return this.keySystem.startKeyRequest(e)}.bind(this))}abortKey(e){this.keySystem&&this.keySystem.abortKeyRequest(e)}onServerCertificateLoaded(e){let t=e.keysystem,i=e.certificate;this.protectionData[t].certificate=i,this.keySystem&&this.keySystemId===t&&this.keySystem.setServerCertificate(i)}get availableKeySystems(){return ze.availableKeySystems}initialize(e){this.protectionData,this.protectionData={};let t=function(e){this.logger.error(`Error loading cert: ${e.message}`)()};for(let i in e){if(!ze.availableKeySystems.includes(i)){this.logger.warn(`Key system ${i} is not valid, ignoring`)();continue}let s=e[i],a=s.certificate,r=s.serverCertUrl;this.protectionData[i]={licenseServerUrl:s.licenseServerUrl,serverCertUrl:r,certificate:a},a?this.onServerCertificateLoaded({keysystem:i,certificate:a}):r&&this.keyLoader.loadCertificate(r,i).then(this.onServerCertificateLoaded.bind(this)).catch(t)}}generateRequest(e,t){this.keySystem&&this.keySystem.setKeyRequestInfo(e,t)}setLicenseResponse(e,t){this.keySystem&&this.keySystem.setParsedResponse(e,t)}setMediaKeys(e){if(!this.media)return void this.logger.warn("No media object attached")();let t=this.setMediaKeysPromise;return this.setMediaKeysPromise||(t=this.setMediaKeysPromise=this.media.setMediaKeys(e)).then(function(){}.bind(this)).catch(this.onMediaKeysError.bind(this)),t}onMediaKeysError(e){this.hls.trigger(s.a.ERROR,{type:a.c.KEY_SYSTEM_ERROR,details:a.a.KEY_SYSTEM_GENERIC_ERROR,fatal:!0,reason:e.message})}ensureMediaKeys(e){if(!this.createMediaKeysPromise){let t=this.keySystemId=ze.getKeySystemIdForDecryptData(e),i=ze.createMediaKeys(t,ce.video,ce.audio,this.hls.platformInfo.keySystemConfig);this.createMediaKeysPromise=i}return this.createMediaKeysPromise}}var fe,ge,me,pe=ue;!(function(e){e.MustRequestResponse="MustRequestResponse",e.WaitingForKeyResponse="WaitingForKeyResponse",e.GotKeyResponse="GotKeyResponse"})(fe||(fe={}));class ye extends Error{constructor(e,t){super(e),this.message=e,this.keyuri=t,this.name="KeyRequestTimeoutError",this.keyuri=t}}!(function(e){e.UnexpectedRequestInfo="UnexpectedRequestInfo",e.WrongChallenge="WrongChallenge",e.WrongLicense="WrongLicense",e.ExistingPromise="ExistingPromise",e.Abort="Abort",e.OutputRestricted="OutputRestricted",e.AlreadyFailedKey="AlreadyFailedKey",e.UnableToLoad="UnableToLoad",e.HttpError="HttpError"})(ge||(ge={}));class ve extends Error{constructor(e,t,i,s,a){super(e),this.message=e,this.keyuri=t,this.statusCode=i,this.isOkToRetry=s,this.keyErrorReason=a,this.name="KeyRequestError",this.keyuri=t,this.statusCode=i,this.isOkToRetry=s,this.keyErrorReason=a}}class Te{constructor(e){this.hls=e,this.hls=e,this.logger=e.logger,this.loaders={},this.keyUriToKeyInfo={},this.numberOfConsecutiveKeyErrors=0,this.resetFn=this.reset.bind(this),this.hls.on(s.a.MANIFEST_LOADING,this.resetFn),this.hls.on(s.a.MEDIA_DETACHING,this.resetFn),this.keySystemController=new pe(e,this)}destroy(){this.keySystemController.destroy(),this.reset(),this.hls&&(this.hls.off(s.a.MEDIA_DETACHING,this.resetFn),this.hls.off(s.a.MANIFEST_LOADING,this.resetFn),this.hls=void 0)}reset(){for(let e in this.keyUriToKeyInfo)this._abort(e);this.keyUriToKeyInfo={},this.numberOfConsecutiveKeyErrors=0;for(let e in this.loaders){let t=this.loaders[e];t&&t.destroy()}this.loaders={}}_handleKeyRequestResolve(e,t){let i=this.keyUriToKeyInfo[e];i?(i.state=t,i.stats.failCount=0,i.timeout&&(clearTimeout(i.timeout),i.timeout=void 0)):this.logger.warn(`Missing info keyuri=${this.hls.redactUrl(e)}`)()}handleKeyRequestError(e,t){let i,r=this.keyUriToKeyInfo[e];if(r){if(this.logger.error(`Key request error keyuri=${this.hls.redactUrl(e)} ${t.message} ${t.stack}`)(),this._abort(e),++r.stats.failCount,t)switch(t.name){case"KeySystemError":{let e=t;i={type:a.c.KEY_SYSTEM_ERROR,details:a.a.KEY_SYSTEM_GENERIC_ERROR,fatal:!0,decryptdata:r.decryptdata,levelIds:r.levelIds,stats:r.stats,response:{code:e.code,text:t.message}};break}case"KeyRequestTimeoutError":i={type:a.c.NETWORK_ERROR,details:a.a.KEY_LOAD_TIMEOUT,fatal:!1,decryptdata:r.decryptdata,levelIds:r.levelIds,stats:r.stats,reason:t.message,response:a.b.CryptResponseReceivedSlowly};break;case"KeyRequestError":{let e=t;this.numberOfConsecutiveKeyErrors++;let s=!e.isOkToRetry&&this.numberOfConsecutiveKeyErrors>=this.hls.config.keyRetryCountOnError;r.stats.isOkToRetry=e.isOkToRetry,i={type:a.c.NETWORK_ERROR,details:a.a.KEY_LOAD_ERROR,fatal:s,decryptdata:r.decryptdata,levelIds:r.levelIds,stats:r.stats,response:{code:e.statusCode,text:t.message},keyErrorReason:e.keyErrorReason};break}default:i={type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!0,reason:t.message}}i&&this.hls.trigger(s.a.ERROR,i)}}getKeyFromDecryptData(e,t,i=!1,a=!1){if(e&&e.isEncrypted){let r=e.uri,n=this.keyUriToKeyInfo[r];if(n&&!n.stats.isOkToRetry)return isNaN(t)||n.levelIds.add(t),this.handleKeyRequestError(r,new ve("Key has already resulted in failure",r,0,!0,ge.AlreadyFailedKey)),Promise.reject(new Error("Key has already resulted in failure"));if(!n||i||n.state===fe.MustRequestResponse){performance.now(),n?this.stopRequest(e):n=this.keyUriToKeyInfo[r]={state:fe.WaitingForKeyResponse,decryptdata:e,stats:{tfirstissue:0,tlastissue:0,failCount:0,isOkToRetry:!0},levelIds:new Set,overallRequest:null,currentRequestPromise:null},n.state=fe.WaitingForKeyResponse,n.decryptdata=e,!i&&a||(n.stats.tfirstissue=0,n.stats.failCount=0,n.overallRequest&&(n.overallRequest.reject(new ve("Request force aborted",r,0,!0,ge.Abort)),n.overallRequest=null));let t,o=this.hls.config,l=this.hls.levelWithPersistentId(this.hls.currentLevel).levelInfo,d=l&&l.details?l.details.targetduration:0,h=Math.min(n.stats.failCount,5)*o.keyLoadingRetryDelay,c=Math.max(o.keyLoadingMinTimeout,d>0?2*d*1e3:o.keyLoadingDefaultTimeout),u=e.method;switch(u){case"SAMPLE-AES":case"ISO-23001-7":case"SAMPLE-AES-CTR":t=function(){let t=new Promise(function(e,t){n.timeout=setTimeout((function(){t(new ye("Key load timed out",r))}),c)});return n.abort=function(){this.keySystemController.abortKey(e)}.bind(this),Promise.race([this.keySystemController.requestKey(e),t])}.bind(this);break;case"AES-128":t=function(){return n.abort=function(){this.loaders[r]&&this.loaders[r].abort()}.bind(this),this.loadKey(r,e,"GET",void 0,c)}.bind(this);break;default:return this.logger.warn(`Unexpected decryptdata method: ${u}`)(),n.overallRequest={promise:Promise.reject(new Error(`Unexpected METHOD attribute: ${u}`))},n.overallRequest.promise}n.overallRequest||(n.overallRequest={},n.overallRequest.promise=new Promise(function(e,t){n.overallRequest.resolve=e,n.overallRequest.reject=t})),n.currentRequestPromise=new Promise(function(e){n.sendRequestTimer=setTimeout(e,h)}.bind(this)).then(()=>{let e=n.stats,i=performance.now();return e.tfirstissue=e.tfirstissue||i,e.tlastissue=i,t()}).then(function(e,t){if(this._handleKeyRequestResolve(r,e?fe.GotKeyResponse:fe.MustRequestResponse),!e)return void this.logger.warn(`[Keys] Empty decryptdata, probably aborted key request ${this.hls.redactUrl(r)}`)();n.currentRequestPromise=null,n.overallRequest.resolve(e),this.numberOfConsecutiveKeyErrors=0;let i={decryptdata:e,keyuri:r,stats:{trequest:t?t.trequest:n.stats.tfirstissue,tfirst:t?t.tfirst:n.stats.tlastissue,tload:t?t.tload:performance.now()},timestamp:Date.now()};this.hls.trigger(s.a.KEY_LOADED,i)}.bind(this)).catch(this.handleKeyRequestError.bind(this,r))}return isNaN(t)||n.levelIds.add(t),n.overallRequest.promise}return Promise.resolve()}_abort(e){let t=this.keyUriToKeyInfo[e];t&&(t.sendRequestTimer&&(clearTimeout(t.sendRequestTimer),t.sendRequestTimer=void 0),t.abort&&t.abort(),t.timeout&&(clearTimeout(t.timeout),t.timeout=void 0),t.state=fe.MustRequestResponse)}stopRequest(e){this._abort(e.uri)}loadKey(e,t,i,s,a){return new Promise(function(r,n){let o=t.uri,l=this.loaders[o||e],d=this.hls.config;l&&(this.logger.warn(`abort previous key loader for uri:${this.hls.redactUrl(o)}`)(),l.abort()),l=this.loaders[o]=m.isCustomUrl(e)?new m(this.hls):new d.loader(d);let h={type:"key",url:e,method:i,payload:s,decryptdata:t,responseType:"arraybuffer",promise:{resolve:r,reject:n}},c={maxLoadTimeMs:a,maxTimeToFirstByteMs:0,maxRetry:0},u={onSuccess:this._onKeyLoadSuccess.bind(this),onError:this._onKeyLoadError.bind(this),onTimeout:this._onKeyLoadTimeout.bind(this)};l.load(h,c,u)}.bind(this))}_onKeyLoadSuccess(e,t,i){let s=i.decryptdata,a=s.uri,r=new Uint8Array(e.data);s.key=r,this.loaders[a]=void 0,i.promise.resolve(s,t)}_onKeyLoadError(e,t){let i=t.decryptdata.uri;this.loaders[i]=void 0,t.promise.reject(new ve("Unable to load key",i,e.code,!0,ge.UnableToLoad))}_onKeyLoadTimeout(e,t){let i=t.decryptdata.uri;this.loaders[i]=void 0,t.promise.reject(new ye("Key load timed out",i))}loadCertificate(e,t){return new Promise(function(i,s){let a=this.hls.config,r=this.loaders.cert;r&&(this.logger.warn("abort previous cert load")(),r.abort()),r=this.loaders.cert=m.isCustomUrl(e)?new m(this.hls):void 0!==a.fLoader?new a.fLoader(a):new a.loader(a);let n,o={keysystem:t,url:e,responseType:"arraybuffer",promise:{resolve:i,reject:s}};n=m.isCustomUrl(e)?a.fragLoadPolicy.customURL:a.fragLoadPolicy.default;let l={onSuccess:this._onCertificateSuccess.bind(this),onError:this._onCertificateError.bind(this),onTimeout:this._onCertificateTimeout.bind(this)};r.load(o,n,l)}.bind(this))}_onCertificateSuccess(e,t,i){this.loaders.cert=void 0;let s=new Uint8Array(e.data);i.promise.resolve({keysystem:i.keysystem,certificate:s})}_onCertificateError(e,t){this.loaders.cert=void 0,t.promise.reject(new Error("Certificate error")),this.hls.trigger(s.a.ERROR,{type:a.c.NETWORK_ERROR,details:a.a.CERT_LOAD_ERROR,fatal:!1,url:t.url,response:e})}_onCertificateTimeout(e,t){this.loaders.cert=void 0,t.promise.reject(new Error("Certificate timeout")),this.hls.trigger(s.a.ERROR,{type:a.c.NETWORK_ERROR,details:a.a.CERT_LOAD_TIMEOUT,fatal:!1,url:t.url,response:a.b.CryptResponseReceivedSlowly})}}!(function(e){e.GET_REQUEST_INFO="GET_REQUEST_INFO",e.GET_CHALLENGE="GET_CHALLENGE",e.GET_KEY_RESPONSE="GET_KEY_RESPONSE",e.PROCESS_LICENSE="PROCESS_LICENSE"})(me||(me={}));class Se extends Error{constructor(e,t,i,s){super(e),this.keyuri=t,this.code=i,this.keysystemstring=s,this.name="KeySystemError"}}class be{constructor(e,t,i,s){this.hls=e,this.mediaKeys=t,this.keyLoader=i,this.systemString=s,this.logger=e.logger,this.shouldDestroyMediaKeys=!1,this.itemId=e.assetInfo.itemId||"",this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={},this.onkeystatuseschange=this.handleKeyStatusesChange.bind(this),this.onkeymessage=this.handleKeyMessage.bind(this)}removeAndCloseSessionInternal(e){return e.remove().catch(e=>{this.logger.error(`Could not remove session: ${e.message}`)()}).then(()=>e.close()).catch(e=>{this.logger.error(`Could not close session: ${e.message}`)()}).then(()=>{this.removeKeySessionListeners(e)})}destroy(){this.isDestroying=!0;for(let e of Object.values(this.keyUriToKeyInfo))this.abortKeyRequestInternal(e);let e=[];this.sessions.forEach(t=>{let i=this.removeAndCloseSessionInternal(t);e.push(i)});let t=Promise.all(e).then(()=>{this.mediaKeys=void 0,this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}});return L.clearKeyUriToKeyIdMap(),t}setPromise(e,t,i){e.promise&&e.promise.reject(new ve("Existing promise",e.decryptdata.uri,0,!0,ge.ExistingPromise)),e.promiseType=t,e.promise=i}resolvePromise(e,t,i,s){e&&e.promise&&(e.promiseType===t?e.promise.resolve(i):(this.logger.warn(`wrong type ${t} ${e.promiseType} ${s}`)(),e.promise.reject(s)),e.promise=void 0,e.promiseType=void 0)}setServerCertificate(e=null){return this.needsCert?(this.setCertPromise||(this.setCertPromise=new Promise(function(e){this.onCertSet=e}.bind(this)).then(function(e){return this.mediaKeys.setServerCertificate(e)}.bind(this)).catch(function(e){throw this.logger.error("Failed setServerCertificate")(),this.setCert=!1,e}.bind(this))),e&&!this.setCert&&(this.setCert=!0,this.onCertSet(e)),this.setCertPromise):Promise.resolve()}setLicenseServer(e){this.licenseServerUrl||(this.licenseServerUrl=e)}ensureKeySessionForKeyInfo(e){if(e.session)return;let t=this.mediaKeys.createSession();t?(this.sessions.push(t),this.addKeySessionListeners(t)):this.logger.error(`${this.systemString} FAIL: could not create MediaKeysSession`)(),e.session=t}startKeyRequest(e){let t=e.uri;this.keyUriToKeyInfo[t]||(this.keyUriToKeyInfo[t]={decryptdata:e,session:null,aborted:!1});let i=this.keyUriToKeyInfo[t];if(this.ensureKeySessionForKeyInfo(i),!i.session)return Promise.reject(new Se("Could not create key session",e.uri,0,this.systemString));let s=g.a.utf8arrayToStr(e.keyId);return this.keyIdToKeyInfo[s]=i,i.aborted=!1,this.logger.info(`[QE Critical] [Keys] ${this.systemString} startKeyRequest uri=${this.hls.redactUrl(t)}`)(),Promise.all([this.getKeyRequestInfo(i),this.setServerCertificate()]).then((function(e){return e[0]})).then(function(e){return this.hls.eventReporter.notifyKeySessionEvent(F.spcsubmitted,{keyuri:t,keyFormat:this.systemString}),this.generateLicenseChallenge(i,e).catch(function(e){throw this.logger.error(`[Keys] ${this.systemString} generateLicenseChallenge Failed ${e.message} uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.spcerror,{keyuri:t}),e}.bind(this))}.bind(this)).then(function(e){return this.logger.info(`[QE Critical] [Keys] ${this.systemString} challenge created uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.spccreated,{keyuri:t,cdmVersion:this.cdmVersion}),this.getKeyRequestResponse(i,e)}.bind(this)).then(function(e){return this.logger.info(`[QE Critical] [Keys] ${this.systemString} onKeyResponseParsed uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.ckcsubmitted,{keyuri:t}),this.handleParsedKeyResponse(i,e).catch(function(e){throw this.hls.eventReporter.notifyKeySessionEvent(F.ckcerror,{keyuri:t}),e}.bind(this))}.bind(this)).then(function(){return this.logger.info(`[QE Critical] [Keys] ${this.systemString} New usable key: keyuri=${this.hls.redactUrl(t)} CDMVersion=${this.cdmVersion}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.ckcprocessed,{keyuri:t}),e}.bind(this)).catch((function(e){if(!i.aborted)throw e}))}abortKeyRequest(e){let t=this.keyUriToKeyInfo[e.uri];t&&(t.promise&&(this.logger.warn(`[Keys] Aborting key ${this.hls.redactUrl(e.uri)}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.keyaborted,{keyuri:e.uri}),t.aborted=!0,t.promise.reject(new ve("Aborted",e.uri,0,!0,ge.Abort)),t.promise=void 0,t.promiseType=void 0),this.abortKeyRequestInternal(t))}abortKeyRequestInternal(e){e.renewalTimer&&(clearTimeout(e.renewalTimer),e.renewalTimer=void 0)}getKeyRequestInfo(e){return Promise.resolve({})}setKeyRequestInfo(e,t){}sanitizeRequest(e){return e}generateLicenseChallengeInternal(e,t,i){return new Promise((s,a)=>{let r,n=e.decryptdata,o=e.session,l=n.uri,d=n.keyId;if(this.setPromise(e,me.GET_CHALLENGE,{resolve:s,reject:a}),o.generateRequestPromise)r=o.generateRequestPromise.then(this.generateRequestInitialized.bind(this,e,"usable"===i));else{let i=this.generateInitData(d,n,t);o.generateRequestPromise=o.generateRequest(i.initDataType,i.initData),r=o.generateRequestPromise.then(function(){this.sessionIdToKeyUri[o.sessionId]=l}.bind(this)).catch(function(t){throw this.logger.error(`${this.systemString} FAIL: generateRequest fail keyuri=${this.hls.redactUrl(e.decryptdata.uri)} message=${t.message}`)(),new Se(t.message,e.decryptdata.uri,0,this.systemString)}.bind(this))}r.catch(a)})}generateLicenseChallenge(e,t){let i=e.decryptdata,s=e.session,a=i.uri,r=i.keyId;this.logger.info(`[QE Critical] [Keys] ${this.systemString} generateLicenseChallenge uri=${this.hls.redactUrl(a)}`)(),e.licenseChallenge&&this.resolvePromise(e,me.GET_CHALLENGE,e.licenseChallenge,new ve("Unexpected challenge",a,0,!0,ge.WrongChallenge)),t=this.sanitizeRequest(t),e.requestInfo=t,this.sessionId=this.sessionId||t&&t.sessionId||this.itemId;let n,o=s.keyStatuses.get(r);switch(o){case"status-pending":case"usable":case"expired":case void 0:n=this.generateLicenseChallengeInternal(e,t,o);break;default:n=Promise.reject(new Se(`Bad internal state state=${o}`,a,0,this.systemString))}return n}setParsedResponse(e,t){let i=this.keyUriToKeyInfo[e];this.resolvePromise(i,me.GET_KEY_RESPONSE,t,new ve("Unexpected response received",e,0,!0,ge.WrongLicense))}addKeySessionListeners(e){e&&(e.addEventListener("keystatuseschange",this.onkeystatuseschange),e.addEventListener("message",this.onkeymessage))}removeKeySessionListeners(e){e&&(e.removeEventListener("keystatuseschange",this.onkeystatuseschange),e.removeEventListener("message",this.onkeymessage))}handleKeyStatusesChange(e){e.target.keyStatuses.forEach(function(e,t){let i=g.a.utf8arrayToStr(new Uint8Array(t)),s=this.keyIdToKeyInfo[i],a=s?s.decryptdata.uri:void 0;switch(e){case"internal-error":s.promise&&(s.promise.reject(new Se("Error processing key",a,0,this.systemString)),s.promise=void 0);break;case"usable":s&&s.promiseType===me.PROCESS_LICENSE&&this.resolvePromise(s,me.PROCESS_LICENSE,{},new ve("Wrong key status",a,0,!0,ge.WrongLicense));break;case"output-restricted":if(this.logger.error(`${this.systemString} output-restricted for keyuri=${this.hls.redactUrl(a)}`)(),s&&s.session){var r=this.sessions.indexOf(s.session);r>-1&&this.sessions.splice(r,1),this.removeAndCloseSessionInternal(s.session)}s&&s.promise?(s.promise.reject(new ve("output-restricted",a,0,!1,ge.OutputRestricted)),s.promise=void 0):this.keyLoader.handleKeyRequestError(a,new ve("output-restricted",a,0,!1,ge.OutputRestricted));break;default:this.logger.info(`[Keys] key status uri=${this.hls.redactUrl(a)} ${e}`)()}}.bind(this))}}const _e={initDataTypes:["keyids","cenc"]},Ee={initDataTypes:["cenc"]},Re=new Uint8Array([148,206,134,251,7,255,79,67,173,184,147,210,250,150,140,162]);var De;!(function(e){e[e.CENC=1667591779]="CENC",e[e.CBCS=1667392371]="CBCS"})(De||(De={}));class Le extends be{constructor(e,t,i,s,a){super(e,t,i,s),this.singleRenewalTimer=a,this.secureStop=e.assetInfo.secureStop,this.renewalTimer=void 0}destroy(){if(this.isDestroying=!0,this.singleRenewalTimer)this.stopRenewal(void 0);else for(let e in this.keyUriToKeyInfo){let t=this.keyUriToKeyInfo[e];this.stopRenewal(t)}return super.destroy()}static get systemId(){return Re}static get requestAccessConfig(){return Ee}get needsCert(){return!0}stopRenewal(e){this.singleRenewalTimer?(clearTimeout(this.renewalTimer),this.renewalTimer=void 0):(clearTimeout(e.renewalTimer),e.renewalTimer=void 0)}sanitizeRequest(e){return{assetId:e&&e.assetId?new Uint8Array(e.assetId):void 0,ssc:e&&e.ssc?new Uint8Array(e.ssc):void 0,sessionId:e&&e.sessionId?e.sessionId:void 0}}setKeyRequestInfo(e,t){let i=this.keyUriToKeyInfo[e];i?this.resolvePromise(i,me.GET_REQUEST_INFO,t,new ve("Unexpected requestInfo",e,0,!0,ge.UnexpectedRequestInfo)):this.logger.error(`Unexpected key requested ${this.hls.redactUrl(e)}`)()}handleParsedKeyResponse(e,t){let i=e.decryptdata.uri,s=t.statusCode;if(!(0!==s||t.ckc&&t.ckc.byteLength))return Promise.reject(new ve("License request resulted in HTTP Error",i,t.statusCode,!0,ge.HttpError));if(0!==s)return Promise.reject(new ve("License server responded with error",i,t.statusCode,!1,ge.WrongLicense));if(!t.ckc||!t.ckc.byteLength)return Promise.reject(new ve("License server responded with invalid license",i,t.statusCode,!1,ge.WrongLicense));let a=t.renewalDate,r=new Date,n=a>r?a.getTime()-r.getTime():0;if(n>0){let t=!1;this.singleRenewalTimer?this.renewalTimer||(t=!0,this.renewalTimer=setTimeout(this.forceStartKeyRequest.bind(this,e,!0),n)):(t=!0,clearTimeout(e.renewalTimer),e.renewalTimer=setTimeout(this.forceStartKeyRequest.bind(this,e,!0),n)),t&&this.logger.info(`[Keys] ${this.systemString} Scheduling renewal in ${n} ms`)()}let o=this.makeProcessLicenseRequestMessage(e,t,n);return e.session.update(o).catch(function(t){throw this.logger.error(`${this.systemString} FAIL: handleParsedKeyResponse keyuri=${this.hls.redactUrl(e.decryptdata.uri)} message=${t.message}`)(),new Se(t.message,e.decryptdata.uri,0,this.systemString)}.bind(this))}forceStartKeyRequest(e,t){t&&this.stopRenewal(e),this.abortKeyRequest(e.decryptdata),this.keyLoader.getKeyFromDecryptData(e.decryptdata,void 0,!0)}makeKeyRequests(e){let t=[];for(let i in e){let s=e[i],a=s.decryptdata,r=s.requestInfo,n=a.keyId;t.push({keyId:n,assetId:r?r.assetId:void 0,ssc:r?r.ssc:void 0,versionList:a.formatversions})}return t}getSchemeAndFlags(e){let t="ISO-23001-7"===e.method?De.CENC:De.CBCS,i=0;return this.secureStop&&(i|=1),{scheme:t,flags:i}}generateInitData(e,t,i){let{scheme:s,flags:a}=this.getSchemeAndFlags(t),r=this.makeKeyRequests([{decryptdata:t,requestInfo:i}]);return{initData:this.makeFpsKeySystemInitData(s,a,r),initDataType:"cenc"}}generateRequestInitialized(e,t){let i=this.makeKeyRequestMessage(e,t);return i?e.session.update(i).then(function(){e.requestInfo=void 0}.bind(this)).catch(function(t){throw this.logger.error(`[Keys] ${this.systemString} FAIL: generateRequestInitialized keyuri=${this.hls.redactUrl(e.decryptdata.uri)} message=${t.message}`)(),new Se(t.message,e.decryptdata.uri,0,this.systemString)}.bind(this)):Promise.reject(new ve("Unable to generate request using existing keySession",e.decryptdata.uri,0,!0,ge.UnableToLoad))}getKeyRequestResponse(e,t){return new Promise(function(i,a){let r=e.decryptdata.uri;this.setPromise(e,me.GET_KEY_RESPONSE,{resolve:i,reject:a}),this.hls.trigger(s.a.LICENSE_CHALLENGE_CREATED,{keyuri:r,licenseChallenge:t,keysystem:this.systemString})}.bind(this))}resolveSPCPromise(e,t){let i=e.decryptdata.uri;this.resolvePromise(e,me.GET_CHALLENGE,t,new ve("Unexpected challenge",i,0,!0,ge.WrongChallenge))}}var Ie=i(3);const Ae={SessionId:"AirPlayPlaybackSessionID",APIProvider:"APIProviderID",MovieID:"PlaybackSessionID",SecureStopSPC:"SecureStopSPC",SessionLifespanSPC:"SessionLifespanSPC"},ke={NONE:0,CRKR:1668442994,RMKY:1919773561,CKCS:1667982195,CERT:1667592820,SPCS:1936745331,RNEW:1919837559,RLSE:1919710053,SSTP:1936946288,CDMI:1667525993},Ce={CENC:"EC396D13-FB13-4993-9D0D-71518ACF3D6F",CBCS:"F19BF03B-7470-41A4-9655-86D078307D59"};function we(e,t,i){if(i+4>e.byteLength)return;let s=t.getUint32(i);if((i+=4)+s>e.byteLength)return;let a=e.slice(i,i+s);return{pos:i+=s,data:a}}function Pe(e){let t={},i=new DataView(e.buffer),s=4;var a=i.getUint32(s);s+=4;for(let r=0;r<a&&s<e.byteLength&&!(s+16>e.byteLength);++r){let a=e.slice(s,s+16);if((s+=16)+4>e.byteLength)break;let r=we(e,i,s);if(!r)break;s=r.pos,t[g.a.utf8arrayToStr(a)]=r.data}return t}function Me(e,t,i,s){let a=s?s.byteLength:0;return t.setUint32(i,a),a&&e.set(s,i+4),i+(4+a)}function Oe(e){let t=4;for(let i in e)t+=28+(e[i].assetId?e[i].assetId.byteLength:0)+(e[i].ssc?e[i].ssc.byteLength:0)+(e[i].versionList?4*e[i].versionList.length:0);return t}function Ne(e,t,i,s){t.setUint32(i,s.length),i+=4;for(let a in s){let r=s[a];if(e.set(r.keyId,i),i=Me(e,t,i=Me(e,t,i+=16,r.assetId),r.ssc),t.setUint32(i,r.versionList?r.versionList.length:0),i+=4,r.versionList)for(let e in r.versionList)t.setUint32(i,r.versionList[e]),i+=4}return i}class xe extends Le{constructor(e,t,i,s){super(e,t,i,s,!0)}ensureKeySessionForKeyInfo(e){if(0===this.sessions.length){let e=this.mediaKeys.createSession();if(!e)return void this.logger.error(`${this.systemString} FAIL: could not create MediaKeysSession`)();this.sessions.push(e),this.addKeySessionListeners(e)}e.session=this.sessions[0]}getKeyRequestInfo(e){return new Promise(function(t,i){let a=e.decryptdata,r=a.uri;this.setPromise(e,me.GET_REQUEST_INFO,{resolve:t,reject:i}),this.hls.trigger(s.a.KEY_REQUEST_STARTED,{keyuri:r,decryptdata:a,timestamp:Date.now()})}.bind(this))}makeProcessLicenseRequestMessage(e,t,i){let s=new Uint8Array(t.ckc);return (function(e){let t=0;for(let i in e)t+=24+e[i].ckc.byteLength;let i=0,s=new Uint8Array(8+t),a=new DataView(s.buffer);a.setUint32(0,ke.CKCS),a.setUint32(4,e.length),i+=8;for(let t in e){let r=e[t];s.set(r.keyId,i),i+=16,a.setUint32(i,r.expirySec),i=Me(s,a,i+=4,r.ckc)}return s})([{keyId:e.decryptdata.keyId,expirySec:i/1e3,ckc:s}])}makeFpsKeySystemInitData(e,t,i){let s=(function(e,t,i,s){let a=Oe(s),r=0,n=new Uint8Array(8+a),o=new DataView(n.buffer);return o.setUint32(r,e),o.setUint32(r+4,1<<24|16777215&i),r=Ne(n,o,r+=8,s),n})(e,0,t,i);return Ie.a.pssh(xe.systemId,[],s)}makeKeyRequestMessage(e){return (function(e){let t=Oe(e),i=0,s=new Uint8Array(4+t),a=new DataView(s.buffer);return a.setUint32(0,ke.CRKR),i=Ne(s,a,i+=4,e),s})([{keyId:e.decryptdata.keyId,assetId:e.requestInfo?e.requestInfo.assetId:void 0,ssc:e.requestInfo?e.requestInfo.ssc:void 0,versionList:e.decryptdata.formatversions}])}handleKeyMessage(e){if(e.message.byteLength<4)return void this.logger.error("Unexpected message")();let t=new Uint8Array(e.message),i=new DataView(e.message),s=i.getUint32(0);if(this.isDestroying&&s!==ke.RLSE)this.logger.warn(`In the middle of destroying, ignore command: ${s.toString(16)}`)();else switch(s){case ke.CERT:this.logger.warn("Certificate not set!")();break;case ke.RNEW:{let e=Pe(t);for(let t in e){let e=this.keyIdToKeyInfo[t];this.forceStartKeyRequest(e,!0)}break}case ke.SPCS:{let e=Pe(t);for(let t in e){let i=this.keyIdToKeyInfo[t],s=e[t];this.resolveSPCPromise(i,s)}break}case ke.RLSE:this._handleLicenseRelease(t);break;case ke.CDMI:{let e=we(t,i,4);if(e){let t=this.cdmVersion=g.a.utf8arrayToStr(e.data);this.logger.info(`[Keys] ${this.systemString} CDM Version :  ${t}`)()}break}}}_handleLicenseRelease(e){let t={},i=new DataView(e.buffer);switch(i.getUint32(4)){case ke.SSTP:{if(!Ae){this.logger.error("No secure stop keys defined")();break}t[Ae.SessionId]=this.sessionId;let s=8;if(s+4>e.byteLength)break;t[Ae.APIProvider]=i.getUint32(s)===De.CENC?Ce.CENC:Ce.CBCS;let a=we(e,i,s+=4);if(!a)break;if(s=a.pos,t[Ae.MovieID]=g.a.utf8arrayToStr(a.data),!(a=we(e,i,s)))break;if(s=a.pos,t[Ae.SecureStopSPC]=a.data,!(a=we(e,i,s)))break;s=a.pos,t[Ae.SessionLifespanSPC]=a.data;break}}this.hls.trigger(s.a.LICENSE_RELEASED,{keysystem:this.systemString,itemId:this.itemId,releaseRecord:t})}}var Fe=xe;const Be={fpsd:g.a.strToUtf8array("fpsd"),fpsi:g.a.strToUtf8array("fpsi"),fpsk:g.a.strToUtf8array("fpsk"),fkri:g.a.strToUtf8array("fkri"),fkai:g.a.strToUtf8array("fkai"),fkcx:g.a.strToUtf8array("fkcx"),fkvl:g.a.strToUtf8array("fkvl")};function Ue(e,t,i,s){let a=[Be.fpsk],r=Ie.a.box(Be.fkri,new Uint8Array([0,0,0,0]),e);if(a.push(r),t&&t.byteLength&&a.push(Ie.a.box(Be.fkai,t)),i&&i.byteLength&&a.push(Ie.a.box(Be.fkcx,i)),s&&s.length){let e=new Uint8Array(4*s.length),t=0;for(let i of s)Ie.a.set32(i,e,t),t+=4;a.push(Ie.a.box(Be.fkvl,e))}return Ie.a.box.apply(null,a)}var Ve={initDataTypes:["cenc"]};const Ge=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);class $e extends be{constructor(e,t,i,s){super(e,t,i,s),this.hls=e,this.shouldDestroyMediaKeys=!0}static get systemId(){return Ge}static get requestAccessConfig(){return Ve}get needsCert(){return!1}generateInitData(e,t){let i=t.pssh;return{initData:Ie.a.pssh($e.systemId,[],i),initDataType:"cenc"}}_startKeyRenewal(e){this.abortKeyRequestInternal(e),this.keyLoader.getKeyFromDecryptData(e.decryptdata,void 0,!0)}getKeyRequestResponse(e,t){return new Promise(function(i,a){let r=e.decryptdata.uri;this.setPromise(e,me.GET_KEY_RESPONSE,{resolve:i,reject:a}),this.hls.trigger(s.a.LICENSE_CHALLENGE_CREATED,{keyuri:r,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId})}.bind(this))}generateRequestInitialized(e){let t=e.decryptdata.uri,i=e.licenseChallenge;e.requestInfo=void 0,this.resolvePromise(e,me.GET_CHALLENGE,i,new ve("Unexpected challenge",t,0,!0,ge.WrongChallenge))}handleParsedKeyResponse(e,t){if(!this.isDestroying)return new Promise((i,s)=>{let a=e.decryptdata.uri;if(0!==t.statusCode)return s(new ve("License server responded with error",a,t.statusCode,!1,ge.WrongLicense));if(!t.license||!t.license.byteLength)return s(new ve("License server responded with invalid license",a,t.statusCode,!1,ge.WrongLicense));if(t.renewalDate){let i=t.renewalDate,s=new Date,a=i>s?i.getTime()-s.getTime():0;a>0&&(clearTimeout(e.renewalTimer),e.renewalTimer=setTimeout(this._startKeyRenewal.bind(this,e),a))}this.setPromise(e,me.PROCESS_LICENSE,{resolve:i,reject:s}),e.session.update(t.license).then(()=>{let t=e.decryptdata.keyId;"usable"===e.session.keyStatuses.get(t)&&this.resolvePromise(e,me.PROCESS_LICENSE,{},new ve("Wrong key status",a,0,!0,ge.WrongLicense))}).catch(t=>{this.logger.error(`${this.systemString} FAIL: Failed to update with key response message=${t.message}`)(),s(new Se(t.message,e.decryptdata.uri,0,this.systemString))})});this.logger.warn("In the middle of destroying, ignore key message")()}handleKeyMessage(e){if(this.isDestroying)return void this.logger.warn("In the middle of destroying, ignore key message")();var t=new DOMParser;let i=String.fromCharCode.apply(null,new Uint16Array(e.message.buffer||e.message)),s=t.parseFromString(i,"application/xml").getElementsByTagName("Challenge")[0].childNodes[0].nodeValue,a=p.a.base64Decode(s),r=g.a.utf8arrayToStr(a),n=t.parseFromString(r,"application/xml").getElementsByTagName("KID")[0];var o;o=n.childNodes[0]?n.childNodes[0].nodeValue:n.getAttribute("VALUE");let l=p.a.base64Decode(o).subarray(0,16),d=this.keyIdToKeyInfo[g.a.utf8arrayToStr(l)],h=d.decryptdata.uri;d.licenseChallenge=a,this.resolvePromise(d,me.GET_CHALLENGE,a,new ve("Unexpected challenge",h,0,!0,ge.WrongChallenge))}}var Ke=$e;const We={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"},He=new Uint8Array([237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237]),qe={clearkey:{id:"clearkey",systemStringPrefix:"org.w3.clearkey",keyFormatString:"org.w3.clearkey"},fairplaystreaming:he,playready:b,widevine:_},je={clearkey:[["org.w3.clearkey",class extends be{constructor(e,t,i,s){super(e,t,i,s)}static get requestAccessConfig(){return _e}get needsCert(){return!1}getKeyRequestInfo(e){return new Promise(function(t,i){let a=e.decryptdata,r=a.uri;this.setPromise(e,me.GET_REQUEST_INFO,{resolve:t,reject:i}),this.hls.trigger(s.a.KEY_REQUEST_STARTED,{keyuri:r,decryptdata:a,timestamp:Date.now()})}.bind(this))}setKeyRequestInfo(e,t){let i=this.keyUriToKeyInfo[e];i&&this.resolvePromise(i,me.GET_REQUEST_INFO,t,new ve("Unexpected requestInfo",e,0,!0,ge.UnexpectedRequestInfo))}getKeyRequestResponse(e,t){let i=e.decryptdata.uri,s=this.hls.config.keyLoadingDefaultTimeout;return this.hls.keyLoader.loadKey(i,e.decryptdata,"GET",void 0,s).then(function(e){return{response:this.parseResponse(t,e.key)}}.bind(this))}generateRequestInitialized(e,t){}parseResponse(e,t){var i={kty:"oct",kid:e,k:p.a.base64UrlEncode(t)};return g.a.strToUtf8array(JSON.stringify({keys:[i]}))}handleParsedKeyResponse(e,t){let i=t.response,s=e.session.update(i);return s.catch((function(t){throw this.logger.error(`${this.systemString} FAIL: Failed to update with key response message=${t.message}`)(),new Se(t.message,e.decryptdata.uri,0,this.systemString)})),s}generateInitData(e){return{initData:S.makeKeyIdsInitData([e]),initDataType:"keyids"}}abortKeyRequestInternal(e){let t=e.decryptdata.uri;this.hls.keyLoader.loaders[t]&&this.hls.keyLoader.loaders[t].abort()}sanitizeRequest(e){return e}handleKeyMessage(e){if("license-request"!==e.messageType)return;let t=new Uint8Array(e.message),i=JSON.parse(g.a.utf8arrayToStr(t).trim());if(1!==i.kids.length)return;let s=p.a.base64Decode(i.kids[0]),a=this.keyIdToKeyInfo[g.a.utf8arrayToStr(s)];if(a){let e=a.decryptdata.uri;this.resolvePromise(a,me.GET_CHALLENGE,i.kids[0],new ve("Unexpected challenge",e,0,!0,ge.WrongChallenge))}}}]],fairplaystreaming:[["com.apple.fps.3_0",class extends Le{constructor(e,t,i,s){super(e,t,i,s,!1),this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}static get needsCert(){return!0}startKeyRequest(e){let t=e.uri;return this.keyUriToKeyInfo[t]||(this.keyUriToKeyInfo[t]={decryptdata:e,session:null,aborted:!1,licenseChallenge:null}),super.startKeyRequest(e)}makeFpsKeySystemInitData(e,t,i){return (function(e,t,i){let s=[Be.fpsd,(function(e,t){let i=new Uint8Array(4);return Ie.a.set32(e,i,0),Ie.a.box(Be.fpsi,new Uint8Array([0,t>>16&255,t>>8&255,255&t]),i)})(e,t)];for(let e of i)s.push(Ue(e.keyId,e.assetId,e.ssc,e.versionList));let a=Ie.a.box.apply(null,s);return Ie.a.pssh(Le.systemId,null,a)})(e,t,i)}makeKeyRequestMessage(e,t){if(t)return g.a.strToUtf8array("renew")}makeProcessLicenseRequestMessage(e,t,i){let s=JSON.stringify([{keyID:p.a.base64Encode(e.decryptdata.keyId),payload:p.a.base64Encode(t.ckc)}]);return g.a.strToUtf8array(s)}handleKeyMessage(e){let t,i=e.target,s=i.sessionId,a=e.messageType,r=this.sessionIdToKeyUri[s];if(r)t=this.keyUriToKeyInfo[r];else for(let e of Object.values(this.keyUriToKeyInfo))e.session===i&&(t=e);if(t)switch(a){case"license-request":{let i=new Uint8Array(e.message),s=g.a.utf8arrayToStr(i);try{JSON.parse(s).forEach(e=>{let t,i=p.a.base64DecodeToStr(e.keyID),s=p.a.base64Decode(e.payload);t=this.keyIdToKeyInfo[i],this.resolveSPCPromise(t,s)})}catch(e){this.logger.warn("[Keys] got unexpected license-request format")(),this.resolveSPCPromise(t,i)}break}case"license-renewal":{let i=new Uint8Array(e.message);this.resolveSPCPromise(t,i);break}case"license-release":this._handleLicenseRelease(i);break;default:this.logger.error(`[Keys] Unexpected messageType ${a}`)()}else this.logger.warn("[Keys] No key associated with session")()}_handleLicenseRelease(e){e.update(g.a.strToUtf8array("acknowledged"))}}],["com.apple.fps",Fe]],playready:[["com.microsoft.playready.hardware",Ke],["com.microsoft.playready",Ke]],widevine:[["com.widevine.alpha",class extends be{constructor(e,t,i,s){super(e,t,i,s),this.hls=e,this.shouldDestroyMediaKeys=!0}static get systemId(){return He}static get requestAccessConfig(){return We}get needsCert(){return!0}getKeyRequestResponse(e,t){return new Promise(function(i,a){let r=e.decryptdata.uri;this.setPromise(e,me.GET_KEY_RESPONSE,{resolve:i,reject:a}),this.hls.trigger(s.a.LICENSE_CHALLENGE_CREATED,{keyuri:r,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId})}.bind(this))}handleParsedKeyResponse(e,t){if(!this.isDestroying)return new Promise((i,s)=>{e.licenseChallenge=void 0;let a=e.decryptdata.uri;if(0!==t.statusCode)return s(new ve("License server responded with error",a,t.statusCode,!1,ge.WrongLicense));if(!t.license||!t.license.byteLength)return s(new ve("License server responded with invalid license",a,t.statusCode,!1,ge.WrongLicense));this.setPromise(e,me.PROCESS_LICENSE,{resolve:i,reject:s});let r=e.session.update(t.license);r.then(function(){let t=e.decryptdata.keyId;"usable"===e.session.keyStatuses.get(t)&&this.resolvePromise(e,me.PROCESS_LICENSE,{},new ve("Wrong key status",a,0,!0,ge.WrongLicense))}.bind(this)).catch(function(t){throw this.logger.error(`${this.systemString} FAIL: Failed to update with key response code=${t.code} message=${t.message}`)(),new Se(t.message,e.decryptdata.uri,t.code,this.systemString)}.bind(this)),r.catch(s)});this.logger.warn("In the middle of destroying, ignore key message")()}generateInitData(e,t){return{initData:t.pssh,initDataType:"cenc"}}_startKeyRenewal(e){this.keyLoader.getKeyFromDecryptData(e.decryptdata,void 0,!0)}generateRequestInitialized(e){let t=e.decryptdata.uri,i=e.licenseChallenge;e.requestInfo=void 0,this.resolvePromise(e,me.GET_CHALLENGE,i,new ve("Unexpected challenge",t,0,!0,ge.WrongChallenge))}handleKeyMessage(e){if(this.isDestroying)return void this.logger.warn("In the middle of destroying, ignore key message")();let t=e.target,i=null,s=null;if(t.sessionId in this.sessionIdToKeyUri)switch(i=this.sessionIdToKeyUri[t.sessionId],s=this.keyUriToKeyInfo[i],e.messageType){case"license-request":{let t=new Uint8Array(e.message);s.licenseChallenge=t,this.resolvePromise(s,me.GET_CHALLENGE,t,new ve("Unexpected challenge",i,0,!0,ge.WrongChallenge));break}case"license-renewal":{let t=new Uint8Array(e.message);s.licenseChallenge=t,this.keyLoader.getKeyFromDecryptData(s.decryptdata,void 0,!0);break}}else this.logger.error(`${this.systemString} empty keyuri and keyInfo`)()}}]]},Ye=he.id;class ze{static createMediaKeys(e,t,i,s){let a=ze.idToMediaKeysInfoMap[e];if(!a){let r;c.b.info(`[Keys] ${e} requesting key system access`)(),r=ze.requestKeySystemAccess(e,t,i,s).then((function(t){return ze.idToMediaKeysInfoMap[e].keySystemAccess=t,c.b.info(`[Keys] ${e} creating CDM`)(),t.createMediaKeys()})).then((function(t){return c.b.info(`[Keys] ${e} created CDM`)(),t})).catch((function(t){throw c.b.error(`[Keys] FAIL: could not initialize ${e} key system: ${t.message}`)(),t})),a=ze.idToMediaKeysInfoMap[e]={promise:r,keySystemAccess:null}}return a.promise}static destroyMediaKeys(){ze.idToMediaKeysInfoMap={}}static getKeySystemIdForDecryptData(e){let t;if(e){t=Ye;let i=e.format;for(let e in qe)if(qe[e].keyFormatString===i){t=e;break}}if(!t)throw Error("No matching key system");return t}static requestKeySystemAccess(e,t,i,s){if("undefined"==typeof navigator||void 0===navigator.requestMediaKeySystemAccess)return Promise.reject(new Se("navigator undefined",void 0,0,e));let a=je[e],r=Promise.reject(new Se("no key systems to try",void 0,0,e));for(let e of a){let a=e[0],n=e[1],o=void 0===s||0==s.length?n.requestAccessConfig:s,l=[Object.assign({},o,S.getCapabilities(t,i))];r=r.catch(ze.requestKeySystemInternal.bind(null,a,l))}return r}static requestKeySystemInternal(e,t){return navigator.requestMediaKeySystemAccess(e,t)}static make(e,t,i,s){let a,r=ze.idToMediaKeysInfoMap[e].keySystemAccess;if(!r)throw new Se(`No keySystemAccess for ${e}`,void 0,0,e);let n=qe[e].systemStringPrefix;for(let t of je[e])if(t[0]===r.keySystem){a=t[1];break}if(!a)throw new Se(`No constructor associated with ${e}`,void 0,0,n);return new a(t,i,s,n)}static get availableKeySystems(){return Object.keys(qe)}static getKeySystemFormat(e){let t=qe[e];return t?t.keyFormatString:""}}var Qe,Xe;ze.idToMediaKeysInfoMap={},(function(e){e.UNKNOWN="unkn",e.VIDEO="vide",e.AUDIO="soun",e.SUBTITLE="sbtl",e.CLOSEDCAPTION="clcp"})(Qe||(Qe={})),(function(e){e[e.NO=0]="NO",e[e.YES=1]="YES"})(Xe||(Xe={}));const Je=/^(\d+)x(\d+)$/,Ze=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class et{constructor(e){this.validTags=e}isKey(e){return e in this.validTags}trySetValue(e,t,i){return!!this.isKey(e)&&(i[e]=this.parseFunc(t),!0)}}class tt{static parseTags(e){let t,i={};if(!e)return i;for(Ze.lastIndex=0;null!==(t=Ze.exec(e));){const e=t[1].toUpperCase(),s='"';let a=t[2];0===a.indexOf(s)&&a.lastIndexOf(s)===a.length-1&&(a=a.slice(1,-1));for(let t of tt.tagParsers)if(t.trySetValue(e,a,i))break}return i}}tt.tagParsers=[new class extends et{parseFunc(e){return e}}({NAME:"",TYPE:"",DEFAULT:"",AUTOSELECT:"",FORCED:"",LANGUAGE:"",URI:"",AUDIO:"","VIDEO-RANGE":"","CLOSED-CAPTIONS":"",CODECS:"",BYTERANGE:"","INSTREAM-ID":"","GROUP-ID":"",CHANNELS:"",CHARACTERISTICS:"",KEYFORMAT:"",KEYFORMATVERSIONS:"","DATA-ID":"",VALUE:"",METHOD:"","HDCP-LEVEL":""}),new class extends et{parseFunc(e){let t=parseInt(e);return t>Number.MAX_SAFE_INTEGER?1/0:t}}({BANDWIDTH:NaN,"AVERAGE-BANDWIDTH":NaN}),new class extends et{constructor(){super(...arguments),this.parseFunc=parseFloat}}({"TIME-OFFSET":NaN,"FRAME-RATE":NaN}),new class extends et{parseFunc(e){let t=(e||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++){let s=parseInt(t.slice(2*e,2*e+2),16);if(isNaN(s))return;i[e]=s}return i}}({IV:null}),new class extends et{parseFunc(e){const t=Je.exec(e);let i;return null!==t&&(i={width:parseInt(t[1],10),height:parseInt(t[2],10)}),i}}({RESOLUTION:null})];const it=/{\$(.*?)}/g,st=/#EXTINF:(\d*(?:\.\d+)?)(?:,(.*))?|(?!#)(\S.+)|#EXT-X-BYTERANGE: *(.+)|#EXT-X-PROGRAM-DATE-TIME:(.+)|#EXT-X-BITRATE:(.+)|#.*/g,at=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:#EXT-X-(I-FRAMES)-ONLY)|(?:#EXT-X-(DEFINE):(.+))|(?:(#)(.*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,rt=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-I-FRAME-STREAM-INF:([^\r\n]+)|#EXT-X-DEFINE:([^\n\r]*)/g,nt=/#EXT-X-MEDIA:(.*)/g,ot=/#EXT-X-SESSION-DATA[^:]*:(.*)/g,lt=/(NAME|VALUE)=\"(.*)\",(NAME|VALUE)=\"(.*)\"|(IMPORT)=\"(.*)\"/;let dt=function(e,t,i){return d.buildAbsoluteURL(t,e,{alwaysNormalize:!0,inheritQuery:i})},ht=function(e,t,i){if(void 0===e)return-1;let s=e.MediaSelectionGroupOptions,a=s.find((function(e){return e.MediaSelectionOptionsMediaType===t.mediaType&&e.MediaSelectionOptionsName===t.name&&e.MediaSelectionOptionsExtendedLanguageTag===t.lang}));return a||(a={MediaSelectionOptionsMediaType:t.mediaType,MediaSelectionOptionsExtendedLanguageTag:t.lang,MediaSelectionOptionsIsDefault:t.default,MediaSelectionOptionsName:t.name,MediaSelectionOptionsPersistentID:i,MediaSelectionOptionsTaggedMediaCharacteristics:t.characteristics},t.mediaType===Qe.SUBTITLE&&(a.MediaSelectionOptionsDisplaysNonForcedSubtitles=t.forced?Xe.NO:Xe.YES),i++,s.push(a)),t.persistentID=a.MediaSelectionOptionsPersistentID,i},ct=function(e){let t,i=e.split(".");return i.length>2?(t=i.shift()+".",t+=parseInt(i.shift()).toString(16),t+=("000"+parseInt(i.shift()).toString(16)).substr(-4)):t=e,t},ut=function(e){let t;try{t=JSON.parse(p.a.base64DecodeToStr(e))}catch(i){c.b.error(`Error ${i} decoding metadata value: '${e}'`)(),t=e}return t},ft=function(e,t){let i,s=!1;return e&&t&&(i=e.replace(it,(function(e){it.lastIndex=0;let i=it.exec(e)[1];if(i&&t.hasOwnProperty(i))return t[i];s=!0}))),{updatedString:i,error:s}};const gt=e=>"DATA-ID"in e;var mt=class{constructor(e,t){this.config=e,this.registerProgramDateTime=t,this._masterVariableList={}}destroy(){this._masterVariableList={}}get query(){return this.inheritQuery}set query(e){this.inheritQuery=e}static isValidPlaylist(e){return 0===e.indexOf("#EXTM3U")}static isMediaPlaylist(e){return e.indexOf("#EXTINF:")>0}_shouldSelectKeyTag(e,t){return"AES-128"===t||"NONE"===t||void 0===this.config||void 0===this.config.keySystemPreference||e===ze.getKeySystemFormat(this.config.keySystemPreference)}_addDefaultClosedCaptionOption(e,t,i){let s={id:0,mediaType:Qe.CLOSEDCAPTION,inStreamID:"CC1",groupId:"cc",name:"English-CC",type:"CLOSED-CAPTIONS",default:!1,autoselect:!1,forced:!1,lang:"en",characteristics:["public.accessibility.transcribes-spoken-dialog","public.accessibility.describes-music-and-sound"],persistentID:i,loadError:0,unchangedLevelCount:0};e.push(s),ht(t,s,i)}optOutClosedCaption(e){let t=!1,i=!1;if(e)for(let s=0;s<e.length;++s){let a=e[s];if(a.videoCodec&&(i=!0,!0!==a.iframes&&a.closedcaption&&"none"===a.closedcaption.toLowerCase())){t=!0;break}}return!i||t}parseMasterPlaylistMedia(e,t,i){let s,r,n={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:Qe.AUDIO,MediaSelectionGroupOptions:[]},o={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:Qe.SUBTITLE,MediaSelectionGroupOptions:[]},l={videoTracks:[],audioTracks:[],subtitleTracks:[],audioMediaSelectionGroup:n,subtitleMediaSelectionGroup:o},d=0;for(nt.lastIndex=0;null!=(s=nt.exec(e));){let e=ft(s[1],this._masterVariableList);if(e.error){r={type:a.c.MEDIA_ERROR,details:a.a.LEVEL_LOAD_ERROR,fatal:!0,reason:"encountered undefined/not imported EXT-X-DEFINE property",response:a.b.FormatError};break}let c,u,f,g,m=tt.parseTags(e.updatedString),p=Qe.UNKNOWN,y=(h=m.CHARACTERISTICS)?h.split(/\s*,\s*/):new Array,v=m["GROUP-ID"],T=m.CHANNELS;switch(m.TYPE){case"VIDEO":p=Qe.VIDEO,u=l.videoTracks;break;case"AUDIO":p=Qe.AUDIO,u=l.audioTracks,f=n;let e=i.find((function(e){return e.audioGroupId===v}));g=e?e.audioCodecList:[];break;case"SUBTITLES":p=Qe.SUBTITLE,u=l.subtitleTracks,f=o;break;case"CLOSED-CAPTIONS":p=Qe.CLOSEDCAPTION,c=m["INSTREAM-ID"],u=l.subtitleTracks,f=o}let S={mediaType:p,groupId:v,channels:T,groupCodecList:g,name:m.NAME,type:m.TYPE,default:"YES"===m.DEFAULT,autoselect:"YES"===m.AUTOSELECT,forced:"YES"===m.FORCED,characteristics:y,persistentID:d,id:u?u.length:0,lang:k.shortenLanguageCode(m.LANGUAGE),loadError:0,unchangedLevelCount:0};m.URI&&(S.url=dt(m.URI,t,this.inheritQuery)),S.name||(S.name=S.lang,S.mediaType===Qe.CLOSEDCAPTION&&(S.name+=" CC")),u&&(S.id=u.length,u.push(S)),d=ht(f,S,d)}var h;return 0!==l.subtitleTracks.length||this.optOutClosedCaption(i)||this._addDefaultClosedCaptionOption(l.subtitleTracks,o,d),{parsedMasterPlaylistMedia:l,errorInfo:r}}static parseSessionData(e,t){let i,s=[],a=new Set;for(ot.lastIndex=0;null!=(i=ot.exec(e));){let e,t=tt.parseTags(i[1]);t.LANGUAGE=k.shortenLanguageCode(t.LANGUAGE),e=t.LANGUAGE?t["DATA-ID"]+"|"+t.LANGUAGE:void 0,gt(t)?e&&a.has(e)||("com.apple.hls.other-tags"===t["DATA-ID"]&&(t.VALUE=ut(t.VALUE)),s.push(t),e&&a.add(e)):c.b.error(`Error processing DATA-ID ${t["DATA-ID"]} and LANGUAGE ${t.LANGUAGE}`)()}return{itemList:s,baseUrl:t}}parseLevelPlaylist(e,t,i,s){let r,n,o,l,h,u,f=0,g=0,m={type:"",version:0,url:t,initSegments:{},fragments:[],live:!0,startSN:0,endSN:0,iframesOnly:!1,targetduration:0,startTimeOffset:0,totalduration:0,averagetargetduration:0},p=new D("NONE",t,null,null,null),y=!1,v=0,T=null,S=new w(this.inheritQuery),b=0,_={},R=!0;for(st.lastIndex=0;null!==(r=st.exec(e));){const e=r[1];if(e){S.duration=parseFloat(e);const t=(" "+r[2]).slice(1);S.title=t||null,S.tagList.push(t?["INF",e,t]:["INF",e])}else if(r[3]){if(!isNaN(S.duration)){const e=f++;if(S.type=s,S.start=g,S.levelkey=p,y=!1,S.sn=e,S.level=i,S.cc=v,S.iframe=m.iframesOnly,S.baseurl=t,(l=ft((" "+r[3]).slice(1),_)).error){h={type:a.c.MEDIA_ERROR,details:a.a.LEVEL_LOAD_ERROR,fatal:!0,reason:"encountered undefined/not imported EXT-X-DEFINE property",response:a.b.FormatError};break}if(S.relurl=l.updatedString,S.bitrate=isNaN(S.byteRangeEndOffset)?b:8*(S.byteRangeEndOffset-S.byteRangeStartOffset)/S.duration,S.rawProgramDateTime?(this.registerProgramDateTime(S.rawProgramDateTime,S.start),o=null):o&&(S.rawProgramDateTime=o,S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]),this.registerProgramDateTime(S.rawProgramDateTime,S.start),o=null),m.fragments.push(S),T=S,g+=S.duration,R&&!m.initSegments[v])if(m.iframesOnly&&S.byteRangeStartOffset>0){let e=new w(this.inheritQuery);e.url=S.url,e.rawByteRange=Math.min(S.byteRangeStartOffset,1316)+"@0",e.baseurl=t,e.level=i,e.type=s,e.sn="initSegment",e.cc=v,e.decryptdata=p,y=!1,m.initSegments[v]=e,c.b.info(`generated implicit initSegment in cc ${v}`)()}else if(u){let e=Object.assign(new w(this.inheritQuery),u);e.cc=v,c.b.info(`assume initSegment from ${u.cc} in cc ${v}`)(),u=m.initSegments[v]=e}R=!1,S=new w(this.inheritQuery)}}else if(r[4]){if(S.rawByteRange=(" "+r[4]).slice(1),T){const e=T.byteRangeEndOffset;e&&(S.lastByteRangeEndOffset=e)}}else if(r[5])S.rawProgramDateTime=(" "+r[5]).slice(1),S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]);else if(r[6]){let e=parseInt(r[6]);isNaN(e)||(b=1e3*e)}else{for(r=r[0].match(at),n=1;n<r.length&&void 0===r[n];n++);let e=ft((" "+r[n+1]).slice(1),_),l=ft((" "+r[n+2]).slice(1),_);if(e.error||l.error){h={type:a.c.MEDIA_ERROR,details:a.a.LEVEL_LOAD_ERROR,fatal:!0,reason:"encountered undefined/not imported EXT-X-DEFINE property",response:a.b.FormatError};break}const g=e.updatedString,T=l.updatedString;switch(r[n]){case"#":S.tagList.push(T?[g,T]:[g]);break;case"PLAYLIST-TYPE":m.type=g.toUpperCase();break;case"MEDIA-SEQUENCE":0===m.fragments.length?f=m.startSN=parseInt(g):c.b.warn(`Ignore MEDIA-SEQUENCE:${g} tag. Must appear before first fragment.`)();break;case"TARGETDURATION":m.targetduration=parseFloat(g);break;case"VERSION":m.version=parseInt(g);break;case"EXTM3U":break;case"ENDLIST":m.live=!1;break;case"DIS":v++,S.tagList.push(["DIS"]),R=!0;break;case"DISCONTINUITY-SEQ":v=parseInt(g);break;case"KEY":let e=g,l=tt.parseTags(e),b=l.METHOD in E?l.METHOD:void 0,L=l.URI,I=l.IV?l.IV:null,A=l.KEYFORMAT,k=(l.KEYFORMATVERSIONS?l.KEYFORMATVERSIONS:"1").split("/").map(Number).filter(isFinite);if(b)if(!y&&this._shouldSelectKeyTag(A,b)){let e;e=L?d.buildAbsoluteURL(t,L,{alwaysNormalize:!0}):t,p=new D(b,e,I,A,k),L&&(l.IV&&!I&&(h={type:a.c.MEDIA_ERROR,details:a.a.MANIFEST_PARSING_ERROR,fatal:!0,url:t,reason:`Invalid IV: ${l.IV}`,response:a.b.PlaylistErrorInvalidEntry}),y=!0)}else c.b.warn(`[Keys] Not selecting EXT-X-KEY tag : ${e}, IsKeySystemSelected: ${y}`)();else c.b.warn(`Invalid EXT-X-KEY tag: ${e}`)();break;case"START":let C=g,P=tt.parseTags(C)["TIME-OFFSET"];isNaN(P)||(m.startTimeOffset=P);break;case"I-FRAMES":m.iframesOnly=!0;break;case"MAP":let M=tt.parseTags(g);S.relurl=M.URI,S.rawByteRange=M.BYTERANGE,S.baseurl=t,S.level=i,S.type=s,S.sn="initSegment",S.levelkey=p,y=!1,S.rawProgramDateTime&&(o=S.rawProgramDateTime),S.cc=v,u=m.initSegments[v]=S,S=new w(this.inheritQuery);break;case"DEFINE":let O=lt.exec(g),N="NAME"===O[1]?O[2]:O[4],x="VALUE"===O[1]?O[2]:O[4],F=O[5],B=O[6];if(N||x||"IMPORT"!==F||!this._masterVariableList.hasOwnProperty(B)){if(!N||F||O[1]===O[3]||_.hasOwnProperty(N)){h={type:a.c.MEDIA_ERROR,details:a.a.MANIFEST_PARSING_ERROR,fatal:!0,reason:"IMPORT references variable not in master playlist and/or NAME ",response:a.b.FormatError};break}_[N]=x}else _[B]=this._masterVariableList[B];break;default:c.b.warn(`line parsed but not handled: ${r}`)()}}}return(S=T)&&!S.relurl&&(m.fragments.pop(),g-=S.duration),m.live||(S.isLastFragment=!0),m.totalduration=g,m.averagetargetduration=g/m.fragments.length,m.endSN=f-1,{levelDetails:m,errorInfo:h}}parseMasterPlaylist(e,t){let i,s,r,n,o=[];for(rt.lastIndex=0;null!=(i=rt.exec(e));)if(i[4]){let e="NAME"===(i=lt.exec(i[4]))[1]?i[2]:i[4],t="VALUE"===i[1]?i[2]:i[4],s=i[5];if(!e||this._masterVariableList.hasOwnProperty(e)||s||i[1]===i[3]){n={type:a.c.MEDIA_ERROR,details:a.a.MANIFEST_PARSING_ERROR,fatal:!0,reason:"invalid EXT-X-DEFINE tag in manifest",response:a.b.FormatError};break}this._masterVariableList[e]=t}else{r=ft(i[1]||i[3],this._masterVariableList);let e=tt.parseTags(r.updatedString);if(s=ft(i[2]||e.URI,this._masterVariableList),r.error||s.error){n={type:a.c.MEDIA_ERROR,details:a.a.MANIFEST_PARSING_ERROR,fatal:!0,reason:"manifest encountered undefined/not imported EXT-X-DEFINE property",response:a.b.FormatError};break}let d=e.BANDWIDTH,h=e["AVERAGE-BANDWIDTH"],u={attrs:e,url:dt(s.updatedString,t,this.inheritQuery),name:e.NAME,audioGroupId:e.AUDIO,iframes:!!i[3],bandwidth:d,avgBandwidth:h,bitrate:h||d,videoRange:e["VIDEO-RANGE"]?e["VIDEO-RANGE"]:"SDR",frameRate:e["FRAME-RATE"],loadError:0,unchangedLevelCount:0,hdcpLevel:e["HDCP-LEVEL"],closedcaption:e["CLOSED-CAPTIONS"]},f=e.RESOLUTION;if(f&&(u.width=f.width,u.height=f.height),e.CODECS){u.videoCodecList=new Array,u.audioCodecList=new Array;let t=e.CODECS.split(/[ ,]+/);var l=t.length;for(let e=0;e<l;e++){const i=t[e];switch(i.slice(0,4)){case"avc1":u.videoCodec=ct(i),u.videoCodecList.push(u.videoCodec);break;case"avc3":case"dvav":case"dva1":case"hev1":case"hvc1":case"dvh1":case"dvhe":u.videoCodec=i,u.videoCodecList.push(u.videoCodec);break;case"mp4a":case"ec-3":case"ac-3":u.audioCodec=i,u.audioCodecList.push(u.audioCodec);break;default:c.b.warn(`Unrecognized codec ${i}`)(),u.audioCodec=i,u.audioCodecList.push(u.audioCodec)}}}o.push(u)}return{levels:o,errorInfo:n}}},pt=class{constructor(e){this.hls=e,this.logger=e.logger,this.loaders={}}destroy(){for(let e in this.loaders){let t=this.loaders[e];t&&t.destroy()}this.loaders={},this.hls=void 0}loadManifest(e,t){if(this.hls)return this.playlistParser=new mt(this.hls.config,this.registerProgramDateTime.bind(this)),this.playlistParser.query=Boolean(t.inheritQuery),new Promise((t,i)=>{this.load(e,{type:"manifest",promise:{resolve:t,reject:i}})});console.warn("loadManifest called without hls object")}retryPlaylistRequest(e){let t=e.loader;const i=new Promise((i,s)=>{t.context.promise={resolve:i,reject:s},e.retrying=t.scheduleRetry()});return e.retrying?i:void 0}isLoadingLevel(e){return this.loaders.level&&this.loaders.level.context&&this.loaders.level.context.level===e}loadLevel(e,t){return new Promise((i,s)=>{this.load(e,{type:"level",level:t,promise:{resolve:i,reject:s}})})}abort(e){let t=this.loaders[e];t&&(t.abort(),this.loaders[e]=void 0)}isLoadingAudioTrack(e){return this.loaders.audioTrack&&this.loaders.audioTrack.context&&this.loaders.audioTrack.context.id===e}loadAudioTrack(e,t){return new Promise((i,s)=>this.load(e,{type:"audioTrack",id:t,promise:{resolve:i,reject:s}}))}isLoadingSubtitleTrack(e){return this.loaders.subtitleTrack&&this.loaders.subtitleTrack.context&&this.loaders.subtitleTrack.context.id===e}loadSubtitleTrack(e,t){return new Promise((i,s)=>{this.load(e,{type:"subtitleTrack",id:t,promise:{resolve:i,reject:s}})})}load(e,t){let i=this.loaders[t.type];if(i){let s=i.context;if(s&&s.url===e&&s.level===t.level)return;this.logger.warn(`abort previous loader for type:${t.type}`)(),i.abort()}let a,r,n=this.hls.config;switch(t.type){case"manifest":a=m.isCustomUrl(e)?n.manifestLoadPolicy.customURL:n.manifestLoadPolicy.default;break;case"level":case"audioTrack":case"subtitleTrack":a=m.isCustomUrl(e)?n.playlistLoadPolicy.customURL:n.playlistLoadPolicy.default,this.logger.info(`[QE Critical] loading playlist for ${t.type} ${t.level||t.id}`)();break;default:return void this.logger.warn(`Load for unexpected type ${t.type}`)()}if(i=this.loaders[t.type]=t.loader=m.isCustomUrl(e)?new m(this.hls):void 0!==n.pLoader?new n.pLoader(n):new n.loader(n),t.url=e,t.responseType="",r={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this),onProgress:this.loadprogress.bind(this)},this.hls&&this.hls.trigger){let e;switch(t.type){case"manifest":e={event:s.a.MANIFEST_LOADING,payload:{url:t.url}};break;case"level":e={event:s.a.LEVEL_LOADING,payload:{url:t.url,level:t.level}};break;case"audioTrack":e={event:s.a.AUDIO_TRACK_LOADING,payload:{url:t.url,id:t.id}};break;case"subtitleTrack":e={event:s.a.SUBTITLE_TRACK_LOADING,payload:{url:t.url,id:t.id}}}e&&this.hls.trigger(e.event,e.payload)}i.load(t,a,r)}get parsedSessionData(){return this.sessionData}registerProgramDateTime(e,t){this.hls.registerProgramDateTime&&this.hls.registerProgramDateTime(e,t)}loadsuccess(e,t,i){var r=e.data,n=e.url,o=i.type,l=i.level,d=this.hls,h=this.playlistParser;if(this.logger.info(`[QE Critical] [Playlist]loadsuccess url/type/level ${this.hls.redactUrl(n)}, ${o}, ${l}`)(),this.loaders[o]=void 0,void 0!==n&&0!==n.indexOf("data:")||(n=i.url),t.tload=performance.now(),mt.isValidPlaylist(r))if(mt.isMediaPlaylist(r)){let e="audioTrack"!==o&&"subtitleTrack"!==o?isNaN(l)?0:l:isNaN(i.id)?0:i.id,{levelDetails:c,errorInfo:u}=h.parseLevelPlaylist(r,n,e,"audioTrack"===o?"audio":"subtitleTrack"===o?"subtitle":"main");if(u)return void d.trigger(s.a.ERROR,u);if(c.tload=t.tload,c.targetduration)switch(c.trequest=t.trequest,o){case"manifest":{c.isInitialMediaPlaylist=!0,d.updatePlaylistAttributes(c);let e={levels:[{url:n,details:c,iframes:c.iframesOnly,bandwidth:void 0,bitrate:void 0,name:void 0,loadError:0,unchangedLevelCount:0}],audioTracks:[],url:n,stats:t,isMediaPlaylist:!0};i.promise.resolve(e);break}case"level":{t.tparsed=performance.now();let{playlistType:s}=d.updatePlaylistAttributes(c);i.promise.resolve({details:c,level:l||0,id:e||0,stats:t,playlistType:s});break}case"audioTrack":case"subtitleTrack":t.tparsed=performance.now(),i.promise.resolve({details:c,id:e,stats:t})}else d.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.MANIFEST_PARSING_ERROR,fatal:!0,url:n,reason:"invalid targetduration",response:a.b.PlaylistErrorBadTargetDuration})}else{let e=h.parseMasterPlaylist(r,n),o=e.levels,l=e.errorInfo;if(l&&d.trigger(s.a.ERROR,l),this.sessionData=mt.parseSessionData(r,n),d.baseurl=n,o.length){let e=h.parseMasterPlaylistMedia(r,n,o),a=e.parsedMasterPlaylistMedia,l=e.errorInfo;l&&d.trigger(s.a.ERROR,l);let c=a.audioTracks,u=a.subtitleTracks,f=a.audioMediaSelectionGroup,g=a.subtitleMediaSelectionGroup,m=!1;if(c.length){let e=!1;c.forEach(t=>{t.url||(e=!0)}),!1===e&&o[0].audioCodec&&!o[0].audioGroupId&&(this.logger.info("audio codec signaled in quality level, but no embedded audio track signaled, create one")(),c.unshift({type:"main",name:"main"}))}i.promise.resolve({levels:o,audioTracks:c,subtitleTracks:u,url:n,stats:t,audioMediaSelectionGroup:f,subtitleMediaSelectionGroup:g,isMediaPlaylist:m})}else d.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.MANIFEST_PARSING_ERROR,fatal:!0,url:n,reason:"no level found in manifest",response:a.b.PlaylistErrorInvalidEntry})}else d.trigger(s.a.ERROR,{type:a.c.NETWORK_ERROR,details:a.a.MANIFEST_PARSING_ERROR,fatal:!0,url:n,reason:"no EXTM3U delimiter",reponse:a.b.PlaylistErrorMissingEXTM3U})}loaderror(e,t){var i,s,r=t.loader;switch(t.type){case"manifest":i=a.a.MANIFEST_LOAD_ERROR,s=!1;break;case"level":i=a.a.LEVEL_LOAD_ERROR,s=!1;break;case"audioTrack":i=a.a.AUDIO_TRACK_LOAD_ERROR,s=!1;break;case"subtitleTrack":i=a.a.SUBTITLE_TRACK_LOAD_ERROR,s=!1}r&&(r.abort(),this.loaders[t.type]=void 0),t.promise.reject({type:a.c.NETWORK_ERROR,details:i,fatal:s,url:t.url,loader:r,response:e,context:t})}loadtimeout(e,t){var i,s,r=t.loader,n=a.b.PlaylistNotReceived;switch(t.type){case"manifest":i=a.a.MANIFEST_LOAD_TIMEOUT,s=!1;break;case"level":i=a.a.LEVEL_LOAD_TIMEOUT,s=!1;break;case"audioTrack":i=a.a.AUDIO_TRACK_LOAD_TIMEOUT,s=!1;break;case"subtitleTrack":i=a.a.SUBTITLE_TRACK_LOAD_TIMEOUT,s=!1}r&&(r.abort(),this.loaders[t.type]=void 0),t.promise.reject({type:a.c.NETWORK_ERROR,details:i,fatal:s,url:t.url,loader:r,response:n,context:t})}loadprogress(e,t,i){var r=t.loader;r&&r.loader&&200===r.loader.status&&(""===r.loader.responseType||"text"===r.loader.responseType)&&i&&i.length>10&&(mt.isValidPlaylist(i)?(this.logger.info("deregister for further progress updates")(),r.callbacks.onProgress=null):(this.logger.error("[Playlist] response doesn't have #EXTM3U tag")(),r.abort(),this.loaders[t.type]=void 0,this.hls.trigger(s.a.ERROR,{type:a.c.NETWORK_ERROR,details:a.a.MANIFEST_PARSING_ERROR,fatal:!0,url:t.url,reason:"response doesnt have #EXTM3U tag",response:a.b.PlaylistErrorMissingEXTM3U})))}},yt=i(9),vt=class{constructor(e){this.hls=e,this.logger=e.logger,this.loaders={}}destroy(){let e=this.loaders;for(let t in e){let i=e[t];i&&i.destroy()}this.loaders={}}loadFragment(e){return new Promise((t,i)=>{let a,r,n,o=e.type,l=this.loaders[o],d=this.hls.config;e.loaded=0,l&&(this.logger.warn(`abort previous fragment loader for type:${o}`)(),l.abort()),l=this.loaders[o]=e.loader=m.isCustomUrl(e.url)?new m(this.hls):void 0!==d.fLoader?new d.fLoader(d):new d.loader(d),a={url:e.url,frag:e,responseType:"arraybuffer",progressData:!1,promise:{resolve:t,reject:i},type:o};let h=e.byteRangeStartOffset,c=e.byteRangeEndOffset;isNaN(h)||isNaN(c)||(a.rangeStart=h,e.byteRange&&e.decryptdata&&"AES-128"===e.decryptdata.method&&("initSegment"===e.sn?c+=(c-h)%16?16-(c-h)%16:16:e.iframe&&(c+=(c-h)%16?16-(c-h)%16:16,h=h>=16?h-16:h,a.rangeStart=h,a.iframe=!0)),a.rangeEnd=c),r=m.isCustomUrl(e.url)?d.fragLoadPolicy.customURL:d.fragLoadPolicy.default,n={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this),onProgress:this.loadprogress.bind(this)},this.hls.trigger(s.a.FRAG_LOADING,{frag:e}),l.load(a,r,n)})}loadsuccess(e,t,r){let n=e.data,o=r.frag;if(!isNaN(e.contentLen)&&e.contentLen!==e.len){let t=`fragment is shorter than expected. content len ${e.contentLen} vs actual len ${e.len}`;return this.logger.error(t)(),void this.loaderror({code:409,text:t},r)}o.loader=void 0,o.loadSuccess=!0,this.loaders[o.type]=void 0,o.decryptdata&&"AES-128"===o.decryptdata.method?(this.segmentDecryptor||(this.segmentDecryptor=new class{constructor(e,t){this.hls=e,this.id=t,this.uriToDecryptingFragments={},this.logger=e.logger,this._onWorkerMessage=this._onWorkerMessage.bind(this),this._ensureHandlerFunc()}_setupInlineHandler(e){return this.observer=new yt.EventEmitter,this.observer.trigger=(e,...t)=>{this.observer.emit(e,e,...t)},this.observer.off=(e,...t)=>this.observer.removeListener(e,...t),this.decryptor=new e.SegmentDecryptorInline(this.observer,this.hls.config),e=>{this.decryptor.decrypt(e.data,e.frag.decryptdata,t=>this._onDecryptComplete(e,t))}}_setupWorkerHandler(e){let t;try{(t=e.createDecryptorWorker()).addEventListener("message",this._onWorkerMessage),t.onerror=e=>this.hls.trigger(s.a.ERROR,{type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!0,event:"decryptorWorker",err:{message:e.message+" ("+e.filename+":"+e.lineno+")"}}),t.postMessage({cmd:"init",id:this.id,config:JSON.stringify(this.hls.config)}),this.worker=t}catch(e){throw t&&URL.revokeObjectURL(t.objectURL),e}return e=>{const i=e.frag.url;if(this.uriToDecryptingFragments[i])return;this.uriToDecryptingFragments[i]=e;const s=e.data,{decryptdata:a}=e.frag;t.postMessage({cmd:"segment-decrypt",fragPayload:s,decryptdata:a,fragObjId:i},[s])}}_genHandlerFunc(){return Promise.resolve().then(i.bind(null,24)).then(e=>{if(this.hls.config.enableWorker&&"undefined"!=typeof Worker)try{return this._setupWorkerHandler(e)}catch(e){this.logger.error("error while initializing SegmentDecryptorWorker, fallback on DecryptorInline")()}return this._setupInlineHandler(e)})}_ensureHandlerFunc(){return this.handlerPromise||(this.handlerPromise=this._genHandlerFunc()),this.handlerPromise}destroy(){return this.handlerPromise?this.handlerPromise.then(()=>this._destroy()):(this._destroy(),Promise.resolve())}_destroy(){this.handlerPromise=null;const{worker:e,decryptor:t,observer:i}=this;e&&(e.removeEventListener("message",this._onWorkerMessage),e.terminate(),this.worker=null),t&&(t.destroy(),this.decryptor=null),i&&(i.removeAllListeners(),this.observer=null)}decrypt(e,t,i,s){const{decryptdata:a}=t,r={frag:t,data:e,stats:i,onComplete:s};return this._ensureHandlerFunc().then(e=>{a.key?e(r):this.logger.error("Decrypt called on fragment without valid key")()})}_onDecryptComplete(e,t){e.onComplete&&e.onComplete({decryptedData:t,frag:e.frag,stats:e.stats,id:this.id})}_onWorkerMessage({data:e}){switch(e.event){case"init":URL.revokeObjectURL(this.worker.objectURL);break;case"segment-decrypted":{const t=this.uriToDecryptingFragments[e.fragObjId];t&&t.onComplete&&(this._onDecryptComplete(t,e.data),delete this.uriToDecryptingFragments[e.fragObjId]);break}}}}(this.hls,"main")),r.iframe&&r.rangeStart&&(o.decryptdata.iv=new Uint8Array(n.slice(0,16)),n=n.slice(16)),this.hls.keyLoader.getKeyFromDecryptData(o.decryptdata,void 0).then(e=>{e&&(o.decryptdata.key=e.key,this.segmentDecryptor.decrypt(n,o,t,e=>{r.promise.resolve({payload:e.decryptedData,frag:e.frag,stats:e.stats})}))}).catch(e=>{})):r.promise.resolve({payload:n,frag:o,stats:t})}loaderror(e,t){let i=this.loaders[t.type];i&&i.abort(),t.promise.reject({type:a.c.NETWORK_ERROR,details:a.a.FRAG_LOAD_ERROR,fatal:!1,frag:t.frag,response:e})}loadtimeout(e,t){let i=this.loaders[t.type];i&&i.abort(),t.promise.reject({type:a.c.NETWORK_ERROR,details:a.a.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t.frag,loader:i,response:a.b.NoResponseFromMediaRequest})}loadprogress(e,t,i){let a=t.frag;a.loaded=e.loaded,this.hls.trigger(s.a.FRAG_LOAD_PROGRESS,{frag:a,stats:e})}};const Tt=12e4;function St(e){return"id"in e}function bt(e){return"bitrate"in e}class _t{constructor(e,t){this.observer=e,this.mediaType=t}destroy(){this.reset()}reset(){this._variantList=[],this._validVariantList=[],this.idToLevelInfoAndPositionMap={},this._penaltyVariantQueue=[],this._penaltyBoxTimer&&(clearTimeout(this._penaltyBoxTimer),this._penaltyBoxTimer=null)}updateIdToLevelInfoMap(){let e=this.validVariantList;this.idToLevelInfoAndPositionMap={};for(let t=0;e&&t<e.length;++t){let i=e[t],s=_t.getUniqueId(i);isNaN(s)?c.b.warn(`variant list doesn't have id: ${s}`)():this.idToLevelInfoAndPositionMap[s]={levelInfo:i,listPosition:t}}}getMediaType(){return this.mediaType}get variantList(){return this._variantList}set variantList(e){this.reset(),this._variantList=this._validVariantList=_t.sortVariants(e),this.updateIdToLevelInfoMap()}get validVariantList(){return this._validVariantList}get penaltyVariantQueue(){return this._penaltyVariantQueue}getVariantInfo(e){return e in this.idToLevelInfoAndPositionMap?this.idToLevelInfoAndPositionMap[e].levelInfo:void 0}getVariantListPosition(e){return e in this.idToLevelInfoAndPositionMap?this.idToLevelInfoAndPositionMap[e].listPosition:void 0}moveAllMatchingHostsToPenaltyBoxOrRemovePermanently(e,t){if(!(e in this.idToLevelInfoAndPositionMap))return;let i=this.idToLevelInfoAndPositionMap[e].levelInfo,s=d.getHostName(i.url),a=[],r=performance.now()+Tt;for(let i=0;i<this._validVariantList.length;i++){let n=this._validVariantList[i],o=n.url;_t.getUniqueId(n)!==e&&o.includes(s)?t||this._penaltyVariantQueue.push({penaltyCompletionTime:r,levelInfo:n}):a.push(n)}this._validVariantList=a,this.updateIdToLevelInfoMap()}addLevelToPenaltyBox(e){if(!(e in this.idToLevelInfoAndPositionMap))return;let t=this.idToLevelInfoAndPositionMap[e],i=t.levelInfo,s=t.listPosition,a=0===this._penaltyVariantQueue.length,r=performance.now()+Tt;this._penaltyVariantQueue.push({penaltyCompletionTime:r,levelInfo:i}),this._validVariantList.splice(s,1),this.updateIdToLevelInfoMap(),a&&this.setOrResetPenaltyBoxTimer(Tt),this.triggerLevelChangeEvent(!1)}removeLevelPermanentlyInternal(e){if(!(e in this.idToLevelInfoAndPositionMap))return;let t=this.idToLevelInfoAndPositionMap[e].listPosition;this._validVariantList.splice(t,1),this.updateIdToLevelInfoMap()}removeLevelPermanently(e){this.removeLevelPermanentlyInternal(e),this.triggerLevelChangeEvent(!1)}removeAllMatchingHDCPLevelsPermanently(e){if(!(e in this.idToLevelInfoAndPositionMap))return;const t=this.idToLevelInfoAndPositionMap[e].levelInfo;let i;if(!bt(t))return;let s=(i=t).hdcpLevel,a=!1;if(void 0===s)this.removeLevelPermanentlyInternal(e),a=!0;else{let e=this.validVariantList.filter(e=>{let t=bt(e)?e.hdcpLevel:void 0;return!t||t!==s});(a=e.length!==this.validVariantList.length)&&(this._validVariantList=e,this.updateIdToLevelInfoMap())}a&&this.triggerLevelChangeEvent(!1)}handlePenaltyBoxTimer(){let e=performance.now(),t=!1;for(;this._penaltyVariantQueue.length>0&&this._penaltyVariantQueue[0].penaltyCompletionTime<=e;){let e=this._penaltyVariantQueue.shift();this._validVariantList.push(e.levelInfo),t=!0}if(this._penaltyVariantQueue.length>0){let e,t;t=(e=this._penaltyVariantQueue[0].penaltyCompletionTime)-performance.now(),this.setOrResetPenaltyBoxTimer(t)}else this._penaltyBoxTimer=null;t&&(_t.sortVariants(this._validVariantList),this.updateIdToLevelInfoMap(),this.triggerLevelChangeEvent(!1))}setOrResetPenaltyBoxTimer(e){this._penaltyBoxTimer&&(clearTimeout(this._penaltyBoxTimer),this._penaltyBoxTimer=null),this._penaltyBoxTimer=setTimeout(this.handlePenaltyBoxTimer.bind(this),e)}triggerLevelChangeEvent(e){if(this.observer)if(this.mediaType===Qe.VIDEO){let t={requiresReset:e};this.observer.trigger(s.a.LEVELS_CHANGED,t)}else this.mediaType===Qe.AUDIO&&this.observer.trigger(s.a.AUDIO_TRACKS_UPDATED,{audioTracks:this._validVariantList})}isVariantValid(e){return e>=0&&void 0!==this.getVariantInfo(e)}static sortVariants(e){return e.sort((function(e,t){return bt(e)&&bt(t)?e.bitrate-t.bitrate:St(e)&&St(t)?e.id-t.id:1})),e}static getUniqueId(e){let t=NaN;return bt(e)?t=e.persistentId:St(e)&&(t=e.id),t}}var Et,Rt,Dt,Lt=_t;!(function(e){e[e.DoNothing=0]="DoNothing",e[e.SendEndCallback=1]="SendEndCallback",e[e.SendAlternateToPenaltyBox=2]="SendAlternateToPenaltyBox",e[e.RemoveAlternatePermanently=3]="RemoveAlternatePermanently",e[e.InsertDiscontinuity=4]="InsertDiscontinuity",e[e.RetryRequest=5]="RetryRequest",e[e.DefaultToSDR=6]="DefaultToSDR",e[e.AbortRequest=7]="AbortRequest",e[e.RemoveAllMatchingHDCPLevelsPermanently=8]="RemoveAllMatchingHDCPLevelsPermanently"})(Et||(Et={})),(function(e){e[e.MoveAllAlternatesMatchingHost=2]="MoveAllAlternatesMatchingHost",e[e.RemoveAllAlternatesPermanentlyMatchingHost=4]="RemoveAllAlternatesPermanentlyMatchingHost"})(Rt||(Rt={})),(function(e){e.FRAG_LOAD_ERROR="FRAG_LOAD_ERROR",e.PLAYLIST_LOAD_ERROR="PLAYLIST_LOAD_ERROR",e.FRAG_LOAD_TIMEOUT="FRAG_LOAD_TIMEOUT",e.PLAYLIST_LOAD_TIMEOUT="PLAYLIST_LOAD_TIMEOUT",e.KEY_LOAD="KEY_LOAD",e.MEDIA_ERROR="MEDIA_ERROR"})(Dt||(Dt={}));var It=class extends P{constructor(e){super(e,s.a.FRAG_LOADED),this.hls=e,this.consecutiveSendAlternateToPenaltyBox=new Map,this.consecutiveSendAlternateToPenaltyBox.set(Qe.VIDEO,{val:0}),this.consecutiveSendAlternateToPenaltyBox.set(Qe.AUDIO,{val:0}),this.consecutiveSendAlternateToPenaltyBox.set(Qe.SUBTITLE,{val:0})}destroy(){P.prototype.destroy.call(this)}_modifyErrorActionIfLastValidVariantInternal(e,t){switch(e){case Et.SendAlternateToPenaltyBox:e=Et.RetryRequest,401!==t&&403!==t&&407!==t||(e=Et.SendEndCallback);break;case Et.RemoveAlternatePermanently:e=Et.SendEndCallback}return e}_modifyErrorActionIfCurrentLevelIsLastValidLevel(e,t,i,s){let a=this.hls.levelController.haveFallbackVariant(),r=e;if(!a){if(e=this._modifyErrorActionIfLastValidVariantInternal(e,i),s){let t=this.hls.levelController.isCurrentLevelNonSDR(),i=this.hls.hasPlaybackEverStarted;s&&!i&&t&&(e=Et.DefaultToSDR)}t=0,this.logger.info(`fallbackVariantAvailable ${a} changing action from ${r} to ${e}`)()}return{errorAction:e,errorActionFlags:t}}_modifyErrorActionIfCurrentTrackIsLastValidTrack(e,t,i,s){let a;return s.haveFallbackVariant()||(e=a=this._modifyErrorActionIfLastValidVariantInternal(e,i),t=0),{errorAction:e,errorActionFlags:t}}_modifyErrorActionManifest(e){return this._modifyErrorActionIfLastValidVariantInternal(e)}_modifyErrorActionIfCurrentLevelIsLastValidiFrameLevel(e,t){return this.hls.levelController.haveFallbackVariant()||(e=Et.AbortRequest,t=0),{errorAction:e,errorActionFlags:t}}_getActionForCommonNetworkError(e){let t,i;switch(e){case 500:case 502:case 503:case 504:case 404:case 409:case 401:case 403:case 407:case-12888:case-12884:t=Et.SendAlternateToPenaltyBox,i=Rt.MoveAllAlternatesMatchingHost;break;case 410:t=Et.RemoveAlternatePermanently,i=Rt.RemoveAllAlternatesPermanentlyMatchingHost;break;default:t=Et.SendAlternateToPenaltyBox,i=0}return{errorAction:t,errorActionFlags:i}}_findAlternateHost(e,t){let i,s,a=this.hls.preferredHostName,r=e.validVariantList,n=e.getVariantInfo(t),o=e.getMediaType()===Qe.VIDEO;for(let e=0;e<r.length;e++){let t=r[e],l=d.getHostName(t.url);if(o){if(bt(n)&&bt(t)&&n.bandwidth===t.bandwidth&&a!==l&&this.hls.isValidCDN(l)){i=t,s=l;break}}else if(St(n)&&St(t)&&n.persistentID===t.persistentID&&a!==l&&this.hls.isValidCDN(l)){i=t,s=l;break}}return this.hls.removeCDNFromWhiteList(a),i?(this.logger.warn(`Backup host found, switching from ${a} to ${s}`)(),this.hls.preferredHostName=s,o&&bt(i)?i.persistentId:St(i)?i.id:void 0):NaN}getActionForPlaylistNetworkError(e,t,i){let s=this._getActionForCommonNetworkError(e.code),r=s.errorAction,n=s.errorActionFlags;return t===a.a.LEVEL_LOAD_ERROR||t===a.a.LEVEL_LOAD_TIMEOUT?(r=(s=this._modifyErrorActionIfCurrentLevelIsLastValidLevel(r,n,e.code,!0)).errorAction,n=s.errorActionFlags):t===a.a.AUDIO_TRACK_LOAD_ERROR||t===a.a.AUDIO_TRACK_LOAD_TIMEOUT||t===a.a.SUBTITLE_TRACK_LOAD_ERROR||t===a.a.SUBTITLE_TRACK_LOAD_TIMEOUT?(r=(s=this._modifyErrorActionIfCurrentTrackIsLastValidTrack(r,n,e.code,i)).errorAction,n=s.errorActionFlags):t!==a.a.MANIFEST_LOAD_ERROR&&t!==a.a.MANIFEST_LOAD_TIMEOUT||(r=this._modifyErrorActionManifest(r),n=0),this.logger.info(`Got playlist error ${e.code} ${e.text}, errorAction ${r}`)(),{errorAction:r,errorActionFlags:n}}getActionForMediaFragNetworkError(e,t){let i=e.response,s=e.frag,a=this._getActionForCommonNetworkError(i.code),r=a.errorAction,n=a.errorActionFlags;return"audio"===s.type||"subtitle"===s.type?(r=(a=this._modifyErrorActionIfCurrentTrackIsLastValidTrack(r,n,i.code,t)).errorAction,n=a.errorActionFlags):"main"!==s.type||s.iframe&&("initSegment"!==s.sn||this.hls.iframeMode)?"main"===s.type&&(s.iframe||"initSegment"===s.sn&&this.hls.iframeMode)&&(r=(a=this._modifyErrorActionIfCurrentLevelIsLastValidiFrameLevel(r,n)).errorAction,n=a.errorActionFlags):(r=(a=this._modifyErrorActionIfCurrentLevelIsLastValidLevel(r,n,i.code,!0)).errorAction,n=a.errorActionFlags),e.errorAction=r,{errorAction:r,errorActionFlags:n}}getActionForFragNetworkError(e,t){return e.details===a.a.FRAG_LOAD_ERROR?this.getActionForMediaFragNetworkError(e,t):this._getActionForLoadTimeout(e,t)}getActionForCryptKeyNetworkError(e,t,i){let s,a=Boolean(e.stats&&e.stats.isOkToRetry),r=Boolean(e.keyErrorReason&&e.keyErrorReason===ge.OutputRestricted),n=Et.DoNothing,o=0;return n=r?Et.RemoveAllMatchingHDCPLevelsPermanently:a?i?Et.SendAlternateToPenaltyBox:(s=this._getActionForCommonNetworkError(e.response.code)).errorAction:Et.RemoveAlternatePermanently,t&&(n=(s=this._modifyErrorActionIfCurrentLevelIsLastValidLevel(n,o,e.response.code,!1)).errorAction,o=s.errorActionFlags),this.logger.info(`Got crypt key error isCurrentLevel=${t} isTimeout=${i}, errorAction ${n}`)(),{errorAction:n,errorActionFlags:o}}getActionForSessionDataNetworkError(){return Et.DoNothing}handleError(e,t,i,s,a,r,n){let o,l;switch(a){case Dt.KEY_LOAD:l=this._handleKeyNetworkError(e,i,r,n);break;case Dt.MEDIA_ERROR:n.haveFallbackVariant()&&(l=this.handleNetworkError(Et.SendAlternateToPenaltyBox,0,e,i,void 0,r,n))}if(r)if(r.validVariantList&&0!==r.validVariantList.length){if(l&&!l.errorHandled)if(o=n.getNextBestAutoVariant(i),-1===n.manualLevel&&o)this.logger.warn(`level controller,${e.details}: switch to next best level for next fragment`)(),n.setNextAutoVariant(o);else{let t=n.playTillEndOfBufferAndRetry(this.hls.media);e.retrying=t.retry,e.fatal=t.fatal}}else this.logger.error("No more variants left after error handling")(),e.fatal=!0,l.errorHandled=!0}_handleKeyNetworkError(e,t,i,s){let r;r=this.getActionForCryptKeyNetworkError(e,t===s.currentVariantId,e.details===a.a.KEY_LOAD_TIMEOUT);let n=this.hls.keyLoader;return this.handleNetworkError(r.errorAction,r.errorActionFlags,e,t,s.attemptToRetryRequest.bind(s,e,t,{tfirstissue:e.stats.tfirstissue,tlastissue:e.stats.tlastissue,retryCount:e.stats.failCount-1},Et.SendAlternateToPenaltyBox,n.getKeyFromDecryptData.bind(n,e.decryptdata,t,!1,!0)),i,s)}_findNextVariant(e,t,i,s,a,r){let n,o=!0;return e&&!t&&(a.moveAllMatchingHostsToPenaltyBoxOrRemovePermanently(s,i),n=this._findAlternateHost(a,s)),isNaN(n)&&(n=r.getNextBestAutoVariant(s),o=!1),{nextVariantId:n,foundBackup:o}}handleNetworkError(e,t,i,r,n,o,l){let d,h=!0,c=i.details;switch(isNaN(r)&&c!==a.a.MANIFEST_LOAD_ERROR&&this.logger.warn(`invalid variantId:${r}, could be ignoring error details:${c}`)(),e){case Et.SendAlternateToPenaltyBox:{if(isNaN(r))break;let e,n,d,h,c=0!=(t&Rt.MoveAllAlternatesMatchingHost)&&this.hls.hasFallBack(),u=m.isCustomUrl(o.getVariantInfo(r).url);if(i.details===a.a.FRAG_LOAD_TIMEOUT||i.details===a.a.LEVEL_LOAD_TIMEOUT||i.details===a.a.AUDIO_TRACK_LOAD_TIMEOUT||i.details===a.a.SUBTITLE_TRACK_LOAD_TIMEOUT)if(e=this._getMediaTypeFourCC(i),this.consecutiveSendAlternateToPenaltyBox.get(e).val<this.hls.config.maxNumAddLevelToPenaltyBox)this.consecutiveSendAlternateToPenaltyBox.get(e).val++;else if(this.consecutiveSendAlternateToPenaltyBox.get(e).val>=this.hls.config.maxNumAddLevelToPenaltyBox)break;d=(n=this._findNextVariant(c,u,!1,r,o,l)).nextVariantId,(h=n.foundBackup)&&c&&this.hls.trigger(s.a.PREFERRED_HOST_CHANGED,o.getMediaType()),o.addLevelToPenaltyBox(r),l.setNextAutoVariant(d),this.hls.iframeMode&&(l.manualLevel=d);break}case Et.RemoveAlternatePermanently:{if(isNaN(r))break;let e,i,a,n=0!=(t&Rt.RemoveAllAlternatesPermanentlyMatchingHost)&&this.hls.hasFallBack(),d=m.isCustomUrl(o.getVariantInfo(r).url);i=(e=this._findNextVariant(n,d,!0,r,o,l)).nextVariantId,(a=e.foundBackup)&&n&&this.hls.trigger(s.a.PREFERRED_HOST_CHANGED,o.getMediaType()),o.removeLevelPermanently(r),l.setNextAutoVariant(i),this.hls.iframeMode&&(l.manualLevel=i);break}case Et.RemoveAllMatchingHDCPLevelsPermanently:isNaN(r)||o.removeAllMatchingHDCPLevelsPermanently(r);break;case Et.RetryRequest:n?d=n():h=!1;break;case Et.AbortRequest:l.abortiFrameFragRequest(i);break;case Et.SendEndCallback:i.fatal=!0;break;case Et.DefaultToSDR:(h=l.resetAndLoadSDRLevels())||(this.hls.trigger(s.a.ERROR,{type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!0,url:this.hls.url,reason:"no valid alternates found in fallback",response:a.b.NoValidAlternates}),h=!0);break;case Et.DoNothing:default:h=!1}return{errorHandled:h,retryPromise:d}}_getActionForLoadTimeout(e,t){let i,s;return e.details!==a.a.MANIFEST_LOAD_TIMEOUT&&t.haveFallbackVariant()||(i=!0),{errorAction:s=i?Et.RetryRequest:Et.SendAlternateToPenaltyBox,errorActionFlags:0}}_getMediaTypeFourCC(e){let t,i;switch("frag"in e?i=e.frag.type:"type"in e.context&&(i=e.context.type),i){case"level":case"main":t=Qe.VIDEO;break;case"audioTrack":case"audio":t=Qe.AUDIO;break;case"subtitleTrack":case"subtitle":t=Qe.SUBTITLE;break;default:t=Qe.UNKNOWN}return t}onFragLoaded(e){let t=this._getMediaTypeFourCC(e);this.consecutiveSendAlternateToPenaltyBox.get(t).val=0}},At=function(e,t){let i,s,a=0,r=e.length-1;for(;a<=r;){let n=t(s=e[i=(a+r)/2|0]);if(n>0)a=i+1;else{if(!(n<0))return s;r=i-1}}return null};const kt={isBuffered:function(e,t){if(e){let i=e.buffered;for(let e=0;i&&e<i.length;e++)if(t>=i.start(e)&&t<=i.end(e))return!0}return!1},bufferInfo:function(e,t,i){if(e){var s=this.buffered(e);return this.bufferedInfo(s,t,i)}return{len:0,start:t,end:t,nextStart:void 0}},buffered:function(e){var t=[];if(e){var i,s=e.buffered;for(t=[],i=0;s&&i<s.length;i++)t.push({start:s.start(i),end:s.end(i)})}return t},subtitleBufferInfo:function(e,t,i){if(e){var s=this.bufferedCues(e);return this.bufferedInfo(s,t,i)}return{len:0,start:t,end:t,nextStart:void 0}},bufferedCues:function(e){var t,i=[];if(e)for(i=[],t=0;t<e.length;t++)i.push({start:e[t].startTime,end:e[t].endTime});return i},bufferedInfo:function(e,t,i){var s,a,r,n,o,l=[];for(e.sort((function(e,t){return e.start-t.start||t.end-e.end})),o=0;o<e.length;o++){var d=l.length;if(d){var h=l[d-1].end;e[o].start-h<i?e[o].end>h&&(l[d-1].end=e[o].end):l.push(e[o])}else l.push(e[o])}for(o=0,s=0,a=r=t;o<l.length;o++){var c=l[o].start,u=l[o].end;if(t+i>=c&&t<u)a=c,s=(r=u)-t;else if(t+i<c){n=c;break}}return{len:s,start:a,end:r,nextStart:n}},toRangeString:e=>`[${e.start.toFixed(3)},${e.end.toFixed(3)}]`,canContinuePlaybackWithoutGap(e,t,i,s,a){if("LIVE"!==s)return!0;if(!e||!a||!a.PTSKnown)return!1;let r=performance.now()+(a.tload-a.trequest);return a.fragments[0].start+(r-a.tload)/1e3<=kt.bufferInfo(e,t,i).end}};var Ct,wt,Pt,Mt=kt;!(function(e){e.AlmostDryWaterLevel="AlmostDryWaterLevel",e.LowWaterLevel="LowWaterLevel",e.HighWaterLevel="HighWaterLevel"})(Ct||(Ct={})),(function(e){e.VideoAudio="VideoAudio",e.Video="Video",e.Audio="Audio",e.Subtitle="Subtitle"})(wt||(wt={}));class Ot extends P{constructor(e,t,i,a,r,n,o,l){super(e,s.a.DESIRED_RATE_CHANGED),this.media=t,this.getEstimatedWaterLevel=i,this.bufferMonitorType=a,this.maxBufferHole=r,this.almostDryWaterLevelSeconds=l,this._maxBufferSeconds=n,this._targetDuration=o,this.listenerMap={seeking:this.stopBufferMonitor.bind(this),seeked:this.startBufferMonitor.bind(this)},this.addListeners()}destroy(){this.removeListeners(),this.stopBufferMonitor(),this.media=null,this.listenerMap=null,this.getEstimatedWaterLevel=null,super.destroy()}addListeners(){let e=this.media;if(e)for(let t in this.listenerMap){let i=this.listenerMap[t];e.addEventListener(t,i)}}removeListeners(){let e=this.media;if(e&&this.listenerMap)for(let t in this.listenerMap){let i=this.listenerMap[t];e.removeEventListener(t,i)}}set targetDuration(e){this._targetDuration!==e&&(this._targetDuration=e,this.startBufferMonitor())}get targetDuration(){return this._targetDuration}set maxBufferSeconds(e){this._maxBufferSeconds!==e&&(this._maxBufferSeconds=e,this.startBufferMonitor())}get maxBufferSeconds(){return this._maxBufferSeconds}notifyWaterLevelChanged(){this.startBufferMonitor()}get highWaterLevelSeconds(){return this.maxBufferSeconds-this.targetDuration}get lowWaterLevelSeconds(){return this.targetDuration}onDesiredRateChanged(e){const t=e.oldRate,i=e.newRate;t!==i&&(0===t?this.startBufferMonitor():0===i&&this.stopBufferMonitor())}stopBufferMonitor(){clearTimeout(this.bufferChangeTimer)}startBufferMonitor(){let e=this.media;if(this.stopBufferMonitor(),!this.hls||!e||e.paused||e.seeking)return void this.logger.info("Not arming buffer monitor")();let t,i,s=e.currentTime,a=this.getEstimatedWaterLevel();if(a>this.highWaterLevelSeconds)t=this.highWaterLevelSeconds,i=Ct.HighWaterLevel;else if(a>this.lowWaterLevelSeconds)t=this.lowWaterLevelSeconds,i=Ct.LowWaterLevel;else{if(!(a>this.almostDryWaterLevelSeconds))return void this.logger.info(`Not arming buffer monitor buffer:${a}s @${s}`)();t=this.almostDryWaterLevelSeconds,i=Ct.AlmostDryWaterLevel}let r=1e3*(a-t);this.bufferChangeTimer=setTimeout(this.checkBufferLevel.bind(this,t,i),r)}checkBufferLevel(e,t){this.media,this.getEstimatedWaterLevel()<=e&&(this.logger.info(`buffer fell below ${t}`)(),this.hls.trigger(s.a.BUFFER_CHANGED,{reason:t,bufferType:this.bufferMonitorType})),this.startBufferMonitor()}}!(function(e){e.LowBuffer="LowBuffer",e.HighBuffer="HighBuffer",e.Seek="Seek"})(Pt||(Pt={}));const Nt={getIframeStartMediaTime:function(e,t,i,s){return Nt.getIframeMediaTime(e.start+(s>1?0:e.duration),t,i,s)},getIframeEndMediaTime:function(e,t,i,s){return Nt.getIframeMediaTime(e.start+(s<0?0:e.duration),t,i,s)},getIframeMediaTime:function(e,t,i,s){return(e-i)/s+t},getIframeRealTime:function(e,t,i,s){return((e=Math.max(e,t))-t)*s+i}};var xt=Nt,Ft={findFragmentBySNAndBuffer:function(e,t,i=0,s=0,a=0){let r;const n=e?t[e.sn-t[0].sn+1]:null;return i<s?(i>s-a&&(a=0),r=n&&!this.fragmentWithinToleranceTest(i,a,n)?n:At(t,this.fragmentWithinToleranceTest.bind(null,i,a))):r=t[t.length-1],r},fragmentWithinToleranceTest:function(e,t,i){let s=Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-s<=e?1:i.start-s>e&&i.start?-1:0},startFragmentInCC(e,t,i){let s=t-i.cc;if(0===s){let t=e[i.sn-e[0].sn-1];s=t&&t.cc===i.cc?-1:0}return s},endFragmentInCC(e,t,i){let s=t-i.cc;if(0===s){let t=e[i.sn-e[0].sn+1];s=t&&t.cc===i.cc?1:0}return s},findStartEndFragmentsInCC:function(e,t){let i,s;return e&&e.length>0&&void 0!==t&&(i=At(e,this.startFragmentInCC.bind(null,e,t)),s=At(e,this.endFragmentInCC.bind(null,e,t))),i&&isNaN(i.cc)&&(i=void 0),s&&isNaN(s.cc)&&(s=void 0),[i,s]},getTimeRangeForCC:function(e,t){let i=this.findStartEndFragmentsInCC(e,t),s=i[0],a=i[1],r=[];return s&&a&&(r=[s.startPTS?s.startPTS:s.start,a.endPTS?a.endPTS:a.start+a.duration]),r},_fragmentMediaTimeTest(e,t,i,s,a){let r=xt.getIframeStartMediaTime(a,t,i,s),n=s>1?1:-1;return xt.getIframeEndMediaTime(a,t,i,s)<=e?n:r>e?-1*n:0},findNextIframe:function(e,t,i,s,a,r){let n;if(e&&e.iframe){let o=i>1?1:-1,l=Math.max(0,Math.min(e.sn-r[0].sn+o,r.length-1));if(e.sn!==r[l].sn)do{if(n=r[l],xt.getIframeStartMediaTime(n,s,a,i)>=t)break;l+=o}while(l>0&&l<r.length)}else n=At(r,this._fragmentMediaTimeTest.bind(this,t,s,a,i));return n}};class Bt extends yt.EventEmitter{trigger(e,...t){this.emit(e,e,...t)}}var Ut=class{constructor(e,t){this.hls=e,this.logger=e.logger,this.id=t,this.typeSupported={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:MediaSource.isTypeSupported('audio/mp4; codecs="ac-3"'),ec3:MediaSource.isTypeSupported('audio/mp4; codecs="ec-3"')},this.onWorkerMessage=this.onWorkerMessage.bind(this),this._ensureHandlerFunc()}_setupInlineHandler(e){const t=this.observer=new Bt;t.trigger=(e,...i)=>t.emit(e,e,...i),t.off=(e,...i)=>t.removeListener(e,...i);const i=(e,t)=>this.onWorkerMessage({data:{event:e,data:t}});[s.a.FRAG_DECRYPTED,s.a.FRAG_PARSING_INIT_SEGMENT,s.a.FRAG_PARSING_DATA,s.a.FRAG_PARSED,s.a.ERROR,s.a.FRAG_PARSING_METADATA,s.a.FRAG_PARSING_USERDATA,s.a.FRAG_PARSING_CAPTIONDATA,s.a.INIT_PTS_FOUND].forEach(e=>t.on(e,i));const a=this.demuxer=new e.DemuxerInline(t,this.typeSupported,this.hls.config,navigator.vendor);return a.push.bind(a)}_setupWorkerHandler(e){const{vendor:t}=navigator;let i;this.logger.info("demuxing in webworker")();try{(i=e.createDemuxerWorker()).addEventListener("message",this.onWorkerMessage),i.onerror=e=>this.hls.trigger(s.a.ERROR,{type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!0,event:"demuxerWorker",err:{message:e.message+" ("+e.filename+":"+e.lineno+")"},response:a.b.InternalError}),i.postMessage({cmd:"init",typeSupported:this.typeSupported,vendor:t,id:this.id,config:JSON.stringify(this.hls.config),options:{streamID:this.hls.streamID,sessionID:this.hls.sessionID}}),this.worker=i}catch(e){throw i&&URL.revokeObjectURL(i.objectURL),e}return(e,t,s,a,r,n,o,l,d,h,c,u,f,g)=>{i.postMessage({cmd:"demux",data:e,decryptdata:t,initSegment:s,audioCodec:a,videoCodec:r,timeOffset:n,discontinuity:o,trackSwitch:l,contiguous:d,duration:h,accurateTimeOffset:c,defaultInitPTS:u,iframeMediaStart:f,iframeDuration:g},[e])}}_genHandlerFunc(){return Promise.resolve().then(i.bind(null,24)).then(e=>{if(this.hls.config.enableWorker&&"undefined"!=typeof Worker)try{return this._setupWorkerHandler(e)}catch(e){this.logger.error("error while initializing DemuxerWorker, fallback on DemuxerInline")()}return this._setupInlineHandler(e)})}_ensureHandlerFunc(){return this.handlerPromise||(this.handlerPromise=this._genHandlerFunc()),this.handlerPromise}destroy(){this.handlerPromise?this.handlerPromise.then(()=>{this._destroy()}):this._destroy()}_destroy(){this.handlerPromise=null;const{worker:e,demuxer:t,observer:i}=this;e&&(e.removeEventListener("message",this.onWorkerMessage),e.terminate(),this.worker=null),t&&(t.destroy(),this.demuxer=null),i&&(i.removeAllListeners(),this.observer=null)}push(e,t,i,s,a,r,n,o){this._ensureHandlerFunc().then(l=>{const d=void 0!==a.startDTS?a.startDTS:a.start,h=a.decryptdata,c=this.frag,u=!(c&&a.cc===c.cc),f=!(c&&a.level===c.level),g=c&&"number"==typeof c.sn&&a.sn===c.sn+1,m=!f&&g,p=void 0!==a.iframeMediaStart?a.iframeMediaStart:void 0,y=void 0!==a.iframeMediaDuration?a.iframeMediaDuration:void 0;this.frag=a,this.iframeMediaStart=p,this.accurateTimeOffset=n,l(e,h,t,i,s,d,u,f,m,r,n,o,p,y)})}isValidFragParsingData(e,t,i,s){let a,r;isNaN(s)?i?(r=void 0!==e.startDTS?e.startDTS:e.start,Math.abs(t.startDTS-r)>.5&&this.logger.warn(`Significant DTS drift vs playlist startDTS=${t.startDTS} expectedDTS=${r}`)(),a=e.duration):this.logger.warn(`accurateTimeOffset==false, bypass DTS check startDTS==${t.startDTS}`)():(r=s,a=.01);const n=t.startPTS>=0&&t.startDTS>=0&&e.duration>0&&(isNaN(t.endPTS)||t.endDTS>t.startDTS)&&(isNaN(t.endDTS)||t.endPTS>t.startPTS)&&(void 0===r||void 0!==a&&Math.abs(t.startDTS-r)<=a);if(!n){const i=isNaN(t.endPTS)?"undefined":t.endPTS.toFixed(3),s=isNaN(t.endDTS)?"undefined":t.endDTS.toFixed(3),n=void 0===r?"undefined":r.toFixed(3);this.logger.error(`${t.type}: ${e.type} frag ${e.sn} failed demuxer sanity check PTS:[${t.startPTS.toFixed(3)},${i}] DTS:[${t.startDTS.toFixed(3)},${s}] expectedStartDTS=${n} dur=${e.duration.toFixed(3)} iframe=${e.iframe} fudge=${a}`)()}return n}onWorkerMessage({data:e}){const{hls:t}=this;let i,{event:r}=e,n=Object.assign(Object.assign({},e.data),{id:this.id,frag:this.frag});switch(r){case"init":return void(this.worker&&URL.revokeObjectURL(this.worker.objectURL));case s.a.FRAG_PARSING_DATA:{e.data1&&(n.data1=new Uint8Array(e.data1)),e.data2&&(n.data2=new Uint8Array(e.data2));const{frag:t}=this;!this.isValidFragParsingData(t,n,this.accurateTimeOffset,this.iframeMediaStart)&&isNaN(this.iframeMediaStart)&&(r=s.a.ERROR,i={type:a.c.MEDIA_ERROR,details:a.a.FRAG_PARSING_ERROR,fatal:!1,reason:"Failed demuxer sanity check"});break}}t.trigger(r,i||n)}};const Vt={mergeDetails:function(e,t){var i,s=Math.max(e.startSN,t.startSN)-t.startSN,a=Math.min(e.endSN,t.endSN)-t.startSN,r=t.startSN-e.startSN,n=e.fragments,o=t.fragments,l=0;for(let e=s;e<=a;++e)if(n[r+e]&&o[e]){l=n[r+e].cc-o[e].cc;break}e.initSegments=e.initSegments||{},t.initSegments=t.initSegments||{};let d={};for(let s in o){let a=n[r+s],h=o[s],u=h.cc+l;t.initSegments[h.cc]&&(d[u]=t.initSegments[h.cc],d[u].cc=u,e.initSegments[u]&&(d[u].data=e.initSegments[u].data)),h.cc=u,a&&!isNaN(a.startPTS)&&(h.sn===a.sn?(h.start=h.startPTS=a.startPTS,h.endPTS=a.endPTS,h.duration=a.duration,h.backtracked=a.backtracked,h.dropped=a.dropped,i=h):c.b.warn(`mismatch in sn during merge newFrag.sn: ${h.sn} vs oldFrag.sn: ${a.sn}`)())}if(t.initSegments=d,i)Vt.updateFragPTSDTS(t,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS);else if(r>=0&&r<n.length){var h=n[r].start;for(let e in o)o[e].start+=h}t.PTSKnown=s<=a&&Boolean(e.PTSKnown)},getExpiredFragmentsRange:function(e,t){var i,s,a=Math.max(e.startSN,t.startSN)-t.startSN,r=Math.min(e.endSN,t.endSN)-t.startSN,n=t.startSN-e.startSN,o=e.fragments;return r<a&&o.length>0&&!isNaN(a)?(i=o[a].start,s=o[o.length-1].start+o[o.length-1].duration):n&&o.length>0&&!isNaN(a)&&!isNaN(n)&&(i=o[a].start,s=o[a+n-1].start+o[a+n-1].duration),{start:i,end:s}},updateFragPTSDTS:function(e,t,i,s,a,r){if(!isNaN(t.startPTS)){let e=Math.abs(t.startPTS-i);isNaN(t.deltaPTS)?t.deltaPTS=e:t.deltaPTS=Math.max(e,t.deltaPTS),i=Math.min(i,t.startPTS),s=Math.max(s,t.endPTS),a=Math.min(a,t.startDTS),r=Math.max(r,t.endDTS)}const n=i-t.start;t.start=t.startPTS=i,t.endPTS=s,t.startDTS=a,t.endDTS=r,t.duration=s-i;const o=t.sn;if(!e||o<e.startSN||o>e.endSN)return 0;let l=o-e.startSN,d=e.fragments,h=d[l];t!==h&&(c.b.warn(`frag may be copy input:${JSON.stringify(t,["level","id","sn","cc"])} details:${JSON.stringify(h,["level","id","sn","cc"])}`)(),h.start=t.start,h.endPTS=t.endPTS,h.startPTS=t.startPTS,h.startDTS=t.startDTS,h.endDTS=t.endDTS,h.duration=t.duration,h.deltaPTS=t.deltaPTS);for(let e=l;e>0;e--)Vt.updatePTS(d,e,e-1);for(let e=l;e<d.length-1;e++)Vt.updatePTS(d,e,e+1);return e.PTSKnown=!0,n},updatePTS:function(e,t,i){var s=e[t],a=e[i],r=a.startPTS;isNaN(r)?a.start=i>t?s.start+s.duration:Math.max(s.start-a.duration,0):i>t?(s.duration=r-s.start,s.duration<0&&c.b.warn(`negative duration computed for frag ${s.sn},level ${s.level}, there should be some duration drift between playlist and fragment!`)()):(a.duration=s.start-r,a.duration<0&&c.b.warn(`negative duration computed for frag ${a.sn},level ${a.level}, there should be some duration drift between playlist and fragment!`)())}};var Gt,$t,Kt,Wt=Vt,Ht=function(e){for(var t="",i=e.length,s=0;s<i;s++)t+="["+e.start(s).toFixed(3)+","+e.end(s).toFixed(3)+"]";return t},qt=i(7),jt=i(5);!(function(e){e.Main="main",e.Audio="audio"})(Gt||(Gt={})),(function(e){e.InitSegment="initSegment",e.Data="data"})($t||($t={})),(function(e){e.STOPPED="STOPPED",e.IDLE="IDLE",e.PAUSED="PAUSED",e.KEY_LOADING="KEY_LOADING",e.FRAG_LOADING="FRAG_LOADING",e.PLAYLIST_LOADING="PLAYLIST_LOADING",e.FRAG_LOADING_WAITING_RETRY="FRAG_LOADING_WAITING_RETRY",e.PARSING="PARSING",e.PARSED="PARSED",e.BUFFER_FLUSHING="BUFFER_FLUSHING",e.BUFFER_FLUSHING_WAITING_PLAYLIST="BUFFER_FLUSHING_WAITING_PLAYLIST",e.ENDED="ENDED",e.ERROR="ERROR",e.WAITING_INIT_PTS="WAITING_INIT_PTS",e.WAITING_DISCONTINUITY="WAITING_DISCONTINUITY"})(Kt||(Kt={}));var Yt,zt,Qt,Xt,Jt,Zt,ei=class extends P{constructor(e,...t){super(e,...t),this.hls=e,this.logger=e.logger,this.config=e.config,this._state=Kt.STOPPED}set state(e){this.state!==e&&(this.state,this._state=e)}get state(){return this._state}retryFragRequest(e){let t=e.frag;var i=this.fragLoadError;i?i++:i=1;let s=this.config,r=e.details===a.a.FRAG_LOAD_ERROR?s.fragLoadPolicy.default.errorRetry:s.fragLoadPolicy.default.timeoutRetry;if(i<=r.maxNumRetry){this.fragLoadError=i,t.loadCounter=0;var n=Math.min(Math.pow(2,i-1)*r.retryDelayMs,r.maxRetryDelayMs);this.logger.warn(`${this.constructor.name}: frag loading failed, retry in ${n} ms`)(),this.retryDate=performance.now()+n,this.state=Kt.FRAG_LOADING_WAITING_RETRY,e.retrying=!0}else this.logger.error(`${this.constructor.name}: reaches max retry, redispatch as fatal ...`)(),e.fatal=!0,e.retrying=!1}_handleFragmentNetworkError(e){let t,i;if(e.frag&&!isNaN(e.frag.level)){t=e.frag.level;let s=this.hls.networkErrorHandler.getActionForFragNetworkError(e,this.variantController);i=this.hls.networkErrorHandler.handleNetworkError(s.errorAction,s.errorActionFlags,e,t,this.retryFragRequest.bind(this,e),this.variantController.variantManager,this.variantController)}else this.logger.warn("fragment network error could not be handled for the invalid frag or frag without variant id")();e.fatal&&!this.hls.bufferEndPromiseWrapper&&this.hls.bufferDryPromise.then(()=>{this.hls.trigger(s.a.ERROR,e)}).catch(e=>{this.logger.error("get an error in buffer dry promise")()})}},ti=class extends ei{constructor(e){super(e,s.a.MEDIA_ATTACHING,s.a.MEDIA_DETACHING,s.a.MANIFEST_LOADING,s.a.MANIFEST_PARSED,s.a.LEVEL_LOADED,s.a.FRAG_LOAD_EMERGENCY_ABORTED,s.a.FRAG_PARSING_INIT_SEGMENT,s.a.FRAG_PARSING_DATA,s.a.FRAG_PARSED,s.a.ERROR,s.a.AUDIO_TRACK_SWITCHING,s.a.AUDIO_TRACK_SWITCHED,s.a.BUFFER_CREATED,s.a.BUFFER_APPENDED,s.a.BUFFER_FLUSHED,s.a.BUFFER_CODEC_UPDATED,s.a.BUFFER_SOURCE_RESET,s.a.LEVELS_CHANGED,s.a.BANDWIDTH_CHANGED,s.a.BUFFER_CHANGED,s.a.STALLED),this.config=e.config,this.audioCodecSwap=!1,this._state=Kt.STOPPED,this.ontick=this.doTick.bind(this),this.firstPlaybackStarted=!1,this.pendingPlayPromises=[],this.startTargetDurationFactor=this.config&&this.config.startTargetDurationFactor?this.config.startTargetDurationFactor:1}destroy(){this.stopLoad(),this.tickInterval&&(clearInterval(this.tickInterval),this.tickInterval=null),this.clearTickImmediate(),P.prototype.destroy.call(this),this.state=Kt.STOPPED}startLoad(e){if(this.logger.info(`startLoad(${e})`)(),this.levels){let t=this.lastCurrentTime,i=this.hls;if(this.stopLoad(),this.tickInterval||(this.tickInterval=setInterval(this.ontick,100)),(this.config.useFirstLevelAtIncompatDiscontinuity||this.waitingForIncompatibleCCFragLoad)&&(!this.config.useFirstLevelAtIncompatDiscontinuity||this.iframeMode||this.pendingParsedData||this.pendingParsedInitSegmentData)||(this.level=-1),this.fragLoadError=0,!this.startFragRequested){let e=i.startLevel;-1===e&&(e=this.hls.levelController.firstLevel,this.bitrateTest=!0),(!this.level||this.level<0)&&(this.level=i.nextLoadLevel=e),this.loadedmetadata=!1}t>0&&-1===e&&(e=t),this.state=Kt.IDLE,this.seek(e),this.tick()}else this.forceStartLoad=!0,this.state=Kt.STOPPED;this.iframeEOS=!1,this.autoPausedRestartTime=void 0}stopLoad(){var e=this.fragCurrent;e&&(e.loader&&e.loader.abort(),this.fragCurrent=null),this.fragPrevious=null,this._destroyDemuxer(),this.state=Kt.STOPPED,this.forceStartLoad=!1}tick(){this.tickImmediate||(this.tickImmediate=Object(qt.setImmediate)(this.doTick.bind(this)))}clearTickImmediate(){Object(qt.clearImmediate)(this.tickImmediate),this.tickImmediate=null}doTick(){switch(this.clearTickImmediate(),this.state){case Kt.BUFFER_FLUSHING:this.fragLoadError=0;break;case Kt.IDLE:this._doTickIdle();break;case Kt.PLAYLIST_LOADING:if(!this.hls.playlistLoader.isLoadingLevel(this.level)){var e=this.hls.levelWithPersistentId(this.level).levelInfo;e&&e.details&&(this.state=Kt.IDLE)}break;case Kt.FRAG_LOADING_WAITING_RETRY:var t=performance.now(),i=this.retryDate;(!i||t>=i||this.media&&this.media.seeking)&&(this.state=Kt.IDLE);break;case Kt.ERROR:case Kt.STOPPED:case Kt.FRAG_LOADING:case Kt.KEY_LOADING:case Kt.PARSING:case Kt.PARSED:case Kt.BUFFER_FLUSHING_WAITING_PLAYLIST:case Kt.ENDED:}this._checkIfLoadedMetadata(),this._checkIfPlaybackLikelyToKeepUp(),this.immediateSwitchCanEnd&&this.immediateLevelSwitchEnd(),this._checkFragmentChanged(),this._loadSessionDataIfNecessary()}_doTickIdle(){const e=this.hls,t=e.config,i=this.media;if(void 0!==this.levelLastLoaded&&!i&&(this.startFragRequested||!t.startFragPrefetch))return;if(this.hls.isLive&&0===this.desiredRate)return;if(this.pendingParsedData){let e=this.pendingParsedData;this.pendingParsedData=void 0;for(let t in e)e.hasOwnProperty(t)&&(e[t].frag,this.state=Kt.PARSING,this.appended=!1,this.onFragParsingData(e[t]),this.state===Kt.PARSING&&this.onFragParsed(e[t]));return}let s;if(s=this.loadedmetadata?i.currentTime:this.nextLoadPosition,this.needsReset)return this.waitingForIncompatibleCCFragLoad=!0,this.state=Kt.WAITING_DISCONTINUITY,this.hls.audioStreamController.pendingParsedData=void 0,this.hls.audioStreamController.pendingParsedInitSegmentData=void 0,void this._resetMediaSource(s);let a=!this.levelAtSwitch||this.iframeMode?e.nextLoadLevel:this.levelAtSwitch,r=this.hls.levelWithPersistentId(a).levelInfo;if(!r)return;let n,o=r.bitrate,l=t.maxBufferSize;this.needsMultipleSourceBuffers&&(l/=2),n=o?Math.max(8*l/o,t.maxBufferLength):t.maxBufferLength,n=Math.min(n,t.maxMaxBufferLength);const d=this.getSourceBufferInfo(s);let h=d.len,c=d.end;if(this.bufferMonitor.maxBufferSeconds=n,h>=n){if(!1===t.enableIFramePreloading)return;let e=this.hls.levelController.preloadiFrameLevelPlaylists();if(!e)return;let i=this.hls.levelController.getLevelWithPersistentId(e).levelInfo.details;if(i&&this.fragPrevious){let t=this.fragPrevious.cc;i.initSegments[t]&&!i.initSegments[t].data&&(this._loadFragmentOrKey(i.initSegments[t],e,i,s,c),this.hls.keyLoader.getKeyFromDecryptData(i.initSegments[t].decryptdata,e))}return}this.level=e.nextLoadLevel=a;const u=r.details;if(u&&(this.bufferMonitor.targetDuration=u.targetduration),e.playlistLoader.isLoadingLevel(a)&&this.state===Kt.BUFFER_FLUSHING)return void(this.state=Kt.BUFFER_FLUSHING_WAITING_PLAYLIST);if(e.playlistLoader.isLoadingLevel(a))return void(this.state=Kt.PLAYLIST_LOADING);let f=this.fragPrevious;if(!u.live&&f&&f.isLastFragment&&!r.iframes&&Math.min(i.duration,f.start+f.duration)-Math.max(d.end,f.start)<=Math.max(.2,f.duration))return this.hls.bufferController.endBuffer(this.altAudio?"video":void 0),void(this.state=Kt.ENDED);this._flushingBuffer&&!this.iframeMode&&(c=this._startOffsetOfBufferFlush,h=void 0),this._fetchPayloadOrEos(s,c,h,u)}getSourceBufferInfo(e,t=this.config.maxBufferHole){return kt.bufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,e,t)}_getVideoAudioSourceBufferInfo(){let e;return e=this.loadedmetadata?this._getPlaybackPos():this.nextLoadPosition,kt.bufferInfo(this.media?this.media:this.mediaBuffer,e,this.config.maxBufferHole)}combinedBufferEmpty(){let e=this._getVideoAudioSourceBufferInfo().len<this.config.almostDryBufferSec,t=e;if(this.hls.subtitleStreamController.isSubtitleTrackEnabled()){let i=this.hls.subtitleStreamController.estimateCurrentWaterLevel()<this.config.almostDryBufferSec;t=e||i}return t}estimateCurrentWaterLevel(){return this._getVideoAudioSourceBufferInfo().len}_getPlaybackPos(){return isNaN(this.seekToPos)?this.media.currentTime:this.seekToPos}resetNextLoadPositionState(){this.loadedmetadata||(this.nextLoadPosition,this.seekToPos,this.seek(this.seekToPos),this.startFragRequested=!1)}snapToCCTimeRange(e,t,i){let s=e,a=Ft.getTimeRangeForCC(t,i);return!isNaN(a[0])&&s<a[0]&&(s=a[0]),s}_fetchPayloadOrEos(e,t,i,s){const a=this.fragPrevious,r=this.level,n=s.fragments,o=n.length;if(0===o)return;let l,d=n[0].start,h=n[o-1].start+n[o-1].duration;if(s.live){let e=this.config.initialLiveManifestSize;if(o<e)return void this.logger.warn(`Can not start playback of a level, reason: not enough fragments ${o} < ${e}`)();if(null===(l=this._ensureFragmentAtLivePoint(s,t,d,h,a,n,o)))return}else t<d&&(l=n[0]);let c=this.hls.levelWithPersistentId(this.level).levelInfo;if(!l)if(c.iframes&&this.iframeMode){const e=this.iframeReferenceClockTime,r=this.media.currentTime,o=this.desiredRate,d=i<2?this.hls.config.initialIframeFPS:this.hls.config.desiredIframeFPS,h=this.hls.config.leftMediaTimeToAutoPause;let c=this.media.seekable,u=c.start(0),f=c.end(c.length-1);if(o>1&&f-e<h)return this.logger.info(`[iframes] near the end of media, resuming normal playback, bufferLen: ${i}, maxTime ${f}, ifrct ${e}`)(),this.autoPausedRestartTime=f-h,this.hls.setRate(0),void this.tick();if(o<0&&e-u<o/-2)return this.logger.info(`[iframes] near the start of media, pausing playback at ${this.autoPausedRestartTime} left, bufferLen: ${i}, minTime ${u}, ifrct ${e}`)(),this.autoPausedRestartTime=u,this.hls.setRate(1),void this.tick();if(this.iframeEOS)return;let g=a&&a.iframe&&!isNaN(this.iframeBaseTime)?a:void 0;if(this.logger.info(`[iframes] prev sn: ${a?a.sn:"N/A"}, level: ${a?a.level:"N/A"}, cc: ${a?a.cc:"N/A"}, iframe: ${a?a.iframe:"N/A"}, mt: ${r.toFixed(3)}, ifrct: ${e.toFixed(3)}, ifrate: ${o}, iffps: ${d}, buffered: ${this.bufferedRangeString}, bufferLen: ${i.toFixed(3)}, seeking: ${this.media.seeking}, readyState: ${this.media.readyState}`)(),isNaN(this.iframeMediaAnchorTime)){this._resetIframeFragments(),this.iframeEOS=!1;let t=Ft.findNextIframe(void 0,e,o,e,e,n);if(!t)return this.logger.info(`[iframes] no anchorFrag for time ${e}, setting iframeEOS`)(),void(this.iframeEOS=!0);let i=Ft.getTimeRangeForCC(n,t.cc),s=Math.abs(o);const a=2;if(o>1&&(i[1]-e)/s<a)return void this.logger.info(`[iframes] FF too close to end of ccRange: ${i[0].toFixed(3)}-${i[1].toFixed(3)}, at ifrct: ${e.toFixed(3)}, wait to anchor`)();if(o<0&&(e-i[0])/s<a)return void this.logger.info(`[iframes] RW too close to start of ccRange: ${i[0].toFixed(3)}-${i[1].toFixed(3)}, at ifrct: ${e.toFixed(3)}, wait to anchor`)();let r;this.ccRange=i,this.iframeBaseTime=e;let l="N/A";if(o>1)r=this.iframeBaseTime;else{let e=this.hls.audioStreamController?this.hls.audioStreamController.getAudioTimeRangeForCC(t.cc):void 0;e?(r=Math.max(e[0],i[0]),l=e?`${e[0].toFixed(3)}-${e[1].toFixed(3)}`:"N/A"):r=i[0]+this.config.maxBufferHole}if(this.iframeMediaAnchorTime=Math.ceil(r),this.logger.info(`[iframes] setting initial ifbt: ${e.toFixed(3)}, startCCTime: ${r.toFixed(3)}, ccRange: ${i[0].toFixed(3)}-${i[1].toFixed(3)}, audioCCRange: ${l}, for cc: ${t.cc}`)(),!1===this.hls.bufferController.isCompatibleTransition(t.cc))return this.logger.info("[iframes] resetting source buffer for incompatible cc")(),this.fragPrevious=void 0,this.iframeMediaAnchorTime=void 0,void this._resetMediaSource(this.iframeMediaAnchorTime,!0,t.cc);let d=this.media.seeking||this.seekToPos!==this.iframeMediaAnchorTime;return this._startAudioIframeTransition(this.iframeMediaAnchorTime,d),this.immediateLevelSwitch(!0,!0),void this.seek(this.iframeMediaAnchorTime)}if(this.ccRange&&(this.ccRange[0]>e||this.ccRange[1]<e))return this.logger.info(`[iframes] ifrct: ${e.toFixed(3)} is outside of ccRange: ${this.ccRange[0].toFixed(3)}-${this.ccRange[1].toFixed(3)}, clearing iframeMediaAnchorTime`)(),this.fragPrevious=void 0,this.iframeMediaAnchorTime=void 0,void(this.altAudio&&this.hls.audioStreamController&&this.hls.audioStreamController.flushAudioBuffer(0,Number.POSITIVE_INFINITY));if(!this.media.seeking){const e=Math.abs(o)/4;this.maxIframeRealTime=xt.getIframeRealTime(t,this.iframeMediaAnchorTime,this.iframeBaseTime,this.desiredRate);let i=this.iframeLagTime;i>e&&(i=o>1?i:-1*i,this.iframeMediaAnchorTime=t,this.iframeBaseTime=this._getBoundedTime(this.maxIframeRealTime+i),this.logger.info(`[iframes] catch-up mode, max_ifrt ${this.maxIframeRealTime.toFixed(3)}, diff from reference: ${i.toFixed(3)}, new ifmat: ${this.iframeMediaAnchorTime.toFixed(3)}, new ifbt: ${this.iframeBaseTime.toFixed(3)}`)())}const m=this.iframeMediaAnchorTime,p=this.iframeBaseTime,y=1/d;if(this.logger.info(`[QE Critical] [iframes] picked frag params maxMediaTime: ${t}, ifmat: ${m}, ifbt: ${p}`)(),(l=Ft.findNextIframe(g,t,o,m,p,n))&&a&&l.cc!==a.cc)return;l?s.initSegments[l.cc]&&!s.initSegments[l.cc].data?(l=s.initSegments[l.cc],this.logger.info("[iframes] loading init segment")()):(this.scaledFragments||(this.scaledFragments=[]),s.live&&(this.ccRange=Ft.getTimeRangeForCC(n,l.cc)),l.iframeMediaStart=t,l.iframeMediaDuration=Math.max(l.duration/Math.abs(o),y),this.logger.info(`[iframes] picked frag sn: ${l.sn}, level: ${l.level}, cc: ${l.cc}, range: ${l.rangeString}, iframeMediaStart ${l.iframeMediaStart.toFixed(3)}, iframeMediaDuration: ${l.iframeMediaDuration.toFixed(3)}, ifmat: ${m.toFixed(3)}, ifbt: ${p.toFixed(3)}`)(),this.scaledFragments.push(l)):g?(this.logger.error("[iframes] no more frags, but we should have found an end fragment, so set iframeEOS")(),this.iframeEOS=!0):(this.logger.error("[iframes] no initial iframe frag, so go back to rate 1")(),this.hls.setRate(1))}else l=this._findFragment(d,a,o,n,t,h,s);if(l){l.decryptdata&&l.decryptdata.isEncrypted&&(this.keyRequestPromise=this.hls.keyLoader.getKeyFromDecryptData(l.decryptdata,l.level),this.keyRequestPromise.then(function(){this.keyRequestPromise=void 0,this.state===Kt.KEY_LOADING&&(this.state=Kt.IDLE,this.tick())}.bind(this)).catch((function(){})));let i=s.initSegments[l.cc];i&&!i.data&&(l=i);let a="initSegment"===l.sn||this.hls.bufferController.isCompatibleTransition(l.cc);if(void 0===a)a=void 0===this.hls.bufferController.isParentCompatibleTransition(Gt.Main,l.cc);else if(!a&&this.media&&l.start-.5<this.media.currentTime&&this.media.currentTime<l.start+l.duration)if(this.media&&this.media.seeking){let e=this.iframeMode?this.media.currentTime:this.snapToCCTimeRange(this.media.currentTime,n,l.cc);this._resetMediaSource(e,!0,l.cc)}else(this.state===Kt.WAITING_DISCONTINUITY||this.stallWhileWaitingForCC)&&(this.stallWhileWaitingForCC=!1,this._resetMediaSource(l.start,!1,l.cc));a?(this.levelAtSwitch&&!this.iframeMode&&(this.levelAtSwitch=void 0),this._loadFragmentOrKey(l,r,s,e,t)):(this.state=Kt.WAITING_DISCONTINUITY,this.waitingForIncompatibleCCFragLoad=!0)}}_loadSessionDataIfNecessary(){let e=this.media;if(!this.sessionDataLoading&&e&&e.readyState>=e.HAVE_ENOUGH_DATA&&this.playbackLikelyToKeepUp){let e=this.hls.sessionData;if(!e||e&&!e.itemList)return;this.hls.trigger(s.a.SESSION_DATA_LOADING,{sessionData:e}),this.sessionDataLoading=!0}}_resetMediaSource(e,t=!1,i=0){this.startFragRequested=!1,this.needsReset=!1,this._bufferedFrags=[],this.tstalled=void 0,this.nudgeRetry=0;let s=this.waitingForIncompatibleCCFragLoad;this.onMediaDetaching(),this.hls.prepareToLoadIncompatCC(i),this.waitingForIncompatibleCCFragLoad=s,this.seek(e),this.logger.info(`Resetting media source for cc ${i}, loading start position ${e}`)(),this.hls.bufferController.resetMediaSource(e,t),this.hls.timelineController&&this.hls.timelineController.resetTracks()}_ensureFragmentAtLivePoint(e,t,i,s,a,r,n){const o=this.hls.config,l=this.media;let d,h=void 0!==o.liveMaxLatencyDuration?o.liveMaxLatencyDuration:o.liveMaxLatencyDurationCount*e.targetduration;if(t<Math.max(i-o.maxFragLookUpTolerance,s-h)){let s=this.liveSyncPosition=this.computeLivePosition(i,e);t=s,l&&l.readyState&&l.duration>s&&(this.logger.info("adjust currentTime to liveSyncPosition")(),l.currentTime=s)}if(e.PTSKnown&&t>s&&l&&l.readyState)return null;if(this.startFragRequested&&!e.PTSKnown){if(a){var c=a.sn+1;c>=e.startSN&&c<=e.endSN&&(d=r[c-e.startSN])}d||(d=r[Math.min(n-1,Math.round(n/2))])}return d}_findFragment(e,t,i,s,a,r,n){const o=this.hls.config;let l,d,h=o.maxFragLookUpTolerance;if((d=Ft.findFragmentBySNAndBuffer(t,s,a,r,h))&&"initSegment"!==d.sn){const e=d.sn-n.startSN,i=t&&d.level===t.level,a=s[e-1],r=s[e+1];if(l=d,t&&l.sn===t.sn)if(i&&!l.backtracked)if(l.sn<n.endSN){let i=t.deltaPTS;i&&i>o.maxBufferHole&&t.dropped&&e?(l=a,this.logger.warn("SN just loaded, with large PTS gap between audio and video, maybe frag is not starting with a keyframe ? load previous one to try to overcome this")(),t.loadCounter--):l=r}else l=null;else l.backtracked&&(r&&r.backtracked?(this.logger.warn(`Already backtracked from fragment ${r.sn}, will not backtrack to fragment ${l.sn}. Loading fragment ${r.sn}`)(),l=r):(this.logger.warn("Loaded fragment with dropped frames, backtracking 1 segment to find a keyframe")(),l.dropped=0,a?(a.loadCounter&&a.loadCounter--,(l=a).backtracked=!0):l=null))}return l}_ensureDemuxer(){this.demuxer||(this.demuxer=new Ut(this.hls,"main"))}_destroyDemuxer(){Object(qt.clearImmediate)(this.demuxImmediate),this.demuxer&&(this.demuxer.destroy(),this.demuxer=null)}_loadFragmentOrKey(e,t,i,r,n){const o=this.hls,l=o.config;if(this.logger.info(`${e.type} loading ${e.sn} of [${i.startSN},${i.endSN}], level: ${t}, cc: ${e.cc}, range: ${e.rangeString}, currentTime: ${this.media.currentTime}, pos:${r?r.toFixed(3):"undefined"}, bufferEnd:${n?n.toFixed(3):"undefined"}, loadCount:${e.loadCounter} URL ${this.hls.redactUrl(e.relurl)} `)(),void 0!==this.fragLoadIdx?this.fragLoadIdx++:this.fragLoadIdx=0,e.loadCounter){e.loadCounter++;let t=l.fragLoadingLoopThreshold;if(e.loadCounter>t&&Math.abs(this.fragLoadIdx-e.loadIdx)<t)return void o.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_LOOP_LOADING_ERROR,fatal:!1,frag:e,response:a.b.CorruptStream})}else e.loadCounter=1;e.loadIdx=this.fragLoadIdx,this.fragCurrent=e,this.startFragRequested=!0,"initSegment"!==e.sn&&(e.iframe?this.nextLoadPosition=e.iframeMediaStart+e.iframeMediaDuration:this.nextLoadPosition=e.start+e.duration),e.autoLevel=o.autoLevelEnabled,e.bitrateTest=this.bitrateTest,o.fragmentLoader.loadFragment(e).then(function(e){this._processLoadedFrag(e)}.bind(this)).catch(function(e){this._handleFragmentError(e)}.bind(this)),this.demuxImmediate=Object(qt.setImmediate)(this._ensureDemuxer.bind(this)),this.state=Kt.FRAG_LOADING}set state(e){const t=this.state;super.state=e,this.hls.trigger(s.a.STREAM_STATE_TRANSITION,{previousState:t,nextState:e})}get state(){return super.state}getBufferedFrag(e){return At(this._bufferedFrags,(function(t){let i=t.iframe?t.iframeMediaStart:t.startPTS,s=t.iframe?t.iframeMediaStart+t.iframeMediaDuration:t.endPTS;return e<i?-1:e>s?1:0}))}get currentLevel(){let e=this.media;if(e){const t=this.getBufferedFrag(e.currentTime);if(t)return t.level}return-1}get nextBufferedFrag(){let e=this.media;return e?this.followingBufferedFrag(this.getBufferedFrag(e.currentTime)):null}followingBufferedFrag(e){return e?this.getBufferedFrag(e.endPTS+.5):null}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}_checkFragmentChanged(){var e,t,i=this.media;if(i&&i.readyState&&!1===i.seeking&&((t=i.currentTime)>i.playbackRate*this.lastCurrentTime&&(this.lastCurrentTime=t),kt.isBuffered(i,t)?e=this.getBufferedFrag(t):kt.isBuffered(i,t+.1)&&(e=this.getBufferedFrag(t+.1)),e)){var a=e;if(a!==this.fragPlaying){this.hls.trigger(s.a.FRAG_CHANGED,{frag:a});const e=a.level;this.fragPlaying&&this.fragPlaying.level===e||this.hls.trigger(s.a.LEVEL_SWITCHED,{level:e}),this.fragPlaying=a}}}_resetIframeFragments(){if(!this.scaledFragments)return;let e=this.scaledFragments;for(let t=0;t<e.length;t++){let i=e[t];i.loadCounter=0,isNaN(i.iframeMediaStart)||(i.iframeMediaStart=void 0,i.iframeMediaDuration=void 0)}this.scaledFragments=void 0}get seeking(){return!isNaN(this.seekToPos)||this.media&&this.media.seeking}adjustSeekPosition(e){let t=this.media,i=kt.bufferInfo(t,e,0),s=e;if(0===i.len){let t=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(s=this._ensureNudgeStartTime(i.nextStart,e,t,this.state))&&this.logger.warn(`adjusted seek ${e}->${s}`)()}return s}seek(e,t=!0){if(isNaN(e))return;if(e<0)return void(this.seekToPos=void 0);if(this.media&&t){let t=this.adjustSeekPosition(e);Math.abs(e-t)>=Number.EPSILON&&(e=t)}let i=isNaN(this.seekToPos)||Math.abs(e-this.seekToPos)>=Number.EPSILON;this.nextLoadPosition=this.lastCurrentTime=this.seekToPos=e,this.playbackLikelyToKeepUp=!1,this.media&&(!this.iframeMode&&i&&(this.logger.info(`startSeek(${e})`)(),this.hls.trigger(s.a.SEEKING)),this.media.paused||this._mediaPause(),t&&e>=0&&this.loadedmetadata&&this.media.currentTime!==e&&!this._flushingBuffer&&(this.logger.info(`adjust currentTime seekToPos=${e}`)(),this.iframeModeSeek=this.iframeMode,this.mediaSeekFn?this.mediaSeekFn(e):this.media.currentTime=e))}completeSeek(){isNaN(this.seekToPos)||this.media.seeking||this._flushingBuffer||(this.logger.info(`completeSeek(${this.seekToPos}) currentTime=${this.media.currentTime}`)(),this.seekToPos=void 0,this.iframeModeSeek||this.hls.trigger(s.a.SEEKED),this.iframeModeSeek=!1)}set playbackLikelyToKeepUp(e){this._playbackLikelyToKeepUp!==e&&(this._playbackLikelyToKeepUp=e,this.hls.trigger(s.a.PLAYER_STATE_CHANGE,{playbackLikelyToKeepUp:e}))}get playbackLikelyToKeepUp(){return Boolean(this._playbackLikelyToKeepUp)}get _avgBufferAppendMs(){return!this._numAppends||this._numAppends<2?400:this._totalBufferAppendMs/this._numAppends}updateAppendBufferAvg(e){(isNaN(this._numAppends)||isNaN(this._totalBufferAppendMs))&&(this._numAppends=0,this._totalBufferAppendMs=0),this._totalBufferAppendMs+=e,++this._numAppends}get _avgParseBw(){return this._totalParseSec?this._totalParsedBits/this._totalParseSec:0}updateParseBwAvg(e,t){this._totalParseSec||(this._totalParsedBits=0,this._totalParseSec=0),this._totalParsedBits+=8*e,this._totalParseSec+=t/1e3}_likelyToAppendFragInTime(e,t,i,s){let a=t.len,r=this.mediaBuffer?this.getSourceBufferInfo(e):t,n=!1,o=1/0;if(r.len>=s)o=0;else if(this.fragCurrent&&Math.abs(this.fragCurrent.start-r.end)<=this.hls.config.maxBufferHole){let e=this._avgBufferAppendMs/1e3;if(this.fragCurrent.loader){let e=this.fragCurrent.loader.stats,t=i.realBitrate?Math.max(i.realBitrate,i.bitrate):i.bitrate,s=e.total?8*e.total:Math.ceil(this.fragCurrent.duration*t),a=8*e.loaded,r=s-a,n=a/(performance.now()-e.tfirst)*1e3;o=r/(n?Math.min(this.hls.abrController.getBandwidthEstimate(),n):this.hls.abrController.getBandwidthEstimate())}else if(this.state===Kt.PARSING){let e=(performance.now()-this.stats.tload)/1e3,t=8*this.stats.total/this._avgParseBw;o=Math.max(0,t-e)}else this.state===Kt.PARSED&&this.pendingBuffering&&(o=0);o+=e}return(n=o<=a)&&!this.playbackLikelyToKeepUp&&this.logger.info(`[main] Probably haveEnough bufferLen=${a} nextFragAppendedDur=${o.toFixed(3)}`)(),n}_checkIfPlaybackLikelyToKeepUp(){if(!this.media||!this.loadedmetadata)return void(this.playbackLikelyToKeepUp=!1);let e=this.level,t=this.hls.levelWithPersistentId(e).levelInfo,i=t?t.details:void 0;if(!t||!i)return;let s=isNaN(this.seekToPos)?this.media.currentTime:this.seekToPos,a=kt.bufferInfo(this.media,s,this.hls.config.maxBufferHole),r=a.len;if(r<=0)return void(this.playbackLikelyToKeepUp=!1);let n=Math.min(i.targetduration,15);this.fragPrevious&&(n=Math.min(this.fragPrevious.duration,n));let o=Math.max(1,n*this.startTargetDurationFactor),l=this.iframeMode||r>=n||r>=o,d=i.fragments[i.fragments.length-1],h=i.fragments[0].start+i.totalduration,c=this.fragCurrent&&this.hls.bufferController.isCompatibleTransition(this.fragCurrent.cc),u=void 0===c?this.fragCurrent&&this.fragPrevious&&this.fragCurrent.cc!==this.fragPrevious.cc:!c;l&&i.live?l=s<=h-d.duration:i.live||(l=l||s>=h-n),l=l||u||this._likelyToAppendFragInTime(s,a,t,n),this.media&&!this.media.ended&&this.media.paused&&l&&0!==this.desiredRate&&!this._flushingBuffer&&(this.logger.info(`[main] haveEnough desiredRate=${this.desiredRate} bufferLen=${r} discontinuity=${u}`)(),this._mediaPlay()),l?this.completeSeek():this.media.controls&&this.seeking&&!this.media.paused&&(this.logger.warn(`Seeking but not enough buffer !media.paused bufferLen=${r}`)(),this._mediaPause()),this.playbackLikelyToKeepUp=l&&this.media&&this.media.readyState>=this.media.HAVE_ENOUGH_DATA}_startAudioIframeTransition(e,t=!1){const i=this.hls.audioStreamController;i&&i.startIframeTransition(e,t)}_mediaPlay(){if(this.media){if(this.playPromise||this._flushingBuffer)return void this.logger.warn(`Ignoring play command playPromise/flushing ${Boolean(this.playPromise)}/${this._flushingBuffer}`)();this._expectPlayEvent=this._expectPlayEvent||this.media.paused,this.logger.info(`play() expectPlayEvent=${this._expectPlayEvent}`)(),this.playPromise=this.media.originalPlay(),this.playPromise&&this.playPromise.then(function(){this.playPromise=null,this._handlePendingPlayPromises()}.bind(this)).catch(function(e){this.playPromise=null,this._expectPlayEvent=!1,this._handlePendingPlayPromises(e||{}),"NotAllowedError"===e.name?(this.logger.warn("play() not allowed, going back to rate 0")(),this.hls.desiredRate=0):this.logger.error(e.message)()}.bind(this))}}_handlePendingPlayPromises(e){let t=this.pendingPlayPromises,i=t.length;if(e)for(let s=0;s<i;s++)t[s].reject(e);else for(let e=0;e<i;e++)t[e].resolve();this.pendingPlayPromises=[]}_mediaPauseInternal(){this._expectPauseEvent=this._expectPauseEvent||!this.media.paused,this.logger.info(`pause() expectPauseEvent=${this._expectPauseEvent}`)(),this.media.originalPause()}_mediaPause(){this.media&&(this.logger.info(`pause() playPromise=${Boolean(this.playPromise)}`)(),this.playPromise?this.playPromise.then(()=>{(0===this.desiredRate||this.seeking&&!this.playbackLikelyToKeepUp)&&this._mediaPauseInternal()}):this._mediaPauseInternal())}_getBoundedTime(e){return isNaN(this.lastMediaDuration)?Math.max(0,e):Math.min(this.lastMediaDuration,Math.max(0,e))}_getIframeReferenceClockTime(e){let t=(e-this.iframeReferenceClockStart)*this.desiredRate/1e3+this.iframeReferenceClockMediaTimeBase;return this._getBoundedTime(t)}get iframeReferenceClockTime(){return this._getIframeReferenceClockTime(performance.now())}get iframeLagTime(){return isNaN(this.maxIframeRealTime)?0:this.desiredRate>1?Math.max(0,this.iframeReferenceClockTime-this.maxIframeRealTime):this.desiredRate<0?Math.max(0,this.maxIframeRealTime-this.iframeReferenceClockTime):void 0}get realCurrentTime(){return this.iframeMode?this.iframeReferenceClockTime:isNaN(this.seekToPos)?this.media?this.media.currentTime:void 0:this.seekToPos}get iframeMode(){return this.isIframeRate(this.desiredRate)}get effectiveRate(){return this.iframeMode?this.desiredRate:this.media.paused?0:1}isIframeRate(e){return 0!==e&&1!==e}get canContinuePlaybackWithoutGap(){let e=this.hls.nextLoadLevel,t=this.hls.levelWithPersistentId(e).levelInfo,i=t?t.details:void 0;return kt.canContinuePlaybackWithoutGap(this.mediaBuffer||this.media,this.media.currentTime,this.config.maxBufferHole,this.hls.playlistType,i)&&(!this.altAudio||!this.hls.audioStreamController||this.hls.audioStreamController.canContinuePlaybackWithoutGap)}get desiredRate(){return void 0!==this._desiredRate?this._desiredRate:0}set desiredRate(e){if(!this.media)return;const t=this.desiredRate,i=this.isIframeRate(e),a=this.isIframeRate(this.desiredRate);if(!i&&!a||t===e)return this.logger.info(`Ordinary rate change ${t} -> ${e}`)(),this._desiredRate=e,this.hls.isLive&&t!==e&&(0===e?(this.hls.levelController.stopLoad(),this.altAudio&&this.hls.audioTrackController&&this.hls.audioTrackController.stopLoad()):this.canContinuePlaybackWithoutGap||(this._mediaPause(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY),this.pendingExpiredLiveBufferRange=null,this.altAudio&&this.hls.audioStreamController&&this.hls.audioStreamController.flushAudioBuffer(0,Number.POSITIVE_INFINITY),this.hls.levelController.cleanupLevels())),0!==e||this.media.paused?1===e&&this.media.paused&&this._checkIfPlaybackLikelyToKeepUp():this._mediaPause(),void(t!==e&&this.hls.trigger(s.a.DESIRED_RATE_CHANGED,{oldRate:t,newRate:e}));const r=performance.now(),n=this.realCurrentTime,o=this.media.currentTime;let l,d,h;if(a&&(d=this._getIframeReferenceClockTime(r),h=this.getSourceBufferInfo(this.iframeMediaAnchorTime).end,l=this.getBufferedFrag(Math.min(o,h)-.001)),this._resetIframeFragments(),this.iframeEOS=!1,this.iframeMediaAnchorTime=void 0,this.iframeBaseTime=void 0,this.iframeRateSetTime=r,this.fragPrevious=void 0,this._desiredRate=e,this.logger.info(`[iframes] rate change ${t} -> ${e}, rct: ${n.toFixed(3)}, mt: ${o.toFixed(3)}, ifrct: ${a?d.toFixed(3):"N/A"}`)(),i){let t=this.media.seekable.end(this.media.seekable.length-1);if(e>1&&t-o<this.hls.config.leftMediaTimeToAutoPause)return void this.logger.info("[iframes] not setting FF iframe rate, too close to end of media")();let i=!a;if(this.iframeReferenceClockStart=r,this.iframeReferenceClockMediaTimeBase=n,i){this.iframeSwitchTime=performance.now();let e=this.hls.levelWithPersistentId(this.level).levelInfo;e&&!e.iframes?this.levelAtSwitch=this.level:this.logger.warn(`currentLevel is in penalty or an i-frame level ${this.level} levelAtSwitch:${this.levelAtSwitch}`)(),isNaN(this.levelAtSwitch)&&(this.levelAtSwitch=this.hls.startLevel),this.muteValueAtSwitch=this.hls.media.muted,this.hls.media.muted=!0,this.iframesInSourceBuffer=void 0,this.hls.abrController.nextAutoLevel=-1;let t=this.hls.levelController.nextLoadLevel,i=this.hls.levelWithPersistentId(t).levelInfo,s=i&&i.width&&i.height?`${i.width}x${i.height}`:"N/A";this.hls.loadLevel=t,this.logger.info(`[QE Critical] [iframes] entering iframe mode, levelAtSwitch: ${this.levelAtSwitch}, iframeLevel: ${t}, resolution: ${s}, bandwidth: ${i?i.bandwidth:"undefined levelInfo"}`)()}else this.logger.info("[iframes] staying in iframe mode with rate switch")();this.immediateLevelSwitch(!0,!0)}else if(a){let e,i=this.levelAtSwitch;this.logger.info(`[QE Critical]  [iframes] leaving iframe mode, iframeReferenceClockTime: ${d.toFixed(3)}, buffered: ${this.bufferedRangeString}, bufferEnd: ${h}, currentFrag: ${l?l.rangeString:"N/A"}, resume level: ${i}`)(),void 0!==this.autoPausedRestartTime?(this.logger.info(`[iframes] setting resumePosition to autoPausedRestartTime: ${this.autoPausedRestartTime.toFixed(3)}`)(),e=this.autoPausedRestartTime,this.autoPausedRestartTime=void 0):l&&Math.abs(l.start-n)<Math.abs(t)?(this.logger.info(`[iframes] setting resumePosition to currentFrag.start: ${l.start}`)(),e=l.start):(this.logger.info(`[iframes] setting resumePosition to iframeReferenceClockTime: ${d.toFixed(3)}`)(),e=d),this._startAudioIframeTransition(e),this.hls.media.muted=this.muteValueAtSwitch,this.hls.loadLevel=-1,this.hls.nextAutoLevel=i,this.iframeSwitchTime=performance.now(),this.immediateLevelSwitch(!0),this.seek(e),this.hls.media.muted=this.muteValueAtSwitch}this.hls.trigger(s.a.DESIRED_RATE_CHANGED,{oldRate:t,newRate:e})}immediateLevelSwitch(e=!1,t=!1){let i=this.media;this.immediateSwitch||(this.immediateSwitch=!0,i&&this._mediaPause());var s=this.fragCurrent;s&&s.loader&&s.loader.abort(),this.fragCurrent=null,t||(this.pendingParsedInitSegmentData=void 0),this.pendingParsedData=void 0,this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,this.flushMainBuffer(0,Number.POSITIVE_INFINITY,e),this.relaxHighBufferStallRule=0,this.immediateSwitchCanEnd=!0}immediateLevelSwitchEnd(){let e=this.media;if(!e||!this.loadedmetadata||!this.immediateSwitchCanEnd)return;let t=e&&e.buffered.length,i=performance.now()-this.iframeSwitchTime,s=!e.seeking||i>=this.config.iframeMaxExitSeekDuration;t&&s&&this.state!==Kt.BUFFER_FLUSHING&&(this.immediateSwitchCanEnd=!1,this.iframeSwitchTime=void 0,void 0!==this.iframeRateSetTime&&(this.logger.info(`[iframes] start playback again spentTime:  ${performance.now()-this.iframeRateSetTime}`)(),this.iframeRateSetTime=void 0),this.relaxHighBufferStallRule=this.config.iframeStallMaxRetry,this.immediateSwitch=!1,isNaN(this.seekToPos)&&kt.isBuffered(e,e.currentTime)&&(e.currentTime=Math.max(0,e.currentTime-1e-4),this.logger.info(`immediateLevelSwitchEnd nudged currentTime to ${e.currentTime} seekable ${JSON.stringify(this.media.seekable)} readyState ${this.media.readyState}`)()))}nextLevelSwitch(){let e=this.media;if(e&&e.readyState){let r,n,o;if(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,(n=this.getBufferedFrag(e.currentTime))&&n.startPTS>1&&this.flushMainBuffer(0,n.startPTS-1),e.paused)r=0;else{var t=this.hls.nextLoadLevel,i=this.hls.levelWithPersistentId(t).levelInfo,s=this.fragLastKbps;r=s&&this.fragCurrent?this.fragCurrent.duration*i.bitrate/(1e3*s)+1:0}if((o=this.getBufferedFrag(e.currentTime+r))&&(o=this.followingBufferedFrag(o))){var a=this.fragCurrent;a&&a.loader&&a.loader.abort(),this.fragCurrent=null,this.flushMainBuffer(o.startPTS,Number.POSITIVE_INFINITY)}}}attemptSafeNextLevelSwitch(){if(!1===this.hls.config.allowFastSwitchUp||this.hls.iframeMode)return;let e=this.media;if(e&&e.readyState&&this.hls.abrController.isSafeToFlushExcessBuffer()){let i,s,a;if(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,s=this.getBufferedFrag(e.currentTime),i=this.hls.abrController.getSafeBufferFlushPosition()+this.hls.config.maxStarvationDelay,a=this.getBufferedFrag(e.currentTime+i)){let e=this.followingBufferedFrag(a);if(e){var t=this.fragCurrent;t&&t.loader&&t.loader.abort(),this.fragCurrent=null,this.flushMainBuffer(e.startPTS,Number.POSITIVE_INFINITY),this.hls.isLive&&(this.fragPrevious=a,this.preserveFragPrevious=!0)}}}}flushMainBuffer(e,t,i=!1){this.state=Kt.BUFFER_FLUSHING,this._flushingBuffer=!0,this._startOffsetOfBufferFlush=e,this.hls.bufferController.flushBufferRange(e,t,this.altAudio?"video":void 0,i)}installMediaFunctions(e){if(e&&e.play&&e.pause){let t,i;t=e.originalPlay?e.originalPlay:e.originalPlay=e.play.bind(e),i=e.originalPause?e.originalPause:e.originalPause=e.pause.bind(e),e.play=function(){let e=this.media;return e&&e.paused&&!e.seeking&&e.duration&&e.currentTime&&e.currentTime>=e.duration-this.hls.config.maxTotalDurationTolerance&&(this.fragPrevious=void 0,this.seek(0)),this.hls.desiredRate=1,e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2?Promise.resolve():new Promise((e,t)=>{this.pendingPlayPromises.push({resolve:e,reject:t})})}.bind(this),e.pause=function(){this.hls.desiredRate=0}.bind(this),"function"==typeof HTMLMediaElement&&(Object.defineProperty(e,"currentTime",{enumerable:!0,configurable:!0,get:function(){return Object.getPrototypeOf(this),Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"currentTime").get.call(this)},set:this.seek.bind(this)}),this.mediaSeekFn=Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"currentTime").set.bind(e)),this.config.overridePlaybackRate&&Object.defineProperty(e,"playbackRate",{enumerable:!0,configurable:!0,get:function(){return 1},set:function(e){Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate").set.call(this,e)}})}}uninstallMediaFunctions(){let e=this.media;e&&(e.originalPlay&&(e.play=e.originalPlay,delete e.originalPlay),e.originalPause&&(e.pause=e.originalPause,delete e.originalPause),this.mediaSeekFn&&(delete e.currentTime,this.mediaSeekFn=null),this.config.overridePlaybackRate&&(e.playbackRate=1,delete e.playbackRate))}onMediaAttaching(e){let t=this.hls,i=-1;if(this.levels)if(t.pendingSeekToDate)i=t.resolvePendingSeekToDate(),t.pendingSeekToDate=void 0;else{let e=this.config;e.autoStartLoad&&(i=e.startPosition)}this.playPromise=null,this._expectPauseEvent=this._expectPlayEvent=!1,this._attachMedia(e.media,i)}_attachMedia(e,t){let i=this.hls;this.media=this.mediaBuffer=e,this.mediaEventListeners={seeking:this.onMediaSeeking.bind(this),seeked:this.onMediaSeeked.bind(this),ended:this.onMediaEnded.bind(this),playing:this.onMediaPlaying.bind(this),play:this.onMediaPlay.bind(this),pause:this.onMediaPause.bind(this),durationchange:this.onMediaDurationChange.bind(this),timeupdate:this.onMediaTimeUpdate.bind(this)};for(let t in this.mediaEventListeners)e.addEventListener(t,this.mediaEventListeners[t]);void 0===this._desiredRate&&(this._desiredRate=e.autoplay?1:e.paused?0:1,this.logger.info(`Setting desiredRate based on media state ${this._desiredRate}`)()),e.autoplay&&this._mediaPause(),this.bufferMonitor&&this.bufferMonitor.destroy(),this.bufferMonitor=new Ot(this.hls,this.media,()=>this.estimateCurrentWaterLevel(),wt.VideoAudio,this.config.maxBufferHole,this.config.maxBufferLength,this.config.defaultTargetDuration,this.config.almostDryBufferSec),this.stallMonitor&&this.stallMonitor.destroy(),this.stallMonitor=new class extends P{constructor(e,t,i,a,r,n){super(e,s.a.BUFFER_APPENDED,s.a.DESIRED_RATE_CHANGED),this.media=t,this.lowBufferThreshold=i,this.lowBufferWatchdogPeriod=a,this.highBufferWatchdogPeriod=r,this.seekWatchdogPeriod=n,this.listenerMap={seeking:this.onseeking.bind(this),seeked:this.onseeked.bind(this),timeupdate:this.ontimeupdate.bind(this),ended:this.onended.bind(this),playing:this.onplaying.bind(this)},this.seekOrWaitingForPlay=t.seeking||t.paused||t.readyState<t.HAVE_FUTURE_DATA,this.addListeners()}destroy(){this.removeListeners(),this.stop(),this.media=null,this.listenerMap=null,super.destroy()}addListeners(){let e=this.media;if(e)for(let t in this.listenerMap){let i=this.listenerMap[t];e.addEventListener(t,i)}}removeListeners(){let e=this.media;if(e&&this.listenerMap)for(let t in this.listenerMap){let i=this.listenerMap[t];e.removeEventListener(t,i)}}set lastCurrentTime(e){this.tlastCurrentTime=performance.now(),this._lastCurrentTime=e,this.start()}get lastCurrentTime(){return this._lastCurrentTime}ontimeupdate(){let e=this.media.currentTime;e<this.lastCurrentTime&&!this.media.seeking&&this.logger.warn(`[stall] timeupdate went backward but not seeking ${e} ${this.lastCurrentTime}`)(),this.lastCurrentTime!==e&&(this.lastCurrentTime=e)}onseeking(){let e=!this.seekOrWaitingForPlay||Math.abs(this.media.currentTime-this.lastCurrentTime)>=Number.EPSILON;this.seekOrWaitingForPlay=!0,this.updateSeekWatchdogStart(e),e?this.lastCurrentTime=this.media.currentTime:this.start()}onseeked(){this.updateSeekWatchdogStart(!0),this.lastCurrentTime=this.media.currentTime}onplaying(){this.seekOrWaitingForPlay=!1,this.tseekWatchdogStart=void 0,this.lastCurrentTime=this.media.currentTime}onended(){this.stop()}onDesiredRateChanged(e){const t=e.oldRate,i=e.newRate;t!==i&&(0===t?(this.updateSeekWatchdogStart(!0),this.lastCurrentTime=this.media.currentTime):0===i&&this.stop())}onBufferAppended(){this.updateSeekWatchdogStart(),this.start()}onBufferFlushed(){this.start()}updateSeekWatchdogStart(e=!1){let t=this.media;(e||!isFinite(this.tseekWatchdogStart))&&this.seekOrWaitingForPlay&&t&&Mt.isBuffered(t,t.currentTime)&&(this.tseekWatchdogStart=performance.now())}stop(){this.stallMonitorTimer&&(clearTimeout(this.stallMonitorTimer),this.stallMonitorTimer=null)}get tstalled(){return this.seekOrWaitingForPlay?this.tseekWatchdogStart:this.tlastCurrentTime}start(){let e=this.media,t=e.currentTime;if(this.stop(),!e||0===this.hls.desiredRate||e.ended||0===e.buffered.length||e.seeking&&!Mt.isBuffered(e,t)||void 0===this.tlastCurrentTime||t!==this.lastCurrentTime)return;let i,s=performance.now(),a=this.tstalled;if(i=this.seekOrWaitingForPlay?this.seekWatchdogPeriod:Mt.bufferInfo(e,t,0).len<=this.lowBufferThreshold?this.lowBufferWatchdogPeriod:this.highBufferWatchdogPeriod,!isFinite(a))return;let r=Math.max(100,1e3*i-(s-a));this.stallMonitorTimer=setTimeout(this.checkForStall.bind(this),r)}checkForStall(){let e,t=performance.now(),i=this.media,a=i.currentTime;if(a===this.lastCurrentTime){let s=this.tstalled,r=t-s,n=Mt.bufferInfo(i,a,0),o=n.len<=this.lowBufferThreshold,l=this.seekOrWaitingForPlay?Pt.Seek:o?Pt.LowBuffer:Pt.HighBuffer;(l===Pt.Seek&&r>=1e3*this.seekWatchdogPeriod||l===Pt.HighBuffer&&r>=1e3*this.highBufferWatchdogPeriod||l===Pt.LowBuffer&&r>=1e3*this.lowBufferWatchdogPeriod)&&(e={type:l,isLowBufferStall:o,bufferInfo:n,tstalled:s,stallDurationMs:r})}e?(this.logger.warn(`stall detected ${Math.round(e.stallDurationMs)}ms type:${e.type}`)(),this.hls.trigger(s.a.STALLED,e)):this.start()}}(this.hls,this.media,.5,this.hls.config.lowBufferWatchdogPeriod,this.hls.config.highBufferWatchdogPeriod,this.hls.config.seekWatchdogPeriod),i.startLoad(t)}onMediaDetaching(){var e=this.media;e&&e.ended&&this.seek(0);var t=this.levels;if(t&&t.forEach(e=>{e.details&&e.details.fragments.forEach(e=>{e.loadCounter=void 0,e.backtracked=void 0})}),e){for(let t in this.mediaEventListeners)e.removeEventListener(t,this.mediaEventListeners[t]);this.mediaEventListeners={}}this._handlePendingPlayPromises({}),this.pendingPlayPromises=[],this.playPromise=null,this._expectPauseEvent=this._expectPlayEvent=!1,this.media=this.mediaBuffer=null,this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null),this.stallMonitor&&(this.stallMonitor.destroy(),this.stallMonitor=null),this.loadedmetadata=!1,this.waitingForIncompatibleCCFragLoad=!1,this.pendingIncompatCC=void 0,this.stopLoad()}onMediaDurationChange(){let e=this.media;e?this.lastMediaDuration=e.duration:this.logger.warn("Listening to media.durationchanged but this.media == null")()}onBufferSourceReset(e){this._attachMedia(e.media,e.startPosition),this.tick()}onMediaSeeking(){let e=this.media,t=e?e.currentTime:void 0,i=this.config;if(!e)return void this.logger.warn("Listening to media.onseeking but this.media == null")();if(this.iframeModeSeek&&!this.iframeMode&&!isNaN(this.seekToPos))return void this.logger.info("received seeking event for wrong mode type, don't overwrite existing seekToPos")();isNaN(t)||this.logger.info(`media seeking to ${t.toFixed(3)}`)();let s=this.getSourceBufferInfo(t);if(this.state===Kt.FRAG_LOADING){let e=this.fragCurrent;if(0===s.len&&e){let s=i.maxFragLookUpTolerance,a=e.start-s,r=e.start+e.duration+s;(t<a||t>r)&&(e.loader&&e.loader.abort(),this.fragCurrent=null,this.fragPrevious=null,this.state=Kt.IDLE)}}else this.state!==Kt.ENDED&&this.state!==Kt.WAITING_DISCONTINUITY||(0===s.len&&(this.fragPrevious=void 0),this.state=Kt.IDLE);this.state!==Kt.FRAG_LOADING&&void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*i.fragLoadingLoopThreshold),this.seek(t,!1),this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:void 0;isNaN(t)||this.logger.info(`[QE Critical]  media seeked to ${t.toFixed(3)}`)(),Math.abs(t-this.seekToPos)>=Number.EPSILON&&this.logger.warn(`currentTime ${t} doesn't match last seekToPos ${this.seekToPos}`)(),this._checkIfPlaybackLikelyToKeepUp(),this.tick()}onMediaEnded(){}onMediaPlaying(){this.firstPlaybackStarted||(this.firstPlaybackStarted=!0),this._checkIfPlaybackLikelyToKeepUp()}onMediaPlay(){this._expectPlayEvent||(this.logger.warn(`Unexpected play event received seeking=${this.seeking}`)(),this.media.controls&&!this.seeking&&(this.logger.info("Assumed play came from controls, setting rate 1")(),this.hls.setRate(1))),this._expectPlayEvent=!1}onMediaPause(){this._expectPauseEvent||(this.logger.warn(`Unexpected pause event received seeking=${this.seeking}`)(),this.media.controls&&!this.seeking&&(this.logger.info("Assumed pause came from controls, setting rate 0")(),this.hls.setRate(0))),this._expectPauseEvent=!1}onManifestLoading(){this.hls.bufferController.resetBuffer(),this._bufferedFrags=[],this.tstalled=void 0,this.seek(0),this.levels=void 0,this.pendingParsedInitSegmentData=void 0,this.pendingParsedData=void 0}onManifestParsed(e){var t,i=!1,s=!1;e.levels.forEach(e=>{(t=e.audioCodec)&&(-1!==t.indexOf("mp4a.40.2")&&(i=!0),-1!==t.indexOf("mp4a.40.5")&&(s=!0))}),this.audioCodecSwitch=i&&s,this.audioCodecSwitch&&this.logger.warn("both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC")(),this.levels=e.levels,this.startLevelLoaded=!1,this.startFragRequested=!1,this.needsMultipleSourceBuffers=e.altAudio;let a=this.config,r=1===this.levels.length&&!this.levels[0].attrs;if(a.autoStartLoad||this.forceStartLoad){let e;this.hls.pendingSeekToDate&&r?(e=this.hls.resolvePendingSeekToDate(),this.hls.pendingSeekToDate=void 0):e=a.startPosition,this.hls.startLoad(e)}}_mergeLiveExpiredBufferRange(e,t){if(!e.start&&!e.end&&!this.pendingExpiredLiveBufferRange)return e;var i={start:void 0,end:void 0};if(this.pendingExpiredLiveBufferRange){var s=e.start?Math.min(this.pendingExpiredLiveBufferRange.start,e.start):this.pendingExpiredLiveBufferRange.start,a=e.end?Math.max(this.pendingExpiredLiveBufferRange.end,e.end):this.pendingExpiredLiveBufferRange.end;t>this.pendingExpiredLiveBufferRange.end&&t>e.end?(i={start:s,end:a},this.pendingExpiredLiveBufferRange=void 0):t<=this.pendingExpiredLiveBufferRange.end&&t<=e.end?this.pendingExpiredLiveBufferRange={start:s,end:a}:(i=this.pendingExpiredLiveBufferRange,this.pendingExpiredLiveBufferRange=e)}else t>e.end?i=e:this.pendingExpiredLiveBufferRange=e;return i}onLevelLoaded(e){var t=e.details,i=e.level,a=this.hls.levelWithPersistentId(i).levelInfo,r=t.totalduration,n=0;if(!(e.livePlaylistUpdateError||this.hls.isLive&&0===this.desiredRate)&&this.media){if(this.levelLastLoaded=i,t.live){var o=a.details;if(o&&t.fragments.length>0){let e=Wt.getExpiredFragmentsRange(o,t);if(Wt.mergeDetails(o,t),n=t.fragments[0].start,this.liveSyncPosition=this.computeLivePosition(n,o),t.PTSKnown,this.config.liveFlushExpiredFrags){var l=this._mergeLiveExpiredBufferRange(e,this.media.currentTime);l.start&&l.end&&this.flushMainBuffer(l.start,l.end)}}else t.PTSKnown=!1}else t.PTSKnown=!1;if(a.details=t,this.hls.trigger(s.a.LEVEL_UPDATED,{details:t,level:i}),!1===this.startFragRequested&&(void 0===this.seekToPos||-1===this.seekToPos||-1===this.lastCurrentTime||t.live&&0===this.seekToPos)){let e,i=t.startTimeOffset;this.hls.pendingSeekToDate&&(i=this.hls.resolvePendingSeekToDate(),this.hls.pendingSeekToDate=void 0),isNaN(i)?e=t.live?this.computeLivePosition(n,t):0:(i<0&&(i=n+r+i),e=i),this.seek(e)}this.state===Kt.PLAYLIST_LOADING?this.state=Kt.IDLE:this.state===Kt.BUFFER_FLUSHING_WAITING_PLAYLIST&&(this.state=Kt.BUFFER_FLUSHING),this.tick()}}_processLoadedFrag(e){var t=this.fragCurrent,i=e.frag;if(this.state===Kt.FRAG_LOADING&&t&&"main"===i.type&&i.level===t.level&&i.sn===t.sn){let a=e.stats,r=this.hls.levelWithPersistentId(t.level).levelInfo,n=r.details;if(this.logger.info(`[QE Critical]  ${t.type} Loaded  ${t.sn} of [${n.startSN},${n.endSN}], level: ${t.level}, cc: ${t.cc}, start: ${t.start} URL ${this.hls.redactUrl(t.relurl)}, bytesLoaded: ${a.loaded}, fragLoadMs: ${a.tload-a.trequest}`)(),this.bitrateTest=!1,this.stats=a,!0===i.bitrateTest&&this.hls.nextLoadLevel)this.state=Kt.IDLE,this.startFragRequested=!1,a.tparsed=a.tbuffered=performance.now(),this.hls.trigger(s.a.FRAG_BUFFERED,{stats:a,frag:t,id:"main"}),this.tick();else if("initSegment"===i.sn)this.state=Kt.IDLE,a.tparsed=a.tbuffered=performance.now(),n.initSegments[i.cc].data=e.payload,this.hls.trigger(s.a.FRAG_BUFFERED,{stats:a,frag:t,id:"main"}),this.tick();else{this.state=Kt.PARSING;let s=n.totalduration,a=t.level,o=t.sn,l=this.config.defaultAudioCodec||r.audioCodec,d=r.videoCodec||this.config.defaultVideoCodec;this.audioCodecSwap&&(void 0===l&&(l=this.lastAudioCodec),l&&(l=-1!==l.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5")),this.pendingBuffering=!0,this.appended=!1,this.waitingForIncompatibleCCFragLoad&&(this.waitingForIncompatibleCCFragLoad=!1),this.logger.info(`${t.type} Parsing ${o} of [${n.startSN} ,${n.endSN}],level ${a}, cc ${t.cc} URL ${this.hls.redactUrl(t.relurl)}`)();let h=this.media,c=!(h&&h.seeking)&&(n.PTSKnown||!n.live),u=n.initSegments[i.cc]?n.initSegments[i.cc].data:new Uint8Array;this._ensureDemuxer(),this.demuxer.push(e.payload,u,l,d,t,s,c,void 0)}}this.fragLoadError=0,this.hls.trigger(s.a.FRAG_LOADED,e)}onFragParsingInitSegment(e){const t=this.fragCurrent,i=e.frag;if(t&&"main"===e.id&&i.sn===t.sn&&i.level===t.level&&this.state===Kt.PARSING){var s,a,r=e.tracks;let t=this.hls.levelWithPersistentId(this.level).levelInfo;if(r.audio&&this.altAudio&&delete r.audio,a=r.audio){s="audio";var n=t.audioCodec,o=navigator.userAgent.toLowerCase();n&&this.audioCodecSwap&&(n=-1!==n.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),this.audioCodecSwitch&&1!==a.metadata.channelCount&&-1===o.indexOf("firefox")&&(n="mp4a.40.5"),-1!==o.indexOf("android")&&"audio/mpeg"!==a.container&&(n="mp4a.40.2"),a.levelCodec=n}(a=r.video)&&(s="video",a.levelCodec=t.videoCodec),"audio"in r&&"video"in r&&r.audio.initSegment===r.video.initSegment&&(r.audiovideo=r.video,r.audiovideo.codec+=","+r.audio.codec,r.audiovideo.levelCodec+=","+r.audio.levelCodec,delete r.video,delete r.audio),"audiovideo"in r&&(a=r.audiovideo,s="audiovideo");const d=i.cc,h=Gt.Main;let c=this.hls.bufferController;if(c.updateKnownCodecs(h,d,r),c.isCompatibleTransition(d))for(s in c.createBuffer(h,d,r),r){var l=(a=r[s]).initSegment;l&&(this.appended=!0,this.pendingBuffering=!0,c.appendBuffer(s,l,Gt.Main,$t.InitSegment))}else this.pendingParsedInitSegmentData=e;this.tick()}}onFragParsingData(e){const t=this.fragCurrent,i=e.frag;if(!t||"main"!==e.id||i.sn!==t.sn||i.level!==t.level||"audio"===e.type&&this.altAudio)return;let a=this.hls.bufferController.isCompatibleTransition(i.cc);if(void 0===a)this.pendingParsedData||(this.pendingParsedData={}),this.pendingParsedData[e.type]=e,this.state=Kt.IDLE;else if(!1===a)this.pendingParsedData=void 0,this.nextLoadPosition=t.start,this.state=Kt.IDLE;else if(this.pendingParsedData){let e=this.pendingParsedData.audio||this.pendingParsedData.video,t=e?e.frag:void 0;t&&t.sn===i.sn&&t.level===i.level?this.pendingParsedData[e.type]=e:this.logger.error(`stream-controller: has unmatched current frag ${i.sn} (level ${i.level}) and pendingParsedData frag ${t?t.sn:"undefined"} (level ${t.level?t.level:"undefined"})`)()}else if(this.state===Kt.PARSING)if(this.keyRequestPromise)this.pendingParsedData={},this.pendingParsedData[e.type]=e,this.state=Kt.KEY_LOADING;else{var r=this.hls.levelWithPersistentId(this.level).levelInfo,n=t;if(isNaN(e.endPTS)&&(e.endPTS=e.startPTS+t.duration,e.endDTS=e.startDTS+t.duration),this.pendingParsedInitSegmentData&&(this.pendingParsedInitSegmentData.frag.sn===i.sn||this.iframeMode)&&(this.pendingParsedInitSegmentData.frag.sn=i.sn,this.onFragParsingInitSegment(this.pendingParsedInitSegmentData),this.pendingParsedInitSegmentData=void 0),"video"===e.type)if(n.dropped=e.dropped,n.dropped)if(n.backtracked)this.logger.warn("Already backtracked on this fragment, appending with the gap")();else{if(this.fragPrevious&&this.fragPrevious.cc===n.cc)return this.logger.warn(`missing video frame(s), backtracking fragment in ${n.cc}`)(),n.backtracked=!0,this.nextLoadPosition=e.startPTS,this.state=Kt.IDLE,this.fragPrevious=n,void this.tick();this.logger.warn(`missing video frame(s) in new cc ${n.cc}), reset dropped count and restart @ frag ${n.sn}`)(),e.dropped=0}else n.backtracked=!1;let a=this.hls;if(!this.iframeMode){let t=Wt.updateFragPTSDTS(r.details,n,e.startPTS,e.endPTS,e.startDTS,e.endDTS);a.trigger(s.a.LEVEL_PTS_UPDATED,{details:r.details,level:this.level,drift:t,type:e.type,start:e.startPTS,end:e.endPTS})}[e.data1,e.data2].forEach(t=>{t&&t.length&&this.state===Kt.PARSING&&(this.appended=!0,this.pendingBuffering=!0,this.iframeMode&&(this.media.currentTime,this.iframeBaseTime,n.start,this.iframeBaseTime,"video"===e.type||e.type),a.bufferController.appendBuffer(e.type,t,Gt.Main,$t.Data))}),this.pendingIncompatCC&&(this.pendingIncompatCC=void 0,this.hls.determineIncompatCCStartTime(i))}this.tick()}onFragParsed(e){const t=this.fragCurrent,i=e.frag;t&&"main"===e.id&&i.sn===t.sn&&i.level===t.level&&this.state===Kt.PARSING&&(this.stats.tparsed=performance.now(),this.state=Kt.PARSED,this._checkAppendedParsed()),this.tick()}onAudioTrackSwitching(e){var t=!!e.url,i=e.id;if(!t){if(this.mediaBuffer!==this.media){this.mediaBuffer=this.media;let e=this.fragCurrent;e.loader&&e.loader.abort(),this.fragCurrent=null,this.fragPrevious=null,this._destroyDemuxer(),this.state=Kt.IDLE}let e=this.hls;this.hls.bufferController.flushBufferRange(0,Number.POSITIVE_INFINITY,"audio"),e.trigger(s.a.AUDIO_TRACK_SWITCHED,{id:i}),this.altAudio=!1}}onAudioTrackSwitched(e){var t=e.id,i=this.hls.audioTrackController.resolveTrackId(t).trackInfo;if(!i)return;let s=!!i.url;if(s){let e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.mediaBuffer=e)}this.altAudio=s,this.tick()}onBufferCreated(e){let t,i,s=e.tracks,a=!1;for(var r in s){let e=s[r];"main"===e.id?(i=r,t=e,"video"===r&&(this.videoBuffer=s[r].buffer)):a=!0}this.mediaBuffer=a&&t?t.buffer:this.media}onBufferAppended(e){let t=this.media;if(t.seeking&&t.paused&&t.buffered.length){let e=this.adjustSeekPosition(this.media.currentTime);Math.abs(t.currentTime-e)>=Number.EPSILON&&(t.currentTime=e)}if("main"===e.parent){const t=this.state;t!==Kt.PARSING&&t!==Kt.PARSED||(this.pendingBuffering=e.pending>0,this._checkAppendedParsed())}this.bufferMonitor.notifyWaterLevelChanged()}onBufferCodecUpdated(e){"main"!==e.parent&&this.state===Kt.WAITING_DISCONTINUITY&&(this.state=Kt.IDLE,this.tick())}addIframeToCurrentLevel(e){e&&!isNaN(e.iframeMediaStart)&&(this.iframesInSourceBuffer&&this.iframesInSourceBuffer.level===e.level?this.iframesInSourceBuffer.buffered++:this.iframesInSourceBuffer={level:e.level,buffered:1,loading:0})}countIframesInCurrentLevel(e){let t=this.iframesInSourceBuffer&&e===this.iframesInSourceBuffer.level?this.iframesInSourceBuffer.buffered:0,i=0,s=this.fragCurrent;return s&&s.iframeMediaStart&&s.level===e&&i++,{level:e,loading:i,buffered:t}}_checkAppendedParsed(){if(!(this.state!==Kt.PARSED||this.appended&&this.pendingBuffering)){const e=this.fragCurrent;if(e){const t=this.mediaBuffer?this.mediaBuffer:this.media;let i;this.logger.info(`main buffered: ${Ht(t.buffered)} media.currentTime=${this.media.currentTime}`)(),e.iframe?(this.media.currentTime,this.iframeBaseTime,e.start,this.iframeBaseTime,(i=this._bufferedFrags.filter(e=>kt.isBuffered(t,(e.iframeMediaStart+e.iframeMediaStart+e.iframeMediaDuration)/2))).push(e),this.addIframeToCurrentLevel(e),this._bufferedFrags=i.sort((function(e,t){return e.iframeMediaStart-t.iframeMediaStart}))):((i=this._bufferedFrags.filter(e=>kt.isBuffered(t,(e.startPTS+e.startPTS+e.duration)/2))).push(e),this._bufferedFrags=i.sort((function(e,t){return e.startPTS-t.startPTS}))),this.fragPrevious=e;const a=this.stats;a.tbuffered=performance.now(),this.fragLastKbps=Math.round(8*a.total/(a.tbuffered-a.tfirst)),this.updateAppendBufferAvg(a.tbuffered-a.tparsed),this.updateParseBwAvg(a.total,a.tparsed-a.tload),this.hls.trigger(s.a.FRAG_BUFFERED,{stats:a,frag:e,id:"main"}),this.state=Kt.IDLE}this.tick()}}_handleFragmentError(e){let t=e.details;super._handleFragmentNetworkError(e),t===a.a.FRAG_LOAD_ERROR&&!e.fatal&&e.frag.iframe&&e.errorAction===Et.AbortRequest&&(this.state=Kt.IDLE),this.resetNextLoadPositionState(),e.fatal&&this.hls.trigger(s.a.ERROR,e)}abortiFrameFragRequest(e){let t=e.frag;t&&(t.loader.abort(),this.state=Kt.IDLE)}onError(e){if(this.state===Kt.ERROR)return;if(e.fatal)return this.state=Kt.ERROR,void this.logger.error(`streamController: ${e.type}, ${e.details}, ${e.response}, switch to ${this.state} state ...`)();let t=e.frag||this.fragCurrent;if(t&&"main"!==t.type)return;this.hls.levelController.handleError(e);let i=this.media,s=i&&kt.isBuffered(i,i.currentTime)&&kt.isBuffered(i,i.currentTime+.5);switch(e.details){case a.a.FRAG_LOOP_LOADING_ERROR:e.fatal||(t.iframe&&e.errorAction===Et.AbortRequest?this.state=Kt.IDLE:this.retryFragRequest(e));break;case a.a.KEY_SYSTEM_GENERIC_ERROR:case a.a.KEY_LOAD_ERROR:case a.a.KEY_LOAD_TIMEOUT:if(!(this.fragCurrent&&this.fragCurrent.decryptdata&&this.fragCurrent.decryptdata.isEncrypted&&e.decryptdata&&e.decryptdata.uri===this.fragCurrent.decryptdata.uri))return;this.resetNextLoadPositionState(),e.fatal||e.retrying||this.state!==Kt.KEY_LOADING||(this.state=Kt.IDLE);break;case a.a.BUFFER_FULL_ERROR:"main"!==e.parent||this.state!==Kt.PARSING&&this.state!==Kt.PARSED||(s?(this._reduceMaxBufferLength(this.config.maxBufferLength),this.state=Kt.IDLE):(this.logger.warn("buffer full error also media.currentTime is not buffered, flush everything")(),this.fragCurrent=null,this.flushMainBuffer(0,Number.POSITIVE_INFINITY)));break;case a.a.FRAG_PARSING_ERROR:this.state=e.fatal?Kt.ERROR:Kt.IDLE,this.logger.warn(`streamcontroller: ${e.details} while parsing frag,switch to ${this.state} state ...`)()}}_reduceMaxBufferLength(e){let t=this.config;t.maxMaxBufferLength>=e&&(t.maxMaxBufferLength/=2,this.logger.warn(`main:reduce max buffer length to ${t.maxMaxBufferLength}s`)(),this.fragLoadIdx+=2*t.fragLoadingLoopThreshold)}_ensureNudgeStartTime(e,t,i,s){let a=e;if(void 0===a&&s===Kt.WAITING_DISCONTINUITY){let e=this.fragCurrent?this.fragCurrent:this.fragPlaying;if(e){let i=this.hls.levelController.getLevelWithPersistentId(e.level).levelInfo,s=i?i.details.fragments:void 0,r=e.start+e.duration;s&&(e.start>t?a=e.start:r>t?a=r:this.logger.warn(`Cannot nudge to frag.sn ${e.sn} [${e.start},${r}] at incompatible discontinuity`)())}}if(!isNaN(a)){let e=a-t;(e>i||e<=0)&&(a=void 0)}return a}_checkIfLoadedMetadata(){let e=this.media;if(!e||!e.readyState)return;let t=e.currentTime,i=this.mediaBuffer?this.mediaBuffer:e,s=i.buffered;if(!this.loadedmetadata&&e.readyState>=e.HAVE_METADATA&&e.seekable.length&&s.length){this.loadedmetadata=!0;let a=isNaN(this.seekToPos)?0:this.seekToPos,r=e.seeking?t:a,n=kt.isBuffered(i,r);this.hls.processIncompatCCStartTime()||t===r&&n||(n||e.seeking||(r=s.start(0),this.logger.info(`target start position not buffered, seek to buffered.start(0) ${r}`)()),this.logger.info(`adjust currentTime from ${t} to ${r}`)(),e.currentTime=r)}}onFragLoadEmergencyAborted(){this.state=Kt.IDLE,this.resetNextLoadPositionState(),this.tick()}onBufferFlushed(){const e=this.mediaBuffer?this.mediaBuffer:this.media;this._bufferedFrags=this._bufferedFrags.filter(t=>kt.isBuffered(e,(t.startPTS+t.endPTS)/2)),this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,this.state===Kt.BUFFER_FLUSHING_WAITING_PLAYLIST?this.state=Kt.PLAYLIST_LOADING:this.state=Kt.IDLE,this.preserveFragPrevious||(this.fragPrevious=null),this.preserveFragPrevious=void 0,this._flushingBuffer=!1,this._startOffsetOfBufferFlush=void 0,this.media&&!isNaN(this.seekToPos)&&(this.logger.info(`[iframes] buffer flushed, iframeSeekTo: ${this.seekToPos.toFixed(3)}, currentTime: ${this.media.currentTime.toFixed(3)}, seekable: ${JSON.stringify(this.media.seekable)}, readyState ${this.media.readyState}`)(),this.seek(this.seekToPos)),this.bufferMonitor.notifyWaterLevelChanged(),this.tick()}onLevelsChanged(e){if(e.requiresReset){if(this.state!==Kt.STOPPED&&this.media){let e=this.realCurrentTime;this.pendingParsedInitSegmentData=void 0,this.pendingParsedData=void 0,this._resetMediaSource(e)}}else(this.state===Kt.PLAYLIST_LOADING||this.state===Kt.KEY_LOADING||this.state===Kt.FRAG_LOADING&&!this.hls.levelController.getLevelWithPersistentId(this.fragCurrent.level).levelInfo||this.state!==Kt.STOPPED&&!this.hls.levelController.getLevelWithPersistentId(this.level).levelInfo)&&(this.pendingParsedInitSegmentData=void 0,this.pendingParsedData=void 0,this.hls.levels&&this.hls.levels.length>0?this.state=Kt.IDLE:(this.logger.error("Empty level list")(),this.state=Kt.ERROR),this.tick())}onBandwidthChanged(){this.tick()}onBufferChanged(){this.tick()}onStalled(e){let t=e.type,i=e.isLowBufferStall,r=e.bufferInfo,n=e.stallDurationMs,o=this.media,l=o.currentTime;const d=r.len;if(this.tstalled=e.tstalled,this.state===Kt.WAITING_DISCONTINUITY&&d<.5&&!o.seeking)return this.logger.info("stalled while waiting for discontinuity, flagging for possible reset")(),this.stallWhileWaitingForCC=!0,this.state=Kt.IDLE,void this.tick();const h=this.hls,c=this.config;this.stallReported||(this.stallReported=!0,this.logger.warn(`playback stall type:${t} @${l}, state: ${this.state}, buffer length: ${d}, buffered ranges: ${this.bufferedRangeString} stallMs=${Math.round(n)}`)(),this.iframeMode||h.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.BUFFER_STALLED_ERROR,fatal:!1,buffer:d,response:i?a.b.InsufficientDataAvailable:a.b.VideoDecoderBadDataErr}));let u=this.nudgeRetry||0;if(i){if(d>.5)return void this.logger.warn("Got low buffer stall but above jump threshold")();var f=this._ensureNudgeStartTime(r.nextStart,l,c.maxSeekHole,this.state);if(f){this.nudgeRetry=++u;const e=u*c.nudgeOffset;this.logger.info(`adjust currentTime from ${o.currentTime} to next buffered @ ${f} + nudge ${e}`)(),o.currentTime=f+e,h.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.BUFFER_SEEK_OVER_HOLE,fatal:!1,hole:f+e-l,response:a.b.InsufficientDataAvailable})}}else if(this.relaxHighBufferStallRule)this.relaxHighBufferStallRule--,h.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.BUFFER_STALLED_ERROR,fatal:!1,response:a.b.VideoDecoderBadDataErr});else if(this.nudgeRetry=++u,u<c.nudgeMaxRetry){const e=o.currentTime,t=e+u*c.nudgeOffset;this.logger.info(`adjust currentTime from ${e} to ${t}`)(),o.currentTime=t,h.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.BUFFER_NUDGE_ON_STALL,fatal:!1,response:a.b.InsufficientDataAvailable})}else this.logger.error(`still stuck in high buffer @${l} after ${c.nudgeMaxRetry}, raise fatal error`)(),h.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.BUFFER_STALLED_ERROR,fatal:!0,response:a.b.VideoDecoderBadDataErr})}onMediaTimeUpdate(){let e=this.media.currentTime;this.stallReported&&(this.logger.info(`playback not stuck anymore @${e}, after ${Math.round(performance.now()-this.tstalled)}ms`)(),this.stallReported=!1),this.tstalled=void 0,this.nudgeRetry=0,this.relaxHighBufferStallRule=0}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}computeLivePosition(e,t){let i=void 0!==this.config.liveSyncDuration?this.config.liveSyncDuration:this.config.liveSyncDurationCount*t.targetduration;return e+Math.max(0,t.totalduration-i)}get liveSyncPosition(){return this._liveSyncPosition}set liveSyncPosition(e){this._liveSyncPosition=e}get playbackEverStarted(){return this.firstPlaybackStarted}get needsReset(){return this._needsReset}set needsReset(e){if(this._needsReset=e,this._needsReset&&this.state===Kt.FRAG_LOADING){let e=this.fragCurrent;e&&(e.loader&&e.loader.abort(),this.fragCurrent=null,this.state=Kt.IDLE),this.tick()}}get bufferedRangeString(){let e=`main${this.mediaBuffer&&this.mediaBuffer.buffered.length?Ht(this.mediaBuffer.buffered):"[N/A]"}`;if(this.altAudio){const t=this.hls.audioStreamController.mediaBuffer;e+=`/audio${t&&t.buffered.length?Ht(t.buffered):"[N/A]"}`}return e}get variantController(){return this.hls.levelController}getLivePlaylistRefreshDelay(e){let t=kt.bufferInfo(this.media,this.media.currentTime,this.config.maxBufferHole),i=0===t.len||t.len<Math.max(this.config.liveMinPlayingBufferLen,e.targetduration),s=this.fragCurrent&&"number"==typeof this.fragCurrent.sn&&e.endSN>this.fragCurrent.sn;return i&&s?this.config.livePlaylistRefreshDelay:0}};!(function(e){e[e.SDR=0]="SDR",e[e.HDR=1]="HDR",e[e.HDR10=2]="HDR10",e[e.DolbyVision=3]="DolbyVision",e[e.HLG=4]="HLG"})(Yt||(Yt={})),(function(e){e[e.H264=16]="H264",e[e.HEVC=64]="HEVC"})(zt||(zt={})),(function(e){e[e.DOVI=3]="DOVI",e[e.HEVC=2]="HEVC",e[e.AVC=1]="AVC",e[e.UNKNOWN=0]="UNKNOWN"})(Qt||(Qt={})),(function(e){e[e.EC3=3]="EC3",e[e.AC3=2]="AC3",e[e.AAC=1]="AAC",e[e.UNKNOWN=0]="UNKNOWN"})(Xt||(Xt={})),(function(e){e[e.VALID=1]="VALID",e[e.INVALID=0]="INVALID"})(Jt||(Jt={}));class ii{constructor(...e){this.identifier=e}ensureSameIdentifierLength(e){if(this.identifier.length!==e.identifier.length)throw new Error(`Identifiers have non-matching lengths! (${this.identifier.length} vs ${e.identifier.length})`)}isGreaterThan(e){this.ensureSameIdentifierLength(e);for(let t=0;t<this.identifier.length;++t){if(this.identifier[t]<e.identifier[t])return!1;if(this.identifier[t]>e.identifier[t])return!0}return!1}isEqualTo(e){return this.ensureSameIdentifierLength(e),this.identifier.every((t,i)=>t===e.identifier[i])}}function si(e){return jt.b.isEC3(e)?Xt.EC3:jt.b.isAC3(e)?Xt.AC3:jt.b.isAAC(e)?Xt.AAC:Xt.UNKNOWN}function ai(e,t){const i=(function(e,t,i){const s=(e,t,i)=>(e-t)*(e-i)<=0;return s(e,i.minValidBitrate,i.maxValidBitrate)&&s(t,i.minValidHeight,i.maxValidHeight)})(e.bitrate,e.height,t)?Jt.VALID:Jt.INVALID,{videoRank:s,audioRank:a}=(function(e){return{videoRank:(t=e.videoCodec,jt.b.isDolby(t)?Qt.DOVI:jt.b.isHEVC(t)?Qt.HEVC:jt.b.isAVC(t)?Qt.AVC:Qt.UNKNOWN),audioRank:si(e.audioCodec)};var t})(e),r=e.bitrate<=t.maxPreferredBitrate?Jt.VALID:Jt.INVALID,n=e.audioChannelCount||1;return new ii(i,s,n,a,r,e.height)}function ri(e,t){let i,s;for(let n=0;n<e.length;++n){var a,r=e[n];r.iframes||(a=t(r,void 0),(!i||a.isGreaterThan(s)||a.isEqualTo(s)&&r.bitrate>i.bitrate)&&(i=r,s=a))}return i}function ni(e){if(!e||!e.length)return;const t=e.sort((e,t)=>si(t)-si(e));return t&&t.length?t[0]:void 0}function oi(e,t){if(!e||!t||!t.length)return;let i=void 0;const s=t.filter(t=>t.groupId===e);if(s&&s.length){const e=s.sort((e,t)=>jt.b.getChannelCount(t.channels)-jt.b.getChannelCount(e.channels));e&&e.length&&(i=e[0].channels)}return i}function li(e,t,i){var s=function(i,s){return (function(i,s){let a=s?"audio":"video";e.has(i)||t.has(i)||(function(e,t){return MediaSource.isTypeSupported(`${e}/mp4;codecs=${t}`)}(a,i)?e.add(i):t.add(i))})(i,s),t.has(i)};let a=!1;return i.audioCodecList&&(a=i.audioCodecList.some(e=>s(e,!0))),!a&&i.videoCodecList&&(a=i.videoCodecList.some(e=>s(e,!1))),!a}function di(e,t){for(let i in e)if(e[i].type===t)return e[i];return{}}function hi(e,t){return isNaN(e)||isNaN(t)||e<=t}function ci(e){return e.every(e=>e.iframes)}function ui(e,t,i,s=!1){let r=i?i.maxHdcpLevel:void 0;r&&(e=(function(e,t){let i=function(e){switch(e){case"NONE":return 0;case"TYPE-0":return 1;case"TYPE-1":return 2;case"TYPE-2":return 3;default:return 4}},s=i(r);return e.filter((function(e){let t=e.hdcpLevel;return!t||i(t)<=s}))})(e)),e.forEach(e=>{if(e.audioCodecList&&e.audioGroupId){let i=t.find(t=>t.groupId===e.audioGroupId),s=i?i.channels:void 0;s&&(e.audioChannelCount=parseInt(s))}});let n,o=navigator&&navigator.mediaCapabilities,l=s&&o&&"function"==typeof o.decodingInfo;return l?n=(function(e,t){let i=navigator&&navigator.mediaCapabilities,s=new Array,a=new Set,r=new Set,n=new Map;function o(e,t,s,a,r){let o={type:"media-source"};a?o.video=(function(e,t){let i={contentType:`video/mp4;codecs=${e}`,width:t.width,height:t.height,bitrate:t.avgBandwidth,framerate:t.iframes?8:t.frameRate};if(t.videoRange)switch(t.videoRange){case"PQ":jt.b.isDolby(e)?(i.hdrMetadataType=Zt.DoVi,i.colorGamut="rec2020"):jt.b.isHEVC(e)&&(i.hdrMetadataType=Zt.HDR10,i.colorGamut="rec2020"),i.transferFunction="pq";break;case"HLG":i.colorGamut="rec2020",i.transferFunction="hlg"}return i})(s,e):o.audio=(function(e,t,i){let s={contentType:`audio/mp4;codecs=${e}`},a=oi(t.audioGroupId,i);if(a){let e=a.split("/"),t=e[0];s.channels=t,e.find(e=>"JOC"===e)&&(s.spatialRendering=!0)}return s})(s,e,t);let l,d=JSON.stringify(o);if(n.has(d))l=n.get(d);else{try{l=i.decodingInfo(o).then(e=>{let t=e.configuration||e.supportedConfiguration,i=t instanceof Object&&(!o.video||void 0===Object.keys(o.video).find(e=>!(e in t.video)))&&(!o.audio||void 0===Object.keys(o.audio).find(e=>!(e in t.audio))),s=e.supported&&(!a||e.powerEfficient)&&i;return s||c.b.warn(`Unsupported config ${e.supported}/${e.powerEfficient}/${i} ${JSON.stringify(o)} supportedConfig=${JSON.stringify(t)}`)(),s})}catch(e){l=Promise.reject(e)}n.set(d,l)}r.push(l)}function l(e){c.b.info(`Unsupported level ${JSON.stringify(e,["avgBandwidth","audioCodecList","videoCodecList","frameRate","width","height","iframes"])}`)()}for(let i of e){let e=Array();if(i.videoCodecList)for(let s of i.videoCodecList)o(i,t,s,!0,e);if(i.audioCodecList&&i.audioCodecList.length>0){const s=ni(i.audioCodecList);o(i,t,s,!1,e)}let n=Promise.all(e).then(e=>{if(void 0===e.find(e=>!1===e))return i;l(i)}).catch(e=>{if(c.b.warn(`decodingInfo error: ${e.message}`)(),li(a,r,i))return i;l(i)});s.push(n)}return Promise.all(s).then(e=>e.filter(e=>Boolean(e)))})(e,t):(e=(function(e,t){let i=new Set,s=new Set,a=!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="-1"'),r=a&&!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="2"; features="INVALID"');return c.b.info(`Platform support for channels: ${a}; features: ${r}`)(),e.filter((function(e){let n=!1;if(e.audioCodecList&&e.audioGroupId){const o=oi(e.audioGroupId,t);o&&(n=(function(e,t){let n=jt.b.isDolbyAtmos(e,t);if(r||a&&!n){!(function(e,t){let a=e+"/"+t;i.has(a)||s.has(a)||(function(e,t){let i,s,a=t.split("/"),r=parseInt(a[0]);a.length>1?(i=`audio/mp4;codecs="${e}";channels="${r}";features="${a[1]}"`,s=`audio/mp4;codecs="${e}";channels="8";features="${a[1]}"`):i=`audio/mp4;codecs="${e}";channels="${r}"`;let n=MediaSource.isTypeSupported(i);return!n&&s&&(n=MediaSource.isTypeSupported(s),c.b.info(`Using mimeCodecAlternate, isSupported: ${n}; mimeCodecAlternate: ${s}`)()),n}(e,t)?i.add(a):s.add(a))})(e,t);let a=e+"/"+t;return s.has(a)}return!!n})(ni(e.audioCodecList),o))}return!n}))})(e=(function(e){let t=new Set,i=new Set;return e.filter(li.bind(null,t,i))})(e),t),n=Promise.resolve(e)),n.then(e=>{if(0===(e=(function(e,t){return e.filter(e=>{const{highestPlayablePeakBitRate:i,highestPlayableAverageBitRate:s,highestPlayableWidth:a,highestPlayableHeight:r,highestPlayableFrameRate:n}=(function(e,t){if(!t)return{highestPlayableAverageBitRate:void 0,highestPlayablePeakBitRate:void 0,highestPlayableWidth:void 0,highestPlayableHeight:void 0,highestPlayableFrameRate:void 0};let i=e.videoCodec,s=e.videoRange,a=t.videoDynamicRangeFormats,r=t.videoCodecs;return (function(e,t,i,s){if(!s&&!i)return{};let a,r,n=i?di(i,t):{},o=s?di(s,e):{};switch(e){case Yt.SDR:a=n,r=o;break;default:a=o,r=n}let l=Object.assign({},a);return l.highestPlayableAverageBitRate||l.highestPlayablePeakBitRate||(l.highestPlayableAverageBitRate=r.highestPlayableAverageBitRate,l.highestPlayablePeakBitRate=r.highestPlayablePeakBitRate),l.highestPlayableWidth||l.highestPlayableHeight||l.highestPlayableFrameRate||(l.highestPlayableWidth=r.highestPlayableWidth,l.highestPlayableHeight=r.highestPlayableHeight,l.highestPlayableFrameRate=r.highestPlayableFrameRate),l})(function(e,t){let i=Yt.SDR;return"PQ"===e&&jt.b.isDolby(t)?i=Yt.DolbyVision:"PQ"===e&&jt.b.isHEVC(t)?i=Yt.HDR10:"HLG"===e&&-1!==t.indexOf("hvc1")&&(i=Yt.HLG),i}(s,i),(function(e){let t=zt.H264;return(jt.b.isHEVC(e)||jt.b.isDolby(e))&&(t=zt.HEVC),t})(i),r,a)})(e,t);return hi(e.bandwidth,i)&&hi(e.avgBandwidth,s)&&hi(e.width,a)&&hi(e.height,r)&&hi(e.frameRate,n)})})(e,i)).length||ci(e)){let e={type:a.c.MEDIA_ERROR,details:a.a.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"no level with compatible codecs found in manifest",response:a.b.IncompatibleAsset};return Promise.reject(new a.d("no level with compatible codecs found in manifest",e))}let t=i?i.videoDynamicRangeFormats:void 0;l&&!t&&(t=[{type:Yt.SDR},{type:Yt.HDR},{type:Yt.HDR10},{type:Yt.DolbyVision},{type:Yt.HLG}]);let{hdrLevels:s,sdrLevels:r}=(function(e,t){let i=new Array,s=new Array,a=(function(e){let t=!1,i=!1,s=!1;if(e&&e.length>0)for(let a=0;a<e.length;++a)switch(e[a].type){case Yt.DolbyVision:t=!0;break;case Yt.HDR10:i=!0;break;case Yt.HLG:s=!0}return{doViSupported:t,hdr10Supported:i,hlgSupported:s}})(t),{doViSupported:r,hdr10Supported:n,hlgSupported:o}=a;return c.b.info(`Supported videoDynamicRangeFormats DoVi/HDR10/HLG: ${r}/${n}/${o}`)(),e.forEach(e=>{let t=e.videoRange,a=e.videoCodec;switch(t){case"PQ":a&&(r&&jt.b.isDolby(a)||n&&jt.b.isHEVC(a))&&i.push(e);break;case"HLG":a&&o&&-1!==a.indexOf("hvc1")&&i.push(e);break;default:s.push(e)}}),{hdrLevels:i,sdrLevels:s}})(e,t);if(0===s.length&&0===r.length||ci(s)&&ci(r)){let e={type:a.c.MEDIA_ERROR,details:a.a.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR,fatal:!0,reason:"level with compatible VIDEO-RANGE not found in manifest",response:a.b.IncompatibleAsset};return Promise.reject(new a.d("level with compatible VIDEO-RANGE not found in manifest",e))}return Promise.resolve({hdrLevels:s,sdrLevels:r})})}function fi(e,t,i){return e&&t.length>0?t:i}!(function(e){e.HDR10="smpteSt2086",e.DoVi="smpteSt2094-10",e.HDR10Plus="smpteSt2094-40"})(Zt||(Zt={}));class gi{constructor(e,t,i){this.levelManager=e,this.loadFn=t,this.abortFn=i}destroy(){this.stop()}loadLevel(e,t=!0,i=0){let s=this.levelManager.getVariantInfo(e);if(!s)return void c.b.warn(`level ${e} invalid`)();let a=s.details;(!a||a.live&&gi.needToRefreshLevel(a))&&(t&&(this._levelLoadTimer=null),0===i?this._loadLevelInternal(s):this._levelLoadTimer=setTimeout(this._loadLevelInternal.bind(this,s),i))}_loadLevelInternal(e){e.details&&(e.details.trequest=performance.now()),this.loadFn(e)}stop(){this._levelLoadTimer=null,this.abortFn()}static getLiveRefreshInterval(e){return 1e3*(e.averagetargetduration?e.averagetargetduration:e.targetduration)}static needToRefreshLevel(e){let t=gi.getLiveRefreshInterval(e),i=performance.now()-e.trequest;return e.live&&i>=t}handleLevelLoad(e,t,i,s=0){let r=this.levelManager.getVariantInfo(e),n=r.details,o={success:!0,error:null};if(t.live){let l=gi.getLiveRefreshInterval(t);!t.isInitialMediaPlaylist&&n&&t.endSN===n.endSN?(l/=2,l=Math.max(l,5e3),r.unchangedLevelCount++,c.b.info(`level ${e} unchangedLevelCount ${r.unchangedLevelCount}`)()):(r.unchangedLevelCount=0,r.loadError=0),r.unchangedLevelCount>=2?(o.success=!1,o.error=a.b.LivePlaylistUpdateError,this._levelLoadTimer=null):(l-=performance.now()-i.trequest,l+=s,c.b.info(`reloadInterval: ${l}`)(),l=Math.max(1e3,Math.round(l)),c.b.info(`level ${e} reload in ${l} ms`)(),this._levelLoadTimer=setTimeout(this.loadLevel.bind(this,e),l))}else this._levelLoadTimer=null,r.loadError=0;return o}set _levelLoadTimer(e){this._levelLoadTimerInternal&&clearTimeout(this._levelLoadTimerInternal),this._levelLoadTimerInternal=e}get _levelLoadTimer(){return this._levelLoadTimerInternal}}var mi=gi,pi=class extends P{constructor(e,...t){super(e,...t),this.hls=e}_handleMediaPlaylistNetworkError(e,t){let i,a,r,n=e.response,o=e.details,l=n?n.code:n,d=isNaN(e.context.id)?e.context.level:e.context.id;i=this.hls.networkErrorHandler.getActionForPlaylistNetworkError(n,o,this),this.logger.warn(`variant ${d} encountered error ${l} errorAction ${i.errorAction}`)(),a=this.hls.playlistLoader.retryPlaylistRequest.bind(this.hls.playlistLoader,e),(r=this.hls.networkErrorHandler.handleNetworkError(i.errorAction,i.errorActionFlags,e,d,a,this.variantManager,this)).retryPromise instanceof Promise?r.retryPromise.then(e=>{this.hls.trigger(t,e)}).catch(e=>{this._handleMediaPlaylistError(e)}):i.errorAction===Et.RetryRequest&&(e.fatal=!0),e.fatal&&!this.hls.bufferEndPromiseWrapper&&this.hls.bufferDryPromise.then(()=>{this.hls.trigger(s.a.ERROR,e)}).catch(e=>{this.logger.error("get an error in buffer dry promise")()})}};const yi={minValidBitrate:2e6,maxValidBitrate:5e6,maxPreferredBitrate:3e6,minValidHeight:480,maxValidHeight:720};function vi(e){return JSON.stringify(e,["bitrate","bandwidth","avg-bandwidth","width","height","videoCodec","audioCodec","videoRange","iframes","frameRate"])}var Ti=class extends pi{constructor(e){super(e,s.a.MANIFEST_LOADING,s.a.MANIFEST_LOADED,s.a.LEVEL_LOADED,s.a.LEVEL_PTS_UPDATED,s.a.LEVEL_UPDATED,s.a.FRAG_LOADED,s.a.PREFERRED_HOST_CHANGED),this._manualLevel=-1,this._loadediframeLevelIds=[],this._lastPreloadIFrameLevelId=void 0;let t=this.hls.playlistLoader;this.variantManager=new Lt(e,Qe.VIDEO),this.levelLoader=new mi(this.variantManager,this._loadLevelInternal.bind(this),t.abort.bind(t,"level")),this.dynamicRangeListener=this.onDynamicRangeQueryChange.bind(this)}destroy(){this.reset(),this._manualLevel=-1,this.levelLoader.destroy(),this.variantManager.destroy(),super.destroy()}reset(){this.stopLoad(),this.stopDynamicRangeQuery(),this.variantManager.reset(),this._loadediframeLevelIds=[],this._lastPreloadIFrameLevelId=null}cleanupLevels(){let e=this.validLevels;this.levelRetryCount=0,e&&e.forEach(e=>{e.loadError=0;const t=e.details;t&&t.live&&(e.unchangedLevelCount=0,mi.needToRefreshLevel(t)&&0!==this.hls.desiredRate&&(e.details=void 0))})}startLoad(){this.cleanupLevels()}stopLoad(){this.levelLoader.stop(),this.cleanupLevels()}isSameLevel(e,t){return void 0===e==(void 0===t)&&e.persistentId===t.persistentId}onManifestLoading(){this.reset()}get displaySupportsHdr(){return this.startDynamicRangeQuery(),!this.dynamicRangeQuery||this.dynamicRangeQuery.matches}startDynamicRangeQuery(){if(!this.dynamicRangeQuery&&window.matchMedia){let e=window.matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");e.media!==t.media&&(this.dynamicRangeQuery=e,this.dynamicRangeQuery.addListener(this.dynamicRangeListener))}}stopDynamicRangeQuery(){this.dynamicRangeQuery&&(this.dynamicRangeQuery.removeListener(this.dynamicRangeListener),this.dynamicRangeQuery=null)}onDynamicRangeQueryChange(e){if(!this.hdrLevels||0===this.hdrLevels.length)return void this.logger.info("Not switching: no HDR levels")();let t=e.matches;this.logger.info(`HDR display support changed = ${t}`)();let i=fi(t,this.hdrLevels,this.sdrLevels);this.setVariantList(i,!0)}setVariantList(e,t){this.stopLoad(),this.startLoad();let i=this.filterAndChooseFirstLevel(e,this.hls.platformInfo);if(!i)throw Error("No valid first level");let a=i.firstLevelInfo;if(this.hls.preferredHostName=d.getHostName(a.url),this.hls.nextAutoLevel=this._firstLevel=a.persistentId,this.logger.info(`First level ${a.persistentId}: ${vi(a)}`)(),this.variantManager.variantList=i.levelList,t){let e={requiresReset:!0};this.hls.trigger(s.a.LEVELS_CHANGED,e)}return i}onManifestLoaded(e){const t=this.hls,i=/chrome|firefox/.test(navigator.userAgent.toLowerCase());let r=[],n=e.audioTracks,o=e.audioMediaSelectionGroup,l=!1,h=!1,c=!1,u=t.platformInfo,f=Math.pow(10,Math.ceil(Math.log(e.levels.length)/Math.log(10)));for(let s=0;s<e.levels.length;++s){let a=e.levels[s];l=l||Boolean(a.videoCodec),i&&a.audioCodec&&-1!==a.audioCodec.indexOf("mp4a.40.34")&&(a.audioCodec=void 0),t.addCDNToWhiteList(d.getHostName(a.url)),h=h||Boolean(a.audioCodec)||Boolean(a.audioGroupId),c=c||a.iframes,a.loadError=0,a.persistentId=(a.bitrate||0)+s/f,r.push(a)}this.hasIframeLevels=c,l&&h&&(r=r.filter(({videoCodec:e})=>Boolean(e))),this.logger.info(`playlist has, ${r.length} levels, ${vi(r)}`)(),ui(r,n,u,this.hls.config.useMediaCapabilities).then(i=>{({hdrLevels:this.hdrLevels,sdrLevels:this.sdrLevels}=i);let a=fi(this.displaySupportsHdr,this.hdrLevels,this.sdrLevels),r=this.setVariantList(a,!1);this.logger.info(`[QE Critical] manifest loaded, ${a.length} valid levels found, levels ${vi(a)}`)(),this.logger.info(`valid levels: hdr=${this.hdrLevels.length} sdr=${this.sdrLevels.length}`)();let d=r.audioGroups,c=new Array,u=new Set,f=!1;n.forEach(e=>{d.has(e.groupId)&&(e.id=c.length,u.add(e.persistentID),c.push(e),f||(f=!!e.url))}),n=c,this.hls.audioTrackController.variantManager.variantList=n;let g=o?o.MediaSelectionGroupOptions:void 0;if(g){let e=new Array;g.forEach(t=>{u.has(t.MediaSelectionOptionsPersistentID)&&e.push(t)}),o.MediaSelectionGroupOptions=e}if(t.trigger(s.a.MANIFEST_PARSED,{levels:a,firstLevel:this._firstLevel,stats:e.stats,audio:h,video:l,altAudio:f,audioTracks:n,audioMediaSelectionGroup:o}),e.stats.tparsed=performance.now(),e.isMediaPlaylist){let i=a[0].details,r=t.playlistType,n={level:a[0].persistentId,details:i,playlistType:r,id:a[0].persistentId,stats:e.stats,livePlaylistUpdateError:!1};t.trigger(s.a.LEVEL_LOADED,n)}}).catch(e=>{let i;this.logger.error(`onManifestLoaded error:${e.message}`)(),i=e instanceof a.d?Object.assign(Object.assign({},e.payload),{url:t.url}):{type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!0,url:t.url,reason:e.message,response:a.b.InternalError},t.trigger(s.a.ERROR,i)})}get validLevels(){return this.variantManager.validVariantList}get penaltyLevels(){return this.variantManager.penaltyVariantQueue}get level(){return this._levelInfo?this._levelInfo.persistentId:void 0}get currentVariantId(){return this.level}get levelInfo(){return this._levelInfo}_isSwitchUp(e,t){let i=!1;return e&&t&&(i=e.bitrate<t.bitrate&&e.iframes===t.iframes),i}addToLoadedLevels(e){this._loadediframeLevelIds.push(e),this._loadediframeLevelIds.sort((function(e,t){return t-e}))}preloadiFrameLevelPlaylists(){if(this.hls.playlistLoader.isLoadingLevel(this._lastPreloadIFrameLevelId))return;let e=this.hls.abrController.findNextABRAutoLevelInMode(!0),t=this.getLevelWithPersistentId(e).levelInfo;return t?(void 0===t.details&&(this.logger.info(`[iframes] preloading iframe playlist for level: ${e}`)(),this._lastPreloadIFrameLevelId=e,this.levelLoader.loadLevel(e,!1)),e):void 0}doesLevelMatchIframeMode(e){return e&&e.iframes===this.hls.iframeMode}getLevelWithPersistentId(e){let t,i;return isNaN(e)||e<0?this.logger.warn(`invalid levelID ${e}`)():(t=this.variantManager.getVariantInfo(e),i=this.variantManager.getVariantListPosition(e)),{levelInfo:t,levelListPosition:i}}getPenaltyLevelWithPersistentId(e){let t;return(t=this.penaltyLevels.find((function(t){return t.levelInfo.persistentId===e})))?t.levelInfo:void 0}haveFallbackVariant(){let e=this;return this.validLevels.filter((function(t){return e.doesLevelMatchIframeMode(t)})).length>1}isCurrentLevelNonSDR(){return this._levelInfo.videoRange&&"SDR"!==this._levelInfo.videoRange}lowestBitrateLevel(e){let t=this,i=e.find((function(e){return t.doesLevelMatchIframeMode(e)}));return void 0!==i?i.persistentId:void 0}set level(e){const t=this.hls;if(!this.validLevels)return;let i=this.getLevelWithPersistentId(e).levelInfo;i&&this.doesLevelMatchIframeMode(i)?this.setLevelInternal(i):t.trigger(s.a.ERROR,{type:a.c.OTHER_ERROR,details:a.a.LEVEL_SWITCH_ERROR,level:e,fatal:!1,reason:"invalid level idx, or level doesnt match iframe mode",response:a.b.CantSwitchInTime})}setLevelInternal(e){const t=this.hls;let i=!1;if(!1===this.isSameLevel(this._levelInfo,e)){let a=void 0!==this._levelInfo?this._levelInfo.persistentId:this._levelInfo,r=void 0!==this._levelInfo?this._levelInfo.bitrate:this._levelInfo;this.logger.info(`switching from ${a}:${r} to level ${e.persistentId}:${e.bitrate}`)(),i=this._isSwitchUp(this._levelInfo,e),this._levelInfo=e,t.trigger(s.a.LEVEL_SWITCH,e),t.trigger(s.a.LEVEL_SWITCHING,e)}this.levelLoader.loadLevel(e.persistentId),i&&(this.logger.info(`Switched to a new level: ${e.persistentId} attemptSafeNextLevelSwitch`)(),this.hls.streamController.attemptSafeNextLevelSwitch())}_loadLevelInternal(e){this.hls.playlistLoader.loadLevel(e.url,e.persistentId).then(function(e){this.hls.trigger(s.a.LEVEL_LOADED,e)}.bind(this)).catch(function(e){this._handleMediaPlaylistError(e)}.bind(this))}get manualLevel(){return this._manualLevel}set manualLevel(e){this._manualLevel=e,void 0!==this._startLevel||this.hls.iframeMode||-1===e||(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){let e=this.hls.config.startLevel;return void 0!==e?e:this._firstLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onFragLoaded(e){const t=e.frag;if(t&&"main"===t.type){const e=this.getLevelWithPersistentId(t.level).levelInfo;e&&(e.loadError=0)}}_startedLoadingLevels(){return void 0!==this._levelInfo}_shouldAttemptLivePlaylistRefresh(){return this._startedLoadingLevels()&&this.hls.isLive&&0!==this.hls.desiredRate}_checkIfLevelExpired(e){let t=this.getLevelWithPersistentId(e).levelInfo,i=this.hls.media;if(!(t&&t.details&&i&&i.readyState))return;let s=t.details;if(0===s.fragments.length)return void this.logger.error(`No fragments for ${e}`)();let r=s.fragments[0].start,n=r+s.totalduration;s.live&&s.PTSKnown&&n<i.currentTime&&(this.logger.error(`level ${e} behind currentTime=${i.currentTime} range:${r.toFixed(3)}-${n.toFixed(3)}`)(),this._handleMediaPlaylistError({type:a.c.NETWORK_ERROR,details:a.a.LEVEL_LOAD_ERROR,fatal:!1,url:this.hls.url,context:{type:"level",level:e,id:void 0},response:a.b.LivePlaylistUpdateError}))}onLevelUpdated(e){this._checkIfLevelExpired(e.level)}onLevelPtsUpdated(e){this._checkIfLevelExpired(e.level)}onLevelLoaded(e){const t=e.level;let i=this.hls.levelWithPersistentId(t).levelInfo,s=e.details;if(void 0!==i&&i.iframes&&this.addToLoadedLevels(i.persistentId),!this._startedLoadingLevels()&&s.isInitialMediaPlaylist||t===this._levelInfo.persistentId){let i=this.hls.isLive?this.hls.streamController.getLivePlaylistRefreshDelay(s):0,r=this.levelLoader.handleLevelLoad(t,s,e.stats,i);if(r.success)this.levelRetryCount=0;else switch(r.error){case a.b.LivePlaylistUpdateError:e.livePlaylistUpdateError=!0,this._handleMediaPlaylistError({type:a.c.NETWORK_ERROR,details:a.a.LEVEL_LOAD_ERROR,fatal:!1,url:this.hls.url,context:{type:"level",level:e.level,id:e.id},response:a.b.LivePlaylistUpdateError})}}}get nextLoadLevel(){if(-1!==this._manualLevel)return this._manualLevel;if(this.hls.iframeMode&&this._loadediframeLevelIds.length>0){let e=this.hls.nextAutoLevel,t=this._loadediframeLevelIds.find((function(t){return t<=e}));return void 0!==t?t:e}return this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this._manualLevel&&(this.hls.nextAutoLevel=e)}getLowerAutoLevel(e){let t;for(let i=e-1;i>=0;i--)if(this.doesLevelMatchIframeMode(this.validLevels[i])){t=this.validLevels[i].persistentId;break}return t}setNextAutoVariant(e){this.hls.nextAutoLevel=e}getNextBestAutoVariant(e){let t=this.variantManager.getVariantListPosition(e),i=this.getLowerAutoLevel(t);if("number"!=typeof i)for(let e=t+1;e<this.validLevels.length;++e)if(this.doesLevelMatchIframeMode(this.validLevels[e])){i=this.validLevels[e].persistentId;break}return i}onPreferredHostChanged(e){if(e===Qe.VIDEO||isNaN(this.level))return;let t,i=this.variantManager.getVariantInfo(this.level);(t=this.variantManager.validVariantList.find(e=>e.bandwidth===i.bandwidth&&e.url.includes(this.hls.preferredHostName)))&&(this.logger.warn(`preemptively switching video host to ${this.hls.preferredHostName}`)(),this.level=t.persistentId)}_handleMediaPlaylistError(e){super._handleMediaPlaylistNetworkError(e,s.a.LEVEL_LOADED),this.hls.streamController.resetNextLoadPositionState()}handleError(e){if(e.frag&&"main"!==e.frag.type)return;let t,i;switch(e.details){case a.a.FRAG_LOOP_LOADING_ERROR:t=[e.frag&&!isNaN(e.frag.level)?e.frag.level:this._levelInfo.persistentId],i=Dt.FRAG_LOAD_ERROR;break;case a.a.FRAG_PARSING_ERROR:t=[e.frag&&!isNaN(e.frag.level)?e.frag.level:this._levelInfo.persistentId],i=Dt.MEDIA_ERROR;break;case a.a.KEY_SYSTEM_GENERIC_ERROR:case a.a.KEY_LOAD_ERROR:case a.a.KEY_LOAD_TIMEOUT:{let s=!1,a=this._levelInfo.persistentId;t=[],e.levelIds.forEach((function(e){e===a?s=!0:t.push(e)})),s?t.push(a):this.logger.warn(`Other levels got key error keyuri=${this.hls.redactUrl(e.decryptdata.uri)} levelIds=${JSON.stringify(t)}`)(),i=Dt.KEY_LOAD;break}case a.a.REMUX_ALLOC_ERROR:t=[e.level]}t&&t.forEach((function(t){let s=this.getLevelWithPersistentId(t),a=s.levelInfo;a?(a.loadError++,this.hls.networkErrorHandler.handleError(e,a,t,s.levelListPosition,i,this.variantManager,this)):this.logger.warn(`${t} not valid, skip`)()}),this)}filterAndChooseFirstLevel(e,t){let i=this.hls.config.targetStartupMs-(performance.now()-this.hls.tloadsource);return this.hls.hasPlaybackEverStarted&&i<0&&(i=this.hls.config.targetStartupMs),(function(e,t,i,s,a){if(!e||0===e.length||ci(e))return void c.b.warn("no non-iframe level found in levels")();let r;if(s&&((r=(function(e,t,i,s){return ri(e=e.filter(e=>(function(e,t,i){const{targetDuration:s,targetStartupMs:a}=i;return e.bandwidth<=t.avgBandwidth&&(e.avgBandwidth||e.bandwidth)*s/t.avgBandwidth*1e3+t.avgLatencyMs<=a})(e,i,s)),e=>ai(e,Object.assign(Object.assign({},t),s.metricsOverride)))})(e,t,s,a))||c.b.warn("no valid first level found when choosing with bandwidth history, falling back to the old selection method")()),!r&&!(r=ri(e,e=>ai(e,t))))return void c.b.warn("no valid first level found in levels")();const{levels:n,audioGroups:o}=(function(e,t){let i=new Set;return{levels:e=e.filter((function(e){let s=(function(e,t){let i=!0;e.videoCodec&&t.videoCodec&&(i=jt.b.isCompatibleVideoCodec(e.videoCodec,t.videoCodec));let s=!0;return e.audioCodec&&t.audioCodec&&(s=jt.b.isCompatibleAudioCodec(e.audioCodec,t.audioCodec)),s&&i})(t,e);if(s){let t=e.audioGroupId;t&&i.add(t)}return s})),audioGroups:i}})(e,r);return{levelList:e=(function(e){return e?e.sort((function(e,t){return e.bitrate-t.bitrate})):void 0})(e=(function(e){return e.filter(e=>!e.iframes||!e.width||!e.height||e.width*e.height<=2488320)})(e=n)),firstLevelInfo:r,audioGroups:o}})(e,yi,0,this.hls.config.enableAdaptiveStartup?this.hls.bandwidthHistoryController.getEstimate():void 0,this.hls.config.enableAdaptiveStartup?{targetDuration:this.hls.config.defaultTargetDuration,targetStartupMs:i,metricsOverride:this.hls.config.adaptiveStartupMetricsOverride}:void 0)}resetAndLoadSDRLevels(){try{this.logger.info("Falling back to SDR")(),this.hdrLevels=[],this.setVariantList(this.sdrLevels,!0)}catch(e){return!1}return!0}_isHostReachable(){return!0}attemptToRetryRequest(e,t,i,s,a){let r,n=i.tfirstissue;performance.now()-n>=(this._isHostReachable()?3e4:12e4)?(this.haveFallbackVariant()||this._levelInfo.persistentId!==t||(s=Et.SendEndCallback),r=this.hls.networkErrorHandler.handleNetworkError(s,0,e,t,void 0,this.variantManager,this)):a()}abortiFrameFragRequest(e){this.hls.streamController.abortiFrameFragRequest(e)}},Si=class extends P{constructor(e){super(e,s.a.MEDIA_ATTACHED,s.a.MEDIA_DETACHING,s.a.FRAG_PARSING_METADATA),this.id3Track=void 0,this.media=void 0}destroy(){P.prototype.destroy.call(this)}onMediaAttached(e){this.media=e.media,this.media&&(this.id3Track=this.media.addTextTrack("metadata","id3"),this.id3Track.mode="hidden")}onMediaDetaching(){this.media=void 0}onFragParsingMetadata(e){const t=e.frag,i=e.samples;if(!this.hls.config.enableID3Cues)return;let s=window.WebKitDataCue||window.VTTCue||window.TextTrackCue,a=t.endPTS?t.endPTS:t.duration+t.start;for(let e=0;e<i.length;e++){let t=i[e].pts,r=e<i.length-1?i[e+1].pts:a;t===r&&(r+=1e-4),i[e].frames&&i[e].frames.forEach(e=>{if(e&&!this.shouldIgnore(e)){let i=new s(t,r,"");i.value=e,this.id3Track.addCue(i)}})}}shouldIgnore(e){return"PRIV"===e.key&&("com.apple.streaming.transportStreamTimestamp"===e.info||"com.apple.streaming.audioDescription"===e.info)}};function bi(e){return(t,i)=>{let s=0,a=0;for(const{timestamp:r,value:n,duration:o}of t){const t=Math.pow(Math.max(0,r-i)/1e3,e);s+=t*n,a+=t*o}return s/a}}const _i={"uniform-time-weighted":bi(0),"linear-time-weighted":bi(1),"quadratic-time-weighted":bi(2)};class Ei{constructor(e,t=(()=>{})){this.windowSize=e,this.cleanupCallback=t,this.latencyEntries=[],this.bandwidthEntries=[],this.minEntries=2,this.cleanUpExpiredEntries=this.cleanUpExpiredEntries.bind(this)}record(e){const{trequest:t,tfirst:i,tload:s,bitsDownloaded:a}=e;this.recordLatency(t,i),this.recordBandwidth(t,s,a)}getEstimate(e="quadratic-time-weighted"){if(this.latencyEntries.length<this.minEntries)return;const t=performance.now()-this.windowSize,i=_i[e],s=this.latencyEntries.map(({start:e,end:t})=>({timestamp:t,value:t-e,duration:1})),a=(function(e,t){const i=[...e].sort((e,t)=>e.start-t.start),s=[];for(const e of i)0===s.length||s[s.length-1].end<=e.start?s.push(e):s[s.length-1]=t(s[s.length-1],e);return s})(this.bandwidthEntries,(e,t)=>({start:e.start,end:Math.max(e.end,t.end),bitsDownloaded:e.bitsDownloaded+t.bitsDownloaded})).map(({start:e,end:t,bitsDownloaded:i})=>({timestamp:t,duration:(t-e)/1e3,value:i}));return{avgLatencyMs:i(s,t),avgBandwidth:i(a,t)}}recordLatency(e,t){this.latencyEntries.push({start:e,end:t}),this.updateCleanupTimeout(t)}recordBandwidth(e,t,i){this.bandwidthEntries.push({start:e,end:t,bitsDownloaded:i}),this.updateCleanupTimeout(t)}setCleanupTimeout(e){this.cleanupTimeout=setTimeout(this.cleanUpExpiredEntries,Math.max(e-performance.now(),0)),this.cleanupTimestamp=e}clearCleanupTimeout(){void 0!==this.cleanupTimeout&&(clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0),this.cleanupTimestamp=void 0}updateCleanupTimeout(e){const t=e+this.windowSize;(!this.cleanupTimestamp||t<this.cleanupTimestamp)&&(this.clearCleanupTimeout(),this.setCleanupTimeout(t))}cleanUpExpiredEntries(){this.clearCleanupTimeout();const e=performance.now()-this.windowSize;this.latencyEntries=this.latencyEntries.filter(t=>t.end>=e),this.bandwidthEntries=this.bandwidthEntries.filter(t=>t.end>=e),this.cleanupCallback();const t=Math.min(...this.latencyEntries.map(e=>e.end),...this.bandwidthEntries.map(e=>e.end));this.updateCleanupTimeout(t)}destroy(){this.clearCleanupTimeout()}}class Ri extends P{constructor(e){super(e,s.a.MEDIA_DETACHED),this.bwEstimator=new Ei(e.config.bandwidthHistoryWindowSize,()=>this.getAndCacheBandwidthEstimate()),this.ttl=e.config.bandwidthHistoryTTL,this.persistBandwidthEstimate=this.persistBandwidthEstimate.bind(this),"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("beforeunload",this.persistBandwidthEstimate),this.onMediaDetached=this.persistBandwidthEstimate,this.storage=e.config.storage,this.storageKey=e.config.bandwidthHistoryStorageKey}getAndCacheBandwidthEstimate(){const e=this.bwEstimator.getEstimate(this.hls.config.bandwidthHistoryAggregationMethod);return e&&(this.aggregatedAt=performance.now(),this.cachedBandwidthEstimate=e),e}sample({trequest:e,tfirst:t,tload:i,loaded:s}){this.bwEstimator.record({trequest:e,tfirst:t,tload:i,bitsDownloaded:8*s}),this.getAndCacheBandwidthEstimate()}getEstimate(){if(performance.now()-this.aggregatedAt<=this.hls.config.bandwidthHistoryGetEstimateThrottleMs)return this.cachedBandwidthEstimate;const e=this.getAndCacheBandwidthEstimate();if(e)return e;try{const t=JSON.parse(this.storage.get(this.storageKey));if(t.expires&&t.expires>=Date.now())return t}catch(e){this.logger.warn(`Unable to get persisted bandwidth history, returning undefined: ${e.message}`)()}}persistBandwidthEstimate(){if(void 0===this.storage.set)return void this.logger.warn("`storage.set` is not supported! Not persisting bandwidth estimate")();const e=this.getAndCacheBandwidthEstimate();e&&this.storage.set(this.storageKey,JSON.stringify(Object.assign({},e,{expires:Date.now()+this.ttl})))}destroy(){"undefined"!=typeof window&&"function"==typeof window.removeEventListener&&window.removeEventListener("beforeunload",this.persistBandwidthEstimate),this.bwEstimator.destroy(),super.destroy()}}var Di,Li=class extends P{constructor(e){super(e,s.a.MEDIA_ATTACHING,s.a.MEDIA_DETACHING,s.a.MANIFEST_LOADING,s.a.MANIFEST_LOADED,s.a.MANIFEST_PARSED,s.a.LEVEL_LOADED,s.a.FRAG_LOADING,s.a.FRAG_LOADED,s.a.FRAG_BUFFERED,s.a.KEY_LOADED,s.a.LEVEL_SWITCHED,s.a.KEY_REQUEST_STARTED,s.a.ERROR),this.enablePerformanceLogging=this.hls.config.enablePerformanceLogging,this.enableRtcReporting=this.hls.config.enableRtcReporting,this.media=null}destroy(){this._removeMediaEventListeners(this.media),P.prototype.destroy.call(this)}get accessLog(){let e=this.rtc;return e?e.accessLog:[]}get errorLog(){let e=this.rtc;return e?e.errorLog:[]}setAppData(e){this.appData=e}setRate(e){this.desiredRate=e,this._logAndReport("Set desired rate to: "+e,F.desiredratechange,{rate:e})}onMediaAttaching(e){this.media=e.media,this._addMediaEventListeners(this.media),this.rtc&&this.rtc.setMedia(this.media)}onMediaDetaching(){let e=this.frag?this.frag.level:void 0;this._logAndReport(`Variant end for level: ${e}`,F.variantend),this._logAndReport(null,F.desiredratechange,{rate:0}),this._logAndReport("[QE Critical] Play ended",F.ended),this._removeMediaEventListeners(this.media),clearInterval(this.timer),this.rtc&&(this.rtc.destroy(),this.rtc=null)}onFragLoading(){this._logAndReport(null,F.fragloading)}onFragLoaded(e){if(e&&e.frag){let t={fragType:e.frag.type,adt:e.stats.tload-e.stats.trequest,processTime:e.stats.tdataack-e.stats.tload,bytes:e.stats.total,duration:e.frag.duration||0,startPTS:e.frag.start,endPTS:e.frag.start+e.frag.duration,contentType:e.stats.contentType,cdnServer:e.stats.cdnServer};this._logAndReport(null,F.fragloaded,t)}}onFragBuffered(e){if(e&&e.frag){let t=e.stats,i={fragType:e.frag.type,adt:t.tload-t.trequest,processTime:t.tdataack-t.tload,parseTime:t.tparsed-t.tdataack,bytes:t.total};this._logAndReport(null,F.fragbuffered,i)}}onKeyLoaded(e){"AES-128"===e.decryptdata.method&&this._logAndReport(null,F.segmentkeyloaded,{adt:e.stats.tload-e.stats.trequest,timestamp:e.timestamp})}onKeyRequestStarted(e){this._logAndReport(null,F.spcrequested,e)}findCurLevelInfo(e){let t=this.hls.levelWithPersistentId(e).levelInfo;return t||(t=this.hls.levelController.getPenaltyLevelWithPersistentId(e))||this.logger.warn("Level with id ${levelId} is missing from levels and penalty levels")(),t}onLevelSwitched(e){let t=this.level,i=this.level=e.level;t>=0&&this._logAndReport(`Variant end for level: ${t}`,F.variantend);let s=this.findCurLevelInfo(i);if(s){let a=JSON.stringify(s,["bitrate","bandwidth","avgBandwidth","width","height"])+JSON.stringify(s.attrs,["CODECS","FRAME-RATE"]);e.url=s.url,e.isSeeking=this.isSeeking,this._logAndReport(`[QE Critical] Playing level switch from ${t} to ${i}. ${a}`,F.levelswitched,e)}}onManifestLoading(){this.rtc&&(this.rtc.destroy(),this.rtc=null),this.hls.userInfo&&(this.enableRtcReporting=this.hls.userInfo.diagnosticsAndUsage||this.hls.userInfo.internalBuild),this.rtc=new class{constructor(e,t,i,s={}){this._logger=e.logger,this._intervalTimeout=i.rtcIntervalTimeout,this._interval=setInterval(this._handlePeriodic.bind(this),this._intervalTimeout),this._state=te,this._sessStartTime=this._stateStartTime=this._intervalStartTime=Date.now(),this._variantStartTime=0,this._minSwitchWindow=1e4,this._sessionData={},this._intervalData={},this._playStalledData={},this._mediaEngineStalledData={},this._keySessionCompleteData={},this._playLikelyToKeepUpData={},this._playRateChangedData={},this._playErrorData={},this._switchCompleteData={},this._variantEndData={},this._nwErrorData={},this._dimensionData={maxVideoQltyIndex:0,maxReWd:0,maxReHt:0},this._miscData={periodicEvtCnt:0,playLikelyToKeepUpEvtCnt:0,keyDataDict:{},fragmentCnt:0,sessVariantList:{},intervalVariantList:{},nonFatalMediaErrList:{},nonFatalNwErrList:{},playlistMimeTypes:new Set,segmentMimeTypes:new Set,decodedFramesForVariant:0,decodedFramesForVariantSampleCount:0,intervalSegmentBytes:0,intervalSegmentAdt:0,intervalSegmentProcessTime:0,sessSegmentBytes:0,sessSegmentAdt:0,sessSegmentProcessTime:0,sessVideoBytes:0,sessVideoDuration:0,sessAudioBytes:0,sessAudioDuration:0,intervalVideoBytes:0,intervalVideoDuration:0,intervalAudioBytes:0,intervalAudioDuration:0},t?s.reportingAgent&&(this.reportingAgent=s.reportingAgent,this._logger.info(`[QE Critical] [RTCA] - Reporting session started, SessionID: ${this.reportingAgent.SessionID}`)()):this._logger.info("[RTCA] - Reporting is disabled")(),this._eventEmitter=e.media,this._accessLogReporter={SessionID:e.sessionID,ServiceName:s.serviceName,ClientName:s.appName},this._accessLogData=this.createAccessLogEntry(),this._accesslog=[],this._errorlog=[]}destroy(){clearInterval(this._interval),this._accesslog=[],this._errorlog=[],this._accessLogData=void 0,this._accessLogReporter=void 0,this.reportingAgent=null,this._eventEmitter=void 0}setMedia(e){!e&&this._interval&&clearInterval(this._interval),this.media=e}updateSvrAddrStats(e){let t=h.parseURL(e);if(t&&t.netLoc){let e=t.netLoc.indexOf(":"),i=e>=0?t.netLoc.slice(0,e):t.netLoc;i.startsWith("//")&&(i=i.slice(2)),this._accessLogData.svrAddr?i!==this._accessLogData.svrAddr&&this._accessLogData.svrAddrChanged++:this._accessLogData.svrAddrChanged=0,this._accessLogData.svrAddr=i}}convertStringObjectToPrimitive(e){return e?"object"==typeof e?e.toString():e:""}createAccessLogEntry(){return{fragmentCnt:0,overdue:0,startPTS:0,obrMax:0,obrMin:0,audioBytes:0,audioDuration:0,videoBytes:0,videoDuration:0,svrAddrChanged:0,svrAddr:"",PlayTimeWC:0,ViFrDr:0,StallCount:0,MediaEngineStallCount:0,ADT:0,NetBytes:0,StartupTime:0,OBRMean:0,OBRLast:0}}translateToAccessLogItem(e,t,i){let s,a=this.convertStringObjectToPrimitive(e);this.updateSvrAddrStats(a),(s=this._switchCompleteData.MediaDur?this._switchCompleteData.MediaDur:this._getBufferedDuration())||(s=0);let r={uri:a,"s-ip":this._accessLogData.svrAddr,"s-ip-changes":this._accessLogData.svrAddrChanged,"sc-wwan-count":-1,"c-transfer-duration":this._accessLogData.ADT,bytes:this._accessLogData.NetBytes,"c-total-media-requests":this._accessLogData.fragmentCnt,"cs-guid":this._accessLogReporter.SessionID,"c-start-time":this._accessLogData.startPTS,"c-startup-time":this._accessLogData.StartupTime,"c-duration-watched":this._accessLogData.PlayTimeWC/1e3,"c-frames-dropped":this._accessLogData.ViFrDr,"c-stalls":this._accessLogData.StallCount,"c-duration-downloaded":this._accessLogData.lastMediaDur?s-this._accessLogData.lastMediaDur:s,"c-overdue":this._accessLogData.overdue,"c-avg-video-bitrate":8*this._accessLogData.videoBytes/(this._accessLogData.videoDuration||1),"c-observed-max-bitrate":this._accessLogData.obrMax,"c-observed-min-bitrate":this._accessLogData.obrMin,"sc-indicated-bitrate":t.bandwidth?t.bandwidth:0,"sc-indicated-avg-bitrate":t.avgBandwidth?t.avgBandwidth:0,"c-observed-bitrate":this._accessLogData.OBRMean,"c-switch-bitrate":this._accessLogData.OBRLast,"c-provisional-entry":!1};return i.playlistType&&(r["s-playback-type"]=i.playlistType),this._accessLogData.audioBytes&&(r["c-avg-audio-bitrate"]=8*this._accessLogData.audioBytes/(this._accessLogData.audioDuration||1)),r}translateToErrorLogItem(e,t){let i=this.convertStringObjectToPrimitive(e);return this.updateSvrAddrStats(i),{date:new Date,"cs-guid":this._accessLogReporter.SessionID,uri:i,"s-ip":this._accessLogData.svrAddr,status:t.ErrCode,domain:t.ErrDomain}}addToAccessLog(e,t,i){if(!e||""===e)return;let s=this.translateToAccessLogItem(e,t,i);if(s){let e=this._accesslog.length-20;e>0&&this._accesslog.splice(0,e),this._accesslog.push(s)}this._accessLogData=this.createAccessLogEntry(),this._accessLogData.lastMediaDur=this._switchCompleteData.MediaDur?this._switchCompleteData.MediaDur:this._getBufferedDuration()}addToErrorLog(e,t){let i=this.translateToErrorLogItem(e,t);if(i){let e=this._errorlog.length-20;e>0&&this._errorlog.splice(0,e),this._errorlog.push(i)}}get accessLog(){let e=this._accesslog.slice(0);if(e){let t=this._miscData.curLevelUrl;if(t&&""!==t){let i=this._getVariantInfo(t),s=this.translateToAccessLogItem(t,i,this._miscData);s&&(s["c-provisional-entry"]=!0,e.push(s))}}return e}get errorLog(){return this._errorlog}notify(e,t){if(this._state!==ne||e===F.ended)switch(e){case F.canplay:this._handleCanPlay();break;case F.desiredratechange:this._handleDesiredRateChange(t);break;case F.pause:case F.playing:this._handleRateChange();break;case F.ended:this._handlePlayEnded();break;case F.bufferstalled:this._handleBufferStalled();break;case F.mediaenginestalled:this._handleMediaEngineStalled();break;case F.mediaerror:this._handleMediaError(t);break;case F.variantend:this._handleVariantEnd();break;case F.levelloaded:this._handleLevelLoaded(t);break;case F.levelswitched:case F.levelloaderror:this._handleLevelSwitched(t);break;case F.nwerror:this._handleNwError(t);break;case F.playbackinfo:this._handlePlaybackInfo(t);break;case F.manifestparsed:case F.manifestloaded:case F.fragloading:case F.fragloaded:case F.fragbuffered:this._aggregateStats(e,t);break;case F.segmentkeyloaded:case F.spcrequested:case F.spcreceived:case F.spcsubmitted:case F.spccreated:case F.ckcrequested:case F.ckcreceived:case F.ckcsubmitted:case F.ckcprocessed:case F.keyaborted:case F.ckcerror:case F.spcerror:this._handleKeySessionEvents(e,t)}}_handleCanPlay(){if(!this._isLikelyToKeepUp){const e=Date.now();this._state===te&&this._setValue([this._intervalData,this._sessionData],"InitTime",e-this._sessStartTime),this._miscData.lastLikelyToKeepUpTime=e,this._setValue([this._playLikelyToKeepUpData,this._playRateChangedData,this._accessLogData],"StartupTime",e-this._stateStartTime),this._sendPlayLikelyToKeepUpEvent(),this._isLikelyToKeepUp=!0}}_handleDesiredRateChange(e){this._desiredRate=e.rate}_handleRateChange(){(this._rate!==this._desiredRate||0!==this._desiredRate&&this._state!==se)&&(this._rate=this._desiredRate,this._updateStateTimes(V,100*this._rate),this._sendPlayRateChangedEvent())}_handlePlayEnded(){let e=this._sessionData.NetBytes,t=this._intervalData.NetBytes;e=1e3*Math.round(e/1e3),t=1e3*Math.round(t/1e3),this._sessionData.NetBytes=e,this._intervalData.NetBytes=t,this._handlePeriodic(),this._updateStateTimes(B,void 0),this._sendSummaryEvent()}_handlePeriodic(){this._finalizeStatsForPeriodic(),this._sendPeriodicEvent()}_handleBufferStalled(){this._state===se&&(this._updateStateTimes(U,void 0),this._inc([this._sessionData,this._intervalData,this._accessLogData],"StallCount",1),this._sendPlayStalledEvent())}_handleMediaEngineStalled(){this._state===se&&(this._updateStateTimes($,void 0),this._inc([this._sessionData,this._intervalData],"MediaEngineStallCount",1),this._sendMediaEngineStalledEvent())}_handleVariantEnd(){if(this._state===se){const e=Date.now(),t=Math.min(e-this._variantStartTime,e-this._stateStartTime),i=Math.abs(t*(this._miscData.lastPlayRate/100));this._inc([this._variantEndData],"VarPlayTime",i),this._inc([this._variantEndData],"VarPlayTimeWC",t)}this._sendVariantEndEvent()}_handleLevelLoaded(e){if(!this._miscData.playlistType){this._miscData.playlistType=e.playlistType;let t=this._getVariantInfo(e.url);t&&(t.targetduration=e.targetduration)}this._miscData.playlistMimeTypes.has(e.contentType)||this._miscData.playlistMimeTypes.add(e.contentType),this._inc([this._sessionData,this._intervalData],"PlaylistADT",e.adt),this._setValue([this._playLikelyToKeepUpData],"PlaylistADT",e.adt),this._updateMaxValue([this._sessionData,this._intervalData],"MaxPlaylistDT",e.adt)}_handleKeySessionEvents(e,t){const i=t.timestamp;let s=this._miscData.keyDataDict[t.keyuri]||{};switch(e){case F.segmentkeyloaded:s.keyFormat="identity",s.keyDeliveryTime=t.adt,this._state===te&&(s.keyInitTime=i-this._sessStartTime),this._miscData.keyData=s,this._sendKeySessionCompleteEvent();break;case F.spcrequested:s.keySessionStartTime=s.SPCRequestStartTime=i,this._state===te&&(s.keyInitTime=i-this._sessStartTime),this._miscData.keyDataDict[t.keyuri]=s;break;case F.spcreceived:s.SPCRequestTime=i-s.SPCRequestStartTime;break;case F.spcsubmitted:s.keyFormat=t.keyFormat,s.SPCSubmitStartTime=i;break;case F.spccreated:s.cdmVersion=t.cdmVersion,s.SPCCreationTime=i-s.SPCSubmitStartTime;break;case F.ckcrequested:s.CKCRequestStartTime=i;break;case F.ckcreceived:s.CKCResponseTime=i-s.CKCRequestStartTime;break;case F.ckcsubmitted:s.CKCSubmitStartTime=i;break;case F.ckcprocessed:s&&(s.CKCProcessTime=i-s.CKCSubmitStartTime,s.keyDeliveryTime=i-s.keySessionStartTime,this._miscData.keyData=s,this._sendKeySessionCompleteEvent(),delete this._miscData.keyDataDict[t.keyuri]);break;case F.keyaborted:case F.ckcerror:case F.spcerror:s&&(s.isKeyError=!0,s.keyErrorType=e,this._miscData.keyData=s,this._sendKeySessionCompleteEvent(),delete this._miscData.keyDataDict[t.keyuri])}}_handleLevelSwitched(e){const t=Date.now();let i,s=!1;if(this._miscData.curLevelUrl){let t=this._getVariantInfo(this._miscData.curLevelUrl),a=this._getVariantInfo(e.url);i=a.bandwidth<t.bandwidth?"Down":"Up",s=a.iframes}if(this._inc([this._sessionData,this._intervalData],"SwCnt",1),this._miscData.isBadSw=this._isBadSw(i,s,t,this._minSwitchWindow,this._miscData,e.isSeeking),e.failedSwitchUrl)this._miscData.failedSwitchUrl=e.failedSwitchUrl;else{if(this._state===se){const e=Math.min(t-this._variantStartTime,t-this._stateStartTime),i=Math.abs(e*(this._miscData.lastPlayRate/100));this._inc([this._switchCompleteData],"PlayTimeLastSW",i);const s=Math.min(e,t-this._intervalStartTime);this._updateLevelStats(s,this._miscData.curLevelUrl)}this._miscData.lastSwitchDir=i,this._miscData.lastSwitchTime=t,this._miscData.variantStartTimeMedia=this._getCurrentMediaTimeMilliSec(),this._miscData.lastLevelIsIframe=s,this._miscData.prevLevelUrl=this._miscData.curLevelUrl,this._miscData.curLevelUrl=e.url,this._variantStartTime=t}this._sendSwitchComplete()}_handleMediaError(e){if(this._inc([this._sessionData,this._intervalData],"PlayerErrCount",1),e.fatal)this._inc([this._sessionData,this._intervalData],"FatalPlayerErrCount",1),this._miscData.playErrCode=e.details,this._miscData.playErrIsFatal=e.fatal,this._miscData.playErrCount=1,this._miscData.playErrDomain=e.type,this._updateStateTimes(G,void 0),this._sendPlayError();else{let t=this._miscData.nonFatalMediaErrList[e.details]||0;this._miscData.nonFatalMediaErrList[e.details]=t+1}}_handleNwError(e){if(this._inc([this._sessionData,this._intervalData],"NwErrCount",1),e.fatal)this._miscData.nwErrTime=Date.now(),this._inc([this._sessionData,this._intervalData],"FatalNwErrCount",1),this._miscData.nwErrCode=e.details,this._miscData.nwErrIsFatal=e.fatal,this._miscData.nwErrDomain=e.type,this._miscData.nwErrReason=e.code,this._updateStateTimes(K,void 0),this._sendNwError();else{let t=e.details+"/"+e.code,i=this._miscData.nonFatalNwErrList[t]||0;this._miscData.nonFatalNwErrList[t]=i+1}}_handleBatchMediaError(){let e=this._miscData.nonFatalMediaErrList;Object.keys(e).forEach(t=>{this._miscData.playErrCode=t,this._miscData.playErrIsFatal=!1,this._miscData.playErrCount=e[t],this._sendPlayError()}),this._miscData.nonFatalMediaErrList={}}_handleBatchNwError(){let e=this._miscData.nonFatalNwErrList;Object.keys(e).forEach(t=>{let i=t.split("/");this._miscData.nwErrTime=Date.now(),this._miscData.nwErrCode=i[0],this._miscData.nwErrReason=parseInt(i[1]),this._miscData.nwErrIsFatal=!1,this._miscData.nwErrCount=e[t],this._sendNwError()}),this._miscData.nonFatalNwErrList={}}_handlePlaybackInfo(e){e.droppedVideoFrames<this._miscData.droppedVideoFrames&&(this._miscData.droppedVideoFrames=0),e.decodedFrameCount<this._miscData.decodedFrameCount&&(this._miscData.decodedFrameCount=0);let t=e.droppedVideoFrames-(this._miscData.droppedVideoFrames||0),i=e.decodedFrameCount-(this._miscData.decodedFrameCount||0);this._miscData.droppedVideoFrames=e.droppedVideoFrames,this._miscData.decodedFrameCount=e.decodedFrameCount,this._miscData.decodedFramesForVariant+=i,this._miscData.decodedFramesForVariantSampleCount+=1,t&&(this._inc([this._accessLogData],"ViFrDr",t),t>=3?(this._inc([this._sessionData,this._intervalData],"GroupViFrDr",t),this._inc([this._sessionData,this._intervalData],"GroupViFrDrEvtCount",1)):(this._inc([this._sessionData,this._intervalData],"SparseViFrDr",t),this._inc([this._sessionData,this._intervalData],"SparseViFrDrEvtCount",1)))}_sendSummaryEvent(){clearInterval(this._interval);let e=this._sessionData.NetBytes||0,t=this._sessionData.ADT||0,i=e&&t?8*e/(t/1e3):0,s=this._sessionData.SegmentProcessTime||0,a=e&&t?8*e/((t+s)/1e3):0,r=this._sessionData.SegmentParseTime||0;e=this._miscData.sessSegmentBytes,t=this._miscData.sessSegmentAdt,s=this._miscData.sessSegmentProcessTime;let n=e&&t?8*e/((t+s+r)/1e3):0,o=8*(this._miscData.sessVideoBytes||0)/(this._miscData.sessVideoDuration||1),l=8*(this._miscData.sessAudioBytes||0)/(this._miscData.sessAudioDuration||1),d=this._findTimeWeightedValues(this._miscData.sessVariantList),h=this._getVariantInfo(this._miscData.curLevelUrl),c=this._miscData.manifestData||{},u="";this._miscData.playlistMimeTypes.forEach(e=>{u+=e+","});let f="";this._miscData.segmentMimeTypes.forEach(e=>{f+=e+","}),this._sessionData.PlayType=this._miscData.playlistType,this._sessionData.TWOBR=i,this._sessionData.PerceivedTWOBR=a,this._sessionData.NetTWOBR=n,this._sessionData.AvgVideoBitrate=o,this._sessionData.AvgAudioBitrate=l,this._sessionData.PlayerTWIBR=d.twIBR,this._sessionData.PlayerTWIABR=d.twIABR,this._sessionData.TWBitRk=d.twBRnk,this._sessionData.TargetDur=h.targetduration,this._sessionData.VariantList=c.trimmedVarList,this._sessionData.PlaylistMimeType=u.slice(0,-1),this._sessionData.SegmentMimeType=f.slice(0,-1),this._sessionData.Rate=this._miscData.lastPlayRate,this._sessionData.ReWd=h.width,this._sessionData.ReHt=h.height,this._fillAndFire(B,W,this._sessionData),this._sessionData={},this._miscData.sessVariantList={},this._miscData.sessSegmentBytes=0,this._miscData.sessSegmentAdt=0,this._miscData.sessSegmentProcessTime=0}_sendPeriodicEvent(){let e=this._intervalData.NetBytes,t=this._intervalData.ADT,i=e&&t?8*e/(t/1e3):0,s=this._intervalData.SegmentProcessTime||0,a=e&&t?8*e/((t+s)/1e3):0,r=this._intervalData.SegmentParseTime||0;e=this._miscData.intervalSegmentBytes,t=this._miscData.intervalSegmentAdt,s=this._miscData.intervalSegmentProcessTime;let n=e&&t?8*e/((t+s+r)/1e3):0,o=8*(this._miscData.intervalVideoBytes||0)/(this._miscData.intervalVideoDuration||1),l=8*(this._miscData.intervalAudioBytes||0)/(this._miscData.intervalAudioDuration||1),d=this._findTimeWeightedValues(this._miscData.intervalVariantList),h=this._getVariantInfo(this._miscData.curLevelUrl),c=this._miscData.manifestData||{};this._intervalData.EventCounter=++this._miscData.periodicEvtCnt,this._intervalData.PlayType=this._miscData.playlistType,this._intervalData.TWOBR=i,this._intervalData.PerceivedTWOBR=a,this._intervalData.NetTWOBR=n,this._intervalData.AvgVideoBitrate=o,this._intervalData.AvgAudioBitrate=l,this._intervalData.PlayerTWIBR=d.twIBR,this._intervalData.PlayerTWIABR=d.twIABR,this._intervalData.TWBitRk=d.twBRnk,this._intervalData.TargetDur=h.targetduration,this._intervalData.VariantList=c.trimmedVarList,this._intervalData.Rate=this._miscData.lastPlayRate,this._intervalData.ReWd=h.width,this._intervalData.ReHt=h.height,(this._intervalData.PlayTimeWC>0||this._intervalData.ADT)&&this._fillAndFire(6110,H,this._intervalData),this._intervalData={},this._miscData.intervalVariantList={},this._miscData.intervalSegmentBytes=0,this._miscData.intervalSegmentAdt=0,this._miscData.intervalSegmentProcessTime=0,this._miscData.intervalVideoBytes=0,this._miscData.intervalVideoDuration=0,this._miscData.intervalAudioBytes=0,this._miscData.intervalAudioDuration=0}_sendPlayStalledEvent(){const e=Date.now();let t=this._getVariantInfo(this._miscData.curLevelUrl);this._playStalledData.MediaDur=this._getBufferedDuration(),this._playStalledData.BitRnk=t.brRnk,this._playStalledData.Codecs=t.codecs,this._playStalledData.PlayTime=this._sessionData.PlayTime,this._playStalledData.PlayType=this._miscData.playlistType,this._playStalledData.LastLikelyToKeepUp=e-this._miscData.lastLikelyToKeepUpTime,this._playStalledData.LastSwitch=e-this._miscData.lastSwitchTime,this._playStalledData.NwErrTime=this._miscData.nwErrTime,this._playStalledData.NwErrCode=this._miscData.nwErrCode,this._playStalledData.LaSwDir=this._miscData.lastSwitchDir,this._playStalledData.TargetDur=t.targetduration,this._playStalledData.PlayerIABR=t.avgBandwidth,this._playStalledData.PlayerIBR=t.bandwidth,this._playStalledData.Rate=this._miscData.lastPlayRate,this._fillAndFire(U,q,this._playStalledData),this._playStalledData={}}_sendMediaEngineStalledEvent(){const e=Date.now();let t=this._getVariantInfo(this._miscData.curLevelUrl);this._mediaEngineStalledData.MediaDur=this._getBufferedDuration(),this._mediaEngineStalledData.BitRnk=t.brRnk,this._mediaEngineStalledData.Codecs=t.codecs,this._mediaEngineStalledData.PlayTime=this._sessionData.PlayTime,this._mediaEngineStalledData.PlayType=this._miscData.playlistType,this._mediaEngineStalledData.LastLikelyToKeepUp=e-this._miscData.lastLikelyToKeepUpTime,this._mediaEngineStalledData.LastSwitch=e-this._miscData.lastSwitchTime,this._mediaEngineStalledData.LaSwDir=this._miscData.lastSwitchDir,this._mediaEngineStalledData.TargetDur=t.targetduration,this._mediaEngineStalledData.PlayerIABR=t.avgBandwidth,this._mediaEngineStalledData.PlayerIBR=t.bandwidth,this._mediaEngineStalledData.Rate=this._miscData.lastPlayRate,this._fillAndFire($,X,this._mediaEngineStalledData),this._mediaEngineStalledData={}}_sendKeySessionCompleteEvent(){this._keySessionCompleteData.KeyFormat=this._miscData.keyData.keyFormat,this._keySessionCompleteData.CDMVersion=this._miscData.keyData.cdmVersion,this._keySessionCompleteData.SPCRequestTime=this._miscData.keyData.SPCRequestTime,this._keySessionCompleteData.SPCCreationTime=this._miscData.keyData.SPCCreationTime,this._keySessionCompleteData.CKCResponseTime=this._miscData.keyData.CKCResponseTime,this._keySessionCompleteData.CKCProcessTime=this._miscData.keyData.CKCProcessTime,this._keySessionCompleteData.KeyDeliveryTime=this._miscData.keyData.keyDeliveryTime,this._keySessionCompleteData.CurrentMediaTime=this._getCurrentMediaTimeMilliSec(),this._keySessionCompleteData.KeyInitTime=this._miscData.keyData.keyInitTime,this._miscData.keyData.isKeyError&&(this._keySessionCompleteData.KeyErrorType=this._miscData.keyData.keyErrorType),this._fillAndFire(6104,j,this._keySessionCompleteData),this._keySessionCompleteData={},delete this._miscData.keyData}_sendPlayLikelyToKeepUpEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._playLikelyToKeepUpData.EventCounter=++this._miscData.playLikelyToKeepUpEvtCnt,this._playLikelyToKeepUpData.PlayType=this._miscData.playlistType,this._playLikelyToKeepUpData.PlayerIABR=e.avgBandwidth,this._playLikelyToKeepUpData.PlayerIBR=e.bandwidth,this._playLikelyToKeepUpData.MediaDur=this._getBufferedDuration(),this._playLikelyToKeepUpData.BitRnk=e.brRnk,this._playLikelyToKeepUpData.Codecs=e.codecs,this._playLikelyToKeepUpData.TargetDur=e.targetduration,this._fillAndFire(6105,Y,this._playLikelyToKeepUpData),this._playLikelyToKeepUpData={}}_sendPlayRateChangedEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._playRateChangedData.Rate=this._miscData.lastPlayRate,this._playRateChangedData.PlayType=this._miscData.playlistType,this._playRateChangedData.StNPT=this._getCurrentMediaTimeMilliSec(),this._playRateChangedData.PlayerIABR=e.avgBandwidth,this._playRateChangedData.PlayerIBR=e.bandwidth,this._playRateChangedData.BitRnk=e.brRnk,this._playRateChangedData.MediaDur=this._getBufferedDuration(),this._playRateChangedData.Codecs=e.codecs,this._fillAndFire(V,z,this._playRateChangedData),this._playRateChangedData={}}_sendPlayError(){const e=Date.now();let t=this._getVariantInfo(this._miscData.curLevelUrl);this._playErrorData.ErrCode=this._miscData.playErrCode,this._playErrorData.ErrIsFatal=this._miscData.playErrIsFatal,this._playErrorData.PlayerErrCount=this._miscData.playErrCount,this._playErrorData.ErrDomain=this._miscData.playErrDomain,this._playErrorData.PlayType=this._miscData.playlistType,this._playErrorData.BitRnk=t.brRnk,this._playErrorData.MediaDur=this._getBufferedDuration(),this._playErrorData.PlayTime=this._sessionData.PlayTime,this._playErrorData.PlayTimeWC=this._sessionData.PlayTimeWC,this._playErrorData.PlayerIABR=t.avgBandwidth,this._playErrorData.PlayerIBR=t.bandwidth,this._playErrorData.LastLikelyToKeepUp=e-this._miscData.lastLikelyToKeepUpTime,this._playErrorData.LastSwitch=e-this._miscData.lastSwitchTime,this._playErrorData.VideoQltyIndex=t.qltyIndex,this.addToErrorLog(this._miscData.curLevelUrl,this._playErrorData),this._fillAndFire(G,Q,this._playErrorData),this._playErrorData={}}_sendSwitchComplete(){let e=this._miscData.prevLevelUrl,t=this._miscData.failedSwitchUrl||this._miscData.curLevelUrl,i=!!this._miscData.failedSwitchUrl;this._miscData.failedSwitchUrl=void 0;let s=this._getVariantInfo(e),a=this._getVariantInfo(t);this._switchCompleteData.FrBitRnk=s.brRnk,this._switchCompleteData.ToBitRnk=a.brRnk,this._switchCompleteData.TimeToBitrate=Date.now()-this._sessStartTime,this._switchCompleteData.MediaDur=this._getBufferedDuration(),this._switchCompleteData.Rate=this._miscData.lastPlayRate,this._switchCompleteData.PlayType=this._miscData.playlistType,this._switchCompleteData.SwFail=i,this._switchCompleteData.PlayerIBR=a.bandwidth,this._switchCompleteData.PlayerIABR=a.avgBandwidth,this._switchCompleteData.LastPlayerIBR=s.bandwidth,this._switchCompleteData.LastPlayerIABR=s.avgBandwidth,this._switchCompleteData.PlayTime=this._sessionData.PlayTime,this._switchCompleteData.BadSw=this._miscData.isBadSw,this._switchCompleteData.ReWd=a.width,this._switchCompleteData.ReHt=a.height,this.addToAccessLog(e,s,this._miscData),this._fillAndFire(6109,J,this._switchCompleteData),this._switchCompleteData={}}_sendVariantEndEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl),t=this._miscData.decodedFramesForVariant/(this._miscData.decodedFramesForVariantSampleCount||1);this._miscData.decodedFramesForVariant=0,this._miscData.decodedFramesForVariantSampleCount=0,this._variantEndData.Rate=this._miscData.lastPlayRate,this._variantEndData.PlayType=this._miscData.playlistType,this._variantEndData.VarAvgBitrate=e.avgBandwidth,this._variantEndData.VarPeakBitrate=e.bandwidth,this._variantEndData.VarBitRk=e.brRnk,this._variantEndData.VarSTTime=this._miscData.variantStartTimeMedia,this._variantEndData.VarEndTime=this._getCurrentMediaTimeMilliSec(),this._variantEndData.IFR=e.framerate,this._variantEndData.ODR=t,this._variantEndData.ReWd=e.width,this._variantEndData.ReHt=e.height,this._fillAndFire(6111,Z,this._variantEndData),this._variantEndData={}}_sendNwError(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._nwErrorData.BitRnk=e.brRnk,this._nwErrorData.PlayTime=this._sessionData.PlayTime,this._nwErrorData.PlayTimeWC=this._sessionData.PlayTimeWC,this._nwErrorData.PlayType=this._miscData.playlistType,this._nwErrorData.ErrCode=this._miscData.nwErrCode,this._nwErrorData.ErrReason=this._miscData.nwErrReason,this._nwErrorData.ErrIsFatal=this._miscData.nwErrIsFatal,this._nwErrorData.NwErrCount=this._miscData.nwErrCount,this._nwErrorData.ErrDomain=this._miscData.nwErrDomain,this.addToErrorLog(this._miscData.curLevelUrl,this._nwErrorData),this._fillAndFire(K,ee,this._nwErrorData),this._nwErrorData={}}_aggregateStats(e,t){switch(e){case F.manifestparsed:this._aggregateManifestParsedStats(t);break;case F.manifestloaded:this._aggregateManifestLoadedStats(t);break;case F.fragloading:this._aggregateFragLoadingStats();break;case F.fragloaded:this._aggregateFragLoadedStats(t);break;case F.fragbuffered:this._aggregateFragBufferedStats(t)}}_aggregateManifestParsedStats(e){let t=e.levels||[],i={},s={},a=0,r=0,n=this._getMaxNormalizedPeak(t);t.forEach(e=>{if(e.attrs){let t=this._getVideoFourCC(e.attrs.CODECS),s=this._getVideoQualityIndex(t,e.attrs["VIDEO-RANGE"])||0,a={codecs:e.attrs.CODECS,width:e.width,height:e.height,bandwidth:parseInt(e.attrs.BANDWIDTH),avgBandwidth:parseInt(e.attrs["AVERAGE-BANDWIDTH"]),framerate:parseFloat(e.attrs["FRAME-RATE"]),iframes:e.iframes,brRnk:this._getBitrateRank(parseInt(e.attrs.BANDWIDTH),t,n),qltyIndex:s};r=s>r?s:r,i[e.url]=a}let t=e.width*e.height;t>a&&(a=t,s={width:e.width,height:e.height})}),this._miscData.manifestData={},this._miscData.manifestData.variantList=i,this._miscData.manifestData.trimmedVarList=Object.keys(i).length>0?Object.values(i).map(e=>e.bandwidth+":"+e.avgBandwidth).join(","):void 0,this._dimensionData.maxVideoQltyIndex=r,this._dimensionData.maxReWd=s.width,this._dimensionData.maxReHt=s.height}_aggregateManifestLoadedStats(e){this._miscData.playlistMimeTypes.has(e.contentType)||this._miscData.playlistMimeTypes.add(e.contentType),this._inc([this._sessionData,this._intervalData],"MasterPlaylistADT",e.adt)}_aggregateFragLoadingStats(){this._inc([this._sessionData,this._intervalData],"MediaRequestsSent",1)}_aggregateFragObserverdBitrate(e,t,i,s){const a=8*i/(s/1e3);return{obr:a,obrLast:8*e.bytes/(e.adt/1e3),obrMean:a/t}}_aggregateFragMinMaxBitrate(e,t){(!e.obrMax||t>e.obrMax)&&(e.obrMax=t),(!e.obrMin||t<e.obrMin)&&(e.obrMin=t)}_hasGap(e,t,i,s){return void 0!==e&&void 0!==i&&(e-s>1||i-t>1)}_aggregateFragLoadedStats(e){if(this._miscData.segmentMimeTypes.has(e.contentType)||this._miscData.segmentMimeTypes.add(e.contentType),"string"==typeof e.cdnServer&&le.includes(e.cdnServer.toLowerCase())&&(this._miscData.lastMediaCDNServer=e.cdnServer),"main"===e.fragType||"video"===e.fragType){this._inc([this._sessionData,this._intervalData,this._accessLogData],"NetBytes",e.bytes),this._inc([this._sessionData,this._intervalData,this._accessLogData],"ADT",e.adt),this._inc([this._sessionData,this._intervalData,this._accessLogData],"SegmentProcessTime",e.processTime);const t=this._aggregateFragObserverdBitrate(e,++this._miscData.fragmentCnt,this._sessionData.NetBytes,this._sessionData.ADT),i=this._aggregateFragObserverdBitrate(e,++this._accessLogData.fragmentCnt,this._accessLogData.NetBytes,this._accessLogData.ADT);if(this._playStalledData.OBRLast=t.obrLast,this._playStalledData.OBRMean=t.obrMean,this._mediaEngineStalledData.OBRLast=t.obrLast,this._mediaEngineStalledData.OBRMean=t.obrMean,this._accessLogData.OBRLast=i.obrLast,this._accessLogData.OBRMean=i.obrMean,this._aggregateFragMinMaxBitrate(this._accessLogData,i.obr),(this.media?this.media.currentTime:0)>e.startPTS&&this._eventEmitter&&!this._eventEmitter.seeking&&this._accessLogData.overdue++,this._hasGap(e.startPTS,e.endPTS,this._accessLogData.lastStartPTS,this._accessLogData.lastEndPTS)){let e=this._getVariantInfo(this._miscData.curLevelUrl);this.addToAccessLog(this._miscData.curLevelUrl,e,this._miscData)}this._accessLogData.startPTS||(this._accessLogData.startPTS=e.startPTS),this._accessLogData.lastStartPTS=e.startPTS,this._accessLogData.lastEndPTS=e.endPTS,this._miscData.sessVideoBytes+=e.bytes,this._miscData.sessVideoDuration+=e.duration,this._miscData.intervalVideoBytes+=e.bytes,this._miscData.intervalVideoDuration+=e.duration,this._accessLogData.videoBytes+=e.bytes,this._accessLogData.videoDuration+=e.duration}else"audio"===e.fragType&&(this._miscData.sessAudioBytes+=e.bytes,this._miscData.sessAudioDuration+=e.duration,this._miscData.intervalAudioBytes+=e.bytes,this._miscData.intervalAudioDuration+=e.duration,this._accessLogData.audioBytes+=e.bytes,this._accessLogData.audioDuration+=e.duration)}_aggregateFragBufferedStats(e){"main"!==e.fragType&&"video"!==e.fragType||(this._miscData.intervalSegmentBytes+=e.bytes,this._miscData.intervalSegmentAdt+=e.adt,this._miscData.intervalSegmentProcessTime+=e.processTime,this._miscData.sessSegmentBytes+=e.bytes,this._miscData.sessSegmentAdt+=e.adt,this._miscData.sessSegmentProcessTime+=e.processTime,this._inc([this._sessionData,this._intervalData,this._accessLogData],"SegmentParseTime",e.parseTime))}_inc(e,t,i){t&&i&&e&&t&&e.forEach(e=>{e[t]=e[t]?e[t]+i:i})}_updateMaxValue(e,t,i){t&&i&&e&&t&&e.forEach(e=>{(!e[t]||e[t]<i)&&(e[t]=i)})}_setValue(e,t,i){t&&i&&e&&t&&e.forEach(e=>{e[t]=i})}_clearValue(e,t){t&&e&&t&&e.forEach(e=>{delete e[t]})}_updateLevelStats(e,t){if(e&&t){let i=this._getVariantInfo(t),s={bandwidth:i.bandwidth,avgBandwidth:i.avgBandwidth,framerate:i.framerate,brRnk:i.brRnk,playTime:0},a=s,r=Object.assign({},s),n=this._miscData.intervalVariantList,o=this._miscData.sessVariantList,l=n[t]?n[t].playTime:0,d=o[t]?o[t].playTime:0;a.playTime=l+e,r.playTime=d+e,n[t]=a,o[t]=r}}_finalizeStatsForPeriodic(){const e=Date.now();let t=e-this._intervalStartTime,i=e-this._stateStartTime;if(this._intervalStartTime=e,this._miscData.pInterval=t,i=Math.min(t,i),this._setValue([this._intervalData],"PInterval",t),this._state===se){this._inc([this._intervalData],"PlayTimeWC",i);const t=Math.abs(i*(this._miscData.lastPlayRate/100));this._inc([this._intervalData],"PlayTime",t);const s=Math.min(e-this._variantStartTime,i);this._updateLevelStats(s,this._miscData.curLevelUrl)}else this._state===ae?this._inc([this._intervalData],"StallTime",i):this._state===re?this._inc([this._intervalData],"MediaEngineStallTime",i):this._state===ie&&this._inc([this._intervalData],"PauseTime",i);this._handleBatchMediaError(),this._handleBatchNwError()}_updateStateTimes(e,t){if(-1===oe.indexOf(e))return;const i=Date.now(),s=i-this._stateStartTime,a=Math.min(i-this._intervalStartTime,s),r=Math.min(i-this._variantStartTime,s);if(this._state===se){this._inc([this._sessionData,this._accessLogData],"PlayTimeWC",s);const e=Math.abs(s*(this._miscData.lastPlayRate/100));this._inc([this._sessionData],"PlayTime",e);let t=Math.abs(a*(this._miscData.lastPlayRate/100));this._inc([this._intervalData],"PlayTimeWC",a),this._inc([this._intervalData],"PlayTime",t);let i=Math.abs(r*(this._miscData.lastPlayRate/100));this._inc([this._variantEndData],"VarPlayTime",i),this._inc([this._variantEndData],"VarPlayTimeWC",r),this._inc([this._switchCompleteData],"PlayTimeLastSW",i);let n=Math.min(r,a);this._updateLevelStats(n,this._miscData.curLevelUrl),this._inc([this._playRateChangedData],"RateChangePlayTime",s),this._setValue([this._playStalledData,this._mediaEngineStalledData,this._playErrorData,this._nwErrorData],"LastResume",s)}else this._state===ae?(this._inc([this._sessionData],"StallTime",s),this._inc([this._intervalData],"StallTime",a),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastStall",s)):this._state===re?(this._inc([this._sessionData],"MediaEngineStallTime",s),this._inc([this._intervalData],"MediaEngineStallTime",a),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastMediaEngineStall",s)):this._state===ie&&(this._inc([this._sessionData],"PauseTime",s),this._inc([this._intervalData],"PauseTime",a),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastPause",s));switch(this._stateStartTime=i,e){case U:this._state=ae,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1;break;case $:this._state=re,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1;break;case V:0===t?this._state=ie:(this._state=se,this._clearValue([this._sessionData],"LastStall"),this._clearValue([this._sessionData],"LastMediaEngineStall"),this._clearValue([this._sessionData],"LastPause")),this._miscData.lastPlayRate=t;break;case K:case G:case B:this._state=ne,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1}}_fillAndFire(e,t,i){if(!(e&&t&&i&&this.reportingAgent))return;this._miscData.lastMediaCDNServer&&(i.LastMediaCDNServer=this._miscData.lastMediaCDNServer),i.MaxVideoQltyIndex=this._dimensionData.maxVideoQltyIndex,i.MaxReWd=this._dimensionData.maxReWd,i.MaxReHt=this._dimensionData.maxReHt;let s={};t.forEach(e=>{let t=i[e];isNaN(t)||(t=Number(Number(t).toFixed(2))),s[e]=t});const a=e===B||6110===e?1:0;this.reportingAgent.issueReportingEvent(e,s,a)}_findTimeWeightedValues(e){let t={};if(e){let i=0,s=0,a=0,r=0,n=0;Object.values(e).forEach(e=>{e.playTime&&(s+=e.bandwidth*e.playTime,i+=e.brRnk*e.playTime,a+=e.playTime,e.avgBandwidth&&(r+=e.avgBandwidth*e.playTime,n+=e.playTime))}),a&&(t.twBRnk=i/a,t.twIBR=s/a),r&&n&&(t.twIABR=r/n)}return t}_getBufferedDuration(){let e=0;if(this.media&&this.media.buffered){let t=this.media.buffered;for(let i=0;i<t.length;i++)e+=t.end(i)-t.start(i)}return Math.round(1e3*e)}_getVariantInfo(e){return e&&this._miscData.manifestData&&this._miscData.manifestData.variantList&&this._miscData.manifestData.variantList[e]?this._miscData.manifestData.variantList[e]:{}}_getVideoFourCC(e){return e?e.split(",").map(e=>e.split(".")[0].trim()).find(e=>de.hasOwnProperty(e)):e}_getVideoQualityIndex(e,t){return"object"==typeof de[e]?de[e][t]:de[e]}_getNormalizedPeak(e,t){return"object"==typeof de[t]?1.5*e:1*e}_getMaxNormalizedPeak(e){let t=0;return e.forEach(e=>{let i=e.attrs;if(i){let e=i.BANDWIDTH||0,s=this._getNormalizedPeak(e,this._getVideoFourCC(i.CODECS)),a=Math.max(e,s);t=a>t?a:t}}),t}_getBitrateRank(e,t,i){const s=Math.max(1,this._getNormalizedPeak(e,t));return Math.ceil(100*s/i)}_getCurrentMediaTimeMilliSec(){return this.media&&this.media.currentTime?Math.round(1e3*this.media.currentTime):0}_isBadSw(e,t,i,s,a,r){let n=!1,o=a.lastSwitchTime||0,l=a.lastSwitchDir||e;return i-o<s&&l!==e&&a.lastLevelIsIframe===t&&!r&&(n=!0),n}}(this.hls,this.enableRtcReporting,this.hls.config,this.hls.assetInfo.appData)}onManifestLoaded(e){this._logAndReport(null,F.manifestloaded,{adt:e.stats.tload-e.stats.trequest,contentType:e.stats.contentType})}onManifestParsed(e){this._logAndReport(null,F.manifestparsed,e)}onLevelLoaded(e){let t={url:e.details.url,targetduration:e.details.targetduration,adt:e.stats.tload-e.stats.trequest,contentType:e.stats.contentType,playlistType:e.playlistType};this._logAndReport(null,F.levelloaded,t)}onError(e){if(e){let t={details:e.details,fatal:e.fatal,type:a.c.MEDIA_ERROR};e.type===a.c.NETWORK_ERROR?(t.type=e.type,t.code=e.response?e.response.code:void 0,e.details!==a.a.LEVEL_LOAD_ERROR||e.fatal||(t.failedSwitchUrl=e.url,t.isSeeking=this.isSeeking,this._logAndReport(null,F.levelloaderror,t)),this._logAndReport("Network Error",F.nwerror,t)):e.type!==a.c.MEDIA_ERROR&&e.type!==a.c.MUX_ERROR&&e.type!==a.c.KEY_SYSTEM_ERROR&&e.type!==a.c.OTHER_ERROR||(e.details!==a.a.BUFFER_STALLED_ERROR||e.fatal?this._logAndReport("Media Error",F.mediaerror,t):e.response.code===a.b.InsufficientDataAvailable.code?this._logAndReport("[QE Critical] Buffer stalled due to insufficient data",F.bufferstalled):this._logAndReport("Stalled due to high buffer (media engine)",F.mediaenginestalled))}}notifyKeySessionEvent(e,t){switch(t.timestamp=Date.now(),e){case F.spcreceived:this._logAndReport(null,F.spcreceived,t);break;case F.spcsubmitted:this._logAndReport(null,F.spcsubmitted,t);break;case F.spccreated:this._logAndReport(null,F.spccreated,t),this._logAndReport(null,F.ckcrequested,t);break;case F.ckcsubmitted:this._logAndReport(null,F.ckcreceived,t),this._logAndReport(null,F.ckcsubmitted,t);break;case F.ckcprocessed:this._logAndReport(null,F.ckcprocessed,t);break;case F.keyaborted:this._logAndReport(null,F.keyaborted,t);break;case F.spcerror:this._logAndReport(null,F.spcerror,t);break;case F.ckcerror:this._logAndReport(null,F.ckcerror,t)}}_timeRangeToArray(e){let t=[];for(let i=0;i<e.length;i++)t.push([e.start(i),e.end(i)]);return t}_isWebkitMediaElement(e){return"webkitDroppedFrameCount"in e}_isHtmlVideoElement(e){return"getVideoPlaybackQuality"in e}_videoPlaybackInfo(){let e=this.hls.media;if(!e)return;let t,i,s={readyToPlay:e.readyState>=e.HAVE_FUTURE_DATA,playbackLikelyToKeepUp:this.hls.playbackLikelyToKeepUp,rate:e.playbackRate,paused:e.paused,position:e.currentTime,duration:e.duration,seekableTimeRanges:this._timeRangeToArray(e.seekable),loadedTimeRanges:this._timeRangeToArray(e.buffered)};if(this._isHtmlVideoElement(e)){let a=e.getVideoPlaybackQuality;if(a&&typeof a==typeof Function){let a=e.getVideoPlaybackQuality();t=s.droppedVideoFrames=a.droppedVideoFrames,s.corruptedVideoFrames=a.corruptedVideoFrames,s.totalVideoFrames=a.totalVideoFrames,i=s.totalVideoFrames-t}}else this._isWebkitMediaElement(e)&&(t=s.droppedVideoFrames=e.webkitDroppedFrameCount,i=s.decodedFrameCount=e.webkitDecodedFrameCount);this._logAndReport(`[QE Critical] hls player: ${JSON.stringify(s)}`,F.playbackinfo,{droppedVideoFrames:t,decodedFrameCount:i})}_addMediaEventListeners(e){e&&(this.onloadstart=this._onloadstart.bind(this),this.onpause=this._onpause.bind(this),this.onplaying=this._onplaying.bind(this),this.onseeking=this._onseeking.bind(this),e.addEventListener("loadstart",this.onloadstart),e.addEventListener("pause",this.onpause),e.addEventListener("playing",this.onplaying),e.addEventListener("seeking",this.onseeking))}_removeMediaEventListeners(e){e&&(e.removeEventListener("loadstart",this.onloadstart),e.removeEventListener("pause",this.onpause),e.removeEventListener("playing",this.onplaying),e.removeEventListener("seeking",this.onseeking))}_onloadstart(){this.timer&&clearInterval(this.timer),this.timer=setInterval(this._videoPlaybackInfo.bind(this),1e3),this._logAndReport("[QE Critical] [PlayerEvent]LoadStart")}_onpause(){this._logAndReport("[QE Critical] [PlayerState]Paused/rate=0",F.pause),this._logAndReport("[QE Critical] [PlayerEvent]Paused")}_onplaying(){this.timer||(this.timer=setInterval(this._videoPlaybackInfo.bind(this),1e3)),this._logAndReport("[QE Critical] [PlayerEvent]CanPlay",F.canplay),this._logAndReport("[QE Critical] [PlayerState]Playing/rate="+this.desiredRate,F.playing),this.isSeeking=!1,this.logger.info("[QE Critical] [PlayerEvent]Playing, sessionID: "+this.hls.sessionID)()}_onseeking(){this._logAndReport("[QE Critical] [PlayerEvent]Seeking"),this.isSeeking=!0}_logAndReport(e,t,i){this.enablePerformanceLogging&&e&&this.logger.info(e)(),this.rtc&&t&&this.rtc.notify(t,i)}},Ii=class{constructor(e){this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=0,this.totalWeight_=0,this.numSamples_=0}sample(e,t){var i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e,this.numSamples_++}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){var e=1-Math.pow(this.alpha_,this.totalWeight_);return this.estimate_/e}return this.estimate_}};!(function(e){e.LowBandwidth="LowBandwidth",e.HighBandwidth="HighBandwidth"})(Di||(Di={}));var Ai=i(10),ki={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Ci=function(e){var t=e;return ki.hasOwnProperty(e)&&(t=ki[e]),String.fromCharCode(t)},wi=15,Pi=100,Mi={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Oi={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Ni={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},xi={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Fi=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],Bi={verboseFilter:{DATA:3,DEBUG:3,INFO:2,WARNING:2,TEXT:1,ERROR:0},time:null,verboseLevel:0,setTime:function(e){this.time=e},log:function(e,t){var i=this.verboseFilter[e];this.verboseLevel>=i&&console.log(this.time+" ["+e+"] "+t)}},Ui=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class Vi{constructor(e,t,i,s,a){this.foreground=e||"white",this.underline=t||!1,this.italics=i||!1,this.background=s||"black",this.flash=a||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){var t;t=e,Object.assign(this,t)}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Gi{constructor(e,t,i,s,a,r){this.uchar=e||" ",this.penState=new Vi(t,i,s,a,r)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class $i{constructor(){this.chars=[];for(var e=0;e<Pi;e++)this.chars.push(new Gi);this.pos=0,this.currPenState=new Vi}equals(e){for(var t=!0,i=0;i<Pi;i++)if(!this.chars[i].equals(e.chars[i])){t=!1;break}return t}copy(e){for(var t=0;t<Pi;t++)this.chars[t].copy(e.chars[t])}isEmpty(){for(var e=!0,t=0;t<Pi;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(Bi.log("ERROR","Negative cursor position "+this.pos),this.pos=0):this.pos>Pi&&(Bi.log("ERROR","Too large cursor position "+this.pos),this.pos=Pi)}moveCursor(e){var t=this.pos+e;if(e>1)for(var i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();var t=Ci(e);this.pos>=Pi?Bi.log("ERROR","Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){var t;for(t=e;t<Pi;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){for(var e=[],t=!0,i=0;i<Pi;i++){var s=this.chars[i].uchar;" "!==s&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Ki{constructor(){this.rows=[];for(var e=0;e<wi;e++)this.rows.push(new $i);this.currRow=wi-1,this.nrRollUpRows=null,this.reset()}reset(){for(var e=0;e<wi;e++)this.rows[e].clear();this.currRow=wi-1}equals(e){for(var t=!0,i=0;i<wi;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(var t=0;t<wi;t++)this.rows[t].copy(e.rows[t])}isEmpty(){for(var e=!0,t=0;t<wi;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){Bi.log("INFO","setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){Bi.log("INFO","pacData = "+JSON.stringify(e));var t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<wi;e++)this.rows[e].clear();var i=this.currRow+1-this.nrRollUpRows;const e=this.lastOutputScreen;if(e){var s=e.rows[i].cueStartTime;if(s&&s<Bi.time)for(let s=0;s<this.nrRollUpRows;s++)this.rows[t-this.nrRollUpRows+s+1].copy(e.rows[i+s])}}this.currRow=t;var a=this.rows[this.currRow];if(null!==e.indent){var r=e.indent,n=Math.max(r-1,0);a.setCursor(e.indent),e.color=a.chars[n].penState.foreground}var o={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(o)}setBkgData(e){Bi.log("INFO","bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null!==this.nrRollUpRows){Bi.log("INFO","TEXT "+this.getDisplayText());var e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),Bi.log("INFO","Rolling up")}else Bi.log("DEBUG","roll_up but nrRollUpRows not set yet")}getDisplayText(e){e=e||!1;for(var t=[],i="",s=-1,a=0;a<wi;a++){var r=this.rows[a].getTextString();r&&(s=a+1,e?t.push("Row "+s+": '"+r+"'"):t.push(r.trim()))}return t.length>0&&(i=e?"["+t.join(" | ")+"]":t.join("\n")),i}getTextAndFormat(){return this.rows}}class Wi{constructor(e,t){this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Ki,this.nonDisplayedMemory=new Ki,this.lastOutputScreen=new Ki,this.currRollUpRow=this.displayedMemory.rows[wi-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.currRollUpRow=this.displayedMemory.rows[wi-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.lastCueEndTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,Bi.log("INFO","MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(var t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);var i=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";Bi.log("INFO",i+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(Bi.log("TEXT","DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){Bi.log("INFO","RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){Bi.log("INFO","BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){Bi.log("INFO","DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){Bi.log("INFO","RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){Bi.log("INFO","FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){Bi.log("INFO","RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){Bi.log("INFO","TR"),this.setMode("MODE_TEXT")}ccRTD(){Bi.log("INFO","RTD"),this.setMode("MODE_TEXT")}ccEDM(){Bi.log("INFO","EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){Bi.log("INFO","CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){Bi.log("INFO","ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(Bi.log("INFO","EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,Bi.log("TEXT","DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){Bi.log("INFO","TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){var t={flash:!1,underline:!1,italics:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{var i=Math.floor(e/2)-16;t.foreground=["white","green","blue","cyan","red","yellow","magenta"][i]}Bi.log("INFO","MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){var t=Bi.time;null!==t&&this.outputFilter&&(this.outputFilter.updateData&&this.outputFilter.updateData(t,this.displayedMemory),null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue&&(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),!0===e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue()),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}var Hi=class{constructor(e,t,i){this.currChNr=-1,this.channels=[new Wi(1,t),new Wi(2,i)],this.lastCmdA=null,this.lastCmdB=null,this.dataCounters={padding:0,char:0,cmd:0,other:0}}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,s,a,r=null;Bi.setTime(e);for(var n=0;n<t.length;n+=2)s=127&t[n],a=127&t[n+1],0!==s||0!==a?(Bi.log("DATA","["+Ui([t[n],t[n+1]])+"] -> ("+Ui([s,a])+")"),(i=this.parseCmd(s,a))||(i=this.parseMidrow(s,a)),i||(i=this.parsePAC(s,a)),i||(i=this.parseBackgroundAttributes(s,a)),i||(r=this.parseChars(s,a))&&(this.currChNr&&this.currChNr>=0?this.channels[this.currChNr-1].insertChars(r):Bi.log("WARNING","No channel found yet. TEXT-MODE?")),i?this.dataCounters.cmd+=2:r?this.dataCounters.char+=2:(this.dataCounters.other+=2,Bi.log("WARNING","Couldn't parse cleaned data "+Ui([s,a])+" orig: "+Ui([t[n],t[n+1]])))):this.dataCounters.padding+=2}parseCmd(e,t){var i;if(!((20===e||28===e)&&32<=t&&t<=47||(23===e||31===e)&&33<=t&&t<=35))return!1;if(e===this.lastCmdA&&t===this.lastCmdB)return this.lastCmdA=null,this.lastCmdB=null,Bi.log("DEBUG","Repeated command ("+Ui([e,t])+") is dropped"),!0;i=20===e||23===e?1:2;var s=this.channels[i-1];return 20===e||28===e?32===t?s.ccRCL():33===t?s.ccBS():34===t?s.ccAOF():35===t?s.ccAON():36===t?s.ccDER():37===t?s.ccRU(2):38===t?s.ccRU(3):39===t?s.ccRU(4):40===t?s.ccFON():41===t?s.ccRDC():42===t?s.ccTR():43===t?s.ccRTD():44===t?s.ccEDM():45===t?s.ccCR():46===t?s.ccENM():47===t&&s.ccEOC():s.ccTO(t-32),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}parseMidrow(e,t){var i=null;return(17===e||25===e)&&32<=t&&t<=47&&((i=17===e?1:2)!==this.currChNr?(Bi.log("ERROR","Mismatch channel in midrow parsing"),!1):(this.channels[i-1].ccMIDROW(t),Bi.log("DEBUG","MIDROW ("+Ui([e,t])+")"),!0))}parsePAC(e,t){var i,s;if(!((17<=e&&e<=23||25<=e&&e<=31)&&64<=t&&t<=127||(16===e||24===e)&&64<=t&&t<=95))return!1;if(e===this.lastCmdA&&t===this.lastCmdB)return this.lastCmdA=null,this.lastCmdB=null,!0;i=e<=23?1:2,s=64<=t&&t<=95?1===i?Mi[e]:Ni[e]:1===i?Oi[e]:xi[e];var a=this.interpretPAC(s,t);return this.channels[i-1].setPAC(a),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}interpretPAC(e,t){var i,s={color:null,italics:!1,indent:null,underline:!1,row:e};return i=t>95?t-96:t-64,s.underline=1==(1&i),i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=4*Math.floor((i-16)/2),s}parseChars(e,t){var i,s=null,a=null,r=null;(e>=25?(s=2,r=e-8):(s=1,r=e),17<=r&&r<=19)?(i=17===r?t+80:18===r?t+112:t+144,Bi.log("INFO","Special char '"+Ci(i)+"' in channel "+s),a=[i]):32<=e&&e<=127&&(a=0===t?[e]:[e,t]);if(a){var n=Ui(a);Bi.log("DEBUG",`Char codes =  ${n.join(",")}`),this.lastCmdA=null,this.lastCmdB=null}return a}parseBackgroundAttributes(e,t){var i,s,a;return((16===e||24===e)&&32<=t&&t<=47||(23===e||31===e)&&45<=t&&t<=47)&&(i={underline:!1},16===e||24===e?(s=Math.floor((t-32)/2),i.background=Fi[s],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0)),a=e<24?1:2,this.channels[a-1].setBkgData(i),this.lastCmdA=null,this.lastCmdB=null,!0)}reset(){for(var e=0;e<this.channels.length;e++)this.channels[e]&&this.channels[e].reset();this.lastCmdA=null,this.lastCmdB=null}cueSplitAtTime(e){for(var t=0;t<this.channels.length;t++)this.channels[t]&&this.channels[t].cueSplitAtTime(e)}};class qi{constructor(e,t){this.handler=e,this.track=t,this.startTime=null,this.endTime=null,this.screen=null}dispatchCue(){null!==this.startTime&&(this.handler.addCues("cc"+this.track,this.startTime,this.endTime,this.screen),this.startTime=null)}newCue(e,t,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.handler.createCaptionsTrack(this.track)}}function ji(e,t,i){return e.substr(i||0,t.length)===t}function Yi(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()}function zi(e){let t=Math.floor(e),i=t+.5,s=t+1;return e>=i?e-i>=s-e?s:i:e-t>=i-e?i:t}var Qi={parse:function(e,t,i,s,a,r,n){let o=g.a.utf8arrayToStr(new Uint8Array(e)).trim().replace(/\r\n|\n\r|\n|\r/g,"\n").split("\n"),l="00:00.000",d=0,h=0,c=0,u=[],f=null,m=!0,p=!1;const y=new Ai.WebVTTParser(window,Ai.WebVTTParser.StringDecoder(),n);y.oncue=function(e){let t=i[s],a=i.ccOffset;t&&t.new&&(void 0!==h?a=i.ccOffset=t.start:(function(e,t,i){let s=e[t],a=e[s.prevCC];if(!a||!a.new&&s.new)return e.ccOffset=e.presentationOffset=s.start,void(s.new=!1);for(;a&&a.new;)e.ccOffset+=s.start-a.start,s.new=!1,a=e[(s=a).prevCC];e.presentationOffset=i})(i,s,c)),c&&(a=c-i.presentationOffset),p&&(e.startTime+=a-h,e.endTime+=a-h),e.id=Yi(zi(e.startTime).toString())+Yi(zi(e.endTime-e.startTime).toString())+Yi(e.text),e.text=decodeURIComponent(encodeURIComponent(e.text)),e.endTime>0&&u.push(e)},y.onparsingerror=function(e){f=e},y.onflush=function(){f&&r?r(f):a(u)},o.forEach(e=>{if(m){if(ji(e,"X-TIMESTAMP-MAP=")){m=!1,p=!0,e.substr(16).split(",").forEach(e=>{ji(e,"LOCAL:")?l=e.substr(6):ji(e,"MPEGTS:")&&(d=parseInt(e.substr(7)))});try{d=(function(e,t){let i;if(!Number.isFinite(t))return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e})(d-t,9e4*i.ccOffset),h=(function(e){let t=parseInt(e.substr(-3)),i=parseInt(e.substr(-6,2)),s=parseInt(e.substr(-9,2)),a=e.length>9?parseInt(e.substr(0,e.indexOf(":"))):0;return isNaN(t)||isNaN(i)||isNaN(s)||isNaN(a)?-1:(t+=1e3*i,t+=6e4*s,t+=36e5*a)})(l)/1e3,c=d/9e4,-1===h&&(f=new Error(`Malformed X-TIMESTAMP-MAP: ${e}`))}catch(t){p=!1,f=new Error(`Malformed X-TIMESTAMP-MAP: ${e}`)}return}""===e&&(m=!1)}y.parse(e+"\n")}),y.flush()}};const Xi=e=>"cc1"===e||"cc2"===e;function Ji(e){let t=[];for(let i=0;i<e.length;i++){let s=e[i];("captions"===s.kind||"subtitles"===s.kind||"metadata"===s.kind&&s.customTextTrackCueRenderer)&&t.push(s)}return t}function Zi(e,t){return(e?e.id:void 0)===(t?t.id:void 0)}const es=1001/3e4;function ts(e){if(e&&e.cues)for(;e.cues.length>0;)e.removeCue(e.cues[0])}class is extends P{constructor(e){super(e,s.a.MEDIA_ATTACHING,s.a.MEDIA_DETACHING,s.a.FRAG_PARSING_USERDATA,s.a.FRAG_PARSING_CAPTIONDATA,s.a.MANIFEST_LOADING,s.a.MANIFEST_LOADED,s.a.FRAG_LOADED,s.a.LEVEL_SWITCHING,s.a.INIT_PTS_FOUND,s.a.INLINE_STYLES_PARSED),this.hls=e,this.hls=e,this.config=e.config,this.enabled=!0,this.Cues=e.config.cueHandler,this.textTracks=[],this.tracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cueRanges=[],this.channelToTrackMap={},this.mediaAttached=!1,this.manifestLoaded=!1}addCues(e,t,i,s){const a=this.cueRanges;let r=!1;for(let e=a.length;e--;){let s=a[e],h=(n=s[0],o=s[1],l=t,d=i,Math.min(o,d)-Math.max(n,l));if(h>=0&&(s[0]=Math.min(s[0],t),s[1]=Math.max(s[1],i),r=!0,h/(i-t)>.5))return}var n,o,l,d;r||a.push([t,i]),this.Cues.newCue(this.channelToTrackMap[e],t,i,s,this.media)}removeParsedFrag(e){let t=this.unparsedVttFrags.indexOf(e);t>-1&&this.unparsedVttFrags.splice(t,1)}onInitPtsFound(e){"main"===e.id&&(this.initPTS[e.frag.cc]=e.initPTS90k),this.unparsedVttFrags.length&&this.unparsedVttFrags.forEach(t=>{t.frag&&t.frag.cc===e.frag.cc?(this._processUnparsedVttFrags(t),this.removeParsedFrag(t)):c.b.info(`[subtitle] ignore PTS ${e.initPTS90k} for cc ${e.frag.cc}; not for frag ${t.frag.sn} ${t.frag.cc}`)()})}forgetFragsWaitingForInitPTS(){let e=this.unparsedVttFrags;return e.length&&(c.b.info(`[subtitle] forget ${e.length} frags waiting for initPTS`)(),this.unparsedVttFrags=[]),e}getExistingTrack(e){const t=this.media;if(t)for(let i=0;i<t.textTracks.length;i++){let s=t.textTracks[i],a="cc"+e;if(Xi(a)&&!0===s[a])return s}return null}sendAddTrackEvent(e,t){var i=null;try{i=new window.Event("addtrack")}catch(e){(i=document.createEvent("Event")).initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}createCaptionsTrackGuts(e,t,i){let s="cc"+e;if(!this.channelToTrackMap[s]){let a=this.getExistingTrack(e);if(a)this.channelToTrackMap[s]=a,ts(this.channelToTrackMap[s]),this.sendAddTrackEvent(this.channelToTrackMap[s],this.media);else{const e=this.createTextTrack("captions",t,i);e&&Xi(s)&&(e[s]=!0,this.channelToTrackMap[s]=e)}}return this.channelToTrackMap[s]}createCaptionsTrack(e){return this.createCaptionsTrackGuts(e,this.config["captionsTextTrack"+e+"Label"],this.config.captionsTextTrack1LanguageCode)}createTextTrack(e,t,i){const s=this.media;if(s){let a=!1;"metadata"!==e&&this.config.customTextTrackCueRenderer&&(a=!0,e="metadata");let r=s.addTextTrack(e,t,i);return a&&(r.customTextTrackCueRenderer=!0),r}}destroy(){P.prototype.destroy.call(this)}onMediaAttaching(e){this.media=e.media,this.mediaAttached=!0,this.attachSubtitleTracks()}onMediaDetaching(){ts(this.textTrack1),ts(this.textTrack2)}onManifestLoading(){this.lastSn=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0}}resetTracks(){this._cleanTracks(),this.cueRanges=[]}_cleanTracks(){const e=this.media;if(e){const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)ts(t[e])}}getCuesOfEnabledTrack(e,t=!1){let i=[];if(t){let t=this._getCuesOfEnabledTrack(e);for(let e=0;e<t.length;e++){let s=t[e];s.webVTTCue&&i.push(s)}}else i=this._getCuesOfEnabledTrack(e);return i}_getCuesOfEnabledTrack(e){let t=this.textTracks[e];return t&&t.cues?t.cues:null}attachSubtitleTracks(){this.mediaAttached&&this.manifestLoaded&&(this.tracks.forEach(e=>{let t;if("sbtl"===e.mediaType)t=this.createTextTrack("subtitles",e.name,e.lang);else{let i=1;e.inStreamID&&(i=Number(e.inStreamID.substring(2))),t=this.createCaptionsTrackGuts(i,e.name,e.lang)}this.textTracks.push(t)}),this.hls.trigger(s.a.SUBTITLE_TRACKS_CREATED,{}))}onManifestLoaded(e){this._cleanTracks(),this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.cueRanges=[],this.config.enableWebVTT&&(this.tracks=e.subtitleTracks||[]),this.manifestLoaded=!0,this.attachSubtitleTracks()}onLevelSwitching(){this.enabled=!0}onInlineStylesParsed(){}hasDiscontinuityOffset(e){return this.vttCCs[e]}_processUnparsedVttFrags(e){let t=e.frag,i=e.payload;i.byteLength?this._parseVTTs(t,i):this.hls.trigger(s.a.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t})}processSubtitleFrag(e){let t=e.frag,i=e.payload;i.byteLength?"initSegment"===t.sn?this.hls.trigger(s.a.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t}):isNaN(this.initPTS[t.cc])?(this.unparsedVttFrags.push(e),this.initPTS.length&&this.hls.trigger(s.a.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t})):this._parseVTTs(t,i):this.hls.trigger(s.a.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t})}onFragLoaded(e){let t=e.frag;if("main"===t.type&&"initSegment"!==t.sn){var i=t.sn;if(i!==this.lastSn+1){const e=this.cea608Parser;e&&e.reset()}this.lastSn=i}}_parseVTTs(e,t){let i=this.vttCCs;i[e.cc]||(i[e.cc]={start:e.start,prevCC:this.prevCC,new:!0},this.prevCC=e.cc);let a=this.textTracks,r=this.hls;Qi.parse(t,this.initPTS[e.cc],i,e.cc,(function(t){const i=a[e.trackId];t.forEach(e=>{if(!i.cues.getCueById(e.id))try{e.webVTTCue=!0,i.addCue(e)}catch(t){c.b.warn(`retry addCue. Previous addCue failed: ${t.message}`)();const s=new window.TextTrackCue(e.startTime,e.endTime,e.text);s.id=e.id,i.addCue(s)}}),r.trigger(s.a.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})}),(function(t){r.trigger(s.a.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e})}),(function(e){r.trigger(s.a.INLINE_STYLES_PARSED,{styles:e})}))}_ensureParser(){if(!this.cea608Parser){var e=new qi(this,1),t=new qi(this,2);this.cea608Parser=new Hi(0,e,t)}}onFragParsingCaptiondata(e){if(this.enabled&&this.config.enableCEA708Captions){this._ensureParser();for(let t=0;t<e.samples.length;t++){let i=e.samples[t].pts,s=e.samples[t].bytes;for(let e=0;e<s.length;e+=2){let a=[];a.push(s[e]),e+1<s.length?a.push(s[e+1]):(c.b.warn(`CEA608 sample ${t} not even length (index ${e+1} >= length ${s.length})`)(),a.push(80)),this.cea608Parser.addData(i,a),i+=es}}}}onFragParsingUserdata(e){if(this.enabled&&this.config.enableCEA708Captions){this._ensureParser();for(let t=0;t<e.samples.length;t++){let i=is.extractCea608Data(e.samples[t].bytes);this.cea608Parser.addData(e.samples[t].pts,i)}}}static extractCea608Data(e){for(var t,i,s,a=31&e[0],r=2,n=[],o=0;o<a;o++)t=e[r++],i=127&e[r++],s=127&e[r++],0===i&&0===s||0!=(4&t)&&0==(3&t)&&(n.push(i),n.push(s));return n}}let ss={maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},as={maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3};const rs={autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,defaultVideoCodec:void 0,debug:!1,debugLevel:void 0,buildType:void 0,minFramesBeforeSwitchingLevel:11,initialLiveManifestSize:1,maxBufferLength:30,maxBufferSize:6e7,maxBufferHole:.5,maxSeekHole:2,almostDryBufferSec:.5,maxTotalDurationTolerance:.1,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,seekWatchdogPeriod:5,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,liveFlushExpiredFrags:!0,maxMaxBufferLength:60,allowFastSwitchUp:!1,desiredIframeFPS:8,initialIframeFPS:6,minRemainingTimeInMediaPipeline:3,leftMediaTimeToAutoPause:10,startTargetDurationFactor:.9,enableWorker:!0,enableSoftwareAES:!0,keySystemPreference:void 0,clearMediaKeysOnPromise:!0,startLevel:void 0,livePlaylistRefreshDelay:2500,liveMinPlayingBufferLen:5,enableIFramePreloading:!0,useMediaCapabilities:!1,enableID3Cues:!0,manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:ss,errorRetry:as,forceContentLenCheckIfNoHeader:!1},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:ss,errorRetry:as}},maxNumAddLevelToPenaltyBox:4,fragLoadingLoopThreshold:3,firstAudioMustOverlapVideoStart:!1,keyLoadingDefaultTimeout:2e4,keyLoadingMinTimeout:3e3,keyLoadingRetryDelay:1e3,keyRetryCountOnError:3,startFragPrefetch:!1,appendErrorMaxRetry:3,alwaysResetOnNewCC:!1,loader:f,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,abrController:class extends P{constructor(e){super(e,s.a.LEVEL_LOADING,s.a.LEVELS_CHANGED,s.a.LEVEL_SWITCHING,s.a.FRAG_LOADING,s.a.FRAG_LOAD_PROGRESS,s.a.FRAG_LOADED,s.a.FRAG_BUFFERED,s.a.ERROR),this._nextAutoLevel=-1,this.shortTermBandwidthFactor=1.8,this.hls=e,this.onCheck=this._abandonRulesCheck.bind(this),this.flowMeasurementPeriodMS=2e3,this.underflowAllowanceMS=1e3,this.fragDownloadSlow=!1,this.fragDownloadTooSlow=!1,this.levelDownloadTooSlow=!1,this.numBandwidthSamples=0,this.minItemsInBandwidthAverage=4,"bandwidth-history-controller"===e.config.abrBandwidthEstimator&&this._ensureBwEstimator()}destroy(){this.clearTimer(),P.prototype.destroy.call(this)}_ensureBwEstimator(e=!1){if(!this._bwEstimator)if("bandwidth-history-controller"===this.hls.config.abrBandwidthEstimator)this._bwEstimator=this.hls.bandwidthHistoryController;else if("ewma"===this.hls.config.abrBandwidthEstimator){const{config:t}=this.hls;let i,s;e?(i=t.abrEwmaFastLive,s=t.abrEwmaSlowLive):(i=t.abrEwmaFastVoD,s=t.abrEwmaSlowVoD),this._bwEstimator=new class{constructor(e,t,i){this.hls=e,this.logger=e.logger,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Ii(t),this.fast_=new Ii(i)}sample({tparsed:e,tload:t,trequest:i,loaded:s}){this.getEstimate();const a=Math.max((e||t)-i,this.minDelayMs_);var r=8e3*s/a,n=a/1e3;this.fast_.sample(n,r),this.slow_.sample(n,r)}canEstimate(){let e=this.fast_;return e&&e.getTotalWeight()>=this.minWeight_}getEstimate(){if(this.canEstimate())return{avgLatencyMs:0,avgBandwidth:Math.min(this.fast_.getEstimate(),this.slow_.getEstimate())}}destroy(){}}(this.hls,s,i);const a=this.hls.bandwidthHistoryController.getEstimate();a&&a.avgBandwidth&&(this.minItemsInBandwidthAverage=1,this._bwEstimator.sample({trequest:0,tparsed:0,tfirst:0,tload:1e3*this.hls.config.defaultTargetDuration,loaded:a.avgBandwidth*this.hls.config.defaultTargetDuration/8}),++this.numBandwidthSamples)}}onFragLoading(e){let t=e.frag;"main"===t.type&&(this.fragDownloadTooSlow=!1,this.timer||(this.timer=setInterval(this.onCheck,100)),t&&!isNaN(t.level)&&this.hls.levelWithPersistentId(t.level).levelInfo?this._ensureBwEstimator(this.hls.levelWithPersistentId(t.level).levelInfo.details.live):this.logger.warn(`Invalid level id ${t.level} or level info, unable to process ensure bw estimator`)(),this.fragCurrent=t)}_abandonRulesCheck(){let e=this.hls,t=e.media,i=this.fragCurrent,a=i.loader,r=e.minAutoLevel,n=e.iframeMode;if(!a||a.stats&&a.stats.aborted||n)return!0!==i.loadSuccess&&this.logger.warn(`[${i.type}] loader of frag ${i.sn} level ${i.level} destroy or aborted, disarm abandonRules`)(),void this.clearTimer();let o=a.stats,l=e.levelWithPersistentId(i.level),d=l.levelInfo,h=l.levelListPosition;if(t&&(!t.paused&&0!==t.playbackRate||!t.readyState)&&i.autoLevel&&h){const l=performance.now();let c=l-o.trequest,u=Math.abs(t.playbackRate);if(c>500*i.duration/u){let f=e.levels,g=Math.max(1,o.bw?o.bw/8:1e3*o.loaded/c),p=d.realBitrate?Math.max(d.realBitrate,d.bitrate):d.bitrate,y=o.total?o.total:Math.max(o.loaded,Math.round(i.duration*p/8)),v=t.currentTime,T=(y-o.loaded)/g,S=(Mt.bufferInfo(t,v,e.config.maxBufferHole).end-v)/u;if(S<2*i.duration/u&&T>S){let t,d,c;for(c=h-1;c>r;c--){let s=f[c];if(s.iframes!==n)continue;if(s.url&&!m.isCustomUrl(s.url)&&!s.url.includes(this.hls.preferredHostName))continue;let a=s.realBitrate?Math.max(s.realBitrate,s.bitrate):s.bitrate;if(e.iframeMode&&(a*=e.config.desiredIframeFPS),t=i.duration*a/(6.4*g),d=s.persistentId,t<S)break}t<T&&(this.logger.warn(`loading too slow, abort fragment loading and switch to level ${d}:fragLoadedDelay[${d}]<fragLoadedDelay[${i.level-1}];bufferStarvationDelay:${t.toFixed(1)}<${T.toFixed(1)}:${S.toFixed(1)}`)(),e.nextAutoLevel=d,this._sampleBandwidth(Object.assign({},o,{tfirst:o.tfirst||l,tload:o.tload||l})),a.abort(),this.clearTimer(),this.fragDownloadTooSlow=!0,this._triggerBwChange(Di.LowBandwidth),e.trigger(s.a.FRAG_LOAD_EMERGENCY_ABORTED,{frag:i,stats:o}))}}}}_fragResponseIsValid(e){let t=this.hls,i=!0;return t.levelWithPersistentId(e).levelInfo||(t.trigger(s.a.ERROR,{type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!1,url:t.url,reason:"empty level info for level "+e,response:a.b.InternalError}),i=!1),i}onFragLoadProgress(e){let t=e.frag,i=e.stats;if("main"===t.type&&"initSegment"!==t.sn&&0!==i.loaded){if(!this._fragResponseIsValid(t.level))return;let e=this.hls.levelWithPersistentId(t.level).levelInfo,s=e.realBitrate?Math.max(e.realBitrate,e.bitrate):e.bitrate,a=i.total?i.total:Math.max(i.loaded,Math.round(t.duration*s/8)),r=performance.now()-i.tfirst,n=i.loaded*t.duration*1e3/a;r>=this.flowMeasurementPeriodMS&&r-n>=this.underflowAllowanceMS&&(this.fragDownloadSlow=!0),r>=1e3*t.duration&&(this.logger.warn(`[${t.type}] too much time spent downloading fragment, likely to switch down ${r} > ${1e3*t.duration}`)(),this.fragDownloadTooSlow=!0)}}onFragLoaded(e){let t=e.frag;if("main"===t.type&&"initSegment"!==t.sn){if(this.clearTimer(),!this._fragResponseIsValid(t.level))return;if(this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){const i=this.hls.levelWithPersistentId(t.level).levelInfo;let s=(i.loaded?i.loaded.bytes:0)+e.stats.loaded,a=(i.loaded?i.loaded.duration:0)+e.frag.duration;i.loaded={bytes:s,duration:a},i.realBitrate=Math.round(8*s/a)}if(e.frag.bitrateTest){let t=e.stats;t.tparsed=t.tbuffered=t.tload,this.onFragBuffered(e)}}}onFragBuffered(e){var t=e.stats,i=e.frag;if(!0!==t.aborted&&1===i.loadCounter&&"initSegment"!==i.sn&&(!i.bitrateTest||t.tload===t.tbuffered)){let e=t.tparsed-t.trequest,s=t.tload-t.trequest,a=t.tdataack-t.tload;if(this.logger.info(`[QE Critical] [${i.type}]latency/loading/dataack/parsing/append:${Math.round(t.tfirst-t.trequest)}/${Math.round(t.tload-t.tfirst)}/${Math.round(a)}/${Math.round(t.tparsed-t.tdataack)}/${Math.round(t.tbuffered-t.tparsed)}`)(),this.logger.info(`[QE Critical] [${i.type}]fragLoadingProcessingMs/stats.loaded/viddur/fragLoadMs: ${e}/${t.loaded}/${i.duration}/${s}`)(),"main"===i.type&&(this.fragDownloadSlow=!1),!("main"!==i.type&&"audio"!==i.type||i.iframe||isNaN(e))){this._sampleBandwidth(t),t.bwEstimate=this.getBandwidthEstimate(),i.bitrateTest?this.bitrateTestDelay=e/1e3:this.bitrateTestDelay=0;let s=this.hls.config.abrBandWidthUpFactor;this.getAdjustedBW(this.getBandwidthEstimate(),s,this.hls.config.abrBandWidthFactor).bwUp>this.highBWTrigger&&this._triggerBwChange(Di.HighBandwidth)}}}_triggerBwChange(e){this.logger.info(`bandwidth note ${e} ${Math.round(this.getBandwidthEstimate())/1e3}kbps`)(),this.hls.trigger(s.a.BANDWIDTH_CHANGED,{reason:e})}onLevelLoading(){this.levelDownloadTooSlow=!1}onLevelsChanged(){this.highBWTrigger=this._getLowestSuperiorBW(this.hls.streamController.level)}onLevelSwitching(e){this.highBWTrigger=this._getLowestSuperiorBW(e.persistentId)}onError(e){switch(e.details){case a.a.FRAG_LOAD_TIMEOUT:this.fragDownloadTooSlow=!0,this._triggerBwChange(Di.LowBandwidth),this.clearTimer();break;case a.a.FRAG_LOAD_ERROR:this.clearTimer();break;case a.a.LEVEL_LOAD_TIMEOUT:this.levelDownloadTooSlow=!0,this._triggerBwChange(Di.LowBandwidth)}}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=null)}isSafeToFlushExcessBuffer(){if(-1!==this._nextAutoLevel&&!this.getBandwidthEstimate(0))return!1;let e=this._bufferedDuration;return this._holdOffDuration&&e>this._holdOffDuration}getSafeBufferFlushPosition(){return this._holdOffDuration}get nextAutoLevel(){const e=this._nextAutoLevel;if(-1!==e&&!this.getBandwidthEstimate(0))return e;let t=this._nextABRAutoLevel;return-1!==e&&(t=Math.min(e,t)),t}get _bufferedDuration(){var e=this.hls;const t=e.media,i=t?t.currentTime:0,s=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1;return(Mt.bufferInfo(t,i,e.config.maxBufferHole).end-i)/s}findNextABRAutoLevelInMode(e){var t=this.hls,i=t.maxAutoLevel,s=t.levels,a=t.config,r=t.minAutoLevel;const n=this.hls.streamController.level,o=this.hls.levelWithPersistentId(n).levelInfo,l=o?o.details:void 0,d=this.getBandwidthEstimate(),h=this._bufferedDuration;let c,u,f;if(e){const s=this.hls.config.desiredIframeFPS;f=this.fragCurrent&&void 0!==this.fragCurrent.iframeMediaDuration?this.fragCurrent.iframeMediaDuration:l?l.targetduration/s:0,f=Math.max(1/s,f),t.iframeMode!==e&&(i=t.maxLevelIframeMode,r=t.minLevelIframeMode)}else f=this.fragCurrent&&void 0!==this.fragCurrent.duration?this.fragCurrent.duration:l?l.targetduration:0;if((u=(c=this._findBestLevel(n,f,d,r,i,h,a.abrBandWidthFactor,a.abrBandWidthUpFactor,s,e)).levelId)<0){let t=f?Math.min(f,a.maxStarvationDelay):a.maxStarvationDelay,o=a.abrBandWidthFactor,l=a.abrBandWidthUpFactor;if(0===h){let e=this.bitrateTestDelay;e&&(t=(f?Math.min(f,a.maxLoadingDelay):a.maxLoadingDelay)-e,o=l=1)}c=this._findBestLevel(n,f,d,r,i,h+t,o,l,s,e),u=Math.max(c.levelId,this.hls.getLowestBitrateLevel(s))}return this._holdOffDuration=c.holdOffDuration,u}_getLowestSuperiorBW(e){let t=1/0,i=this.hls.levelWithPersistentId(e),s=i.levelInfo;if(!s)return;let a=i.levelListPosition,r=s.frameRate,n=s.realBitrate?Math.max(s.realBitrate,s.bitrate):s.bitrate,o=this.hls.levels,l=Math.min(this.hls.maxAutoLevel,o.length-1);for(let e=this.hls.config.abrMaxWithRealBitrate?this.hls.minAutoLevel:Math.max(this.hls.minAutoLevel,a+1);e<=l;++e){let i=o[e];if(i.iframes!==s.iframes||void 0!==r&&i.frameRate<r)continue;let a=i.realBitrate?Math.max(i.realBitrate,i.bitrate):i.bitrate;if(a>n&&(t=Math.min(a,t),!this.hls.config.abrMaxWithRealBitrate))break}return t}set highBWTrigger(e){this._highBWTrigger!==e&&(this._highBWTrigger=e)}get highBWTrigger(){return this._highBWTrigger}get avgBW(){return this.logger.warn("abrController.getBandwidthEstimate() is deprecated and will be removed in a future release.")(),this.getBandwidthEstimate()}getBandwidthEstimate(e=this.hls.config.abrEwmaDefaultEstimate){const t=this._bwEstimator?this._bwEstimator.getEstimate():void 0;return t?t.avgBandwidth:e}_sampleBandwidth(e){++this.numBandwidthSamples,this._bwEstimator.sample(e),this._bwEstimator!==this.hls.bandwidthHistoryController&&this.hls.bandwidthHistoryController.sample(e)}getAdjustedBW(e,t,i){let s,a;return this.numBandwidthSamples>=this.minItemsInBandwidthAverage?(s=e*t,a=e*i):s=a=e/this.shortTermBandwidthFactor,{bwUp:s,bwDown:a}}shouldSwitchLevel(){let e=this.hls.iframeMode,t=this.hls.streamController.level,i=this.hls.levelWithPersistentId(t).levelInfo,s=i?i.realBitrate?Math.max(i.realBitrate,i.bitrate):i.bitrate:void 0,a=i&&e!==Boolean(i.iframes),r=this.getAdjustedBW(this.getBandwidthEstimate(),this.hls.config.abrBandWidthUpFactor,this.hls.config.abrBandWidthFactor),n=!this.hls.seeking&&!this.hls.waitingForIncompatibleCCFragLoad,o=n&&this.highBWTrigger&&r.bwUp>this.highBWTrigger,l=n&&r.bwDown<=s||this.fragDownloadTooSlow||this.levelDownloadTooSlow,d=this.hls.playbackLikelyToKeepUp;this._shouldCheckBuffer&&!d?this._shouldCheckBuffer=!1:this._shouldCheckBuffer||!d&&!l||(this._shouldCheckBuffer=!0);let h=this._shouldCheckBuffer&&!d;return!!(!i||a||o||l||h)}get _nextABRAutoLevel(){let e,t=this.hls,i=t.iframeMode,s=t.config.minFramesBeforeSwitchingLevel;if(i){let a=t.countIframesInCurrentLevel();e=!t.levelWithPersistentId(a.level).levelInfo||a.loading+a.buffered===0||a.buffered>=s?this.findNextABRAutoLevelInMode(i):a.level}else e=this.shouldSwitchLevel()?this.findNextABRAutoLevelInMode(i):this.hls.streamController.level;return e}_findBestLevel(e,t,i,s,a,r,n,o,l,d){let h=this.hls.levelWithPersistentId(e).levelInfo,c=this.getAdjustedBW(i,o,n);for(let i=a;i>=s;i--){let s,a=l[i],n=a.details,o=n?n.totalduration/n.fragments.length:t,u=!!n&&n.live,f=a.persistentId,g=a.url,p=f>e;if(void 0===o)continue;if(a.iframes!==d)continue;if(g&&!m.isCustomUrl(g)&&!g.includes(this.hls.preferredHostName))continue;s=f<=e?c.bwDown:c.bwUp;let y=h?h.frameRate:void 0;if(void 0!==y&&(f>e&&a.frameRate<y||f<e&&a.frameRate>y))continue;let v=l[i].realBitrate?Math.max(l[i].realBitrate,l[i].bitrate):l[i].bitrate;const T=v*o/s,S=l[i].bandwidth;let b=t,_=s>v&&s<S&&this._bufferedDuration<=2*b;if(s>v&&(d||!T||u&&!this.bitrateTestDelay||T<r)&&!_){if(p&&h&&h.height>a.height)continue;return this.fragDownloadSlow&&this._bufferedDuration<=2*b&&f>e&&(f=e),(!this.gotFirst||f!==e&&d===this.hls.iframeMode)&&(this.gotFirst=!0,this.logger.info(`[abr] level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: ${f}/${Math.round(s)}/${v}/${o}/${r}/${T}`)()),{levelId:f,holdOffDuration:T}}}return{levelId:-1,holdOffDuration:-1}}set nextAutoLevel(e){if(isNaN(e))try{throw Error("nextAutoLevel set with NaN")}catch(e){this.logger.warn(`${e.message} ${e.stack}`)()}this._nextAutoLevel=e}},bufferController:class extends P{constructor(e){super(e,s.a.MEDIA_ATTACHING,s.a.MEDIA_DETACHING,s.a.MANIFEST_PARSED,s.a.LEVEL_PTS_UPDATED,s.a.LEVEL_UPDATED,s.a.AUDIO_TRACK_LOADED),this._levelTargetDuration=10,this._needsFlush=!1,this._needsEos=!1,this.bufferCodecEventsExpected=0,this.segments=[],this.appending=!1,this.appended=0,this.appendError=0,this.flushBufferCounter=0,this.sourceBuffer={},this.flushRange=[],this._msDuration=null,this._levelDuration=null,this.onsbue=this.onSBUpdateEnd.bind(this),this.onsbe=this.onSBUpdateError.bind(this),this.pendingTracks={},this.tracks={},this.trackCodecByCC={},this.invalidSourceBufferNb=0,this.sourceBufferTimeout=1e4,this.alwaysResetOnNewCC=e.config.alwaysResetOnNewCC}destroy(){this._clearTimer(),P.prototype.destroy.call(this)}_clearTimer(){this.sbOpenTimer&&(clearTimeout(this.sbOpenTimer),this.sbOpenTimer=null)}onLevelPtsUpdated(e){let t=e.type,i=this.tracks.audio;if("audio"===t&&i&&"audio/mpeg"===i.container){let t=this.sourceBuffer.audio;if(Math.abs(t.timestampOffset-e.start)>.1){let i=t.updating;try{t.abort()}catch(e){i=!0,this.logger.warn("can not abort audio buffer: "+e)()}i?this.audioTimestampOffset=e.start:(this.logger.warn("change mpeg audio timestamp offset from "+t.timestampOffset+" to "+e.start)(),t.timestampOffset=e.start)}}this.onLevelUpdated(e)}onManifestParsed(e){let t=e.audio,i=e.video||e.levels.length&&e.altAudio,s=0;e.altAudio&&(t||i)&&(s=(t?1:0)+(i?1:0)),this.sourceBufferNb=s}onMediaAttaching(e){this.logger.info("media source attaching")();let t=this.media=e.media;if(t){var i=this.mediaSource=new MediaSource;this.onmso=this.onMediaSourceOpen.bind(this),this.onmse=this.onMediaSourceEnded.bind(this),this.onmsc=this.onMediaSourceClose.bind(this),i.addEventListener("sourceopen",this.onmso),i.addEventListener("sourceended",this.onmse),i.addEventListener("sourceclose",this.onmsc),t.src=URL.createObjectURL(i),this._objectUrl=t.src,this.sbOpenTimer||(this.sbOpenTimer=setTimeout(this._handleMediaSourceTimeout.bind(this),this.sourceBufferTimeout))}}onMediaDetaching(){this.logger.info("media source detaching")();var e=this.mediaSource;if(e){if("open"===e.readyState)try{e.endOfStream()}catch(e){this.logger.error(`onMediaDetaching:${e.message} while calling endOfStream`)()}e.removeEventListener("sourceopen",this.onmso),e.removeEventListener("sourceended",this.onmse),e.removeEventListener("sourceclose",this.onmsc),this.media&&(URL.revokeObjectURL(this._objectUrl),this.media.src===this._objectUrl?(this.media.removeAttribute("src"),this.media.load()):this.logger.warn("media.src was changed by a third party - skip cleanup")()),this.mediaSource=null,this.media=null,this._objectUrl=null,this.pendingTracks={},this.tracks={},this.sourceBuffer={},this.flushRange=[],this.segments=[],this.appended=0,this.currentCC=void 0}this.onmso=this.onmse=this.onmsc=null,this._clearTimer(),this.resettingMediaSource||this.hls.trigger(s.a.MEDIA_DETACHED)}_handleMediaSourceTimeout(){this.logger.warn("Timeout while waiting for sourceopen callback from MediaSource")(),this.sbOpenTimer=null}onMediaSourceOpen(){this._clearTimer(),this.resettingMediaSource?(this.resettingMediaSource=!1,this.updateMediaElementDuration(),this.hls.trigger(s.a.BUFFER_SOURCE_RESET,{media:this.media,startPosition:this.resetStartPosition})):this.hls.trigger(s.a.MEDIA_ATTACHED,{media:this.media});let e=this.mediaSource;e&&e.removeEventListener("sourceopen",this.onmso),this.checkPendingTracks()}ignoreSourceBuffer(e){let t=this.mediaSource;t&&t.sourceBuffers&&t.sourceBuffers.length>0?this.invalidSourceBufferNbAfterReset=e:(this.invalidSourceBufferNb=e,this.checkPendingTracks())}checkPendingTracks(){let e=this.pendingTracks,t=Object.keys(e).length,i=this.sourceBufferNb-this.invalidSourceBufferNb;t&&(i<=t||0===i)&&(this.createSourceBuffers(e),this.pendingTracks={},this.doAppending())}onMediaSourceClose(){}onMediaSourceEnded(){}onSBUpdateEnd(){if(this.audioTimestampOffset){let e=this.sourceBuffer.audio;this.logger.warn("change mpeg audio timestamp offset from "+e.timestampOffset+" to "+this.audioTimestampOffset)(),e.timestampOffset=this.audioTimestampOffset,delete this.audioTimestampOffset}this._needsFlush&&this.doFlush(),this._needsEos&&this.checkEos(),this.appending=!1;let e=this.parent,t=this.segments.reduce((t,i)=>i.parent===e?t+1:t,0),i={};const a=this.sourceBuffer;for(let e in a)i[e]=a[e].buffered;this.hls.trigger(s.a.BUFFER_APPENDED,{parent:e,pending:t,timeRanges:i}),this._needsFlush||this.doAppending(),this.updateMediaElementDuration()}onSBUpdateError(e){this.logger.error("sourceBuffer error:",e)(),this.hls.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.BUFFER_APPENDING_ERROR,fatal:!1,response:a.b.VideoDecoderBadDataErr})}resetMediaSource(e,t=!1){if(this.media&&!this.resettingMediaSource){let i=this.media;this.resettingMediaSource=!0,this.resetStartPosition=e,this.resetBuffer(t),this.hls.trigger(s.a.BUFFER_SOURCE_RESETTING,{}),this.onMediaDetaching(),this.onMediaAttaching({media:i})}}resetBuffer(e=!1){let t=this.sourceBuffer;for(let i in t){let s=t[i];try{this.mediaSource.removeSourceBuffer(s),s.removeEventListener("updateend",this.onsbue),s.removeEventListener("error",this.onsbe)}catch(e){this.logger.error(e)()}}this._needsFlush=!1,this.sourceBuffer={},this.flushRange=[],this.segments=[],this.appended=0,e?(this.invalidSourceBufferNb=0,this.invalidSourceBufferNbAfterReset=void 0):this.invalidSourceBufferNbAfterReset?(this.invalidSourceBufferNb=this.invalidSourceBufferNbAfterReset,this.invalidSourceBufferNbAfterReset=void 0):this.invalidSourceBufferNb=0}createBuffer(e,t,i){if(0===Object.keys(this.sourceBuffer).length){for(let s in i)this.pendingTracks[s]=Object.assign(Object.assign({},i[s]),{id:e,cc:t});let s=this.mediaSource;s&&"open"===s.readyState&&this.checkPendingTracks()}}createSourceBuffers(e){const t=this.sourceBuffer,i=this.mediaSource;let r={};for(let n in e)if(!t[n]){let o=e[n],l=this.pickCodec(o),d=`${o.container};codecs=${l}`;this.logger.info(`creating sourceBuffer(${d})`)();try{let h=t[n]=i.addSourceBuffer(d);h.timestampOffset=-1*this.hls.config.audioPrimingDelay,h.addEventListener("updateend",this.onsbue),h.addEventListener("error",this.onsbe),this.tracks[n]={codec:l,container:o.container,cc:o.cc},r[n]={id:o.id,codec:l,container:o.container,buffer:h},void 0!==this.currentCC&&this.currentCC!==o.cc?this.logger.error("createSourceBuffers: track cc mismatch!")():this.currentCC=o.cc}catch(e){this.logger.error(`error while trying to add sourceBuffer:${e.message}`)(),this.hls.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.BUFFER_ADD_CODEC_ERROR,fatal:!1,err:e,mimeType:d,response:a.b.VideoDecoderBadDataErr})}}this.hls.trigger(s.a.BUFFER_CREATED,{tracks:r})}pickCodec(e){let t=e.codec||e.levelCodec;return void 0===t&&(t=""),t}updateKnownCodecs(e,t,i){let a=!1,r=!0;for(let e in i){if("metadata"===e)continue;let s=i[e],n=this.pickCodec(s);if(this.trackCodecByCC[e]||(this.trackCodecByCC[e]={}),this.trackCodecByCC[e][t]){let i=this.trackCodecByCC[e][t];r=r&&jt.b.isCompatibleCodecString(i,n)}else a=!0;this.trackCodecByCC[e][t]=n}return a&&this.hls.trigger(s.a.BUFFER_CODEC_UPDATED,{parent:e}),r}isTrackCompatibleTransition(e,t){let i=this.currentCC;if(void 0===i||i===t)return!0;if(this.alwaysResetOnNewCC)return!1;let s,a=this.trackCodecByCC,r=a[e]&&a[e][i]?a[e][i]:void 0,n=a[e]&&a[e][t]?a[e][t]:void 0;return r&&n?s=jt.b.isCompatibleCodecString(r,n):a.audiovideo&&a.audiovideo[i]&&(a.video&&a.video[t]||a.audio&&a.audio[t])?s=!1:(a.audio&&a.audio[i]||a.video&&a.video[i])&&a.audiovideo&&a.audiovideo[t]?s=!1:n&&(s=!1),s}isParentCompatibleTransition(e,t){return e===Gt.Main?this.trackCodecByCC.audiovideo?this.isTrackCompatibleTransition("audiovideo",t):this.isTrackCompatibleTransition("video",t):e===Gt.Audio?this.isTrackCompatibleTransition("audio",t):void 0}isCompatibleTransitionWithSeparateSourceBuffers(e){let t,i=this.isTrackCompatibleTransition("video",e),s=2!==this.sourceBufferNb||this.isTrackCompatibleTransition("audio",e);return!1===i||!1===s?t=!1:i&&s&&(t=!0),t}isCompatibleTransitionWithCombinedSourceBuffer(e){return this.isTrackCompatibleTransition("audiovideo",e)}isCompatibleTransition(e){return this.trackCodecByCC.audiovideo?this.isCompatibleTransitionWithCombinedSourceBuffer(e):this.isCompatibleTransitionWithSeparateSourceBuffers(e)}appendBuffer(e,t,i,s){let a={type:e,data:t,parent:i,content:s};this._needsFlush||(this.segments?this.segments.push(a):this.segments=[a],this.doAppending())}onBufferAppendFail(e){this.logger.error("sourceBuffer error:",e.event)(),this.hls.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.BUFFER_APPENDING_ERROR,fatal:!1,response:a.b.VideoDecoderBadDataErr})}endBuffer(e){var t=this.sourceBuffer;for(let i in t)e&&i!==e||t[i].ended||(t[i].ended=!0,this.logger.info(`${i} sourceBuffer now EOS`)());this.checkEos()}checkEos(){var e=this.sourceBuffer,t=this.mediaSource;if(t&&"open"===t.readyState){for(let t in e){let i=e[t];if(!i.ended)return;if(i.updating)return void(this._needsEos=!0)}this.logger.info("all media data available, signal endOfStream() to MediaSource and stop loading fragment")();try{t.endOfStream()}catch(e){this.logger.warn("exception while calling mediaSource.endOfStream()")()}this._needsEos=!1}else this._needsEos=!1}flushBufferRange(e,t,i,s=!1){this.flushRange.push({start:e,end:t,type:i,forceAll:s}),this.flushBufferCounter=0,this.doFlush()}onLevelUpdated(e){let t=e.details;0!==t.fragments.length&&(this._levelDuration=t.totalduration+t.fragments[0].start,this.updateMediaElementDuration())}onAudioTrackLoaded(e){this.onLevelUpdated(e)}updateMediaElementDuration(){let e=this.media,t=this.mediaSource,i=this.sourceBuffer,s=this._levelDuration;if(null===s||!e||!t||"open"!==t.readyState)return;for(let e in i)if(i[e].updating)return;let a=e.duration;if(null===this._msDuration||!isFinite(a)||s>this._msDuration&&s>a)try{t.duration=s,this._msDuration=s}catch(e){this.logger.error(`Exception setting mediasource duration ${e.message}`)()}}doFlush(){for(;this.flushRange.length;){var e=this.flushRange[0];if(!this.flushBuffer(e.start,e.end,e.type,e.forceAll))return void(this._needsFlush=!0);this.flushRange.shift(),this.flushBufferCounter=0}if(0===this.flushRange.length){this._needsFlush=!1;var t=0,i=this.sourceBuffer;try{for(var a in i)t+=i[a].buffered.length}catch(e){this.logger.error("error while accessing sourceBuffer.buffered")()}this.appended=t,this.hls.trigger(s.a.BUFFER_FLUSHED)}}doAppending(){var e=this.hls,t=this.sourceBuffer,i=this.segments;if(Object.keys(t).length){if(this.media.error)return this.segments=[],void this.logger.error("trying to append although a media error occured, flush segment and abort")();if(this.appending)return;if(i&&i.length){let n=i.shift();try{let o=t[n.type];o?o.updating?i.unshift(n):(o.ended=!1,this.hls.trigger(s.a.BUFFER_APPENDING,n),this.parent=n.parent,o.appendBuffer(n.data),this.appendError=0,this.appended++,this.appending=!0):this.onSBUpdateEnd()}catch(t){this.logger.error(`error while trying to append buffer:${t.message}`)(),i.unshift(n);var r={type:a.c.MEDIA_ERROR,parent:n.parent};if(22===t.code)return this.segments=[],r.details=a.a.BUFFER_FULL_ERROR,r.fatal=!1,r.response=a.b.AllocationFailed,void e.trigger(s.a.ERROR,r);if(this.appendError?this.appendError++:this.appendError=1,r.details=a.a.BUFFER_APPEND_ERROR,r.response=a.b.VideoDecoderBadDataErr,this.appendError>e.config.appendErrorMaxRetry)return this.logger.error(`fail ${e.config.appendErrorMaxRetry} times to append segment in sourceBuffer`)(),i=[],r.fatal=!0,void e.trigger(s.a.ERROR,r);r.fatal=!1,e.trigger(s.a.ERROR,r)}}}}abortBuffer(e){let t=this.sourceBuffer;if(Object.keys(t).length){let i=t[e];i&&(this.logger.warn("aborting any appends for "+e)(),i.abort())}}flushBuffer(e,t,i,s=!1){var a,r,n,o,l,d,h=this.sourceBuffer;if(Object.keys(h).length)if(this.logger.info(`flushBuffer,pos/start/end/forceAll: ${this.media.currentTime.toFixed(3)}/${e}/${t}/${s}`)(),this.flushBufferCounter<this.appended){for(var c in h)if(!i||c===i){if((a=h[c]).ended=!1,a.updating)return this.logger.warn("cannot flush, sb updating in progress")(),!1;try{for(r=0;r<a.buffered.length;r++)if(n=a.buffered.start(r),o=a.buffered.end(r),-1!==navigator.userAgent.toLowerCase().indexOf("firefox")&&t===Number.POSITIVE_INFINITY?(l=e,d=t):(l=Math.max(n,e),d=Math.min(o,t)),s||Math.min(d,o)-l>.5)return this.flushBufferCounter++,a.remove(l,d),!1}catch(e){this.logger.warn("exception while accessing sourcebuffer, it might have been removed from MediaSource")()}}}else this.logger.warn("abort flushing too many retries")();return!0}},audioStreamController:class extends ei{constructor(e){super(e,s.a.MEDIA_ATTACHING,s.a.MEDIA_DETACHING,s.a.AUDIO_TRACKS_UPDATED,s.a.AUDIO_TRACK_SWITCHING,s.a.AUDIO_TRACK_LOADED,s.a.FRAG_PARSING_INIT_SEGMENT,s.a.FRAG_PARSING_DATA,s.a.FRAG_PARSED,s.a.ERROR,s.a.BUFFER_CREATED,s.a.BUFFER_APPENDED,s.a.BUFFER_FLUSHED,s.a.BUFFER_CODEC_UPDATED,s.a.BUFFER_SOURCE_RESETTING,s.a.BUFFER_SOURCE_RESET,s.a.INIT_PTS_FOUND),this.audioCodecSwap=!1,this.ontick=this.doTick.bind(this),this.waitingFragment=null,this.initPTS=[]}destroy(){this.stopLoad(),this.tickInterval&&(clearInterval(this.tickInterval),this.tickInterval=null),this.clearTickImmediate(),P.prototype.destroy.call(this),this.state=Kt.STOPPED}onInitPtsFound(e){let t=e.id,i=e.frag.cc,s=e.initPTS90k;if("main"===t&&(this.initPTS[i]=s,this.state===Kt.WAITING_INIT_PTS))if(this.waitingFragment)this.state=Kt.FRAG_LOADING,this._processLoadedFrag(this.waitingFragment),this.waitingFragment=null;else{if(this.hls.config.firstAudioMustOverlapVideoStart){let t=e.frag,i=isNaN(t.startPTS)?t.start:t.startPTS;this.nextLoadPosition=this.lastCurrentTime=this.startPosition=i}this.state=Kt.IDLE}}startLoad(e){if(this.tracks){var t=this.lastCurrentTime;this.stopLoad(),this.tickInterval||(this.tickInterval=setInterval(this.ontick,100)),this.fragLoadError=0,t>0&&-1===e||(this.lastCurrentTime=this.startPosition?this.startPosition:e),this.state=Kt.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime,this.tick()}else this.startPosition=e,this.state=Kt.STOPPED}stopLoad(){var e=this.fragCurrent;e&&(e.loader&&e.loader.abort(),this.fragCurrent=null),this.fragPrevious=null,this._destroyDemuxer(),this.state=Kt.STOPPED}startIframeTransition(e,t){this.waitForSeek=t;let i=!!this.mediaBuffer&&kt.isBuffered(this.mediaBuffer,e);if(void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold),this.state===Kt.FRAG_LOADING){var s=this.fragCurrent;s&&(s.loader&&!i&&(s.start>=e||s.start+s.duration<=e)&&(this.logger.info(`[iframes] currently loading audio range: ${s.start.toFixed(3)}-${(s.start+s.duration).toFixed(3)}, outside of seekToPos: ${e}, cancel it`)(),s.loader.abort()),this.fragCurrent=null),this.fragPrevious=null,this.state=Kt.IDLE}i||(this.lastCurrentTime=this.nextLoadPosition=e)}get pendingIncompatCC(){return this._pendingIncompatCC}set pendingIncompatCC(e){this._pendingIncompatCC=e}tick(){this.tickImmediate||(this.tickImmediate=Object(qt.setImmediate)(this.doTick.bind(this)))}clearTickImmediate(){Object(qt.clearImmediate)(this.tickImmediate),this.tickImmediate=null}flushAudioBuffer(e,t){this.state=Kt.BUFFER_FLUSHING,this.hls.bufferController.flushBufferRange(e,t,"audio")}resetNextLoadPositionState(){this.loadedmetadata||(this.nextLoadPosition,this.startPosition,this.startFragRequested=!1,this.nextLoadPosition=this.startPosition)}getAudioTimeRangeForCC(e){if(!this.tracks||isNaN(this.trackId))return;let t=this.hls.audioTrackController.resolveTrackId(this.trackId).trackInfo;return t&&t.details?Ft.getTimeRangeForCC(t.details.fragments,e):void 0}doTick(){this.clearTickImmediate();const e=this.hls,t=e.config;switch(this.state){case Kt.ERROR:case Kt.PAUSED:case Kt.BUFFER_FLUSHING:break;case Kt.IDLE:{let i,r;if(!this.tracks)break;if(!this.media&&(this.startFragRequested||!t.startFragPrefetch))break;if(this.hls.isLive&&0===this.hls.desiredRate)return;i=this.loadedmetadata&&!this.waitForSeek?this.media.currentTime:this.nextLoadPosition;let n=this.getSourceBufferInfo(i),o=n.len,l=n.end,d=this.fragPrevious,h=t.maxBufferLength,c=this.audioSwitch,u=this.trackId;if(this.pendingParsedData){this.pendingParsedData.frag,this.state=Kt.PARSING,this.appended=!1,this.onFragParsingData(this.pendingParsedData),this.state===Kt.PARSING&&(this.onFragParsed(this.pendingParsedData),this.pendingParsedData=void 0);break}if(o<h||c){let o=this.hls.audioTrackController.resolveTrackId(u).trackInfo;if(!o)return;r=o.details;let h=this.hls.streamController.getSourceBufferInfo(i);if(this.hls.audioTrackController.updateTrack(u),this.hls.playlistLoader.isLoadingAudioTrack(u)){this.state=Kt.PLAYLIST_LOADING;break}if(!this.hls.playbackLikelyToKeepUp&&!this.hls.streamController.iframeMode&&n.end>h.end+r.targetduration){let e=performance.now();(!this.tlastCatchupReport||e-this.tlastCatchupReport>1e3)&&(this.tlastCatchupReport=e,this.logger.info(`[audio] waiting for video to catch up @ ${i.toFixed(3)} ${kt.toRangeString(h)}/${kt.toRangeString(n)} targetDuration=${r.targetduration}`)());break}if(this.hls.config.firstAudioMustOverlapVideoStart&&!this.startFragRequested&&this.hls.streamController){let e=this.hls.streamController.fragCurrent;if(!e||isNaN(e.start)){this.state=Kt.WAITING_INIT_PTS;break}i=this.nextLoadPosition=e.start}if(!c&&!r.live&&d&&d.sn===r.endSN&&!this.hls.iframeMode&&(!this.media.seeking||this.media.duration-l<d.duration/2)){this.hls.bufferController.endBuffer("audio"),this.state=Kt.ENDED;break}let f,g=r.fragments,m=g.length,p=g[0].start,y=g[m-1].start+g[m-1].duration;if(c)if(this.startFragRequested&&r.live&&!r.PTSKnown)l=0;else if(l=i,r.PTSKnown&&i<p){if(!(n.end>p||n.nextStart))return;this.logger.info("[audio] adjust currentTime to alt audio track start")(),this.media.currentTime=p+.05}if(l<=p){if(f=g[0],r.live&&f.loadIdx&&f.loadIdx===this.fragLoadIdx){const e=n.nextStart?n.nextStart:p;return this.logger.info(`[audio] no alt audio available @currentTime:${this.media.currentTime}, seeking @${e+.05}`)(),void(this.media.currentTime=e+.05)}}else{let e,t=this.hls.config.firstAudioMustOverlapVideoStart?0:this.hls.config.maxFragLookUpTolerance;if(e=Ft.findFragmentBySNAndBuffer(d,g,l,y,t),this.hls.isLive&&null===d&&e&&"number"==typeof e.sn&&(l>=y||y-l<=t)&&g.length>0&&e.sn===g[g.length-1].sn&&e.level===g[g.length-1].level&&(this.logger.info(`Dropping ${e.sn} as a repeat download`)(),e=null),e){if(f=e,p=e.start,this.hls.streamController&&!this.loadedmetadata){let e=this.hls.streamController.fragCurrent;"initSegment"!==f.sn&&e&&e.cc!==f.cc&&f.sn<r.endSN&&(this.logger.warn(`mismatching cc @pos:${i.toFixed(3)} main:${e.cc} audio:${f.cc} bumping one ahead`)(),f=g[f.sn+1-r.startSN],e.cc!==f.cc&&(this.logger.error(`still mismatching cc main:${e.cc} audio:${f.cc}`)(),f=null))}d&&f&&f.level===d.level&&f.sn===d.sn&&(f="initSegment"!==f.sn&&f.sn<r.endSN?g[f.sn+1-r.startSN]:null)}}if(f){f.decryptdata&&f.decryptdata.isEncrypted&&(this.keyRequestPromise=this.hls.keyLoader.getKeyFromDecryptData(f.decryptdata,f.level),this.keyRequestPromise.then(function(){this.keyRequestPromise=void 0,this.state===Kt.KEY_LOADING&&(this.state=Kt.IDLE,this.tick())}.bind(this)).catch((function(){}))),r.initSegments[f.cc]&&!r.initSegments[f.cc].data&&(f=r.initSegments[f.cc]);let n="initSegment"===f.sn||this.hls.bufferController.isCompatibleTransition(f.cc);if(void 0===n&&(n=void 0===this.hls.bufferController.isParentCompatibleTransition(Gt.Audio,f.cc)),n||(this.state=Kt.WAITING_DISCONTINUITY),n){if(void 0!==this.fragLoadIdx?this.fragLoadIdx++:this.fragLoadIdx=0,f.loadCounter){f.loadCounter++;let i=t.fragLoadingLoopThreshold;if(f.loadCounter>i&&Math.abs(this.fragLoadIdx-f.loadIdx)<i)return void e.trigger(s.a.ERROR,{type:a.c.MEDIA_ERROR,details:a.a.FRAG_LOOP_LOADING_ERROR,fatal:!1,frag:f,response:a.b.CorruptStream})}else f.loadCounter=1;f.loadIdx=this.fragLoadIdx,this.fragCurrent=f,this.startFragRequested=!0,"initSegment"!==f.sn&&(this.nextLoadPosition=f.start+f.duration),this.logger.info(`${f.type} loading ${f.sn} of [${r.startSN},${r.endSN}], trackId: ${u}, cc: ${f.cc}, range: ${f.rangeString}, currentTime: ${this.media.currentTime}, pos:${i?i.toFixed(3):"undefined"}, bufferEnd:${l?l.toFixed(3):"undefined"} URL ${this.hls.redactUrl(f.relurl)} `)(),e.fragmentLoader.loadFragment(f).then(function(e){this._processLoadedFrag(e)}.bind(this)).catch(function(e){this._handleFragmentError(e)}.bind(this)),this.demuxImmediate=Object(qt.setImmediate)(this._ensureDemuxer.bind(this)),this.state=Kt.FRAG_LOADING}}}break}case Kt.PLAYLIST_LOADING:if(!this.hls.playlistLoader.isLoadingAudioTrack(this.trackId)){let e=this.hls.audioTrackController.resolveTrackId(this.trackId).trackInfo;e&&e.details&&(this.state=Kt.IDLE)}break;case Kt.FRAG_LOADING_WAITING_RETRY:{let e=performance.now(),t=this.retryDate,i=this.media,s=i&&i.seeking;(!t||e>=t||s)&&(this.state=Kt.IDLE);break}case Kt.WAITING_INIT_PTS:case Kt.STOPPED:case Kt.FRAG_LOADING:case Kt.KEY_LOADING:case Kt.PARSING:case Kt.PARSED:case Kt.ENDED:}}get loadedmetadata(){return this.hls.streamController.loadedmetadata}getSourceBufferInfo(e,t=this.config.maxBufferHole){return kt.bufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,e,t)}onMediaAttaching(e){let t=this.config,i=this.tracks&&t.autoStartLoad?t.startPosition:-1;this._attachMedia(e.media,i)}_attachMedia(e,t){this.media=this.mediaBuffer=e,this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),e.addEventListener("seeking",this.onvseeking),e.addEventListener("ended",this.onvended),t>=0&&this.startLoad(t)}onMediaDetaching(){var e=this.media;e&&e.ended&&(this.startPosition=this.lastCurrentTime=0);var t=this.tracks;t&&t.forEach(e=>{e.details&&e.details.fragments.forEach(e=>{e.loadCounter=void 0})}),e&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvseeked=this.onvended=void 0),this.media=this.mediaBuffer=null,this.stopLoad(),this.hls.config.firstAudioMustOverlapVideoStart&&(this.initPTS=[])}onMediaSeeking(){this.state!==Kt.ENDED&&this.state!==Kt.WAITING_DISCONTINUITY||(this.state=Kt.IDLE),this.media&&!this.waitForSeek&&(this.lastCurrentTime=this.nextLoadPosition=this.media.currentTime),void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold),this.waitForSeek=!1,this.tick()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onAudioTracksUpdated(e){this.tracks=e.audioTracks}onAudioTrackSwitching(e){var t=!!e.url;this.trackId=e.id,this.state=Kt.IDLE,this.fragCurrent=null,this.state=Kt.PAUSED,this.waitingFragment=null,t?this.tickInterval||(this.tickInterval=setInterval(this.ontick,100)):this._destroyDemuxer(),t&&(this.audioSwitch=!0,this.state=Kt.IDLE,void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold)),this.tick()}onAudioTrackLoaded(e){var t=e.details,i=e.id,s=this.hls.audioTrackController.resolveTrackId(i).trackInfo;if(t.totalduration,t.live){var a=s.details;a&&t.endSN===a.endSN&&(t.unchangedLivePlaylist=!0),a&&t.fragments.length>0?(Wt.mergeDetails(a,t),t.fragments[0].start,t.PTSKnown):t.PTSKnown=!1}else t.PTSKnown=!1;if(s.details=t,!this.startFragRequested){if(-1===this.startPosition){let e=t.startTimeOffset;isNaN(e)?this.startPosition=0:this.startPosition=e}this.nextLoadPosition=this.startPosition}this.state===Kt.PLAYLIST_LOADING&&(this.state=Kt.IDLE),this.tick()}_ensureDemuxer(){this.demuxer||(this.demuxer=new Ut(this.hls,"audio"))}_destroyDemuxer(){Object(qt.clearImmediate)(this.demuxImmediate),this.demuxer&&(this.demuxer.destroy(),this.demuxer=null)}_processLoadedFrag(e){var t=this.fragCurrent,i=e.frag;if("main"===i.type)this.tick();else if(this.state===Kt.FRAG_LOADING&&t&&"audio"===i.type&&i.level===t.level&&i.sn===t.sn){var a=t.level,r=this.hls.audioTrackController.resolveTrackId(a).trackInfo.details,n=r.totalduration,o=t.sn,l=t.cc,d=this.config.defaultAudioCodec,h=this.stats=e.stats;if("initSegment"===o)this.state=Kt.IDLE,h.tparsed=h.tbuffered=performance.now(),r.initSegments[l].data=e.payload,this.hls.trigger(s.a.FRAG_BUFFERED,{stats:h,frag:t,id:"audio"}),this.tick();else{this.state=Kt.PARSING,this.appended=!1,this._ensureDemuxer();let i=this.initPTS[l],s=r.initSegments[l]?r.initSegments[l].data:void 0;if(void 0===i)this.waitingFragment=e,this.state=Kt.WAITING_INIT_PTS;else{this.pendingBuffering=!0;let a=!1;this.demuxer.push(e.payload,s,d,null,t,n,a,i)}}}this.fragLoadError=0,this.hls.trigger(s.a.FRAG_LOADED,e)}onFragParsingInitSegment(e){const t=this.fragCurrent,i=e.frag;if(t&&"audio"===e.id&&i.sn===t.sn&&i.level===t.level&&this.state===Kt.PARSING){let s,a=e.tracks;if(a.video&&delete a.video,s=a.audio){const r=this.hls.levels,n=this.hls.audioTrackController.resolveTrackId(t.level).trackInfo,o=r.find(e=>e.audioGroupId&&e.audioGroupId===n.groupId),l=i.cc,d=Gt.Audio,h=this.hls.bufferController;s.levelCodec=o.audioCodec;let c=h.updateKnownCodecs(d,l,a);if(c&&h.isCompatibleTransition(l)){h.createBuffer(d,l,a);let e=s.initSegment;if(e){let t={type:"audio",data:e,parent:d,content:$t.InitSegment};this.appended=!0,this.pendingBuffering=!0,h.appendBuffer(t.type,t.data,t.parent,t.content)}}else this.pendingParsedInitSegmentData=e;c||(this.logger.info(`incompatible audio codecs[level/parsed]=[${s.levelCodec}/${s.codec}] on track switch, will wait for a source buffer reset`)(),this.hls.streamController.needsReset=!0,this.state=Kt.WAITING_DISCONTINUITY),this.tick()}else this.logger.warn(`${e.id}: missing audio track @ level ${i.level} cc ${i.cc} discontinuity ${e.discontinuity}`)(),"audio"===e.id&&e.discontinuity&&(this.hls.bufferController.ignoreSourceBuffer(1),this.stopLoad())}}onFragParsingData(e){const t=this.fragCurrent,i=e.frag;if(!t||"audio"!==e.id||"audio"!==e.type||i.sn!==t.sn||i.level!==t.level)return;let a=this.hls.bufferController.isCompatibleTransition(i.cc);if(void 0===a)this.pendingParsedData=e,this.state=Kt.IDLE;else if(!1===a)this.pendingParsedData=void 0,this.state=Kt.IDLE;else if(this.audioSwitch&&this.mediaBuffer.buffered.length)this.pendingParsedData=e,this.flushAudioBuffer(0,Number.POSITIVE_INFINITY);else if(this.state===Kt.PARSING)if(this.keyRequestPromise)this.pendingParsedData=e,this.state=Kt.KEY_LOADING;else{let a=this.trackId,r=this.hls.audioTrackController.resolveTrackId(a).trackInfo,n=this.hls;isNaN(e.endPTS)&&(e.endPTS=e.startPTS+t.duration,e.endDTS=e.startDTS+t.duration),this.pendingParsedInitSegmentData&&this.pendingParsedInitSegmentData.frag.sn===i.sn&&(this.onFragParsingInitSegment(this.pendingParsedInitSegmentData),this.pendingParsedInitSegmentData=void 0),Wt.updateFragPTSDTS(r.details,t,e.startPTS,e.endPTS),this.pendingIncompatCC&&(this.pendingIncompatCC=void 0,this.hls.determineIncompatCCStartTime(i));let o=this.audioSwitch,l=this.media;o&&l&&(this.audioSwitch=!1,n.trigger(s.a.AUDIO_TRACK_SWITCHED,{id:a})),[e.data1,e.data2].forEach(t=>{if(t&&t.length&&this.state===Kt.PARSING){let i={type:e.type,data:t,parent:Gt.Audio,content:$t.Data};this.appended=!0,this.pendingBuffering=!0,this.hls.bufferController.appendBuffer(e.type,i.data,i.parent,i.content)}})}this.tick()}onFragParsed(e){const t=this.fragCurrent,i=e.frag;t&&"audio"===e.id&&i.sn===t.sn&&i.level===t.level&&this.state===Kt.PARSING&&(this.stats.tparsed=performance.now(),this.state=Kt.PARSED,this._checkAppendedParsed())}onBufferCreated(e){let t=e.tracks.audio;t&&(this.mediaBuffer=t.buffer)}onBufferAppended(e){if("audio"===e.parent){const t=this.state;t!==Kt.PARSING&&t!==Kt.PARSED||(this.pendingBuffering=e.pending>0,this._checkAppendedParsed())}}_checkAppendedParsed(){if(!(this.state!==Kt.PARSED||this.appended&&this.pendingBuffering)){let e=this.fragCurrent,t=this.stats,i=this.hls;if(e){this.fragPrevious=e,t.tbuffered=performance.now(),i.trigger(s.a.FRAG_BUFFERED,{stats:t,frag:e,id:"audio"});let a=this.mediaBuffer?this.mediaBuffer:this.media;this.logger.info(`audio buffered : ${Ht(a.buffered)} media.currentTime=${this.media.currentTime}`)(),this.audioSwitch&&this.appended&&(this.audioSwitch=!1,i.trigger(s.a.AUDIO_TRACK_SWITCHED,{id:this.trackId})),this.state=Kt.IDLE}this.tick()}}onBufferFlushed(){this.state!==Kt.FRAG_LOADING&&(this.state=Kt.IDLE,this.fragPrevious=null,this.tick())}onBufferCodecUpdated(e){"audio"!==e.parent&&this.state===Kt.WAITING_DISCONTINUITY&&(this.state=Kt.IDLE,this.tick())}onBufferSourceResetting(){this.onMediaDetaching()}onBufferSourceReset(e){this.startPosition=e.startPosition,this.lastCurrentTime=e.startPosition,this.startFragRequested=!1,this.state=Kt.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e.startPosition,this.waitForSeek=!0,this._attachMedia(e.media,-1),this.tick()}_handleFragmentError(e){super._handleFragmentNetworkError(e),this.resetNextLoadPositionState(),e.fatal&&this.hls.trigger(s.a.ERROR,e)}onError(e){if(this.state===Kt.ERROR)return;if(e.fatal)return this.state=Kt.ERROR,void this.logger.error(`audioStreamController: ${e.type}, ${e.details}, ${e.response}, switch to ${this.state} state ...`)();let t=e.frag;if(!t||"audio"===t.type)switch(this.hls.audioTrackController.handleError(e),e.details){case a.a.KEY_SYSTEM_GENERIC_ERROR:case a.a.KEY_LOAD_ERROR:case a.a.KEY_LOAD_TIMEOUT:if(!(this.fragCurrent&&this.fragCurrent.decryptdata&&this.fragCurrent.decryptdata.isEncrypted&&e.decryptdata&&e.decryptdata.uri===this.fragCurrent.decryptdata.uri))return;this.resetNextLoadPositionState(),e.fatal||e.retrying||this.state!==Kt.KEY_LOADING||(this.state=Kt.IDLE);break;case a.a.FRAG_PARSING_ERROR:this.resetNextLoadPositionState(),this.state=e.fatal?Kt.ERROR:Kt.IDLE,this.logger.warn(`audioStreamController: ${e.details} while parsing frag,switch to ${this.state} state`)();break;case a.a.FRAG_LOOP_LOADING_ERROR:e.fatal||e.retrying||this.state!==Kt.PLAYLIST_LOADING||(this.state=Kt.IDLE);break;case a.a.BUFFER_FULL_ERROR:if("audio"===e.parent&&(this.state===Kt.PARSING||this.state===Kt.PARSED)){const e=this.mediaBuffer,t=this.media.currentTime;if(e&&kt.isBuffered(e,t)&&kt.isBuffered(e,t+.5)){const e=this.config;e.maxMaxBufferLength>=e.maxBufferLength&&(e.maxMaxBufferLength/=2,this.logger.warn(`audio:reduce max buffer length to ${e.maxMaxBufferLength}s`)(),this.fragLoadIdx+=2*e.fragLoadingLoopThreshold),this.state=Kt.IDLE}else this.logger.warn("buffer full error also media.currentTime is not buffered, flush audio buffer")(),this.fragCurrent=null,this.flushAudioBuffer(0,Number.POSITIVE_INFINITY)}}}get canContinuePlaybackWithoutGap(){let e=this.trackId,t=this.hls.audioTrackController.resolveTrackId(e).trackInfo,i=t?t.details:void 0;return kt.canContinuePlaybackWithoutGap(this.mediaBuffer||this.media,this.media.currentTime,this.config.maxBufferHole,this.hls.playlistType,i)}get variantController(){return this.hls.audioTrackController}},audioTrackController:class extends pi{constructor(e){super(e,s.a.MANIFEST_LOADING,s.a.MANIFEST_PARSED,s.a.AUDIO_TRACK_LOADED,s.a.PREFERRED_HOST_CHANGED);let t=this.hls.playlistLoader;this.variantManager=new Lt(e,Qe.AUDIO),this.levelLoader=new mi(this.variantManager,this._loadTrackInternal.bind(this),t.abort.bind(t,"audioTrack")),this.trackRetryCount=0}destroy(){this.reset(),this.levelLoader.destroy(),this.variantManager.destroy(),P.prototype.destroy.call(this)}reset(){this.stopLoad(),this.trackRetryCount=0,this.variantManager.reset()}stopLoad(){this.levelLoader.stop()}onManifestLoading(){this.trackId=-1,this.trackRetryCount=0,this._mediaOptions=void 0,this._selectedMediaOption=void 0}onManifestParsed(e){let t=e.audioTracks||[];if(e.audioMediaSelectionGroup?this._mediaSelectionGroup=e.audioMediaSelectionGroup:this._mediaSelectionGroup={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:Qe.AUDIO,MediaSelectionGroupOptions:[]},this.hls.trigger(s.a.AUDIO_TRACKS_UPDATED,e),void 0===this.queuedPersistentID||this.selectedMediaOption){if(this.mediaSelectionOptions.length>0){let e=this.mediaSelectionOptions.find((function(e){return e.MediaSelectionOptionsIsDefault}));this.selectedMediaOption=e||this.mediaSelectionOptions[0]}}else{let e=this.sanitizePersistentID(t,this.queuedPersistentID);e===this.queuedPersistentID||(this.queuedPersistentID=e),this.selectedPersistentID=this.queuedPersistentID,this.queuedPersistentID=void 0}}onPreferredHostChanged(e){if(e===Qe.AUDIO||isNaN(this.trackId))return;let t,i=this.variantManager.getVariantInfo(this.trackId),s=(i.url,this.variantManager.validVariantList),a=i.groupCodecList;(t=s.find(e=>{let t=e.groupCodecList,s=!1;if(t.length===a.length&&1===t.length){let r=a[0],n=t[0];s=e.persistentID===i.persistentID&&jt.b.isCompatibleAudioCodec(r,n)&&e.url&&e.url.includes(this.hls.preferredHostName)}return s}))&&(this.logger.warn(`preemptively switching audio host to ${this.hls.preferredHostName}`)(),this.updateTrack(t.id))}onAudioTrackLoaded(e){if(this.variantManager.isVariantValid(e.id)){let t=e.details,i=this.levelLoader.handleLevelLoad(e.id,t,e.stats);i.success||this.logger.error(`Got error ${i.error}`)(),this.resolveTrackId(e.id).trackInfo.details=t}else this.logger.warn(`invalid audioTrack ${e.id} loaded`)()}_findValidGroupId(e){return this.audioTracks.find((function(t){return t.groupId&&t.groupId!==e.groupId})).groupId}getNextBestAutoVariant(e){let t=this.resolveTrackId(e).trackInfo,i=this._findValidGroupId(t);return this.audioTracks.find((function(e){return e.groupId===i&&e.persistentID===t.persistentID})).id}resolveTrackId(e){let t,i;return!e&&0!==e||e<0?this.logger.warn(`invalid trackID ${e}`)():(t=this.variantManager.getVariantInfo(e),i=this.variantManager.getVariantListPosition(e)),{trackInfo:t,trackListPosition:i}}haveFallbackVariant(){let e=this.audioTrack,t=this.resolveTrackId(e).trackInfo;return!t||this.audioTracks.filter((function(e){return e.groupId&&e.persistentID===t.persistentID&&e.groupId!==t.groupId})).length>0}setNextAutoVariant(e){this.audioTrack=e}_handleMediaPlaylistError(e){super._handleMediaPlaylistNetworkError(e,s.a.AUDIO_TRACK_LOADED)}handleError(e){}get audioTracks(){return this.variantManager.validVariantList}get currentVariantId(){return this.audioTrack}get audioTrack(){return this.trackId}set audioTrack(e){if(!this.audioTracks)return;let t=this.resolveTrackId(e).trackInfo;t&&(this.trackId===e&&void 0!==t.details||this.setAudioTrackInternal(e))}get mediaSelectionGroup(){return this._mediaSelectionGroup}get mediaSelectionOptions(){return this.mediaSelectionGroup?this.mediaSelectionGroup.MediaSelectionGroupOptions:[]}get selectedPersistentID(){return this.selectedMediaOption?this.selectedMediaOption.MediaSelectionOptionsPersistentID:-1}set selectedPersistentID(e){if(e>=0&&!this._mediaSelectionGroup)return void(this.queuedPersistentID=e);let t=this.mediaSelectionOptions.find((function(t){return t.MediaSelectionOptionsPersistentID===e}));this.selectedMediaOption=t}get selectedMediaOption(){return this._selectedMediaOption}set selectedMediaOption(e){this._selectedMediaOption=e,this.updateTrackSelection()}get penaltyTracks(){return this.variantManager.penaltyVariantQueue}updateTrackSelection(){if(!this._selectedMediaOption)return;let e=this._selectedMediaOption.MediaSelectionOptionsPersistentID,t=this.audioTracks.find(t=>e===t.persistentID&&t.url&&t.url.includes(this.hls.preferredHostName));t?this.audioTrack=t.id:this.logger.warn("could not find audio track for selected media group: "+this._selectedMediaOption.MediaSelectionOptionsName+" with ID: ("+e+")")()}setAudioTrackInternal(e){if(this.trackId!==e){this.trackId=e;let t=this.resolveTrackId(e).trackInfo,i=this.hls,a={id:e,type:t.type,url:t.url};this.logger.info(`[QE Critical] switching to audioTrack ${e} - ${t.name}`)(),i.trigger(s.a.AUDIO_TRACK_SWITCH,a),i.trigger(s.a.AUDIO_TRACK_SWITCHING,a)}this.levelLoader.loadLevel(e)}updateTrack(e){this.setAudioTrackInternal(e)}_loadTrackInternal(e){let t=e.url,i=e.id;t&&(this.logger.info(`[QE Critical] (re)loading playlist for audioTrack ${i}`)(),this.hls.playlistLoader.loadAudioTrack(t,i).then(function(e){this.hls.trigger(s.a.AUDIO_TRACK_LOADED,e)}.bind(this)).catch(function(e){this._handleMediaPlaylistError(e)}.bind(this)))}sanitizePersistentID(e,t){if(!e||!e.length)return t;let i;for(let s=0;s<e.length;s++){let a=e[s];if(a.persistentID===t){i=t;break}a.default&&(i=a.persistentID),i||"en-US"!==a.lang||(i=a.persistentID)}return i>=0?i:e[0].persistentID}},iframeMaxExitSeekDuration:2e3,iframeStallMaxRetry:5,audioPrimingDelay:0,subtitleStreamController:class extends ei{constructor(e){super(e,s.a.MEDIA_ATTACHING,s.a.MEDIA_DETACHING,s.a.ERROR,s.a.SUBTITLE_TRACKS_UPDATED,s.a.SUBTITLE_TRACK_SWITCH,s.a.SUBTITLE_TRACK_LOADED,s.a.SUBTITLE_FRAG_PROCESSED),this.config=e.config,this._state=Kt.STOPPED,this.ticks=0,this.enabledTrack=void 0,this.fragLoadError=0,this.ontick=this.tick.bind(this)}destroy(){this.stopLoad(),this.clearTimer(),this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null),P.prototype.destroy.call(this),this.state=Kt.STOPPED,this._pendingDiscontinuityOffsets=void 0}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=void 0)}startLoad(){this.tracks?(this.stopLoad(),this.timer||(this.timer=setInterval(this.ontick,100)),this.fragLoadError=0,this.state=Kt.IDLE,this.tick()):this.state=Kt.STOPPED}stopLoad(){var e=this.fragCurrent;e&&(e.loader&&e.loader.abort(),this.fragCurrent=null),this.fragPrevious=null,this.state=Kt.STOPPED}tick(){this.ticks++,1===this.ticks&&(this.doTick(),this.ticks>1&&setTimeout(this.tick.bind(this),1),this.ticks=0)}isSubtitleTrackEnabled(){return this.findEnabledTrack()&&(this.findEnabledTrack().mediaType===Qe.SUBTITLE||this.enabledTrack.sideTrackId)}processSubtitleFrag(e){let t=e.frag,i=this.enabledTrack.details;this.logger.info(`${t.type} Loaded  ${t.sn} of [${i.startSN},${i.endSN}], level: ${t.level}, cc: ${t.cc}, start: ${t.start} URL ${this.hls.redactUrl(t.relurl)}`)(),this.hls.timelineController.processSubtitleFrag(e)}doTick(){if(this.state===Kt.FRAG_LOADING_WAITING_RETRY){let e=performance.now(),t=this.retryDate;t&&e>=t&&(this.state=Kt.IDLE)}if(this.state!==Kt.IDLE||!this.enabledTrack||this.enabledTrack.mediaType!==Qe.SUBTITLE&&void 0===this.enabledTrack.sideTrackId||!this.media)return;let e=this.media.currentTime,t=this.hls.config,i=this.hls.timelineController.getCuesOfEnabledTrack(this.enabledTrack.id,void 0!==this.enabledTrack.sideTrackId),s=Mt.subtitleBufferInfo(i,e,t.maxBufferHole),a=s.len,r=s.end,n=t.maxBufferLength,o=!1;if(this.enabledTrack.details?this.enabledTrack.details.live&&Date.now()-this.enabledTrack.details.lastLoadTimeMillis>=1e3*this.enabledTrack.details.targetduration&&this.hls.isLive&&0!==this.hls.desiredRate&&(o=!0):o=!0,this.enabledTrack.details&&this.fragQueue.isEmpty()&&this._addAllFragmentsToQueue(),o&&(this.state=Kt.PLAYLIST_LOADING,this.hls.subtitleTrackController.loadTrackInternal(this.enabledTrack)),this.enabledTrack.details&&this.bufferMonitor&&(this.bufferMonitor.targetDuration=this.enabledTrack.details.targetduration),(a<n||this.subtitleSwitch)&&!this.fragQueue.isEmpty()){let e=this._findFragment(r),t=this.enabledTrack.details,i=this.fragQueue.fragArray;if(!e)return;this.fragLoadError>0&&"initSegment"!==e.sn&&this.fragPrevious&&e.sn!==this.fragPrevious.sn+1&&(e=i[this.fragPrevious.sn-i[0].sn+1]),this._pendingDiscontinuityOffsets||(this._pendingDiscontinuityOffsets=this._findAllDiscontinuityFragmentsBefore(e));let s=this.enabledTrack.details.initSegments[e.cc];s&&!s.data?(s.trackId=this.enabledTrack.id,e=s):this._pendingDiscontinuityOffsets&&this._pendingDiscontinuityOffsets.length>0&&(e=this._pendingDiscontinuityOffsets.shift()),this.fragPrevious&&e.sn===this.fragPrevious.sn&&e.level===this.fragPrevious.level||(this.logger.info(`${e.type} loading ${e.sn} of level ${e.level} trackId ${e.trackId} [${t.startSN},${t.endSN}], cc: ${e.cc}, range: ${e.rangeString}, currentTime: ${this.media.currentTime} URL ${this.hls.redactUrl(e.relurl)} `)(),this.state=Kt.FRAG_LOADING,this.fragCurrent=e,this.hls.fragmentLoader.loadFragment(e).then(function(e){this.processSubtitleFrag(e),this.fragLoadError=0}.bind(this)).catch(function(e){this._handleFragmentError(e)}.bind(this)))}}_findFragment(e){let t,i=this.hls.config,s=this.fragQueue.fragArray,a=s.length,r=s[0].start,n=s[a-1].start+s[a-1].duration,o=this.fragPrevious,l=i.maxBufferLength;if(!(t=e<=r?s[0]:Ft.findFragmentBySNAndBuffer(o,s,e,n,i.maxFragLookUpTolerance))){const e=o?s[o.sn-s[0].sn+1]:null;e&&e.start<o.start+o.duration+l&&(t=e)}return t}_addAllFragmentsToQueue(){this.enabledTrack.details.fragments.forEach(e=>{this.fragQueue.enqueue(this.enabledTrack.id,e)}),this.enabledTrack.details.live&&(this.enabledTrack.details.lastLoadTimeMillis=Date.now())}_findAllDiscontinuityFragmentsBefore(e){let t,i=[];return this.enabledTrack.details.fragments.forEach(s=>{if(e.sn>s.sn){let e=this.hls.timelineController.hasDiscontinuityOffset(s.cc);void 0!==t&&s.cc===t||e||(i.push(s),t=s.cc)}}),i}onMediaAttaching(e){this.media=e.media;let t=this.tracks&&this.hls.config.autoStartLoad?this.hls.config.startPosition:-1;this._attachMedia(e.media,t)}_attachMedia(e,t){this.media=e,this.onvseeking=this.onMediaSeeking.bind(this),e.addEventListener("seeking",this.onvseeking),this.onvseeked=this.onMediaSeeked.bind(this),e.addEventListener("seeked",this.onvseeked),t>=0&&this.startLoad()}onMediaDetaching(){var e=this.media;e&&(e.removeEventListener("seeking",this.onvseeking),this.onvseeking=null,e.removeEventListener("seeked",this.onvseeked),this.onvseeked=null),this.media=null,this.stopLoad(),this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null)}onMediaSeeking(){this.state===Kt.ENDED&&(this.state=Kt.IDLE),this.tick()}onMediaSeeked(){this.logger.info(`[subtitle] seeked. state ${this.state}`)();let e=this.hls.timelineController.forgetFragsWaitingForInitPTS();this.state===Kt.FRAG_LOADING&&e.length&&(e.forEach(e=>{this.fragQueue.processed(e.frag,!1)}),this.state=Kt.IDLE)}onSubtitleTracksUpdated(e){this.tracks=e.subtitleTracks,this.fragQueue=new class{constructor(e){this.logger=e.logger,this.fragArray=[],this.queuedFragSet=new Set,this.processedFragSet=new Set,this.currentFragKey=void 0}getFragKey(e){return e.trackId+"-"+e.sn+"-"+e.cc}enqueue(e,t){t.trackId=e;let i=this.getFragKey(t);this.currentFragKey===i||this.queuedFragSet.has(i)||this.processedFragSet.has(i)||(this.fragArray.push(t),this.queuedFragSet.add(i))}dequeue(){let e;if(!this.isEmpty()){e=this.fragArray.shift();let t=this.getFragKey(e);this.queuedFragSet.delete(t),this.currentFragKey=t}return e}isEmpty(){return 0===this.fragArray.length}processed(e,t){let i=this.getFragKey(e);this.currentFragKey&&this.currentFragKey!==i&&this.logger.error("got a processed complete for unexpected fragment "+i)(),this.currentFragKey=void 0,t&&this.processedFragSet.add(i)}clearUnprocessed(){this.fragArray=[],this.queuedFragSet.clear(),this.currentFragKey=void 0}}(this.hls),this.state=Kt.IDLE}onSubtitleTrackSwitch(e){if(e.hidden?(this.enabledTrack=this.tracks[this.hls.subtitleTrackController.redirectTextTrack(e.track.id)],this.enabledTrack.sideTrackId=e.track.id,this.enabledTrack.url=this.tracks[e.track.id].url,this.fragPrevious&&this.fragPrevious.trackId!==this.enabledTrack.id&&(this.logger.info(`[subtitle] clear fragPrevious from trackId ${this.fragPrevious.trackId}`)(),this.fragPrevious=null)):this.enabledTrack=e.track,this.logger.info(`[subtitle] enable track id: ${this.enabledTrack?this.enabledTrack.id:"undefined"} side track id ${this.enabledTrack?this.enabledTrack.sideTrackId:"undefined"}`)(),this.enabledTrack){this.bufferMonitor&&this.bufferMonitor.destroy();let e=()=>this.estimateCurrentWaterLevel();this.bufferMonitor=new Ot(this.hls,this.hls.media,e,wt.Subtitle,this.config.maxBufferHole,this.config.maxBufferLength,this.config.defaultTargetDuration,this.config.almostDryBufferSec)}else this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null);this.fragQueue.clearUnprocessed(),this.fragCurrent&&(this.fragCurrent.loader&&this.fragCurrent.loader.abort(),this.fragCurrent=null),this.timer||(this.timer=setInterval(this.ontick,100)),this.subtitleSwitch=!0,this.state=Kt.IDLE,this.tick()}onSubtitleTrackLoaded(e){this.enabledTrack.details=e.details,this.enabledTrack&&this.enabledTrack.id===e.id&&this._addAllFragmentsToQueue(),this.state=Kt.IDLE,this.tick()}estimateCurrentWaterLevel(){return 0}onSubtitleFragProcessed(e){this.fragPrevious=e.frag,this.fragCurrent=null,"initSegment"!==e.frag.sn&&this.fragQueue.processed(e.frag,e.success),this.state=Kt.IDLE,this.subtitleSwitch=!1,this.tick()}findEnabledTrack(){return this.enabledTrack}_handleFragmentError(e){super._handleFragmentNetworkError(e),e.fatal&&this.hls.trigger(s.a.ERROR,e)}onError(e){if(this.state!==Kt.ERROR)return e.fatal?(this.state=Kt.ERROR,void this.logger.error(`subtitleStreamController: ${e.type}, ${e.details}, ${e.response}, switch to ${this.state} state ...`)()):void 0}get variantController(){return this.hls.subtitleTrackController}},subtitleTrackController:class extends pi{constructor(e){super(e,s.a.MEDIA_ATTACHED,s.a.MEDIA_DETACHING,s.a.MANIFEST_LOADING,s.a.MANIFEST_LOADED,s.a.SUBTITLE_TRACKS_CREATED,s.a.PREFERRED_HOST_CHANGED),this.tracks=[],this.media=void 0,this.subtitleDisplay=!1,this.allTracksCreated=!1,this.trackRetryCount=0,this.variantManager=new Lt(e,Qe.SUBTITLE)}destroy(){this.variantManager.destroy(),P.prototype.destroy.call(this)}get subtitleTracks(){return this.tracks}get mediaSelectionGroup(){return this._mediaSelectionGroup}get mediaSelectionOptions(){return this.mediaSelectionGroup?this.mediaSelectionGroup.MediaSelectionGroupOptions:[]}get selectedPersistentID(){return this.selectedMediaOption?this.selectedMediaOption.MediaSelectionOptionsPersistentID:-1}set selectedPersistentID(e){if(e>=0&&!this.allTracksCreated)return void(this.queuedPersistentID=e);let t=this.mediaSelectionOptions.find((function(t){return t.MediaSelectionOptionsPersistentID===e}));this.selectedMediaOption=t}get selectedMediaOption(){return this._selectedMediaOption}set selectedMediaOption(e){if(e&&!this.allTracksCreated)return void(this.queuedPersistentID=e.MediaSelectionOptionsPersistentID);let t;if(this._selectedMediaOption=e,e){let i=e.MediaSelectionOptionsPersistentID;(t=this.tracks.find((function(e){return e.persistentID===i})))||this.logger.warn("could not find subtitle track for selected media group: "+e.MediaSelectionOptionsName+" with ID: ("+i+")")()}this.selectedTrack=t;let i=this.selectedTrack?this.selectSideTrack(this._selectedMediaOption):void 0;i&&(this.selectedSideTrack=i)}get selectedTrack(){return this._selectedTrack}set selectedTrack(e){Zi(this._selectedTrack,e)||(this.selectedSideTrack&&(this._selectedSideTrack=void 0),this.logger.info("[QE Critical] switching to subtitle/caption track "+(e?e.id+" - "+e.name:"(NONE)"))(),this._selectedTrack=e,this.hls.trigger(s.a.SUBTITLE_TRACK_SWITCH,{track:e}),this.updateTextTrackState())}selectSideTrack(e){let t;if(this.hls.config.enableDualTrackSelection&&e&&e.MediaSelectionOptionsMediaType===Qe.CLOSEDCAPTION){e.MediaSelectionOptionsPersistentID;let i=this.selectedTrack,s=this.logger;t=this.tracks.find((function(t){let a=t.mediaType===Qe.SUBTITLE&&t.lang===e.MediaSelectionOptionsExtendedLanguageTag&&t.forced&&t.autoselect&&t.groupId!==i.groupId;return a&&s.info(`[subtitle] pick side track persistent id ${t.persistentID} track id ${t.id} group id ${t.groupId}`)(),a}))}return t}get selectedSideTrack(){return this._selectedSideTrack}set selectedSideTrack(e){Zi(this._selectedSideTrack,e)||(this.logger.info("[QE Critical] switching to side subtitle/caption track "+(e?e.id+" - "+e.name:"(NONE)"))(),this._selectedSideTrack=e,this.hls.trigger(s.a.SUBTITLE_TRACK_SWITCH,{track:e,hidden:!0}),this.updateTextTrackState())}redirectTextTrack(e){let t=e;return this.selectedSideTrack&&e===this.selectedSideTrack.id&&(t=this.selectedTrack.id,this.logger.info(`[subtitle] promote side track id from ${e} to ${t}`)()),t}updateTextTrackState(){if(!this.media||!this.media.textTracks)return;let e=this.selectedTrack?this.selectedTrack.id:void 0,t=Ji(this.media.textTracks);for(let i=0;i<t.length;i++)i===e&&"showing"!==t[i].mode?t[i].mode="showing":i!==e&&"hidden"!==t[i].mode&&(t[i].mode="hidden")}onMediaAttached(e){this.media=e.media,this.media&&(this.updateTextTrackState(),this.trackChangeListener=this._onTextTracksChanged.bind(this),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.subtitlePollingInterval=setInterval(()=>{this.trackChangeListener()},500):this.media.textTracks.addEventListener("change",this.trackChangeListener))}onMediaDetaching(){this.media&&(this.useTextTrackPolling?clearInterval(this.subtitlePollingInterval):this.media.textTracks.removeEventListener("change",this.trackChangeListener),this.media=void 0)}onManifestLoading(){this.tracks=[],this.selectedTrack=void 0,this._selectedMediaOption=void 0,this.trackRetryCount=0}onManifestLoaded(e){this.variantManager.variantList=this.tracks=e.subtitleTracks||[],e.subtitleMediaSelectionGroup?this._mediaSelectionGroup=e.subtitleMediaSelectionGroup:this._mediaSelectionGroup={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:Qe.SUBTITLE,MediaSelectionGroupOptions:[]},this.hls.trigger(s.a.SUBTITLE_TRACKS_UPDATED,{subtitleTracks:this.tracks})}onSubtitleTracksCreated(){this.allTracksCreated=!0,void 0===this.queuedPersistentID||this.selectedMediaOption||(this.selectedPersistentID=this.queuedPersistentID,this.queuedPersistentID=void 0)}onPreferredHostChanged(e){if(e===Qe.SUBTITLE||!this.selectedTrack)return;let t,i=this.selectedTrack;i.url,(t=this.variantManager.validVariantList.find(e=>e.persistentID===i.persistentID&&e.url.includes(this.hls.preferredHostName)))&&(this.selectedSideTrack?(this.logger.warn(`preemptively switching subtitle host for side track id ${this.selectedSideTrack.id} to id ${t.id}, host=${this.hls.preferredHostName}`)(),this.selectedSideTrack=t):(this.logger.warn(`preemptively switching subtitle host to ${this.hls.preferredHostName}`)(),this.selectedTrack=t))}_onTextTracksChanged(){if(!this.media)return;let e,t=!1,i=Ji(this.media.textTracks);for(let s=0;s<i.length;s++)i[s].seen?"showing"===i[s].mode&&this.tracks[s]&&(e=this.tracks[s]):(i[s].seen=!0,t=!0);if(!t){let t=e?e.persistentID:void 0,i=this._selectedMediaOption;if(!i||i.MediaSelectionOptionsPersistentID!==t){let e=this.mediaSelectionOptions.find((function(e){return e.MediaSelectionOptionsPersistentID===t}));this.selectedMediaOption=e}}}loadTrackInternal(e){let t=e.url;e.id,t&&this.hls.playlistLoader.loadSubtitleTrack(e.url,e.id).then(function(e){this.hls.trigger(s.a.SUBTITLE_TRACK_LOADED,e)}.bind(this)).catch(function(e){this._handleMediaPlaylistError(e)}.bind(this))}haveFallbackVariant(){return!1}_handleMediaPlaylistError(e){super._handleMediaPlaylistNetworkError(e,s.a.SUBTITLE_TRACK_LOADED)}isLastValidVariant(){return!0}_findValidGroupId(e){let t=this.tracks.find((function(t){return t.groupId&&t.groupId!==e.groupId}));return t?t.groupId:void 0}resolveTrackId(e){let t,i;return!e&&0!==e||e<0?this.logger.warn(`invalid trackID ${e}`)():(t=this.variantManager.getVariantInfo(e),i=this.variantManager.getVariantListPosition(e)),{trackInfo:t,trackListPosition:i}}getNextBestAutoVariant(e){let t,i=this.resolveTrackId(e).trackInfo,s=i?this._findValidGroupId(i):void 0;return i&&s?t=this.tracks.find((function(e){return e.groupId===s&&e.persistentID===i.persistentID})):(this.logger.warn("invalid subtitleTrack or groupId, setting next best auto variant as trackId"+this.tracks[0].id)(),t=this.tracks[0]),t?t.id:-1}setNextAutoVariant(e){let t=this.resolveTrackId(e).trackInfo;if(t){let e=this.mediaSelectionOptions.find((function(e){return e.MediaSelectionOptionsPersistentID===t.persistentID}));this.selectedSideTrack?(this.logger.info(`[subtitle] use next side track ${t.id}`)(),this.selectedSideTrack=t):(this.logger.info(`[subtitle] use next track ${t.id}`)(),this._selectedMediaOption=e,this.selectedTrack=t)}}},timelineController:is,cueHandler:{newCue:function(e,t,i,s,a){let r,n,o,l,d;const h={foreground:!1,background:!1,italics:!1,underline:!1,flash:!1,styleStack:[]};for(const[c,u]of s.rows.entries())if(n=!0,o=0,l="",!u.isEmpty()){for(let e=0;e<u.chars.length;e++)u.chars[e].uchar.match(/\s/)&&n?o++:(l+=this.getFormattedChar(u.chars[e],h),n=!1);u.cueStartTime=t,t===i&&(i+=1e-4),l=l.trim().replace(/<br(?: \/)?>/gi,"\n"),l+=this.closeStyles(h),r=new Ai.VTTCue(t,i,l),o>=16?o--:o++,d=navigator.userAgent.match(/Firefox\//)?c+1:c>7?c:c+1,r.snapToLines=!1,r.line=10+5.33*d,r.align="left",r.position=this.getPosition(o,a),e.addCue(r)}},getPosition:function(e,t){let i=4/3;t&&t.offsetWidth&&t.offsetHeight&&t.offsetWidth/t.offsetHeight>=1.6&&(i=16/9);let s=10+e/32*80,a=10,r=90;return i===16/9&&(s=12.5+.75*s,a=20,r=80),Math.max(a,Math.min(r,s+(navigator.userAgent.match(/Firefox\//)?50:0)))},getRootStyleTag:function(e){let t=e[0];return"c"===t?t:e},closeStyles:function(e){let t="";for(let i=e.styleStack.length-1;i>=0;--i)t+="</"+this.getRootStyleTag(e.styleStack[i])+">",e.styleStack.pop();return t},beginStyleAndBalance:function(e,t){let i="";return"c"===t[0]&&(i+=this.closeStyleAndBalance(e,"c")),i+="<"+t+">",e.styleStack.push(t),i},closeStyleAndBalance:function(e,t){let i=e.styleStack.length,s=0,a="",r=!1;for(let n=i-1;n>=0;--n){let o=e.styleStack[n],l=this.getRootStyleTag(o);if(t[0]===o[0]){a+="</"+l+">",e.styleStack.splice(i-1-s);break}r=!0,"c"===l[0]?(e.background="",e.foreground="",e.flash=!1,a+="</c>"):"u"===l[0]?(e.underline=!1,a+="</u>"):"i"===l[0]&&(e.italics=!1,a+="</i>"),s++}return a},getFormattedChar:function(e,t){let i="",s=e.uchar,a="",r=e.penState.foreground!==t.foreground,n=e.penState.background!==t.background,o=e.penState.flash!==t.flash;return(r||n||o)&&(a="."+e.penState.foreground,a+=".bg_"+e.penState.background,e.penState.flash&&o&&(a+=".blink"),e.penState.foreground||e.penState.background||e.penState.blink?i+=this.beginStyleAndBalance(t,"c"+a):i+=this.closeStyleAndBalance(t,"c"),r&&(t.foreground=e.penState.foreground),n&&(t.background=e.penState.background),o&&(t.flash=e.penState.flash)),e.penState.underline!==t.underline&&(i+=e.penState.underline?this.beginStyleAndBalance(t,"u"):this.closeStyleAndBalance(t,"u"),t.underline=e.penState.underline),e.penState.italics!==t.italics&&(i+=e.penState.italics?this.beginStyleAndBalance(t,"i"):this.closeStyleAndBalance(t,"i"),t.italics=e.penState.italics),i+s}},enableCEA708Captions:!0,customTextTrackCueRenderer:!1,enableWebVTT:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",enableDualTrackSelection:!1,stretchShortVideoTrack:!1,forceKeyFrameOnDiscontinuity:!0,useFirstLevelAtIncompatDiscontinuity:!0,abrBandwidthEstimator:"bandwidth-history-controller",abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.9,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,enableRtcReporting:!1,rtcIntervalTimeout:3e5,rtcSender:"HLSJS",rtcSessionTag:"none",warmupCdms:!1,enablePerformanceLogging:!1,overridePlaybackRate:!1,enableAdaptiveStartup:!0,bandwidthHistoryWindowSize:12e4,bandwidthHistoryTTL:6e5,bandwidthHistoryAggregationMethod:"quadratic-time-weighted",bandwidthHistoryGetEstimateThrottleMs:1e3,defaultTargetDuration:10,targetStartupMs:3e3,adaptiveStartupMetricsOverride:{maxValidHeight:1080,maxValidBitrate:1/0,maxPreferredBitrate:1/0},bandwidthHistoryStorageKey:"AppleHLS-bandwidth-estimation",storage:{get:"undefined"==typeof localStorage?void 0:localStorage.getItem.bind(localStorage),set:"undefined"==typeof localStorage?void 0:localStorage.setItem.bind(localStorage)},enableCDNFallback:!0,enableQueryParamsForITunes:!1},ns=[".*.itunes.apple.com"],os={deviceName:"&xapdn=",deviceModel:"&xapdm=",language:"&xapdl=",dsid:"&xapdsid=",subs:"&xapsub="};class ls extends Bt{constructor(e={}){super(),this.media=null;let t=ls.DefaultConfig;if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");this.config=Object.assign(Object.assign({},t),e);const{config:i}=this;if(void 0!==i.liveMaxLatencyDurationCount&&i.liveMaxLatencyDurationCount<=i.liveSyncDurationCount)throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be gt "liveSyncDurationCount"');if(void 0!==i.liveMaxLatencyDuration&&(i.liveMaxLatencyDuration<=i.liveSyncDuration||void 0===i.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be gt "liveSyncDuration"');this.logger=new c.a,this.logger.enable(i.debug,i.debugLevel),this.config=i,this._autoLevelCapping=-1,this.trigger=function(e,...t){if("hlsFragLoadProgress"!==e.toString()){let i="";"hlsError"===e&&t.length&&(i=JSON.stringify(t[0],["fatal","details","reason"])),this.logger.info(`[QE Critical] [EventTrigger] ${e.toString()} ${i}`)()}this.emit(e,e,...t)}.bind(this),void 0===this.off&&(this.off=function(e,...t){this.removeListener(e,...t)}),this.bufferChangedFn=this.onBufferChanged.bind(this),this.on(s.a.BUFFER_CHANGED,this.bufferChangedFn);const a=this.bandwidthHistoryController=new Ri(this),r=this.abrController=new i.abrController(this),n=this.bufferController=new i.bufferController(this),o=this.playlistLoader=new pt(this),l=this.fragmentLoader=new vt(this),d=this.keyLoader=new Te(this),h=this.networkErrorHandler=new It(this),u=new x(this),f=new Si(this);let g=[this.levelController=new Ti(this),this.streamController=new ti(this)];if(i.audioStreamController){const e=this.audioStreamController=new i.audioStreamController(this);g.push(e)}if(i.subtitleStreamController){const e=this.subtitleStreamController=new i.subtitleStreamController(this);g.push(e)}this.networkControllers=g;const m=[o,l,d,u,r,n,f,h,a];if(i.audioTrackController){let e=new i.audioTrackController(this);this.audioTrackController=e,m.push(e)}if(i.subtitleTrackController){let e=new i.subtitleTrackController(this);this.subtitleTrackController=e,m.push(e)}if(i.timelineController){let e=new i.timelineController(this);this.timelineController=e,m.push(e)}const p=this.eventReporter=new Li(this);m.push(p),this.coreComponents=m,this.assetInfo={},this.isValid=!0,this.cdnReferenceBaseURL=void 0,this.cdnWhiteList=new Set}static initialize(e){let t=ls.DefaultConfig,i=Object.assign(Object.assign({},t),e);ls.DefaultConfig=i,c.b.enable(i.debug,i.debugLevel),!0===i.warmupCdms&&pe.warmupCDM()}static get version(){return"1.414.2"}static isSupported(){return (function(){try{const e=window.MediaSource||window.WebKitMediaSource,t=window.SourceBuffer||window.WebKitSourceBuffer,i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),s=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!i&&!!s}catch(e){return!1}})()}static get Events(){return s.a}static get ErrorTypes(){return a.c}static get ErrorDetails(){return a.a}static get ErrorResponses(){return a.b}static get DefaultConfig(){return ls.defaultConfig?ls.defaultConfig:rs}static set DefaultConfig(e){ls.defaultConfig=e}destroy(){this._isObjectValid()&&(this.logger.info("destroy")(),this.trigger(s.a.DESTROYING),this.detachMedia(),this.coreComponents.concat(this.networkControllers).forEach(e=>{e.destroy()}),this.assetInfo=null,this.removeAllListeners(),this._autoLevelCapping=-1,this.cdnReferenceBaseURL=void 0,this.cdnWhiteList.clear(),this.isValid=!1,this.bufferEndPromiseWrapper=void 0)}attachMedia(e){this._isObjectValid()&&(this.logger.info("attachMedia")(),this.media=e,this.streamController.installMediaFunctions(e),this.trigger(s.a.MEDIA_ATTACHING,{media:e}))}detachMedia(){this._isObjectValid()&&this.media&&(this.logger.info("detachMedia")(),this.incompatCCStartFrag=[],this.incompatCCStartTime=void 0,this.streamController.uninstallMediaFunctions(),this.trigger(s.a.MEDIA_DETACHING),this.media=null)}get accessLog(){if(!this._isObjectValid())return;let e=this.eventReporter;return e?e.accessLog:[]}get errorLog(){if(!this._isObjectValid())return;let e=this.eventReporter;return e?e.errorLog:[]}get url(){if(this._isObjectValid())return this.assetInfo.url}_isObjectValid(){return this.isValid||this.logger.error("Hls object already destroyed")(),this.isValid}_getHostName(e){return d.getHostName(e)}_urlNeedsUpdate(e){if(!0===this.config.enableQueryParamsForITunes)return!0;let t=this._getHostName(e);return void 0!==ns.find(e=>new RegExp(e).exec(t))}_shouldUpdateUrlWithDeviceNameAndModel(e){let t=e.model,i=e.manufacturer;return t&&i||this.logger.warn(`Missing model/manufacturer in platformInfo model ${t} manufacturer ${i}`)(),!!t&&!!i}_updateUrlWithDeviceNameAndModel(e,t){let i,s,a=t.model,r=t.manufacturer,n=-1!==e.indexOf("?");return i=encodeURIComponent(a),s=encodeURIComponent(r),(e=n?e:e+"?")+os.deviceName+s+os.deviceModel+i}_updateUrlWithOptionsQuery(e,t){let i,s=-1!==e.indexOf("?");for(i in e=s?e:e+"?",t)t[i]?e+=os[i]+("subs"===i?encodeURIComponent(t[i]):t[i]):this.logger.warn(`Missing ${i} info`)();return e}_updateUrlWithQueryStrings(e,t,i){return this._shouldUpdateUrlWithDeviceNameAndModel(t)&&(e=this._updateUrlWithDeviceNameAndModel(e,t)),this._updateUrlWithOptionsQuery(e,i)}_createSessionID(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,a=[];for(let e=0;e<256;++e)a[e]=(e<16?"0":"")+e.toString(16);return a[255&e]+a[e>>8&255]+a[e>>16&255]+a[e>>24&255]+"-"+a[255&t]+a[t>>8&255]+"-"+a[t>>8&15|64]+a[t>>16&255]+"-"+a[63&i|128]+a[i>>8&255]+"-"+a[i>>8&255]+a[i>>16&255]+a[255&s]+a[s>>8&255]+a[s>>16&255]+a[s>>24&255]}loadSource(e,t={}){if(!this._isObjectValid())return;let i;if(t.appData&&(i=t.appData.reportingAgent),this.sessionID=i?i.SessionID:this._createSessionID(),this.streamID=t.streamID,this.logger.setStreamAndSessionIDs(this.sessionID,this.streamID),this.logger.info(`[QE Critical] hls player version ${ls.version}`)(),"playready"!==this.config.keySystemPreference)if(e&&e.trim().length){if(e=d.buildAbsoluteURL(window.location.href,e,{alwaysNormalize:!0}),this.platformInfo=t.platformInfo,this._userInfo=t.userInfo,this._urlNeedsUpdate(e)){let i={language:t.language,dsid:t.dsid,subs:t.subs};e=this._updateUrlWithQueryStrings(e,this.platformInfo,i),t.inheritQuery=!1}this.assetInfo={url:e,itemId:t.itemId,inheritQuery:Boolean(t.inheritQuery),secureStop:Boolean(t.generateSecureStop),appData:t.appData},this.tloadsource=performance.now(),this.logger.info(`[QE Critical] loadSource:${this.redactUrl(e)}`)(),this.playlistLoader.loadManifest(e,t).then(this.trigger.bind(this,s.a.MANIFEST_LOADED)).catch(this._handleManifestNetworkError.bind(this))}else this.trigger(s.a.ERROR,{type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!0,url:e,reason:"Empty loadSource url"});else this.trigger(s.a.ERROR,{type:a.c.OTHER_ERROR,details:a.a.INTERNAL_EXCEPTION,fatal:!0,url:e,reason:"Playready key system is not supported now"})}_handleManifestNetworkError(e){let t,i,a,r=e.response,n=e.details,o=r?r.code:r;i=this.networkErrorHandler.getActionForPlaylistNetworkError(e.response,n),this.logger.warn(`manifest encountered error ${o} errorAction ${i.errorAction}`)(),a=this.playlistLoader.retryPlaylistRequest.bind(this.playlistLoader,e),(t=this.networkErrorHandler.handleNetworkError(i.errorAction,i.errorActionFlags,e,void 0,a)).retryPromise instanceof Promise?t.retryPromise.then(this.trigger.bind(this,s.a.MANIFEST_LOADED)).catch(this._handleManifestNetworkError.bind(this)):i.errorAction===Et.RetryRequest&&(e.fatal=!0),e.fatal&&this.trigger(s.a.ERROR,e)}get bufferDryPromise(){if(this.streamController.combinedBufferEmpty())return Promise.resolve();if(!this.bufferEndPromiseWrapper){this.bufferEndPromiseWrapper={};let e=new Promise((e,t)=>{this.bufferEndPromiseWrapper.resolve=e,this.bufferEndPromiseWrapper.reject=t});this.bufferEndPromiseWrapper.promise=e.then(()=>{this.bufferEndPromiseWrapper=void 0}).catch(e=>{throw this.bufferEndPromiseWrapper=void 0,e})}return this.bufferEndPromiseWrapper.promise}onBufferChanged(e,t){switch(t.reason){case Ct.AlmostDryWaterLevel:this.bufferEndPromiseWrapper&&this.bufferEndPromiseWrapper.resolve()}}get realCurrentTime(){if(this._isObjectValid())return this.streamController.realCurrentTime}get iframeMode(){if(this._isObjectValid())return this.streamController.iframeMode}get effectiveRate(){return this.streamController.effectiveRate}set desiredRate(e){this.setRate(e)}get desiredRate(){return this._isObjectValid()?this.streamController.desiredRate:0}addCDNToWhiteList(e){this.cdnWhiteList.add(e)}removeCDNFromWhiteList(e){this.cdnWhiteList.delete(e)}isValidCDN(e){return this.cdnWhiteList.has(e)}hasFallBack(){return this.cdnWhiteList.size>1&&this.config.enableCDNFallback}get preferredHostName(){return this.cdnReferenceBaseURL}set preferredHostName(e){this.cdnReferenceBaseURL=e}setRate(e){if(!this._isObjectValid()||!this.media)return;this.logger.info(`setRate ${e}`)();const t=Math.abs(e);if(![0,1,8,24,48,96].some(e=>e===t))return this.logger.warn(`unsupported rate(${e})`)(),-3;const i=0!==e&&1!==e;if(i&&!this.levelController.hasIframeLevels)return this.logger.warn("can't switch to iframe mode")(),-1;if(this.config.overridePlaybackRate){let e=i?2:1;this.media.playbackRate=e,this.logger.info(`[iframes] setting playbackRate to ${e}`)()}return this.streamController.desiredRate=e,this.eventReporter.setRate(e),0}startLoad(e=-1){this._isObjectValid()&&this.media&&(this.logger.info(`startLoad(${e})`)(),this.networkControllers.forEach(t=>{t.startLoad(e)}))}stopLoad(){this._isObjectValid()&&(this.logger.info("stopLoad")(),this.networkControllers.forEach(e=>{e.stopLoad()}))}setAppData(e){this._isObjectValid()&&e&&this.eventReporter&&this.eventReporter.setAppData(e)}set userInfo(e){this._isObjectValid()&&e&&(this._userInfo=e)}get userInfo(){if(this._isObjectValid())return this._userInfo}get keysystems(){if(this._isObjectValid())return this.keyLoader.keySystemController.availableKeySystems}setProtectionData(e){this._isObjectValid()&&this.keyLoader.keySystemController.initialize(e)}generateKeyRequest(e,t){this._isObjectValid()&&(this.keyLoader.keySystemController.generateRequest(e,t),this.eventReporter.notifyKeySessionEvent(F.spcreceived,{keyuri:e}))}setLicenseResponse(e,t){this._isObjectValid()&&this.keyLoader.keySystemController.setLicenseResponse(e,t)}registerProgramDateTime(e,t){if(!this._isObjectValid())return;this.availableProgramDateTime||(this.availableProgramDateTime=new Map);let i=new Date(e);this.availableProgramDateTime.set(i.getTime(),t)}resolvePendingSeekToDate(){if(!this._isObjectValid())return;let e=-1;return this.availableProgramDateTime&&this.availableProgramDateTime.size>0&&this.pendingSeekToDate&&(e=this.resolveProgramDateTimeToPTS(this.pendingSeekToDate)),e}resolveProgramDateTimeToPTS(e){if(!this._isObjectValid())return;let t=Array.from(this.availableProgramDateTime.keys());t.sort((function(e,t){return e-t}));let i,s=new Date("1970-01-01 00:00:00").getTime(),a=0,r=0,n=0;if(t.length){for(i=0;i<t.length;++i){let a=t[i];if(e.getTime()<a)break;s=a}if(0===i){let i=t[0],s=this.availableProgramDateTime.get(i);s>0&&(n=s-(r=(i-e.getTime())/1e3))}else n=(a=this.availableProgramDateTime.get(s))+(r=(e.getTime()-s)/1e3)}return n}seekToDate(e){if(this._isObjectValid()&&e instanceof Date&&!isNaN(e.getTime()))if(this.availableProgramDateTime&&0!==this.availableProgramDateTime.size){let t=this.resolveProgramDateTimeToPTS(e);null!=t&&isFinite(t)&&(this.logger.info(`adjust currentTime to date ${t}`)(),this.media.currentTime=t)}else this.pendingSeekToDate=e}handleResolvedUri(e,t){this._isObjectValid()&&this.trigger(s.a.UNRESOLVED_URI_LOADED,{uri:e,response:t})}redactUrl(e){return"production"===this.config.buildType?"<redacted>":e}swapAudioCodec(){this._isObjectValid()&&this.streamController.swapAudioCodec()}recoverMediaError(){if(this._isObjectValid()){var e=this.media;this.detachMedia(),this.attachMedia(e)}}get levels(){if(this._isObjectValid())return this.levelController.validLevels}get currentLevel(){if(this._isObjectValid())return this.streamController.currentLevel}levelWithPersistentId(e){if(this._isObjectValid())return this.levelController.getLevelWithPersistentId(e)}set currentLevel(e){this._isObjectValid()&&(this.loadLevel=e,this.streamController.immediateLevelSwitch())}get nextLevel(){if(this._isObjectValid())return this.streamController.nextLevel}set nextLevel(e){this._isObjectValid()&&(this.levelController.manualLevel=e,this.streamController.nextLevelSwitch())}get loadLevel(){if(this._isObjectValid())return this.levelController.level}set loadLevel(e){this._isObjectValid()&&(this.levelController.manualLevel=e)}get nextLoadLevel(){if(this._isObjectValid())return this.levelController.nextLoadLevel}set nextLoadLevel(e){this._isObjectValid()&&(this.levelController.nextLoadLevel=e)}get firstLevel(){if(this._isObjectValid())return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this._isObjectValid()&&(this.levelController.firstLevel=e)}get startLevel(){if(this._isObjectValid())return this.levelController.startLevel}set startLevel(e){this._isObjectValid()&&(-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e)}get autoLevelCapping(){if(this._isObjectValid())return this._autoLevelCapping}set autoLevelCapping(e){this._isObjectValid()&&(this._autoLevelCapping=e)}get autoLevelEnabled(){if(this._isObjectValid())return-1===this.levelController.manualLevel}prepareToLoadIncompatCC(e){this.incompatCCStartFrag=[],this.incompatCCStartTime=void 0,this.streamController.pendingIncompatCC=e,this.audioStreamController&&(this.audioStreamController.pendingIncompatCC=e)}determineIncompatCCStartTime(e){let t="audio"===e.type?1:0;this.incompatCCStartFrag[t]={sn:e.sn,startPTS:e.startPTS,cc:e.cc,level:e.level};let i=0,s=0,a=isNaN(this.streamController.lastCurrentTime)?0:this.streamController.lastCurrentTime,r=this.bufferController.sourceBufferNb,n=0;if(this.incompatCCStartFrag[0]&&(s=isNaN(this.incompatCCStartFrag[0].startPTS)?0:this.incompatCCStartFrag[0].startPTS,n++),this.incompatCCStartFrag[1]&&(i=isNaN(this.incompatCCStartFrag[1].startPTS)?0:this.incompatCCStartFrag[1].startPTS,n++),n===r){let e=Math.max(a,s,i);this.incompatCCStartTime=e!==a?e:void 0}}processIncompatCCStartTime(){let e=!1;return this.incompatCCStartTime&&(this.streamController.seek(this.incompatCCStartTime),this.incompatCCStartTime=void 0,e=!0),e}get manualLevel(){if(this._isObjectValid())return this.levelController.manualLevel}get seeking(){return!!this._isObjectValid()&&this.streamController.seeking}get playbackLikelyToKeepUp(){return!!this._isObjectValid()&&this.streamController.playbackLikelyToKeepUp}set waitingForIncompatibleCCFragLoad(e){this._isObjectValid()&&(this.streamController.waitingForIncompatibleCCFragLoad=e)}get waitingForIncompatibleCCFragLoad(){return!!this._isObjectValid()&&this.streamController.waitingForIncompatibleCCFragLoad}get minAutoLevel(){if(!this._isObjectValid())return;let e=this,t=e.levels,i=e.config.minAutoBitrate,s=t?t.length:0;for(let a=0;a<s;a++)if((t[a].realBitrate?Math.max(t[a].realBitrate,t[a].bitrate):t[a].bitrate)>i&&t[a].iframes===e.iframeMode)return a;return 0}get minLevelIframeMode(){if(!this._isObjectValid())return;let e=this.levels,t=this.config.minAutoBitrate,i=e?e.length:0;for(let s=0;s<i;s++)if((e[s].realBitrate?Math.max(e[s].realBitrate,e[s].bitrate):e[s].bitrate)>t&&!0===e[s].iframes)return s;return 0}get maxAutoLevel(){if(!this._isObjectValid())return;const e=this.levels,t=this.iframeMode?-1:this.autoLevelCapping;return-1===t&&e&&e.length?e.length-1:t}get maxLevelIframeMode(){if(!this._isObjectValid())return;const e=this.levels;return e&&e.length?e.length-1:-1}getLowestBitrateLevel(e){if(this._isObjectValid())return this.levelController.lowestBitrateLevel(e)}countIframesInCurrentLevel(){return this.streamController.countIframesInCurrentLevel(this.levelController.level)}get nextAutoLevel(){if(this._isObjectValid())return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.levels[this.maxAutoLevel].persistentId)}set nextAutoLevel(e){this._isObjectValid()&&(this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e))}get sessionData(){if(this._isObjectValid())return this.playlistLoader.parsedSessionData}get liveSyncPosition(){if(this._isObjectValid())return this.streamController.liveSyncPosition}get audioTracks(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e?e.audioTrack:-1}get audioMediaOptions(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e&&e.mediaSelectionGroup?e.mediaSelectionGroup.MediaSelectionGroupOptions:void 0}get audioSelectedPersistentID(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e&&e.selectedMediaOption?e.selectedPersistentID:void 0}set audioSelectedPersistentID(e){if(!this._isObjectValid())return;const t=this.audioTrackController;t&&(t.selectedPersistentID=e)}get subtitleTracks(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleMediaOptions(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e&&e.mediaSelectionGroup?e.mediaSelectionGroup.MediaSelectionGroupOptions:void 0}get subtitleSelectedPersistentID(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e&&e.selectedMediaOption?e.selectedPersistentID:void 0}set subtitleSelectedPersistentID(e){if(!this._isObjectValid())return;const t=this.subtitleTrackController;t&&(t.selectedPersistentID=e)}get selectedMediaArray(){if(!this._isObjectValid())return;let e=[],t=this.audioTrackController?this.audioTrackController.selectedMediaOption:void 0,i=this.subtitleTrackController?this.subtitleTrackController.selectedMediaOption:void 0;if(t){let i={MediaSelectionGroupMediaType:Qe.AUDIO,MediaSelectionOptionsPersistentID:t.MediaSelectionOptionsPersistentID};e.push(i)}if(i){let t=i.MediaSelectionOptionsDisplaysNonForcedSubtitles?i.MediaSelectionOptionsDisplaysNonForcedSubtitles:Xe.NO,s={MediaSelectionGroupMediaType:Qe.SUBTITLE,MediaSelectionOptionsDisplaysNonForcedSubtitles:t,MediaSelectionOptionsPersistentID:i.MediaSelectionOptionsPersistentID};e.push(s)}return e}set selectedMediaArray(e){this._isObjectValid()&&e.forEach(e=>{e.MediaSelectionGroupMediaType===Qe.AUDIO||e.MediaSelectionOptionsMediaType===Qe.AUDIO?this.audioSelectedPersistentID=e.MediaSelectionOptionsPersistentID:e.MediaSelectionGroupMediaType!==Qe.SUBTITLE&&e.MediaSelectionOptionsMediaType!==Qe.SUBTITLE&&e.MediaSelectionOptionsMediaType!==Qe.CLOSEDCAPTION||(this.subtitleSelectedPersistentID=e.MediaSelectionOptionsPersistentID)})}get mediaSelectionArray(){if(!this._isObjectValid())return;let e=new Array;const t=this.subtitleTrackController,i=this.audioTrackController;return i&&i.mediaSelectionGroup&&e.push(i.mediaSelectionGroup),t&&t.mediaSelectionGroup&&e.push(t.mediaSelectionGroup),e}get subtitleDisplay(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){if(!this._isObjectValid())return;const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get hasPlaybackEverStarted(){if(this._isObjectValid())return this.streamController.playbackEverStarted}updatePlaylistAttributes(e){let t=e.type,i="VOD",s=e.live;return"EVENT"===t&&s?i="EVENT":t&&"LIVE"!==t||!s||(i="LIVE"),this.isLive=s,this.playlistType=i,{playlistType:i,isLive:s}}}t.default=ls}),(function(e,t,i){"use strict";i.r(t),i.d(t,"createDemuxerWorker",(function(){return n})),i.d(t,"createDecryptorWorker",(function(){return o}));var s=i(11);i.d(t,"DemuxerInline",(function(){return s.a}));var a=i(12);i.d(t,"SegmentDecryptorInline",(function(){return a.a}));const r=(e,t)=>i(20)(e,t),n=()=>r(21),o=()=>r(22)})]).default}));